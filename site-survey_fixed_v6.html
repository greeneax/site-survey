<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Site Survey Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .nav-overlay {
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .nav-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }
        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.flex {
            display: flex;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .loader {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            background-color: #f9fafb;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .photo-upload-area:hover {
            border-color: #0d9488;
            background-color: #f0fdfa;
        }
        .photo-upload-area.dragover {
            border-color: #0d9488;
            background-color: #e6fffa;
        }
        .photo-preview {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .photo-item {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        .photo-delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .photo-delete-btn:hover {
            background-color: rgba(220, 38, 38, 0.9);
        }
        
        /* Collaborative Editing Styles */
        .collaborative-user-indicator {
            animation: slideInFromRight 0.3s ease-out;
        }
        
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .field-being-edited {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        /* Authentication Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .auth-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            margin: 1rem;
        }
        .user-menu {
            position: relative;
            display: inline-block;
        }
        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
        }
        .user-dropdown.show {
            display: block;
        }
        .admin-panel {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .access-denied {
            background: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }
        .venue-suggestion {
            transition: background-color 0.2s;
        }
        .venue-suggestion:hover {
            background-color: #f3f4f6;
        }
        #venue-suggestions {
            border-top: none;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        @media print {
            body > *:not(#printable-area) {
                display: none;
            }
            #printable-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                font-size: 12px;
            }
            .no-print {
                display: none !important;
            }
            body {
                background-color: #fff;
            }
            #summary-content h2, #summary-content h3 {
                color: #000;
            }
        }
        
        /* AI Assistant Styles */
        .field-being-edited {
            border-color: #8b5cf6 !important;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1) !important;
        }
        
        .ai-suggestion-highlight {
            background-color: rgba(139, 92, 246, 0.1);
            border-left: 4px solid #8b5cf6;
        }
        
        /* Agenda Upload Styles */
        .agenda-upload-area {
            transition: all 0.2s ease;
        }
        
        .agenda-upload-area:hover {
            border-color: #6b7280;
            background-color: #f9fafb;
        }
        
        .agenda-upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    /* Custom styled date inputs */
    .date-field-wrapper { position: relative; display:inline-flex; align-items:center; }
    .date-field-wrapper input[type=date] { padding-left:2.25rem; }
    .date-field-icon { position:absolute; left:0.65rem; color:#0d9488; pointer-events:none; font-size:0.9rem; }
    .date-field-wrapper input[type=date]:focus { outline:2px solid #0d9488; outline-offset:2px; }
        
        /* AI Status Indicator */
        #ai-status {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        /* Unified User Menu Styles */
        .user-menu { position: relative; display: inline-block; }
        .user-dropdown {
            display: none; position: absolute; right: 0; top: calc(100% + 8px);
            background: white; border: 1px solid #e5e7eb; border-radius: 12px; min-width: 200px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 1000; width: 280px;
        }
        .user-dropdown.show, .user-dropdown:not(.hidden) { display: block; }
        /* Desktop nav button active */
        .nav-btn { transition: all 0.3s ease; color: #475569; }
        .nav-btn.active { background-color: #0d9488; color: white; box-shadow: 0 4px 14px 0 rgba(13, 148, 136, 0.25); }
        /* Hamburger Menu Styles */
        .hamburger { display: none; flex-direction: column; cursor: pointer; padding: 8px; background: none; border: none; z-index: 50; }
        .hamburger span { width: 25px; height: 3px; background: #4B5563; margin: 3px 0; transition: 0.3s; border-radius: 2px; }
        .hamburger.active span:nth-child(1) { transform: rotate(-45deg) translate(-5px, 6px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(45deg) translate(-5px, -6px); }
        /* Mobile Navigation */
        @media (max-width: 768px) {
            .hamburger { display: flex; }
            .main-nav { position: fixed; top: 0; left: -100%; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: left 0.3s ease; z-index: 40; padding-top: 80px; overflow-y: auto; }
            .main-nav.open { left: 0; }
            .nav-btn { width: 100%; justify-content: flex-start; padding: 16px 24px; margin: 4px 0; border-radius: 0; font-size: 16px; text-align: left; flex-direction: row; }
            .nav-btn span:first-child { margin-right: 12px; }
            .nav-btn span:last-child { font-size: 16px; margin-top: 0; }
            .nav-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 30; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
            .nav-overlay.open { opacity: 1; visibility: visible; }
        }
        /* Sections default hidden, show only active */
        #survey-container .content-section { display: none; }
        #survey-container .content-section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseConfig = {
            url: 'https://iasddcsryzgtcasuxioc.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhc2RkY3NyeXpndGNhc3V4aW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NDA3NDcsImV4cCI6MjA3MDAxNjc0N30.fwZ-uDhkWIai76XW7AYgdwoUkuo_D52ypCQ6tEvtScY'
        };
        
        // Export for use by auth system
        window.supabaseConfig = supabaseConfig;
        
        // Export for global access
        window.supabaseClient = null;
    </script>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container hidden">
        <div class="auth-card">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Site Survey Portal</h1>
                <p class="text-gray-600 mt-2">Sign in with your Microsoft account</p>
            </div>
            <div id="auth-content">
                <button id="login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    Sign in with Microsoft
                </button>
            </div>
            <div id="auth-loading" class="hidden text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2 text-gray-600">Signing you in...</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Container (shows after login) -->
    <div id="dashboard-container" class="hidden min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <!-- Dashboard Header with User Menu -->
        <header id="dashboard-header" class="bg-white shadow-sm border-b border-gray-200">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <button id="home-link-dashboard" type="button" onclick="returnToDashboard()" class="text-xl font-semibold text-gray-700 hover:text-blue-700">
                            Site Survey Portal
                        </button>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center space-x-3 bg-gray-50 hover:bg-gray-100 rounded-lg px-4 py-2 transition-colors">
                            <div id="user-avatar" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-medium">
                                U
                            </div>
                            <div class="text-left hidden lg:block">
                                <p id="user-display-name" class="text-sm font-medium text-gray-800">Loading...</p>
                                <p id="user-role" class="text-xs text-gray-500">User</p>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div id="user-dropdown" class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50 hidden">
                            <div class="px-4 py-3 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-800" id="dropdown-user-name">User Name</p>
                                <p class="text-sm text-gray-500" id="dropdown-user-email">user@company.com</p>
                                <div id="admin-indicator" class="hidden mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        Administrator
                                    </span>
                                </div>
                            </div>
                            
                            <div id="admin-section" class="hidden">
                                <div class="py-1">
                                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">Admin Tools</p>
                                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                        </svg>
                                        Manage Users
                                    </button>
                                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        System Settings
                                    </button>
                                </div>
                                <div class="border-t border-gray-100"></div>
                            </div>
                            
                            <div id="manager-section" class="hidden">
                                <div class="py-1">
                                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">Manager Tools</p>
                                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        View Reports
                                    </button>
                                </div>
                                <div class="border-t border-gray-100"></div>
                            </div>
                            
                            <div class="py-1">
                                <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                    <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Profile Settings
                                </button>
                                <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                    <svg class="w-4 h-4 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container mx-auto px-4 py-8">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">Welcome to Site Survey Portal</h1>
                <p class="text-xl text-gray-600">What would you like to do today?</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                <!-- New Site Survey -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-8 text-center">
                    <div class="bg-green-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">New Site Survey</h3>
                    <p class="text-gray-600 mb-6">Start a fresh site survey for a new event. You'll be taken directly to the survey form to enter all details.</p>
                    <button id="new-survey-btn" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition-colors font-medium">
                        Start New Survey
                    </button>
                </div>

                <!-- Edit Existing Survey -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-8 text-center">
                    <div class="bg-blue-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Edit Existing Survey</h3>
                    <p class="text-gray-600 mb-6">Continue working on a survey that's already in progress or needs updates.</p>
                    <button id="edit-survey-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Browse Surveys
                    </button>
                </div>

                <!-- Venue Lookup -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-8 text-center">
                    <div class="bg-purple-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Venue Lookup</h3>
                    <p class="text-gray-600 mb-6">Search and view detailed information about venues from previous surveys.</p>
                    <button id="venue-lookup-btn" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                        Search Venues
                    </button>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="mt-16 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Recent Activity</h2>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div id="recent-activity" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">Loading recent activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden until survey is selected) -->
    <div id="main-app" class="hidden"></div>

    <!-- User Header (survey-only) -->
    <div id="survey-header" class="hidden bg-white shadow-sm border-b px-6 py-3 flex justify-between items-center no-print">
        <div class="flex items-center space-x-4">
            <button id="home-link-survey" type="button" onclick="returnToDashboard()" class="text-xl font-semibold text-gray-700 hover:text-blue-700">
                Site Survey Portal
            </button>
            <div id="soft-delete-banner" class="hidden ml-4 px-3 py-1 rounded-md text-sm font-medium bg-red-100 text-red-700 flex items-center space-x-2">
                <span>Survey Archived</span>
                <button id="restore-survey-btn" class="underline text-xs">Restore</button>
            </div>
        </div>
        <!-- Reuse the same user menu markup as the dashboard for consistency -->
        <div class="relative">
            <button id="user-menu-button" class="flex items-center space-x-3 bg-gray-50 hover:bg-gray-100 rounded-lg px-4 py-2 transition-colors">
                <div id="user-avatar" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-medium">
                    U
                </div>
                <!-- Hide name/role on mobile & tablet; show on desktop (lg+) -->
                <div class="text-left hidden lg:block">
                    <p id="user-display-name" class="text-sm font-medium text-gray-800">Loading...</p>
                    <p id="user-role" class="text-xs text-gray-500">User</p>
                </div>
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <button id="delete-survey-btn" class="ml-4 hidden lg:inline-flex items-center bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 text-sm font-medium px-3 py-1.5 rounded-md transition-colors" title="Archive (soft delete) this survey">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                Archive
            </button>
            <!-- Dropdown Menu -->
            <div id="user-dropdown" class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50 hidden">
                <div class="px-4 py-3 border-b border-gray-100">
                    <p class="text-sm font-medium text-gray-800" id="dropdown-user-name">User Name</p>
                    <p class="text-sm text-gray-500" id="dropdown-user-email">user@company.com</p>
                    <div id="admin-indicator" class="hidden mt-1">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Administrator
                        </span>
                    </div>
                </div>
                <div id="admin-section" class="hidden">
                    <div class="py-1">
                        <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">Admin Tools</p>
                        <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                            <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            Manage Users
                        </button>
                        <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                            <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            System Settings
                        </button>
                    </div>
                    <div class="border-t border-gray-100"></div>
                </div>
                <div id="manager-section" class="hidden">
                    <div class="py-1">
                        <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">Manager Tools</p>
                        <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                            <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            View Reports
                        </button>
                    </div>
                    <div class="border-t border-gray-100"></div>
                </div>
                <div class="py-1">
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Profile Settings
                    </button>
                    <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                        <svg class="w-4 h-4 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="modal no-print hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Admin Panel</h2>
                <button id="close-admin-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Active Users -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">Active Users</h3>
                    <div id="active-users-list" class="space-y-2">
                        <!-- Will be populated with active users -->
                    </div>
                </div>
                
                <!-- User Management -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">User Roles</h3>
                    
                    <!-- Add new user role -->
                    <div class="space-y-3 mb-4">
                        <div>
                            <label class="form-label">Email Address</label>
                            <input type="email" id="role-email" class="form-input" placeholder="user@ita.com">
                        </div>
                        <div>
                            <label class="form-label">Role</label>
                            <select id="role-select" class="form-input">
                                <option value="user">User</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button id="set-role-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Set User Role
                        </button>
                    </div>
                    
                    <!-- Existing user roles -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Current User Roles</h4>
                        <div id="user-roles-list" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- Will be populated with user roles -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Survey Records -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-3">Survey Records</h3>
                <div id="survey-records" class="bg-gray-50 p-4 rounded-lg max-h-64 overflow-y-auto">
                    <!-- Will be populated with survey records -->
                </div>
            </div>
        </div>
    </div>

    <!-- Start New Survey Modal -->
    <div id="new-survey-modal" class="modal no-print hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Start New Survey</h2>
                <button id="close-new-survey-modal" class="text-gray-500 hover:text-gray-700" aria-label="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-5">
                <div>
                    <label for="start-r2-input" class="form-label">R2 Order Number</label>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="start-r2-input" class="form-input flex-1" placeholder="e.g., 0912345" />
                        <button id="start-r2-go-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Go
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">This will populate the R2 Quote Number field in the survey and database.</p>
                    <p id="start-r2-duplicate-msg" class="hidden text-sm text-red-600 mt-2">A Survey for this Order has already been created.</p>
                </div>

                <div class="text-center text-gray-400 select-none">-OR-</div>

                <div class="pt-2">
                    <button id="start-without-r2-btn" class="w-full bg-amber-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-amber-700 transition-colors">
                        Start W/O R2 Order Number
                    </button>
                </div>

                <div class="flex justify-end pt-2">
                    <button id="cancel-new-survey-btn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Venue Lookup Modal -->
    <div id="venue-lookup-modal" class="modal no-print hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Venue Database Lookup</h2>
                <button id="close-venue-lookup-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="flex gap-4">
                    <div class="flex-1">
                        <input type="text" id="venue-search-input" placeholder="Search venues by name, address, or location..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button id="venue-search-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        Search
                    </button>
                </div>
            </div>
            
            <div id="venue-search-results" class="max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-center py-8">Enter a venue name to search</p>
            </div>
        </div>
    </div>

    <!-- Welcome Modal (Legacy - for direct R2 access) -->
    <div id="welcome-modal" class="modal no-print hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Live Event Site Survey</h2>
            <p class="text-gray-600 mb-6">Please enter your name and the R2# for the event to begin.</p>
            <div class="space-y-4">
                <div>
                    <label for="user-name-input" class="form-label">Your Name</label>
                    <input type="text" id="user-name-input" class="form-input" placeholder="e.g., Jane Doe" required />
                </div>
                <div>
                    <label for="r2-number-input" class="form-label">Event R2#</label>
                    <input type="text" id="r2-number-input" class="form-input" placeholder="e.g., 0911234" required />
                </div>
            </div>
            <button id="load-survey-btn" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-teal-700 transition-colors mt-6">
                Load Survey
            </button>
        </div>
    </div>
    
    <div id="survey-container" class="container mx-auto p-4 max-w-7xl no-print" style="display: none;">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-900">Live Event Site Survey</h1>
            <p id="header-subtitle" class="text-lg text-gray-600 mt-1">A Collaborative Checklist for Technicians</p>
            <div class="mt-4 flex justify-center gap-4">
                <button onclick="showSurveyBrowser()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 shadow-md">
                    <span>🔍</span>
                    <span>Browse Surveys</span>
                </button>
                <button onclick="saveSurveyToDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 shadow-md">
                    <span>💾</span>
                    <span>Save to Database</span>
                </button>
                <button id="ai-assistant-btn" onclick="showAISettings()" class="hidden bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 shadow-md">
                    <span>🤖</span>
                    <span id="ai-btn-text">AI Assistant</span>
                </button>
                <div class="bg-green-600/20 text-green-800 px-4 py-2 rounded-lg flex items-center gap-2">
                    <span>✨</span>
                    <span class="text-sm">Auto-save enabled</span>
                </div>
                <div id="ai-status" class="hidden bg-purple-600/20 text-purple-800 px-4 py-2 rounded-lg flex items-center gap-2">
                    <span>🧠</span>
                    <span class="text-sm">AI Assistant active</span>
                </div>
            </div>
        </header>

        <nav class="sticky top-0 z-10 bg-white/80 backdrop-blur-sm rounded-xl shadow-md mb-8 p-2">
            <!-- Mobile hamburger button -->
            <button class="hamburger md:hidden" id="mobile-menu-btn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <!-- Desktop navigation -->
            <div class="hidden md:flex justify-center items-center gap-2 md:gap-4">
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="event-info">
                    <span class="text-2xl">📅</span>
                    <span class="text-xs font-medium mt-1">Event Info</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="client-info">
                    <span class="text-2xl">👤</span>
                    <span class="text-xs font-medium mt-1">Client Info</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="venue-info">
                    <span class="text-2xl">🏢</span>
                    <span class="text-xs font-medium mt-1">Venue Info</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="logistics">
                    <span class="text-2xl">🗺️</span>
                    <span class="text-xs font-medium mt-1">Logistics</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="rooms">
                    <span class="text-2xl">🚪</span>
                    <span class="text-xs font-medium mt-1">Rooms</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="venue-guidelines">
                    <span class="text-2xl">📜</span>
                    <span class="text-xs font-medium mt-1">Guidelines</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="wrap-up">
                    <span class="text-2xl">✅</span>
                    <span class="text-xs font-medium mt-1">Wrap-Up</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="summary-export">
                    <span class="text-2xl">📄</span>
                    <span class="text-xs font-medium mt-1">Summary</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="activity">
                    <span class="text-2xl">🕰️</span>
                    <span class="text-xs font-medium mt-1">Activity</span>
                </button>
            </div>
            
            <!-- Mobile navigation overlay -->
            <div class="nav-overlay md:hidden" id="nav-overlay"></div>
            
            <!-- Mobile navigation menu -->
            <div class="main-nav md:hidden" id="mobile-nav">
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="event-info">
                    <span class="text-2xl">📅</span>
                    <span class="text-sm font-medium">Event Information</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="client-info">
                    <span class="text-2xl">👤</span>
                    <span class="text-sm font-medium">Client Information</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="venue-info">
                    <span class="text-2xl">🏢</span>
                    <span class="text-sm font-medium">Venue Information</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="logistics">
                    <span class="text-2xl">🗺️</span>
                    <span class="text-sm font-medium">Logistics</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="rooms">
                    <span class="text-2xl">🚪</span>
                    <span class="text-sm font-medium">Rooms</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="venue-guidelines">
                    <span class="text-2xl">📜</span>
                    <span class="text-sm font-medium">Venue Guidelines</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="wrap-up">
                    <span class="text-2xl">✅</span>
                    <span class="text-sm font-medium">Wrap-Up</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="summary-export">
                    <span class="text-2xl">📄</span>
                    <span class="text-sm font-medium">Summary</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="activity">
                    <span class="text-2xl">🕰️</span>
                    <span class="text-sm font-medium">Activity</span>
                </button>
            </div>
        </nav>

        <main id="app-content" class="space-y-8">
            <section id="event-info" class="content-section active p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="client-info" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="venue-info" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="logistics" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="rooms" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="venue-guidelines" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="wrap-up" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="summary-export" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="activity" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
        </main>
        
        <footer class="text-center mt-8 p-4 border-t border-gray-200">
             <div id="save-status" class="text-sm text-gray-500 mb-2 h-5"></div>
             <p class="text-xs text-gray-400">User: <span id="user-display" class="font-mono">Loading...</span></p>
             <p class="text-xs text-gray-400">Survey: <span id="survey-info" class="font-mono">Version 1</span></p>
        </footer>
    </div>
    
    <!-- Survey Browser Modal -->
    <div id="survey-browser-modal" class="modal no-print hidden">
        <div class="modal-content max-w-6xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Browse Surveys</h2>
                <button onclick="closeSurveyBrowser()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="flex gap-4 mb-6">
                <input type="text" id="survey-search" placeholder="Search by R2#, Event Name, or Venue..." class="flex-1 form-input">
                <select id="status-filter" class="form-input">
                    <option value="all">All Status</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Draft">Draft</option>
                </select>
                <button onclick="searchSurveysInBrowser()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Search
                </button>
            </div>
            
            <div id="survey-results" class="max-h-96 overflow-y-auto">
                <p class="text-center py-8 text-gray-500">Enter a search term to find surveys</p>
            </div>
        </div>
    </div>

    <!-- AI Settings Modal -->
    <div id="ai-settings-modal" class="modal no-print hidden">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold" id="ai-modal-title">AI Assistant</h2>
                <button onclick="closeAISettings()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Admin-only API Key Configuration -->
                <div id="admin-ai-config" class="hidden bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">System Configuration (Admin Only)</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="enable-ai-system" class="form-checkbox">
                            <div>
                                <span class="font-medium">Enable AI System</span>
                                <p class="text-sm text-gray-600">Allow users to access AI features</p>
                            </div>
                        </label>
                        
                        <div id="api-key-section" class="hidden">
                            <label class="form-label">OpenAI API Key</label>
                            <div class="flex gap-2">
                                <input type="password" id="openai-key-input" class="form-input flex-1" placeholder="sk-...">
                                <button id="toggle-key-visibility" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                                    👁️
                                </button>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">This key will be stored securely and shared with all users</p>
                            
                            <div class="flex gap-3 mt-3">
                                <button id="save-api-key" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    Save & Enable AI
                                </button>
                                <button id="test-api-key" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                    Test Connection
                                </button>
                                <button id="disable-ai-system" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors hidden">
                                    Disable AI System
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User AI Features -->
                <div id="user-ai-features" class="hidden bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">AI Features</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="ai-assistance-toggle" class="form-checkbox">
                            <div>
                                <span class="font-medium">Enable AI Assistance</span>
                                <p class="text-sm text-gray-600">Get real-time suggestions for AV setup and site survey questions</p>
                            </div>
                        </label>
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="agenda-analysis-toggle" class="form-checkbox" checked>
                            <div>
                                <span class="font-medium">Agenda Analysis</span>
                                <p class="text-sm text-gray-600">Automatically analyze uploaded agendas to suggest rooms and schedule</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- AI Status -->
                <div id="ai-status-display" class="bg-blue-50 p-4 rounded-lg hidden">
                    <h3 class="text-lg font-semibold mb-2 text-blue-800">AI Assistant Status</h3>
                    <div id="ai-status-content" class="text-sm text-blue-700">
                        <!-- Status content will be populated here -->
                    </div>
                </div>
                
                <!-- System Disabled Message -->
                <div id="ai-disabled-message" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 hidden">
                    <div class="flex items-center">
                        <span class="text-yellow-600 text-xl mr-3">⚠️</span>
                        <div>
                            <h3 class="font-semibold text-yellow-800">AI Assistant Not Available</h3>
                            <p class="text-sm text-yellow-700">The AI assistant has not been configured by an administrator.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Suggestions Panel -->
    <div id="ai-suggestions-panel" class="fixed right-4 top-20 w-80 bg-white shadow-lg rounded-lg border border-purple-200 hidden z-40">
        <div class="bg-purple-600 text-white p-3 rounded-t-lg flex justify-between items-center">
            <span class="font-medium">🤖 AI Suggestions</span>
            <button onclick="hideAISuggestions()" class="text-purple-200 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="ai-suggestions-content" class="p-4 max-h-96 overflow-y-auto">
            <!-- AI suggestions will be populated here -->
        </div>
    </div>

    <!-- Agenda Analysis Modal -->
    <div id="agenda-analysis-modal" class="modal no-print hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Agenda Analysis Results</h2>
                <button onclick="closeAgendaAnalysis()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="agenda-analysis-content" class="space-y-6">
                <!-- Analysis results will be populated here -->
            </div>
            
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
                <button onclick="closeAgendaAnalysis()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    No, I'll fill manually
                </button>
                <button id="apply-ai-suggestions" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    Apply AI Suggestions
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Use the config from head
        const config = window.supabaseConfig;
        
        // Check if configuration is valid before initializing
        function isValidSupabaseConfig(config) {
            return config.url && 
                   config.anonKey && 
                   config.url !== 'YOUR_SUPABASE_URL' && 
                   config.anonKey !== 'YOUR_SUPABASE_ANON_KEY' &&
                   config.url.startsWith('https://') &&
                   config.url.includes('.supabase.co');
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        let appId = urlParams.get('id'); 
        
        // On initial load, ensure survey UI is hidden when no id is present
        document.addEventListener('DOMContentLoaded', () => {
            const surveyContainer = document.getElementById('survey-container');
            const surveyHeader = document.getElementById('survey-header');
            if (!appId) {
                if (surveyContainer) surveyContainer.style.display = 'none';
                if (surveyHeader) surveyHeader?.classList.add('hidden');
            }
        });

        let supabase = null;
        let currentUserId = null;
        let currentUserName = localStorage.getItem('siteSurveyUserName');
        let formInputTimeout;
        let fullSurveyData = {};
        let previousFieldValues = {}; // Track previous values for change detection
        let pendingChanges = {}; // Buffer changes by minute and user
        let changeFlushTimeout;
        
        let userDisplay, saveStatus;

        // Initialize Supabase only if configuration is valid
        if (isValidSupabaseConfig(config)) {
            try {
                supabase = createClient(config.url, config.anonKey);
                window.supabaseClient = supabase; // Make globally accessible
                console.log('Supabase initialized successfully');
                console.log('Supabase URL:', config.url);
                console.log('Supabase client:', supabase);
                
                // Test the connection
                supabase.from('survey_database').select('count', { count: 'exact', head: true })
                    .then(({ count, error }) => {
                        if (error) {
                            console.error('Supabase connection test failed:', error);
                        } else {
                            console.log('Supabase connection test successful. Table row count:', count);
                        }
                    });
                    
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                showConfigurationError();
            }
        } else {
            console.error('Invalid Supabase configuration - please update the config values');
            console.log('Config received:', config);
            showConfigurationError();
        }

        // Export for use by auth system
        window.supabase = supabase;

        // Check database setup
        async function checkDatabaseSetup() {
            if (!supabase) return false;
            
            try {
                // Try to query a simple table to see if database is set up
                const { data, error } = await supabase
                    .from('system_config').select('setting_name,setting_value')
                    .limit(1);
                    
                if (error && error.code === 'PGRST205') {
                    console.warn('Database tables not found. Please run the supabase_tables.sql script to set up the database.');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.warn('Database connection issue:', error);
                return false;
            }
        }

        function showConfigurationError() {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-0 left-0 w-full bg-red-600 text-white p-4 text-center z-50';
            errorDiv.innerHTML = `
                <h3 class="font-bold">Configuration Error</h3>
                <p>Supabase is not configured. Please contact your administrator to set up the database connection.</p>
                <p class="text-sm mt-2">The application will run in read-only mode.</p>
            `;
            document.body.appendChild(errorDiv);
        }

        // AI Configuration
        let openAIKey = null;
        let aiAssistanceEnabled = false;
        let aiSuggestionsActive = false;
        let aiSystemEnabled = false; // Admin-controlled global setting

        // Legacy welcome modal function for compatibility
        function showWelcomeModal() {
            const urlParams = new URLSearchParams(window.location.search);
            const directAppId = urlParams.get('id');

            if (directAppId) {
                // Direct R2 access - skip legacy modal and go directly to survey
                console.log('Direct survey access detected, initializing survey:', directAppId);
                
                // Set up basic user info from localStorage or default
                if (!currentUserName) {
                    currentUserName = localStorage.getItem('siteSurveyUserName') || 'Survey User';
                    window.currentUserName = currentUserName;
                }
                
                // Initialize the main app directly
                initializeMainApp(directAppId);
            } else {
                // No direct R2 - check authentication and show appropriate interface
                console.log('Initializing authentication for dashboard mode');
                initializeAuthentication();
            }
        }

        function initializeAuthentication() {
            // Check if user is already authenticated via Microsoft SSO
            if (window.currentUserEmail && window.currentUserName) {
                showDashboard();
            } else {
                showAuthContainer();
            }
        }

        function showAuthContainer() {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('main-app').classList.add('hidden');

            // Make sure the survey container is hidden
            const mainContainer = document.querySelector('#survey-container');
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }

            // Hide survey header while in auth
            const surveyHeader = document.getElementById('survey-header');
            if (surveyHeader) surveyHeader.classList.add('hidden');

            // Setup login button
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    // This would trigger Microsoft SSO
                    // For now, simulate successful authentication
                    simulateAuthentication();
                });
            }
        }

        function simulateAuthentication() {
            // This is a placeholder - in real implementation, this would be handled by Microsoft SSO
            const authLoading = document.getElementById('auth-loading');
            const authContent = document.getElementById('auth-content');
            
            authContent.classList.add('hidden');
            authLoading.classList.remove('hidden');
            
            setTimeout(async () => {
                // Simulate successful authentication - you can change the email to test different roles
                // Use 'alex.greene@ita.com' to test admin role
                window.currentUserEmail = 'alex.greene@ita.com'; // Change this to test different users
                window.currentUserName = window.currentUserEmail === 'alex.greene@ita.com' ? 'Alex Greene' : 'Site Survey User';
                
                // Determine role from database or default logic
                let role;
                try {
                    role = await getUserRoleFromDatabase(window.currentUserEmail);
                } catch (error) {
                    console.log('getUserRoleFromDatabase function not available, using default role logic');
                    role = window.currentUserEmail === 'alex.greene@ita.com' ? 'admin' : 'user';
                }
                window.currentUserRole = role;
                
                // Set currentUserId for Supabase operations
                if (window.currentUserEmail) {
                    currentUserId = btoa(window.currentUserEmail).replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
                    currentUserName = window.currentUserName;
                }
                
                // Track user session in database
                await trackUserSession(window.currentUserEmail, window.currentUserName, window.currentUserRole);
                
                showDashboard();
            }, 2000);
        }

        async function showDashboard() {
            // Guard: if currently in survey mode, skip showing dashboard body
            if (window.inSurveyMode) {
                document.getElementById('dashboard-header')?.classList.remove('hidden');
                const dash = document.getElementById('dashboard-container');
                if (dash) { dash.classList.add('hidden'); dash.style.display='none'; dash.style.visibility='hidden'; }
                const mainApp = document.getElementById('main-app');
                if (mainApp) mainApp.classList.remove('hidden');
                const surveyContainer = document.getElementById('survey-container');
                if (surveyContainer) { surveyContainer.style.display='block'; surveyContainer.style.visibility='visible'; }
                return; // do not render dashboard content
            }
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');

            // Make sure the survey container is hidden
            const mainContainer = document.querySelector('#survey-container');
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }

            // Ensure global header is visible
            document.getElementById('dashboard-header')?.classList.remove('hidden');
            // Keep survey-header hidden (single header approach)
            const surveyHeader = document.getElementById('survey-header');
            if (surveyHeader) surveyHeader.classList.add('hidden');

            // Check database setup
            const dbReady = await checkDatabaseSetup();
            if (!dbReady) {
                console.log('Running in offline mode - some features may not be available');
            }

            // Setup dashboard button handlers
            setupDashboardButtons();
            
            // Setup user menu
            setupUserMenu();
            
            // Load recent activity (only if database is ready)
            if (dbReady) {
                loadRecentActivity();
            } else {
                const activityDiv = document.getElementById('recent-activity');
                if (activityDiv) {
                    activityDiv.innerHTML = '<p class="text-orange-500 text-center py-8">Database not configured - running in offline mode</p>';
                }
            }
        }

        function setupDashboardButtons() {
            const newSurveyBtn = document.getElementById('new-survey-btn');
            const editSurveyBtn = document.getElementById('edit-survey-btn');
            const venueLookupBtn = document.getElementById('venue-lookup-btn');

            if (newSurveyBtn) {
                newSurveyBtn.addEventListener('click', showNewSurveyModal);
            }

            if (editSurveyBtn) {
                editSurveyBtn.addEventListener('click', showSurveyBrowser);
            }

            if (venueLookupBtn) {
                venueLookupBtn.addEventListener('click', showVenueLookupModal);
            }
        }

    function createNewSurveyDirect() {
        // Generate a user-friendly temporary R2 number for the new survey
        const timestamp = Date.now();
        const dateStr = new Date().toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD format
        const timeStr = new Date().toTimeString().slice(0, 5).replace(':', ''); // HHMM format
        const tempR2Number = `NEW-${dateStr}-${timeStr}`;
        // Mark that we're in survey mode to suppress dashboard
        window.inSurveyMode = true;
        // Hide dashboard and show survey container
    const dash = document.getElementById('dashboard-container');
    if (dash) { dash.classList.add('hidden'); dash.style.display='none'; dash.style.visibility='hidden'; }
    // Keep global header (dashboard-header) visible per requirement
    document.getElementById('dashboard-header')?.classList.remove('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    // Do not use separate survey-header anymore; ensure it stays hidden
    const surveyHeader = document.getElementById('survey-header');
    if (surveyHeader) surveyHeader.classList.add('hidden');
        const mainContainer = document.querySelector('#survey-container');
        if (mainContainer) { mainContainer.style.display='block'; mainContainer.style.visibility='visible'; mainContainer.style.opacity='1'; }
        window.appId = tempR2Number;
        const newUrl = new URL(window.location); newUrl.searchParams.set('id', tempR2Number); window.history.pushState({}, '', newUrl);
        initializeMainApp(tempR2Number, '', '');
        console.log('Created new survey with ID:', tempR2Number);
    }

    async function returnToDashboard() {
            // Exit survey mode and show dashboard body again
            window.inSurveyMode = false;
            document.getElementById('main-app').classList.add('hidden');
            const dash = document.getElementById('dashboard-container');
            if (dash) { dash.classList.remove('hidden'); dash.style.display='block'; dash.style.visibility='visible'; }
            document.getElementById('dashboard-header')?.classList.remove('hidden'); // keep header
            
            // Also hide the container
            const mainContainer = document.querySelector('#survey-container');
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }

            // Keep survey header hidden consistently
            const surveyHeader = document.getElementById('survey-header');
            if (surveyHeader) surveyHeader.classList.add('hidden');
            
            // Clear the survey ID from URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('id');
            window.history.pushState({}, '', newUrl);
            
            // Clear current survey data if it's a temporary survey
            if (window.appId && (window.appId.startsWith('NEW-') || window.appId.startsWith('SURVEY_'))) {
                window.appId = null;
                fullSurveyData = {};
            }
            
            // Refresh Recent Activity on return
            const activityDiv = document.getElementById('recent-activity');
            if (activityDiv) {
                activityDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Loading recent activity...</p>';
            }
            try {
                const dbReady = await checkDatabaseSetup();
                if (dbReady) {
                    await loadRecentActivity();
                } else if (activityDiv) {
                    activityDiv.innerHTML = '<p class="text-orange-500 text-center py-8">Database not configured - running in offline mode</p>';
                }
            } catch (e) {
                console.error('Failed to refresh recent activity:', e);
            }

            console.log('Returned to dashboard');
        }

        function setupUserMenu() {
            // Support both dashboard and survey headers
            const userMenuButtons = Array.from(document.querySelectorAll('#dashboard-header #user-menu-button, #survey-header #user-menu-button'));
            const allDropdownsSelector = '#dashboard-header #user-dropdown, #survey-header #user-dropdown';
            const logoutBtns = Array.from(document.querySelectorAll('#dashboard-header #logout-btn, #survey-header #logout-btn'));
            
            // Get DOM elements first
            const adminSection = document.getElementById('admin-section');
            const managerSection = document.getElementById('manager-section');

            // Get user role and populate UI
            const userRole = window.currentUserRole || 'user';
            const userName = window.currentUserName || 'Unknown User';
            const userEmail = window.currentUserEmail || 'unknown@example.com';

            // Update user display
            try {
                updateUserInterface(userName, userEmail, userRole);
            } catch (error) {
                console.log('updateUserInterface function not available, updating UI manually');
                // Manual UI update as fallback
                const userDisplayName = document.getElementById('user-display-name');
                const userRoleElement = document.getElementById('user-role');
                const userAvatar = document.getElementById('user-avatar');
                const dropdownUserName = document.getElementById('dropdown-user-name');
                const dropdownUserEmail = document.getElementById('dropdown-user-email');
                
                if (userDisplayName) userDisplayName.textContent = userName;
                if (userRoleElement) userRoleElement.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                if (userAvatar) userAvatar.textContent = userName.charAt(0).toUpperCase();
                if (dropdownUserName) dropdownUserName.textContent = userName;
                if (dropdownUserEmail) dropdownUserEmail.textContent = userEmail;
                
                // Show admin indicator if admin
                if (userRole === 'admin') {
                    const adminIndicator = document.getElementById('admin-indicator');
                    if (adminIndicator) adminIndicator.classList.remove('hidden');
                }
            }

            // Toggle dropdown
            userMenuButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close other dropdowns
                    document.querySelectorAll(allDropdownsSelector).forEach(dd => dd.classList.add('hidden'));
                    // Toggle the dropdown scoped to this button's container
                    const container = btn.closest('.relative') || btn.parentElement;
                    const dropdown = container ? container.querySelector('#user-dropdown') : null;
                    if (dropdown) dropdown.classList.toggle('hidden');
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const clickedMenuBtn = userMenuButtons.some(btn => btn.contains(e.target));
                const anyDropdownClicked = Array.from(document.querySelectorAll(allDropdownsSelector)).some(dd => dd.contains(e.target));
                if (!clickedMenuBtn && !anyDropdownClicked) {
                    document.querySelectorAll(allDropdownsSelector).forEach(dd => dd.classList.add('hidden'));
                }
            });

            // Ensure handleLogout is defined before binding (definition later in file)
            if (typeof handleLogout !== 'function') {
                window.handleLogout = async function(){ console.warn('Deferred handleLogout call; full implementation loads later.'); };
            }
            logoutBtns.forEach(btn => btn.addEventListener('click', window.handleLogout));

            // Helper to close any open dropdowns
            const closeAllDropdowns = () => {
                document.querySelectorAll(allDropdownsSelector).forEach(dd => dd.classList.add('hidden'));
            };

            // Setup admin section button handlers
            const adminButtons = adminSection?.querySelectorAll('button[class*="text-left"]');
            adminButtons?.forEach(button => {
                if (button.textContent.includes('Manage Users')) {
                    button.addEventListener('click', () => {
                        closeAllDropdowns();
                        showAdminModal();
                    });
                } else if (button.textContent.includes('System Settings')) {
                    button.addEventListener('click', () => {
                        closeAllDropdowns();
                        showSystemSettings();
                    });
                }
            });

            // Setup manager section button handlers
            const managerButtons = managerSection?.querySelectorAll('button[class*="text-left"]');
            managerButtons?.forEach(button => {
                if (button.textContent.includes('View Reports')) {
                    button.addEventListener('click', () => {
                        closeAllDropdowns();
                        showManagerReports();
                    });
                }
            });

            // Setup profile settings button - target the button that contains "Profile Settings" text
            const allButtons = document.querySelectorAll('#dashboard-header #user-dropdown button, #survey-header #user-dropdown button');
            allButtons.forEach(button => {
                if (button.textContent.includes('Profile Settings')) {
                    button.addEventListener('click', () => {
                        closeAllDropdowns();
                        showProfileSettings();
                    });
                }
            });

            // Show/hide role-specific sections
            if (userRole === 'admin') {
                adminSection.classList.remove('hidden');
                managerSection.classList.remove('hidden');
            } else if (userRole === 'manager') {
                managerSection.classList.remove('hidden');
            }
        }

        // Simple getUserRole function for dashboard (fallback if database function not available)
        function getUserRole(email = null) {
            const userEmail = email || window.currentUserEmail || '';
            
            // Check hardcoded admin first
            if (userEmail === 'alex.greene@ita.com') {
                return 'admin';
            }
            
            // Check URL parameters for testing
            const urlParams = new URLSearchParams(window.location.search);
            const testRole = urlParams.get('role');
            if (testRole && ['admin', 'manager', 'user'].includes(testRole)) {
                return testRole;
            }
            
            // Default role
            return 'user';
        }

        // Admin and Manager dropdown functions
        function showAdminModal() {
            const modal = document.getElementById('admin-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                console.log('Opening admin panel');
            } else {
                alert('Admin panel is not available in this interface. Please use the main survey application for full admin features.');
            }
        }

        function setupAgendaUpload() {
            const agendaUpload = document.getElementById('agenda-upload');
            if (!agendaUpload) return;
            // Progress UI ensures consistent experience with photos
            if (!document.getElementById('agenda-progress-wrapper')) {
                const container = document.getElementById('agenda-files')?.parentElement || agendaUpload.parentElement;
                if (container) {
                    const wrap = document.createElement('div');
                    wrap.innerHTML = `<div id="agenda-progress-wrapper" class="mt-4 hidden"><div class=\"w-full bg-gray-200 h-2 rounded-full overflow-hidden\"><div id=\"agenda-progress-bar\" class=\"h-2 bg-teal-600 w-0 transition-all\"></div></div><div id=\"agenda-progress-text\" class=\"text-xs text-gray-500 mt-1\">Preparing...</div></div>`;
                    container.insertBefore(wrap.firstChild, container.querySelector('#agenda-files'));
                }
            }
            const wrap = document.getElementById('agenda-progress-wrapper');
            const bar = document.getElementById('agenda-progress-bar');
            const txt = document.getElementById('agenda-progress-text');

            agendaUpload.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                let completed = 0; const total = files.length;
                if (wrap && bar && txt) { wrap.classList.remove('hidden'); bar.style.width='0%'; txt.textContent = `Uploading 0 / ${total}`; }
                const currentData = await getCurrentSurveyData();
                const agendaFiles = currentData.agendaFiles || [];
                for (const file of files) {
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                        continue;
                    }
                    try {
                        const agendaId = `agenda_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
                        const storageRef = ref(storage, `agendas/${appId}/${agendaId}`);
                        const uploadResult = await uploadBytes(storageRef, file);
                        const downloadURL = await getDownloadURL(uploadResult.ref);
                        const agendaData = { id: agendaId, name: file.name, url: downloadURL, type: file.type, size: file.size, uploadedAt: new Date().toISOString(), uploadedBy: window.currentUserEmail || currentUserName };
                        agendaFiles.push(agendaData);
                        await updateSurveyData({ agendaFiles });
                        logActivity(`Uploaded agenda file: "${file.name}"`);
                        renderAgendaFiles(agendaFiles);
                        completed++; if (bar && txt) { const pct = Math.round((completed/total)*100); bar.style.width = pct+'%'; txt.textContent = `Uploading ${completed} / ${total} (${pct}%)`; }
                    } catch (err) {
                        console.error('Error uploading agenda file:', err);
                        alert(`Failed to upload "${file.name}"`);
                    }
                }
                // Clear input & finalize progress
                agendaUpload.value='';
                if (wrap && txt) { txt.textContent = completed ? 'Upload complete' : 'No valid files'; if (bar) bar.style.width='100%'; setTimeout(()=> wrap.classList.add('hidden'), 1500); }
            });
        }

        function showVenueLookupModal() {
            const modal = document.getElementById('venue-lookup-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Setup modal handlers
            const closeBtn = document.getElementById('close-venue-lookup-modal');
            const searchBtn = document.getElementById('venue-search-btn');
            const searchInput = document.getElementById('venue-search-input');

            const closeModal = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.getElementById('venue-search-input').value = '';
                document.getElementById('venue-search-results').innerHTML = '<p class="text-gray-500 text-center py-8">Enter a venue name to search</p>';
            };

            closeBtn.addEventListener('click', closeModal);
            
            searchBtn.addEventListener('click', performVenueSearch);
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performVenueSearch();
                }
            });
        }

        async function performVenueSearch() {
            const query = document.getElementById('venue-search-input').value.trim();
            const resultsDiv = document.getElementById('venue-search-results');

            if (query.length < 2) {
                resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Please enter at least 2 characters</p>';
                return;
            }

            resultsDiv.innerHTML = '<p class="text-center py-8">Searching venues...</p>';

            try {
                const venues = await searchVenues(query);
                
                if (venues.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No venues found matching your search</p>';
                    return;
                }

                resultsDiv.innerHTML = `
                    <div class="space-y-4">
                        ${venues.map(venue => `
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="openVenueDetails('${venue.venueName}')">
                                <h3 class="text-lg font-semibold text-gray-900">${venue.venueName}</h3>
                                <p class="text-gray-600">${venue.venueAddress || 'Address not available'}</p>
                                <p class="text-sm text-gray-500">
                                    Last updated: ${formatDate(venue.updated_at)} by ${venue.updated_by || 'Unknown'}
                                </p>
                                <div class="mt-2 flex gap-2">
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                        ${venue.rooms?.length || 0} Rooms
                                    </span>
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                        Previous Surveys Available
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Venue search error:', error);
                resultsDiv.innerHTML = '<p class="text-red-500 text-center py-8">Error searching venues</p>';
            }
        }

        function openVenueDetails(venueName) {
            // Close the venue lookup modal
            document.getElementById('venue-lookup-modal').classList.add('hidden');
            document.getElementById('venue-lookup-modal').classList.remove('flex');
            
            // Show venue details - for now, just show a summary
            alert(`Venue Details for: ${venueName}\n\nThis would show detailed venue information, previous surveys, photos, and allow creating a new survey for this venue.`);
        }

        function startSurvey(r2Number, eventName, venueName) {
            // Hide dashboard and show main app
                    const dash = document.getElementById('dashboard-container');
                    if (dash) { dash.classList.add('hidden'); dash.style.display='none'; dash.style.visibility='hidden'; }
            // Keep the global header visible (don't hide dashboard-header)
            const dashHeader = document.getElementById('dashboard-header');
            if (dashHeader) { dashHeader.classList.remove('hidden'); dashHeader.style.display=''; }
            document.getElementById('main-app').classList.remove('hidden');
        // Keep survey-header hidden (using only one header now)
        const surveyHeader = document.getElementById('survey-header');
        if (surveyHeader) surveyHeader.classList.add('hidden');
            const mainContainer = document.querySelector('#survey-container');
            if (mainContainer) {
                mainContainer.style.display = 'block';
                mainContainer.style.visibility = 'visible';
                mainContainer.style.opacity = '1';
                        mainContainer.style.position = 'relative';
                        mainContainer.style.zIndex = '20';
            }
                    // Also hide any lingering welcome/hero sections inside dashboard if still in DOM
                    document.querySelectorAll('#dashboard-container *').forEach(el=>{ if(el.closest && el.closest('#dashboard-container')) { /* already hidden via parent */ }});
                    window.inSurveyMode = true;
            
            // Set the app ID and initialize the survey
            window.appId = r2Number;
            
            // Update URL without refresh
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('id', r2Number);
            window.history.pushState({}, '', newUrl);
            
            // Populate R2 Quote Number field if present
            const r2Field = document.getElementById('r2-quote-number') || document.querySelector('input[name="r2-quote-number"], input[data-field="r2_quote_number"]');
            if (r2Field) {
                r2Field.value = r2Number;
            }

            // Ensure survey row exists (create if not found) then init
            (async () => {
                try {
                    // Try fetch existing by survey_id or r2_quote_number
                    const { data: existing } = await supabase.from('surveys').select('id,survey_id,r2_quote_number').or(`survey_id.eq.${r2Number},r2_quote_number.eq.${r2Number}`).limit(1);
                    if (existing && existing.length) {
                        window.surveyRowUuid = existing[0].id;
                    } else {
                        // Insert new minimal survey row
                        const insertPayload = { survey_id: r2Number, r2_quote_number: r2Number, status: 'Draft', survey_date: new Date().toISOString().slice(0,10) };
                        const { data: inserted, error: insertErr } = await supabase.from('surveys').insert(insertPayload).select('id,survey_id').single();
                        if (!insertErr && inserted) {
                            window.surveyRowUuid = inserted.id;
                        } else if (insertErr) {
                            console.warn('Failed to insert survey row early', insertErr);
                        }
                    }
                } catch(e) { console.warn('startSurvey prefetch/create failed', e); }
                // Initialize the main application after ensuring row
                initializeMainApp(r2Number, eventName, venueName);
            })();
        }

        function showLegacyWelcomeModal(appId) {
            // Legacy path for direct R2 access
            const welcomeModal = document.getElementById('welcome-modal');
            const mainContainer = document.querySelector('#survey-container');

            document.title = `Survey | ${appId}`;
            document.getElementById('dashboard-container').classList.add('hidden');
            // Keep header visible in legacy path as well
            document.getElementById('dashboard-header')?.classList.remove('hidden');
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            if (welcomeModal) welcomeModal.classList.add('flex');

            const loadSurveyBtn = document.getElementById('load-survey-btn');
            const userNameInput = document.getElementById('user-name-input');
            const r2NumberInput = document.getElementById('r2-number-input');

            if (currentUserName && userNameInput) {
                userNameInput.value = currentUserName;
            }

            if (r2NumberInput) {
                r2NumberInput.value = appId;
            }

            if (loadSurveyBtn) {
                loadSurveyBtn.addEventListener('click', async () => {
                    const name = userNameInput ? userNameInput.value.trim() : '';
                    const r2 = r2NumberInput ? r2NumberInput.value.trim() : '';

                    if (name && r2) {
                        localStorage.setItem('siteSurveyUserName', name);
                        window.currentUserName = name;
                        welcomeModal.classList.add('hidden');
                        welcomeModal.classList.remove('flex');
                        initializeMainApp(r2, '', '');
                    } else {
                        alert('Please provide both your name and the event R2#.');
                    }
                });
            }
        }

    function initializeMainApp(r2Number, eventName = '', venueName = '') {
            // Set global app ID
            window.appId = r2Number;
            
            // Ensure currentUserId is set for Supabase operations
            if (window.currentUserEmail && !currentUserId) {
                currentUserId = btoa(window.currentUserEmail).replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
                currentUserName = window.currentUserName;
            }
            
            // Get the main container and make it visible
            const mainContainer = document.querySelector('#survey-container');
            if (mainContainer) {
                mainContainer.style.display = 'block';
            }

            // Ensure survey header is visible in survey mode
            const surveyHeader = document.getElementById('survey-header');
            if (surveyHeader) surveyHeader.classList.remove('hidden');

            // Make sure the main-app div is visible and contains the survey content
            const mainAppDiv = document.getElementById('main-app');
            if (mainAppDiv && mainContainer) {
                // Instead of moving the container, just make both visible
                mainContainer.style.display = 'block';
                mainContainer.style.visibility = 'visible';
                mainContainer.style.opacity = '1';
                mainAppDiv.classList.remove('hidden');
                
                // Make sure the container is visible within the viewport
                mainContainer.style.position = 'relative';
                mainContainer.style.zIndex = '1';
                
                // Apply survey-specific visibility fixes
                if (window.appId) {
                    // Ensure navigation and header are visible; section visibility is controlled by CSS + .active
                    const nav = mainContainer.querySelector('nav');
                    if (nav) {
                        nav.style.display = 'block';
                        nav.style.visibility = 'visible';
                    }
                    const header = mainContainer.querySelector('header');
                    if (header) {
                        header.style.display = 'block';
                        header.style.visibility = 'visible';
                    }
                }
                
                console.log('Made container and main-app visible with survey fixes');
            }

            userDisplay = document.getElementById('user-display');
            saveStatus = document.getElementById('save-status');
            
            // initializeAppAndAuth was removed in refactor; replicate intended behavior inline
            // Expected responsibilities: ensure authentication / dashboard readiness before UI setup.
            // If user already authenticated (currentUserEmail present) show dashboard, else run authentication flow.
            (function initializeAppAndAuth(){
                try {
                    if (window.currentUserEmail && window.currentUserName) {
                        // Authenticated path
                        showDashboard?.();
                    } else {
                        // Fallback to authentication container / welcome modal logic
                        initializeAuthentication?.();
                    }
                } catch(e){ console.warn('initializeAppAndAuth wrapper issue', e); }
            })();
            setupUI();

            // Pre-populate data if provided
            if (eventName || venueName) {
                setTimeout(async () => {
                    const initialData = {};
                    if (eventName) initialData['event-name'] = eventName;
                    if (venueName) initialData['venue-name'] = venueName;
                    if (r2Number) initialData['r2-number'] = r2Number;
                    
                    await updateSurveyData(initialData, false);
                }, 1000);
            }

            // Ensure the survey content is rendered with a small delay to let the DOM settle
            setTimeout(() => {
                console.log('Timeout reached - attempting to render sections');
                console.log('Current appId:', window.appId);
                console.log('fullSurveyData:', fullSurveyData);
                
                if (window.appId) {
                    const data = fullSurveyData || { 'r2-number': window.appId };
                    console.log('About to render sections with data:', data);
                    console.log('Event info section exists:', !!document.getElementById('event-info'));
                    console.log('Client info section exists:', !!document.getElementById('client-info'));
                    
                    // Do not force sections visible; CSS and .active will control visibility
                    
                    try {
                        renderAllSections(data);
                        console.log('renderAllSections completed successfully');
                        
                        // Double check that content was rendered
                        const eventSection = document.getElementById('event-info');
                        if (eventSection) {
                            console.log('Event section content length:', eventSection.innerHTML.length);
                            console.log('Event section has content:', eventSection.innerHTML.length > 100);
                        }
                    } catch (error) {
                        console.error('Error in renderAllSections:', error);
                    }
                    
                    // Visibility is controlled by CSS + active classes; no inline forcing needed
                }
            }, 500);
            // Wire delete / restore buttons (idempotent)
            const deleteBtn = document.getElementById('delete-survey-btn');
            const restoreBtn = document.getElementById('restore-survey-btn');
            const softBanner = document.getElementById('soft-delete-banner');
            function reflectSoftDeleteState(isDeleted) {
                if (!deleteBtn || !softBanner) return;
                if (isDeleted) {
                    softBanner.classList.remove('hidden');
                    deleteBtn.classList.add('hidden');
                } else {
                    softBanner.classList.add('hidden');
                    deleteBtn.classList.remove('hidden');
                }
            }
            // Initial state unknown until fetch; attempt quick probe
            if (window.surveyRowUuid) {
                supabase.from(TABLES.SURVEYS).select('deleted_at').eq('id', window.surveyRowUuid).maybeSingle().then(({ data }) => {
                    reflectSoftDeleteState(!!data?.deleted_at);
                });
            }
            if (deleteBtn && !deleteBtn.dataset.bound) {
                deleteBtn.dataset.bound='1';
                deleteBtn.addEventListener('click', async () => {
                    if (!window.surveyRowUuid) return;
                    if (!confirm('Archive (soft delete) this survey? You can restore later.')) return;
                    deleteBtn.disabled=true; deleteBtn.textContent='Archiving...';
                    try { await deleteSurveySoft(); reflectSoftDeleteState(true); }
                    catch(e){ console.error('Archive failed', e); alert('Failed to archive'); }
                    finally { deleteBtn.disabled=false; deleteBtn.textContent='Archive'; }
                });
            }
            if (restoreBtn && !restoreBtn.dataset.bound) {
                restoreBtn.dataset.bound='1';
                restoreBtn.addEventListener('click', async () => {
                    if (!window.surveyRowUuid) return;
                    restoreBtn.disabled=true; restoreBtn.textContent='Restoring...';
                    try { await restoreSurvey(); reflectSoftDeleteState(false); }
                    catch(e){ console.error('Restore failed', e); alert('Failed to restore'); }
                    finally { restoreBtn.disabled=false; restoreBtn.textContent='Restore'; }
                });
            }
        }

        async function loadRecentActivity() {
            const activityDiv = document.getElementById('recent-activity');
            
            try {
                // Get recent surveys for this user
                const recentSurveys = await getRecentSurveys();
                
                if (!Array.isArray(recentSurveys) || recentSurveys.length === 0) {
                    activityDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No recent activity found</p>';
                    return;
                }

                activityDiv.innerHTML = recentSurveys.map(survey => `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${survey.eventName || 'Unnamed Event'}</h4>
                            <p class="text-sm text-gray-600">R2#: ${survey.surveyId} • ${survey.venueName || 'Venue TBD'}</p>
                            <p class="text-xs text-gray-500">Last updated: ${formatDate(survey.lastUpdated)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(survey.status)}">
                                ${survey.status || 'In Progress'}
                            </span>
                            <button onclick="openSurvey('${survey.surveyId}')" 
                                    class="bg-teal-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700">
                                Open
                            </button>
                            ${(window.currentUserRole === 'admin' || window.currentUserRole === 'manager') ? `
                                <button onclick="viewSurveyHistory('${survey.surveyId}')" 
                                        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                    History
                                </button>
                            ` : ''}
                            ${window.currentUserRole === 'admin' ? `
                                <button onclick="confirmDeleteSurvey('${survey.surveyId}', '${survey.eventName || 'Unknown'}')" 
                                        class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                activityDiv.innerHTML = '<p class="text-red-500 text-center py-8">Error loading recent activity</p>';
            }
        }

        async function getRecentSurveys() {
            // Returns an array of up to 5 most recently updated surveys for the current user (or all if admin)
            if (!supabase) return [];
            try {
                let query = supabase
                    .from('surveys')
                    .select('id,survey_id,event_name,venue_name,status,updated_at,created_at,updated_by,created_by')
                    .order('updated_at', { ascending: false })
                    .limit(5);

                // If role-scoped filtering is required (non-admin/manager see only their own)
                if (!(window.currentUserRole === 'admin' || window.currentUserRole === 'manager') && window.currentUserEmail) {
                    query = query.or(`created_by.eq.${window.currentUserEmail},updated_by.eq.${window.currentUserEmail}`);
                }

                const { data, error } = await query;
                if (error) throw error;
                if (!Array.isArray(data)) return [];
                return data.map(r => ({
                    id: r.id,
                    surveyId: r.survey_id,
                    eventName: r.event_name || 'Unnamed Event',
                    venueName: r.venue_name || 'Venue TBD',
                    status: r.status || 'In Progress',
                    lastUpdated: r.updated_at || r.created_at,
                    updatedBy: r.updated_by,
                    createdBy: r.created_by
                }));
            } catch (e) {
                console.error('getRecentSurveys failed', e);
                return [];
            }
        }

        function initializeOfflineMode() {
            console.log('Running in offline mode - database features disabled');
            // Initialize basic UI without database dependencies
            if (saveStatus) {
                saveStatus.textContent = 'Offline Mode - Changes not saved';
                saveStatus.className = 'text-orange-600';
            }
        }
        
        function initializeSupabaseListeners() {
            // Initialize venue database
            initializeVenueDatabase();
            
            // Initialize survey database
            initializeSurveyDatabase();
            
            // Initialize role system
            initializeRoleSystem();
            
            // Initialize collaborative editing
            initializeCollaborativeEditing();

            // Initialize mobile menu
            initializeMobileMenu();

            // Subscribe to survey data changes
            setupSurveyDataSubscription();
            
            // Subscribe to activity log changes
            setupActivityLogSubscription();
        }

    // Helper: fetch a survey row by survey_id, or fall back to r2_quote_number if needed
    async function fetchSurveyRowByAnyId(id) {
            if (!supabase || !id) return { row: null, usedFallback: false };
            // Try by survey_id first
            let usedFallback = false;
            try {
                const { data: bySurveyId, error: err1 } = await supabase
                    .from('surveys') // <---- defining table for recall (includes event_name)
                    .select('*')
                    .eq('survey_id', id)
                    .single();
                if (bySurveyId && !err1) {
                    // Persist canonical survey UUID for RPCs and child-table operations
                    window.surveyRowUuid = bySurveyId.id;
                    return { row: bySurveyId, usedFallback };
                }
                // If no rows (PGRST116), try fallback by r2_quote_number
                usedFallback = true;
                const { data: byQuoteRows, error: err2 } = await supabase
                    .from('surveys')
                    .select('*')
                    .eq('r2_quote_number', id)
                    .order('updated_at', { ascending: false })
                    .limit(1);
                if (err2) {
                    if (err2.code !== 'PGRST116') console.error('Fallback fetch error:', err2);
                    return { row: null, usedFallback };
                }
                const row = Array.isArray(byQuoteRows) && byQuoteRows.length > 0 ? byQuoteRows[0] : null;
                if (row) window.surveyRowUuid = row.id;
                return { row, usedFallback };
            } catch (e) {
                console.error('fetchSurveyRowByAnyId exception:', e);
                return { row: null, usedFallback };
            }
        }

    async function setupSurveyDataSubscription() {
            // Get initial data for existing surveys (with fallback by r2_quote_number)
            const { row: surveyData, usedFallback } = await fetchSurveyRowByAnyId(window.appId);

            if (!surveyData) {
                // No row found; initialize with only the provided R2 id
                let data = {};
                data['r2-number'] = window.appId;
                // Store current data and update previous values tracker
                fullSurveyData = data;
                if (Object.keys(previousFieldValues).length === 0) {
                    // First load - populate previous values
                    previousFieldValues = { ...data };
                }
                
                renderAllSections(data);
                if (!surveyData) {
                    updateSurveyData({ 'r2-number': window.appId }, false); // Don't auto-save on initialization
                }
                return;
            }

            // If we reached here, we have a row. If we found it by fallback (r2_quote_number), normalize to real survey_id
            if (usedFallback && surveyData?.survey_id && surveyData.survey_id !== window.appId) {
                console.log('[Recall] Fallback matched by r2_quote_number. Normalizing appId to survey_id:', surveyData.survey_id, 'from', window.appId);
                window.appId = surveyData.survey_id;
                // Update URL to use canonical survey_id for realtime sync
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('id', window.appId);
                window.history.replaceState({}, '', newUrl);
            }

            console.log('[Recall] DB event_name:', surveyData.event_name, 'for survey_id:', surveyData.survey_id);
            let data = mapRowToUIData(surveyData);
            console.log('[Recall] Mapped UI event-name:', data['event-name']);

            // Store current data and update previous values tracker
            fullSurveyData = data;
            if (Object.keys(previousFieldValues).length === 0) {
                previousFieldValues = { ...data };
            }
            renderAllSections(data);

            // Set up real-time subscription
            const surveySubscription = supabase
                .channel(`survey-${window.appId}`)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'surveys',
                    filter: `survey_id=eq.${window.appId}`
                }, (payload) => {
                    const row = payload.new;
                    if (row) {
                        console.log('[Recall:Realtime] DB event_name:', row.event_name, 'for survey_id:', row.survey_id);
                    }
                    const data = row ? mapRowToUIData(row) : {};
                    if (data) {
                        console.log('[Recall:Realtime] Mapped UI event-name:', data['event-name']);
                    }
                    fullSurveyData = data;
                    renderAllSections(data);
                })
                .subscribe();
        }

        async function setupActivityLogSubscription() {
            // Temporarily disabled activity log due to database schema issues
            console.log('Activity log subscription disabled - will be re-enabled after database schema update');
            return;
            
            // Get initial activity data
            const { data: activityData, error: activityError } = await supabase
                .from('survey_activity').select('survey_id,created_by::text,updated_by::text,timestamp::text')
                .eq('survey_id', window.appId)
                .order('timestamp', { ascending: false });

            if (activityError) {
                console.error("Error fetching activity log:", activityError);
            } else {
                renderActivityLog(activityData || []);
            }

            // Set up real-time subscription for activity
            const activitySubscription = supabase
                .channel(`activity-${window.appId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'survey_activity',
                    filter: `survey_id=eq.${window.appId}`
                }, async () => {
                    // Refetch activity data when new activity is added
                    const { data: newActivityData } = await supabase
                        .from('survey_activity').select('survey_id,created_by::text,updated_by::text,timestamp::text')
                        .eq('survey_id', window.appId)
                        .order('timestamp', { ascending: false });
                    
                    renderActivityLog(newActivityData || []);
                })
                .subscribe();
        }

        function setupUI() {
            console.log('setupUI called');
            
            // Ensure survey interface is visible if we have an appId
            if (window.appId) {
                const mainContainer = document.querySelector('#survey-container');
                if (mainContainer) {
                    mainContainer.style.display = 'block';
                    mainContainer.style.visibility = 'visible';
                    mainContainer.style.opacity = '1';
                }
                // Ensure navigation is visible and styled
                const nav = document.querySelector('nav');
                if (nav) {
                    nav.style.display = 'block';
                    nav.style.visibility = 'visible';
                }
            }
            
            const headerSubtitle = document.getElementById('header-subtitle');
            if (headerSubtitle) {
                headerSubtitle.textContent = `A Collaborative Checklist for R2# ${window.appId}`;
            }

            const navButtons = document.querySelectorAll('.nav-btn');
            console.log('Found nav buttons:', navButtons.length);
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    console.log('Nav button clicked, target:', targetId);
                    // Sync active state across both desktop and mobile navs
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.target === targetId);
                    });
                    // Toggle only the matching section
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.toggle('active', section.id === targetId);
                    });
                    if(!document.getElementById(targetId)) {
                        console.error('Target section not found:', targetId);
                    }
                    if(currentUserName) {
                        // Update presence with current section
                        updateUserPresence();
                    }
                    // Close mobile menu when item is clicked
                    closeMobileMenu();
                });
            });
            const firstNavBtn = document.querySelector('.nav-btn[data-target="event-info"]');
            if (firstNavBtn) {
                console.log('Clicking first nav button');
                firstNavBtn.click();
                // No inline forcing; CSS will handle showing only the active section
            } else {
                console.error('First nav button not found');
            }
        }

        function initializeMobileMenu() {
            const hamburger = document.getElementById('mobile-menu-btn');
            const mobileNav = document.getElementById('mobile-nav');
            const navOverlay = document.getElementById('nav-overlay');
            
            if (hamburger) {
                hamburger.addEventListener('click', toggleMobileMenu);
            }
            
            if (navOverlay) {
                navOverlay.addEventListener('click', closeMobileMenu);
            }
        }

        function toggleMobileMenu() {
            const hamburger = document.getElementById('mobile-menu-btn');
            const mobileNav = document.getElementById('mobile-nav');
            const navOverlay = document.getElementById('nav-overlay');
            
            hamburger.classList.toggle('active');
            mobileNav.classList.toggle('open');
            navOverlay.classList.toggle('open');
            
            // Prevent body scroll when menu is open
            document.body.style.overflow = mobileNav.classList.contains('open') ? 'hidden' : '';
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('mobile-menu-btn');
            const mobileNav = document.getElementById('mobile-nav');
            const navOverlay = document.getElementById('nav-overlay');
            
            hamburger.classList.remove('active');
            mobileNav.classList.remove('open');
            navOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        function updateUserDisplay() {
            const userRole = getUserRole();
            const roleColors = {
                'admin': 'text-red-600 font-bold',
                'manager': 'text-blue-600 font-semibold',
                'user': 'text-gray-600'
            };
            
            if(userDisplay) {
                userDisplay.innerHTML = `${currentUserName || 'Anonymous'} (${currentUserId}) - <span class="${roleColors[userRole] || 'text-gray-600'}">${userRole.toUpperCase()}</span>`;
            }
        }

        function renderAllSections(data = {}) {
            console.log('renderAllSections called');
            console.log('Key fields:', {
                r2: data['r2-number'],
                event: data['event-name'],
                venue: data['venue-name'],
                client: data['client-business'],
                schedule: {
                    show_start_date: data['event-date'],
                    show_start_time: data['event-start-time'],
                    show_end_time: data['event-end-time']
                }
            });
            
            // Do not force visibility here; CSS + .active class control visibility
            
            renderEventInfoSection(data);
            renderClientInfoSection(data);
            renderVenueInfoSection(data);
            renderLogisticsSection(data);
            renderRoomsSection(data);
            renderVenueGuidelinesSection(data);
            renderWrapUpSection(data);
            renderSummaryExportSection(data);
            setupClientBusinessTypeahead();
            setupPrimaryClientContactSelector();
            
            // Update survey info display
            const surveyInfo = document.getElementById('survey-info');
            if (surveyInfo) {
                const version = data.version || 1;
                const status = data.status || 'In Progress';
                const lastSaved = data.lastSavedToDatabase ? new Date(data.lastSavedToDatabase).toLocaleDateString() : 'Never';
                surveyInfo.textContent = `Version ${version} | ${status} | Last saved: ${lastSaved}`;
            }
        }
        
        let compositeAutosaveBuffer = {}; let compositeAutosaveTimer = null; const COMPOSITE_AUTOSAVE_DELAY = 1200;
        function queueCompositeAutosave(part) {
            compositeAutosaveBuffer = { ...compositeAutosaveBuffer, ...part };
            if (compositeAutosaveTimer) clearTimeout(compositeAutosaveTimer);
            compositeAutosaveTimer = setTimeout(flushCompositeAutosave, COMPOSITE_AUTOSAVE_DELAY);
        }
        async function flushCompositeAutosave() {
            if (!Object.keys(compositeAutosaveBuffer).length) return;
            const patch = buildCompositeFromDelta(compositeAutosaveBuffer);
            compositeAutosaveBuffer = {}; compositeAutosaveTimer = null;
            if (patch) {
                if(saveStatus) saveStatus.textContent = 'Saving...';
                try {
                    await enqueueCompositeSave(patch);
                    if(saveStatus) { saveStatus.textContent = 'All changes saved.'; setTimeout(()=>{ if(saveStatus) saveStatus.textContent=''; },2000); }
                } catch(e){ console.error('flushCompositeAutosave error', e); if(saveStatus) saveStatus.textContent='Error saving.'; }
            }
        }
        function buildCompositeFromDelta(delta) {
            if (!delta) return null;
            const simple = mapPatchToColumns(delta);
            const composite = { simple: Object.keys(simple).length? simple : undefined };
            // pass through recognized child list keys if present in delta
            const listKeys = ['inhouse_av','client-contacts','venue-contacts','inhouse-av-contacts','event-contacts','survey-team-members','rooms','room-access','photos','agenda-files','guidelines','ai-analysis','ai-analysis-timestamp'];
            listKeys.forEach(k=> { if (delta[k] !== undefined) composite[k] = delta[k]; });
            // If only simple is empty and no other keys -> skip
            const nonSimpleKeys = listKeys.filter(k=> composite[k] !== undefined);
            if (!composite.simple && !nonSimpleKeys.length) return null;
            return composite;
        }
        async function updateSurveyData(dataObject, triggerAutoSave = false) {
            if (!currentUserId || !window.appId) return;
            // Merge local model for UI (not writing survey_data blob anymore)
            fullSurveyData = { ...fullSurveyData, ...dataObject };
            // Queue composite autosave (debounced) for significant changes
            if (triggerAutoSave) queueCompositeAutosave(dataObject); else queueCompositeAutosave(dataObject);
        }
        
        function handleFormChange(event) {
            const target = event.target;
            let fieldName = target.name || target.id;
            let newValue = target.type === 'checkbox' ? target.checked : target.value;
            
            // Map survey-status to status
            if (fieldName === 'survey-status') {
                fieldName = 'status';
            }
            
            if (target.type === 'radio') {
                if (!target.checked) return;
            }

            // Get previous value for change tracking
            const previousValue = previousFieldValues[fieldName];
            
            // Only proceed if value actually changed
            if (previousValue === newValue) return;

            clearTimeout(formInputTimeout);
            
            // Show typing indicator for collaborative editing
            showTypingIndicator(fieldName, target);
            
            formInputTimeout = setTimeout(() => {
                // Define which fields should trigger auto-save to database
                const significantFields = [
                    'event-name', 'venue-name', 'client-business', 'status',
                    'event-date', 'event-start-time', 'event-end-time',
                    'attendee-count', 'contact-name', 'contact-email', 'contact-phone',
                    'survey-date', 'survey-team', 'survey-team-members'
                ];
                
                const shouldTriggerAutoSave = significantFields.includes(fieldName) || 
                                            fieldName.startsWith('room-') || 
                                            fieldName.includes('agenda');
                
                const dataObject = { [fieldName]: newValue };
                updateSurveyData(dataObject, shouldTriggerAutoSave);
                
                // Track the change for activity logging
                queueFieldChange(fieldName, previousValue, newValue);
                
                // Update previous value tracker
                previousFieldValues[fieldName] = newValue;
                
                // Hide typing indicator
                hideTypingIndicator(fieldName);
                
                // Auto-save venue data if venue-related fields changed
                if (['venue-name', 'venue-address', 'venue-contact'].includes(fieldName) ||
                    fieldName.startsWith('dock-') || fieldName.startsWith('freight-') ||
                    fieldName.includes('ramp') || fieldName.includes('trailer') || fieldName.includes('cab')) {
                    setTimeout(autoSaveVenueData, 2000);
                }
            }, 500);
        }

        async function showTypingIndicator(fieldName, element) {
            if (!currentUserId) return;
            
            try {
                await supabase
                    .from('user_presence')
                    .upsert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || currentUserName,
                        is_typing: true,
                        typing_field: fieldName,
                        last_active: new Date().toISOString()
                    }, {
                        onConflict: 'survey_id,user_email'
                    });
                
                // Add visual indicator to the field
                element.classList.add('field-being-edited');
            } catch (error) {
                console.error('Error showing typing indicator:', error);
            }
        }

        async function hideTypingIndicator(fieldName) {
            if (!currentUserId) return;
            
            try {
                await supabase
                    .from('user_presence')
                    .upsert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || currentUserName,
                        is_typing: false,
                        typing_field: null,
                        last_active: new Date().toISOString()
                    }, {
                        onConflict: 'survey_id,user_email'
                    });
                
                // Remove visual indicator from all fields with this name
                document.querySelectorAll(`[name="${fieldName}"], #${fieldName}`).forEach(el => {
                    el.classList.remove('field-being-edited');
                });
            } catch (error) {
                console.error('Error hiding typing indicator:', error);
            }
        }

        // Collaborative Editing Features
        let collaborativeUsers = new Map();

        function initializeCollaborativeEditing() {
            // Temporarily disabled collaborative editing due to database schema issues
            console.log('Collaborative editing disabled - will be re-enabled after database schema update');
            return;
            
            if (!supabase || !window.appId || !currentUserId) return;
            
            // Update user presence
            updateUserPresence();
            
            // Set up real-time subscription for user presence
            setupUserPresenceSubscription();
            
            // Clean up presence on page unload
            window.addEventListener('beforeunload', () => {
                cleanupUserPresence();
            });
            
            // Heartbeat to maintain presence
            setInterval(updateUserPresence, 30000); // Every 30 seconds
        }

        // ---- Client Business Typeahead & Primary Contact ----
        function setupClientBusinessTypeahead() {
            const input = document.getElementById('client-business');
            const box = document.getElementById('client-business-suggestions');
            if (!input || !box || !supabase) return;
            if (input.dataset.typeaheadBound) return; input.dataset.typeaheadBound='1';
            let debounce;
            let activeIndex = -1; let currentItems = []; let loading=false;
            const setLoading = (l)=> { loading=l; if (l){ box.innerHTML="<div class='p-2 text-xs text-gray-500'>Loading...</div>"; box.classList.remove('hidden'); } };
            input.addEventListener('input', () => {
                clearTimeout(debounce);
                const term = input.value.trim();
                if (!term) { box.classList.add('hidden'); box.innerHTML=''; return; }
                debounce = setTimeout(async () => {
                    try {
                        setLoading(true);
                        const pattern = `%${term}%`;
                        const [{ data: byName }, { data: byAlias }] = await Promise.all([
                            supabase.from(TABLES.CLIENTS).select('id,business_name,business_address,tax_status').ilike('business_name', pattern).limit(10),
                            supabase.from(TABLES.CLIENT_ALIASES).select('client_id,alias').ilike('alias', pattern).limit(10)
                        ]);
                        const aliasIds = [...new Set((byAlias||[]).map(a=>a.client_id))];
                        let aliasClients = [];
                        if (aliasIds.length) {
                            const { data: ac } = await supabase.from(TABLES.CLIENTS).select('id,business_name,business_address,tax_status').in('id', aliasIds);
                            aliasClients = ac || [];
                        }
                        const merged = {}; (byName||[]).forEach(c=>merged[c.id]=c); aliasClients.forEach(c=>merged[c.id]=c);
                        currentItems = Object.values(merged).slice(0,10);
                        activeIndex = -1;
                        if (!currentItems.length) { box.classList.add('hidden'); box.innerHTML=''; return; }
                        box.innerHTML = currentItems.map((c,i)=>`<div class='px-2 py-1 cursor-pointer hover:bg-blue-50' data-idx='${i}' data-client='${c.id}'><strong>${c.business_name}</strong><br><span class='text-xs text-gray-500'>${c.business_address||''}</span></div>`).join('');
                        box.classList.remove('hidden');
                        box.querySelectorAll('[data-client]').forEach(el=> el.addEventListener('click', async () => { await selectClientByEl(el); }));
                    } catch(e){ console.error('client typeahead failed', e); }
                    finally { setLoading(false); }
                }, 250);
            });
            async function selectClientByEl(el){
                const id = el.getAttribute('data-client');
                const client = currentItems.find(c=>c.id===id); if (!client) return;
                input.value = client.business_name; box.classList.add('hidden');
                await seedClientSelection(client);
                const updated = await fetchSurvey({ survey_id: window.appId });
                if (updated) { fullSurveyData = updated; renderClientInfoSection(updated); setupPrimaryClientContactSelector(); }
            }
            input.addEventListener('keydown', async (e)=>{
                if (box.classList.contains('hidden')) return;
                if (e.key==='ArrowDown'){ e.preventDefault(); activeIndex = (activeIndex+1) % currentItems.length; highlight(); }
                else if (e.key==='ArrowUp'){ e.preventDefault(); activeIndex = (activeIndex-1+currentItems.length) % currentItems.length; highlight(); }
                else if (e.key==='Enter'){ if (activeIndex>=0){ e.preventDefault(); const el = box.querySelector(`[data-idx='${activeIndex}']`); if (el) await selectClientByEl(el);} }
                else if (e.key==='Escape'){ box.classList.add('hidden'); box.innerHTML=''; activeIndex=-1; currentItems=[]; }
            });
            function highlight(){ box.querySelectorAll('[data-idx]').forEach(el=> el.classList.toggle('bg-blue-100', parseInt(el.dataset.idx)===activeIndex)); }
            document.addEventListener('click', (e)=> { if (e.target !== input && !box.contains(e.target)) box.classList.add('hidden'); });
        }

        function setupPrimaryClientContactSelector() {
            const sel = document.getElementById('primary-client-contact');
            if (!sel || sel.dataset.bound) return; sel.dataset.bound='1';
            sel.addEventListener('change', async () => {
                if (!sel.value) return; await setPrimaryClientContact(sel.value);
                const updated = await fetchSurvey({ survey_id: window.appId });
                if (updated) { fullSurveyData = updated; renderClientInfoSection(updated); }
            });
        }

        async function setupUserPresenceSubscription() {
            // Get initial user presence data
            const { data: presenceData, error: presenceError } = await supabase
                .from('user_presence').select('survey_id,user_email::text,last_seen::text')
                .eq('survey_id', window.appId);

            if (presenceError) {
                console.error("Error fetching user presence:", presenceError);
            } else {
                updateActiveUsersDisplay(presenceData || []);
            }

            // Set up real-time subscription for user presence
            const presenceSubscription = supabase
                .channel(`presence-${window.appId}`)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'user_presence',
                    filter: `survey_id=eq.${window.appId}`
                }, async () => {
                    // Refetch presence data when changes occur
                    const { data: newPresenceData } = await supabase
                        .from('user_presence').select('survey_id,user_email::text,last_seen::text')
                        .eq('survey_id', window.appId);
                    
                    updateActiveUsersDisplay(newPresenceData || []);
                })
                .subscribe();
        }

        async function updateUserPresence() {
            if (!currentUserId) return;
            
            try {
                const { error } = await supabase
                    .from('user_presence')
                    .upsert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || currentUserName,
                        user_name: currentUserName || 'Anonymous',
                        last_active: new Date().toISOString(),
                        current_section: getCurrentActiveSection(),
                        is_typing: false,
                        typing_field: null
                    }, {
                        onConflict: 'survey_id,user_email'
                    });

                if (error) throw error;
            } catch (error) {
                console.error('Error updating user presence:', error);
            }
        }

        async function cleanupUserPresence() {
            if (!currentUserId) return;
            
            try {
                await supabase
                    .from('user_presence')
                    .delete()
                    .eq('survey_id', window.appId)
                    .eq('user_email', window.currentUserEmail || currentUserName);
            } catch (error) {
                console.error('Error cleaning up user presence:', error);
            }
        }

        function getCurrentActiveSection() {
            const activeSection = document.querySelector('.content-section.active');
            return activeSection ? activeSection.id : 'general';
        }

        function updateActiveUsersDisplay(presenceData) {
            collaborativeUsers.clear();
            const now = new Date();
            
            presenceData.forEach(userData => {
                const lastActive = new Date(userData.last_active);
                const currentUserIdentifier = window.currentUserEmail || currentUserName;
                
                // Consider user active if they were active in the last 2 minutes
                if (lastActive && (now - lastActive) < 120000 && userData.user_email !== currentUserIdentifier) {
                    collaborativeUsers.set(userData.user_email, {
                        userId: userData.user_email,
                        userName: userData.user_name,
                        userEmail: userData.user_email,
                        lastActive: lastActive,
                        currentSection: userData.current_section,
                        isTyping: userData.is_typing,
                        typingField: userData.typing_field
                    });
                }
            });
            
            renderCollaborativeIndicators();
        }

        function renderCollaborativeIndicators() {
            // Update header with active users count
            updateHeaderWithActiveUsers();
            
            // Add indicators to sections where users are active
            updateSectionIndicators();
        }

        function updateHeaderWithActiveUsers() {
            let indicator = document.getElementById('collaborative-indicator');
            
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'collaborative-indicator';
                indicator.className = 'flex items-center gap-2 text-sm text-gray-600';
                
                const header = document.querySelector('header');
                if (header) {
                    const buttonsDiv = header.querySelector('.mt-4');
                    if (buttonsDiv) {
                        buttonsDiv.appendChild(indicator);
                    }
                }
            }
            
            if (collaborativeUsers.size > 0) {
                const userNames = Array.from(collaborativeUsers.values()).map(user => user.userName);
                indicator.innerHTML = `
                    <span class="flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <span>${collaborativeUsers.size} other user(s) online: ${userNames.join(', ')}</span>
                    </span>
                `;
            } else {
                indicator.innerHTML = '';
            }
        }

        function updateSectionIndicators() {
            // Remove existing indicators
            document.querySelectorAll('.collaborative-user-indicator').forEach(el => el.remove());
            
            // Add indicators for each section where users are active
            collaborativeUsers.forEach(user => {
                if (user.currentSection) {
                    const sectionElement = document.getElementById(user.currentSection);
                    if (sectionElement) {
                        const indicator = document.createElement('div');
                        indicator.className = 'collaborative-user-indicator absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs flex items-center gap-1';
                        indicator.innerHTML = `
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            <span>${user.userName} is here</span>
                        `;
                        
                        // Make sure section has relative positioning
                        sectionElement.style.position = 'relative';
                        sectionElement.appendChild(indicator);
                    }
                }
            });
        }

        function queueFieldChange(fieldName, previousValue, newValue) {
            if (!currentUserId || !currentUserName) return;
            
            const now = new Date();
            const minuteKey = `${currentUserId}_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            if (!pendingChanges[minuteKey]) {
                pendingChanges[minuteKey] = {
                    userId: currentUserId,
                    userName: currentUserName,
                    timestamp: now,
                    changes: [],
                    section: getCurrentActiveSection()
                };
            }
            
            // Format the change description
            const friendlyFieldName = getFriendlyFieldName(fieldName);
            let changeDescription;
            
            if (previousValue === undefined || previousValue === null || previousValue === '') {
                changeDescription = `Added ${friendlyFieldName}: "${newValue}"`;
            } else {
                changeDescription = `Changed ${friendlyFieldName} from "${previousValue}" to "${newValue}"`;
            }
            
            pendingChanges[minuteKey].changes.push(changeDescription);
            
            // Clear existing timeout and set new one
            clearTimeout(changeFlushTimeout);
            changeFlushTimeout = setTimeout(flushPendingChanges, 3000); // Flush after 3 seconds of inactivity
        }

        function getFriendlyFieldName(fieldName) {
            const fieldNameMap = {
                'event-name': 'Event Name',
                'venue-name': 'Venue Name',
                'client-business': 'Client Business',
                'client-name': 'Client Name',
                'client-cell': 'Client Phone',
                'client-email': 'Client Email',
                'r2-quote-number': 'R2 Quote Number',
                'anticipated-attendees': 'Anticipated Attendees',
                'charge-days': 'Charge Days',
                'budget': 'Budget',
                'venue-address': 'Venue Address',
                'venue-contact': 'Venue Contact',
                'status': 'Survey Status',
                'dock-location': 'Dock Location',
                'dock-door-height': 'Dock Door Height',
                'num-dock-spaces': 'Number of Dock Spaces'
            };
            
            return fieldNameMap[fieldName] || fieldName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        async function flushPendingChanges() {
            if (Object.keys(pendingChanges).length === 0) return;
            
            try {
                for (const [minuteKey, batch] of Object.entries(pendingChanges)) {
                    const summary = batch.changes.length === 1 
                        ? batch.changes[0]
                        : `Made ${batch.changes.length} changes: ${batch.changes.join(', ')}`;
                    
                    await supabase
                        .from('survey_activity')
                        .insert({
                            survey_id: window.appId,
                            user_email: window.currentUserEmail || 'anonymous',
                            user_name: batch.userName,
                            description: summary,
                            section: batch.section,
                            timestamp: new Date().toISOString(),
                            change_count: batch.changes.length,
                            changes: batch.changes
                        });
                }
                
                // Clear pending changes
                pendingChanges = {};
                
            } catch (e) {
                console.error("Error flushing activity changes: ", e);
            }
        }

        async function logActivity(description) {
            // For non-field changes (like file uploads, AI processing, etc.)
            if (!currentUserId || !currentUserName) return;
            try {
                await supabase
                    .from('survey_activity')
                    .insert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || 'anonymous',
                        user_name: currentUserName,
                        description: description,
                        section: getCurrentActiveSection(),
                        timestamp: new Date().toISOString(),
                        change_count: 1
                    });
                
                // Update presence with current activity
                await supabase
                    .from('user_presence')
                    .upsert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || currentUserName,
                        last_active: new Date().toISOString()
                    }, {
                        onConflict: 'survey_id,user_email'
                    });
            } catch (e) {
                console.error("Error adding activity log: ", e);
            }
        }

        // Photo handling functions
        async function uploadPhoto(file, section, photoId = null) {
            if (!currentUserId) return null;
            
            try {
                const timestamp = Date.now();
                const fileName = photoId || `${section}_${timestamp}_${file.name}`;
                const filePath = `surveys/${window.appId}/photos/${fileName}`;
                
                const { data, error } = await supabase.storage
                    .from('survey-files')
                    .upload(filePath, file);

                if (error) throw error;

                const { data: { publicUrl } } = supabase.storage
                    .from('survey-files')
                    .getPublicUrl(filePath);
                
                const photoRecord = {
                    id: fileName,
                    survey_id: window.surveyRowUuid || null,
                    section: section,
                    url: publicUrl,
                    filename: file.name,
                    mime_type: file.type || null,
                    size_bytes: file.size || null,
                    uploaded_by: currentUserName,
                    uploaded_at: new Date().toISOString()
                };
                if (window.surveyRowUuid) {
                    const { error: insertErr } = await supabase.from(TABLES.PHOTOS).insert(photoRecord).select('id');
                    if (insertErr) console.error('photo insert error', insertErr);
                }
                return photoRecord;
            } catch (error) {
                console.error("Error uploading photo:", error);
                throw error;
            }
        }

        async function deletePhoto(photoId) {
            if (!currentUserId || !photoId) return;
            try {
                const filePath = `surveys/${window.appId}/photos/${photoId}`;
                const { error: storageErr } = await supabase.storage.from('survey-files').remove([filePath]);
                if (storageErr) console.warn('Storage remove issue (continuing):', storageErr);
                // Hard delete row (or could soft delete if schema has deleted_at trigger)
                const { error: dbErr } = await supabase.from(TABLES.PHOTOS).delete().eq('id', photoId);
                if (dbErr) console.error('DB photo delete error', dbErr);
            } catch (error) {
                console.error("Error deleting photo:", error);
                throw error;
            }
        }

        function createPhotoUploadArea(sectionName, fieldName = null) {
            const fieldId = fieldName ? `${sectionName}-${fieldName}` : sectionName;
            const displayName = fieldName ? fieldName.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) : sectionName.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            return `
                <div class="photo-section mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <h4 class="font-semibold text-gray-700 mb-3">📸 Photos - ${displayName}</h4>
                    
                    <div class="photo-upload-area mb-4" data-section="${fieldId}">
                        <input type="file" id="photo-input-${fieldId}" accept="image/*" capture="environment" multiple class="hidden">
                        <div class="upload-content">
                            <svg class="mx-auto h-12 w-12 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="text-gray-600 mb-2">Drop photos here or click to select</p>
                            <button type="button" class="photo-upload-btn bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700" data-target="photo-input-${fieldId}">
                                📷 Choose Photos / Take Photo
                            </button>
                                                </div>
                                                <div class="mt-3 hidden" id="photo-progress-wrapper-${fieldId}">
                                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div id="photo-progress-bar-${fieldId}" class="h-2 bg-teal-600 w-0 transition-all"></div></div>
                                                    <div id="photo-progress-text-${fieldId}" class="text-xs text-gray-500 mt-1">Preparing upload...</div>
                                                </div>
                    </div>
                    
                    <div id="photo-grid-${fieldId}" class="photo-grid"></div>
                </div>
            `;
        }

        function setupPhotoUploadListeners(container) {
            const uploadAreas = container.querySelectorAll('.photo-upload-area');
            
            uploadAreas.forEach(area => {
                const sectionName = area.dataset.section;
                const input = area.querySelector(`#photo-input-${sectionName}`);
                const uploadBtn = area.querySelector('.photo-upload-btn');
                
                // Upload button click
                uploadBtn?.addEventListener('click', () => {
                    input?.click();
                });
                
                // File input change
                input?.addEventListener('change', (e) => {
                    handlePhotoUpload(e.target.files, sectionName);
                });
                
                // Drag and drop
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });
                
                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });
                
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    handlePhotoUpload(e.dataTransfer.files, sectionName);
                });
            });
        }

        async function handlePhotoUpload(files, sectionName) {
            if (!files || files.length === 0) return;
            // Progress elements
            const wrapper = document.getElementById(`photo-progress-wrapper-${sectionName}`);
            const bar = document.getElementById(`photo-progress-bar-${sectionName}`);
            const txt = document.getElementById(`photo-progress-text-${sectionName}`);
            let completed = 0; const total = files.length;
            if (wrapper && bar && txt) { wrapper.classList.remove('hidden'); bar.style.width='0%'; txt.textContent = `Uploading 0 / ${total}`; }
            
            for (const file of files) {
                // Type validation
                if (!file.type.startsWith('image/')) {
                    alert('Please select only image files.');
                    continue;
                }
                // Size validation (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB.');
                    continue;
                }
                try {
                    const photoData = await uploadPhoto(file, sectionName);
                    completed++;
                    if (bar && txt) {
                        const pct = Math.round((completed / total) * 100);
                        bar.style.width = pct + '%';
                        txt.textContent = `Uploading ${completed} / ${total} (${pct}%)`;
                    }
                    // Update survey data incrementally (keeps UI responsive)
                    const currentData = await getCurrentSurveyData();
                    const photos = currentData.photos || {};
                    if (!photos[sectionName]) photos[sectionName] = [];
                    photos[sectionName].push(photoData);
                    await updateSurveyData({ photos });
                    logActivity(`Uploaded photo "${file.name}" to ${sectionName} section`);
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert('Failed to upload photo. Please try again.');
                }
            }
            // Finalize progress display
            if (wrapper && txt) {
                if (completed === 0) {
                    txt.textContent = 'No valid photos to upload';
                } else {
                    txt.textContent = 'Upload complete';
                }
                if (bar) bar.style.width = '100%';
                setTimeout(() => wrapper.classList.add('hidden'), 1200);
            }
        }

        async function handlePhotoDelete(photoId, sectionName) {
            try {
                await deletePhoto(photoId);
                // Refetch photos from DB to stay authoritative
                if (window.surveyRowUuid) {
                    const { data: rows } = await supabase.from(TABLES.PHOTOS).select('*').eq('survey_id', window.surveyRowUuid).is('deleted_at', null).order('created_at', { ascending: true });
                    const grouped = {};
                    (rows||[]).forEach(p => { const key = p.section || 'uncategorized'; (grouped[key]||(grouped[key]=[])).push(p); });
                    await updateSurveyData({ photos: grouped });
                }
                logActivity(`Deleted photo from ${sectionName} section`);
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete photo. Please try again.');
            }
        }

        function renderPhotos(sectionName, photos = []) {
            const grid = document.getElementById(`photo-grid-${sectionName}`);
            if (!grid) return;
            
            if (photos.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 text-center py-4">No photos uploaded yet.</p>';
                return;
            }
            
            grid.innerHTML = photos.map((photo, idx) => `
                <div class="photo-item relative group" data-section="${sectionName}" data-photo-id="${photo.id}" data-index="${idx}">
                    <img data-src="${photo.url}" alt="${photo.filename||photo.name||'Photo'}" loading="lazy" class="photo-thumb w-full h-32 object-cover rounded border border-gray-200 cursor-zoom-in opacity-0 transition-opacity duration-300" />
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                    <div class="p-2 bg-white">
                        <p class="text-xs text-gray-600 truncate" title="${photo.filename||photo.name}">${photo.filename||photo.name}</p>
                        <p class="text-xs text-gray-400">${photo.uploaded_by||photo.uploadedBy||''}</p>
                    </div>
                    <button class="photo-delete-btn" onclick="event.stopPropagation(); handlePhotoDelete('${photo.id}', '${sectionName}')" title="Delete photo" aria-label="Delete photo">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
            queueLazyLoad();
        }

        // ---- Photo Lazy Loading & Preview Modal ----
        let photoLazyObserver;
        function queueLazyLoad(){
            if (!('IntersectionObserver' in window)) {
                document.querySelectorAll('img[data-src]:not(.loaded)').forEach(img=>{ img.src = img.dataset.src; img.classList.add('loaded','opacity-100'); });
                return;
            }
            if (!photoLazyObserver) {
                photoLazyObserver = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target; img.src = img.dataset.src; img.onload = ()=> img.classList.add('opacity-100'); img.classList.add('loaded'); photoLazyObserver.unobserve(img);
                        }
                    });
                }, { rootMargin: '50px' });
            }
            document.querySelectorAll('img[data-src]:not(.loaded)').forEach(img=> photoLazyObserver.observe(img));
        }

        // Preview modal markup injection (if not already added manually)
        if (!document.getElementById('photo-preview-modal')) {
            const m = document.createElement('div');
            m.innerHTML = `
            <div id="photo-preview-modal" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-black/80 p-4">
              <div class="relative max-w-5xl w-full">
                <button id="photo-preview-close" class="absolute top-2 right-2 bg-black/60 text-white rounded-full w-8 h-8 flex items-center justify-center" aria-label="Close preview">✕</button>
                <div class="bg-white rounded-lg overflow-hidden shadow-lg">
                  <div class="flex items-center justify-between px-4 py-2 bg-gray-900 text-white text-sm">
                    <div id="photo-preview-filename" class="truncate font-medium"></div>
                    <div class="flex gap-2 items-center">
                      <button id="photo-preview-delete" class="px-2 py-1 text-xs bg-red-600 hover:bg-red-700 rounded" title="Delete this photo">Delete</button>
                    </div>
                  </div>
                  <div class="relative bg-black flex items-center justify-center" style="max-height:70vh;">
                    <img id="photo-preview-image" alt="Preview" class="max-h-[70vh] object-contain" />
                    <button id="photo-preview-prev" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white w-10 h-10 rounded-full flex items-center justify-center" aria-label="Previous photo">‹</button>
                    <button id="photo-preview-next" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white w-10 h-10 rounded-full flex items-center justify-center" aria-label="Next photo">›</button>
                  </div>
                  <div class="px-4 py-3 text-xs text-gray-600 space-y-1">
                    <div id="photo-preview-meta"></div>
                  </div>
                </div>
              </div>
            </div>`;
            document.body.appendChild(m.firstChild);
        }

        let previewState = { list: [], index: -1, section: null };
        function openPhotoPreview(section, photoId){
            const grid = document.getElementById(`photo-grid-${section}`); if (!grid) return;
            const items = Array.from(grid.querySelectorAll('.photo-item'));
            const list = items.map(el => ({ id: el.dataset.photoId, url: el.querySelector('img')?.dataset.src || el.querySelector('img')?.src, name: el.querySelector('p')?.getAttribute('title') || '', el }));
            const idx = list.findIndex(p=>p.id===photoId);
            if (idx === -1) return;
            previewState = { list, index: idx, section };
            updatePhotoPreview();
            document.getElementById('photo-preview-modal').classList.remove('hidden');
        }
        function updatePhotoPreview(){
            const modal = document.getElementById('photo-preview-modal'); if (!modal) return;
            const current = previewState.list[previewState.index]; if (!current) { closePhotoPreview(); return; }
            const imgEl = document.getElementById('photo-preview-image');
            imgEl.src = current.url; imgEl.alt = current.name;
            document.getElementById('photo-preview-filename').textContent = current.name || current.id;
            document.getElementById('photo-preview-meta').innerHTML = `<div><strong>ID:</strong> ${current.id}</div>`;
            document.getElementById('photo-preview-delete').onclick = async () => { await handlePhotoDelete(current.id, previewState.section); // refresh list
                // Recompute list after deletion
                const newGrid = document.getElementById(`photo-grid-${previewState.section}`);
                const newItems = Array.from(newGrid.querySelectorAll('.photo-item'));
                previewState.list = newItems.map(el => ({ id: el.dataset.photoId, url: el.querySelector('img')?.dataset.src || el.querySelector('img')?.src, name: el.querySelector('p')?.getAttribute('title') || '', el }));
                if (previewState.index >= previewState.list.length) previewState.index = previewState.list.length -1;
                if (previewState.index < 0) { closePhotoPreview(); } else updatePhotoPreview(); };
        }
        function closePhotoPreview(){ const m=document.getElementById('photo-preview-modal'); if (m) m.classList.add('hidden'); }
        document.addEventListener('click', (e)=>{
            const img = e.target.closest('.photo-item img');
            if (img) { const parent = img.closest('.photo-item'); openPhotoPreview(parent.dataset.section, parent.dataset.photoId); }
            if (e.target.id==='photo-preview-close') closePhotoPreview();
            if (e.target.id==='photo-preview-prev') { if (previewState.index>0){ previewState.index--; updatePhotoPreview(); } }
            if (e.target.id==='photo-preview-next') { if (previewState.index < previewState.list.length-1){ previewState.index++; updatePhotoPreview(); } }
        });
        document.addEventListener('keydown', (e)=>{
            const modalEl = document.getElementById('photo-preview-modal');
            if (!modalEl) return; // element not yet injected
            const modalVisible = !modalEl.classList.contains('hidden');
            if (!modalVisible) return;
            if (e.key==='Escape') closePhotoPreview();
            if (e.key==='ArrowLeft' && previewState.index>0) { previewState.index--; updatePhotoPreview(); }
            if (e.key==='ArrowRight' && previewState.index < previewState.list.length-1) { previewState.index++; updatePhotoPreview(); }
        });
        window.openPhotoPreview = openPhotoPreview;

    async function getCurrentSurveyData() {
            // Return empty data for new surveys that don't exist in database yet
            if (window.appId && window.appId.startsWith('NEW-')) {
                return fullSurveyData || {};
            }

            try {
                const { row: surveyData, usedFallback } = await fetchSurveyRowByAnyId(window.appId);
                if (!surveyData) return {};
                if (usedFallback && surveyData?.survey_id && surveyData.survey_id !== window.appId) {
                    console.log('[getCurrentSurveyData] Normalizing appId to survey_id:', surveyData.survey_id, 'from', window.appId);
                    window.appId = surveyData.survey_id;
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('id', window.appId);
                    window.history.replaceState({}, '', newUrl);
                }
                console.log('[getCurrentSurveyData] DB event_name:', surveyData.event_name, 'for survey_id:', surveyData.survey_id);
                const mapped = mapRowToUIData(surveyData);
                console.log('[getCurrentSurveyData] Mapped UI event-name:', mapped['event-name']);
                return mapped;
            } catch (error) {
                console.error('Error fetching current survey data:', error);
                return {};
            }
        }

        // Role-based Access Control (WordPress Integration)
        let wpUserData = null;
        
        function initializeRoleSystem() {
            // Load WordPress user data if available
            loadWordPressUserData();
        }
        
        function loadWordPressUserData() {
            // Check if WordPress user data is available (set by PHP)
            if (typeof window.wpUser !== 'undefined') {
                wpUserData = window.wpUser;
                console.log('WordPress user data loaded:', wpUserData);
            } else {
                console.log('No WordPress user data found, using fallback system');
            }
        }
        
        async function updateUserRole(userEmail, newRole) {
            if (!checkAccess('manageUsers')) {
                throw new Error('Access denied - admin privileges required');
            }
            
            try {
                // Call WordPress REST API to update user role
                const response = await fetch('/wp-json/wp/v2/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-WP-Nonce': window.wpNonce || '' // WordPress nonce for security
                    },
                    body: JSON.stringify({
                        action: 'update_user_role',
                        email: userEmail,
                        role: mapToWordPressRole(newRole)
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update user role in WordPress');
                }
                
                logActivity(`Updated user role: ${userEmail} is now ${newRole}`);
                return true;
                
            } catch (error) {
                console.error('Error updating user role:', error);
                // Fallback: Log the action for manual processing
                logActivity(`ADMIN ACTION NEEDED: Set ${userEmail} role to ${newRole}`);
                throw error;
            }
        }
        
        function mapToWordPressRole(appRole) {
            // Map our application roles to WordPress roles
            switch(appRole) {
                case 'admin': return 'administrator';
                case 'manager': return 'site_survey_manager'; // Custom role
                case 'user': return 'site_survey_user'; // Custom role
                default: return 'subscriber';
            }
        }
        
        async function getUsersList() {
            if (!checkAccess('manageUsers')) {
                return [];
            }
            
            try {
                // Fetch WordPress users with survey-related roles
                const response = await fetch('/wp-json/wp/v2/users?roles=administrator,site_survey_manager,site_survey_user', {
                    headers: {
                        'X-WP-Nonce': window.wpNonce || ''
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch users from WordPress');
                }
                
                const users = await response.json();
                return users.map(user => ({
                    email: user.email,
                    role: mapFromWordPressRole(user.roles[0]),
                    name: user.name,
                    updatedBy: 'WordPress',
                    updatedAt: user.date_modified || user.date
                })).sort((a, b) => a.email.localeCompare(b.email));
                
            } catch (error) {
                console.error('Error getting users list:', error);
                // Return mock data for development
                return [
                    {
                        email: 'alex.greene@ita.com',
                        role: 'admin',
                        name: 'Alex Greene',
                        updatedBy: 'System',
                        updatedAt: new Date().toISOString()
                    }
                ];
            }
        }
        
        function mapFromWordPressRole(wpRole) {
            // Map WordPress roles back to our application roles
            switch(wpRole) {
                case 'administrator': return 'admin';
                case 'site_survey_manager': return 'manager';
                case 'site_survey_user': return 'user';
                default: return 'user';
            }
        }

        function checkAccess(permission) {
            const userRole = getUserRole();
            
            const permissions = {
                'user': [
                    'createSurvey',
                    'editOwnSurvey',
                    'viewSurvey'
                ],
                'manager': [
                    'createSurvey',
                    'editOwnSurvey',
                    'viewSurvey',
                    'editAnySurvey',
                    'viewHistory',
                    'createVenue',
                    'editOwnVenue',
                    'viewVenueList'
                ],
                'admin': [
                    'createSurvey',
                    'editOwnSurvey',
                    'viewSurvey',
                    'editAnySurvey',
                    'viewHistory',
                    'deleteSurvey',
                    'createVenue',
                    'editOwnVenue',
                    'editAnyVenue',
                    'viewVenueList',
                    'deleteVenue',
                    'manageUsers',
                    'manageRoles'
                ]
            };
            
            return permissions[userRole]?.includes(permission) || false;
        }

        // Survey Management Functions
        
        function initializeSurveyDatabase() {
            // No initialization needed for Supabase - using direct client
        }

    // Safely upsert into Supabase by removing columns not present in the table
    async function supabaseUpsertSafe(tableName, doc, conflictColumn = null, maxAttempts = 5) {
            let payload = { ...doc };
            const removed = new Set();
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                const options = conflictColumn ? { onConflict: conflictColumn } : undefined;
                const { error } = await supabase.from(tableName).upsert(payload, options);
                if (!error) return { ok: true };

                // Handle missing column errors like: Could not find the 'event_date' column of 'surveys' in the schema cache
                if (error.code === 'PGRST204' && typeof error.message === 'string') {
                    const match = error.message.match(/'([^']+)'/); // first quoted token should be the column
                    if (match && match[1] && payload.hasOwnProperty(match[1])) {
                        const missing = match[1];
                        delete payload[missing];
                        removed.add(missing);
                        console.debug(`Removed unknown column from payload: ${missing}`);
                        continue; // retry with the trimmed payload
                    }
                }

                // If it's a different error, stop early
                return { ok: false, error };
            }
            return { ok: false, error: new Error(`Upsert failed after removing: ${[...removed].join(', ')}`) };
        }

        // Update by key or insert if missing; avoids on_conflict requirement
        async function supabaseUpsertByKey(tableName, keyColumn, doc, maxAttempts = 5) {
            const keyValue = doc[keyColumn];
            if (keyValue === undefined) {
                return { ok: false, error: new Error(`Missing key '${keyColumn}' in payload`) };
            }
            let updatePayload = { ...doc };
            let removed = new Set();
            // Try UPDATE first
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                const { data, error } = await supabase
                    .from(tableName)
                    .update(updatePayload)
                    .eq(keyColumn, keyValue)
                    .select();
                if (!error) {
                    if (Array.isArray(data) && data.length > 0) return { ok: true, mode: 'update' };
                    break; // no rows updated, fall through to INSERT
                }
                if (error.code === 'PGRST204' && typeof error.message === 'string') {
                    const match = error.message.match(/'([^']+)'/);
                    if (match && match[1] && updatePayload.hasOwnProperty(match[1])) {
                        const missing = match[1];
                        delete updatePayload[missing];
                        removed.add(missing);
                        console.debug(`Removed unknown column from UPDATE payload: ${missing}`);
                        continue;
                    }
                }
                return { ok: false, error };
            }
            // Try INSERT
            let insertPayload = { ...updatePayload };
            removed = new Set();
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                const { error } = await supabase
                    .from(tableName)
                    .insert(insertPayload);
                if (!error) return { ok: true, mode: 'insert' };
                if (error.code === 'PGRST204' && typeof error.message === 'string') {
                    const match = error.message.match(/'([^']+)'/);
                    if (match && match[1] && insertPayload.hasOwnProperty(match[1])) {
                        const missing = match[1];
                        delete insertPayload[missing];
                        removed.add(missing);
                        console.debug(`Removed unknown column from INSERT payload: ${missing}`);
                        continue;
                    }
                }
                return { ok: false, error };
            }
            return { ok: false, error: new Error('Upsert by key failed after multiple attempts') };
        }

        // Sanitize values to match DB types (avoid sending empty strings to typed columns)
        function toNullIfEmpty(value) {
            return (value === undefined || value === null || value === '') ? null : value;
        }
        function asDateOrNull(value) {
            const v = toNullIfEmpty(value);
            if (!v) return null;
            // Accept YYYY-MM-DD only
            return /^\d{4}-\d{2}-\d{2}$/.test(v) ? v : null;
        }
        function asTimeOrNull(value) {
            const v = toNullIfEmpty(value);
            if (!v) return null;
            // Accept HH:MM or HH:MM:SS
            return /^(\d{2}:\d{2})(:\d{2})?$/.test(v) ? v : null;
        }
        function sanitizeSurveyDoc(doc) {
            const out = { ...doc };
            // Coerce date/time fields
            if ('event_date' in out) out.event_date = asDateOrNull(out.event_date);
            if ('event_start_time' in out) out.event_start_time = asTimeOrNull(out.event_start_time);
            if ('event_end_time' in out) out.event_end_time = asTimeOrNull(out.event_end_time);
            // Actual DB columns per schema
            if ('show_start_date' in out) out.show_start_date = asDateOrNull(out.show_start_date);
            if ('show_start_time' in out) out.show_start_time = asTimeOrNull(out.show_start_time);
            if ('show_end_time' in out) out.show_end_time = asTimeOrNull(out.show_end_time);
            if ('load_in_date' in out) out.load_in_date = asDateOrNull(out.load_in_date);
            if ('load_in_time' in out) out.load_in_time = asTimeOrNull(out.load_in_time);
            if ('setup_date' in out) out.setup_date = asDateOrNull(out.setup_date);
            if ('setup_time' in out) out.setup_time = asTimeOrNull(out.setup_time);
            if ('rehearsal_date' in out) out.rehearsal_date = asDateOrNull(out.rehearsal_date);
            if ('rehearsal_time' in out) out.rehearsal_time = asTimeOrNull(out.rehearsal_time);
            if ('strike_date' in out) out.strike_date = asDateOrNull(out.strike_date);
            if ('strike_time' in out) out.strike_time = asTimeOrNull(out.strike_time);
            if ('survey_date' in out) out.survey_date = asDateOrNull(out.survey_date);
            // Optional numerics: convert NaN to null
            if ('anticipated_attendees' in out && (out.anticipated_attendees === '' || isNaN(out.anticipated_attendees))) out.anticipated_attendees = null;
            if ('charge_days' in out && (out.charge_days === '' || isNaN(out.charge_days))) out.charge_days = null;
            return out;
        }

        // ================= NORMALIZED SCHEMA CONSTANTS =================
        // Added per html_schema_change_guide.md
        const TABLES = Object.freeze({
            SURVEYS: 'surveys',
            CONTACTS: 'survey_contacts',
            INHOUSE_AV: 'inhouse_av',
            TEAM: 'survey_team_members',
            ROOMS: 'rooms',
            ACCESS: 'room_access',
            PHOTOS: 'photos',
            AGENDA: 'agenda_files',
            GUIDELINES: 'guidelines',
            VENUES: 'venues',
            VENUE_CONTACTS: 'venue_contacts', // library
            CLIENTS: 'clients',
            CLIENT_ALIASES: 'client_aliases',
            CLIENT_CONTACTS: 'client_contacts' // library
        });
        const CONTACT_CATEGORIES = Object.freeze(['client','venue','inhouse_av','event_contact']);
        const PHONE_TYPES = Object.freeze(['cell','office','other']);

        // Map UI field names to SURVEYS table column names ONLY (arrays go to child tables)
        const FIELD_TO_COLUMN = {
            'event-name': 'event_name',
            'venue-name': 'venue_name', // venue_id handled separately during selection
            'client-business': 'client_business', // client_id handled separately
            'status': 'status',
            'event-date': 'show_start_date',
            'event-start-time': 'show_start_time',
            'event-end-time': 'show_end_time',
            'show-start-date': 'show_start_date',
            'show-start-time': 'show_start_time',
            'show-end-time': 'show_end_time',
            'load-in-date': 'load_in_date',
            'load-in-time': 'load_in_time',
            'setup-date': 'setup_date',
            'setup-time': 'setup_time',
            'rehearsal-date': 'rehearsal_date',
            'rehearsal-time': 'rehearsal_time',
            'strike-date': 'strike_date',
            'strike-time': 'strike_time',
            'indoor-outdoor': 'indoor_outdoor',
            'anticipated-attendees': 'anticipated_attendees',
            'charge-days': 'charge_days',
            'budget': 'budget',
            'survey-date': 'survey_date',
            'survey-team': 'survey_team',
            'project-manager': 'project_manager',
            'account-rep': 'account_rep',
            'event-contact-name': 'event_contact_name',
            'event-contact-email': 'event_contact_email',
            'event-contact-phone': 'event_contact_phone',
            'event-contact-title': 'event_contact_title',
            'client-name': 'client_name',
            'client-email': 'client_email',
            'client-cell': 'client_cell',
            'client-address': 'client_address',
            // legacy client_company retained read-only; prefer client_business
            'client-title': 'client_title',
            'tax-status': 'tax_status',
            'r2-quote-number': 'r2_quote_number',
            'r2-number': 'r2_quote_number'
        };

        function mapPatchToColumns(patch) {
            const out = {};
            Object.entries(patch || {}).forEach(([key, val]) => {
                const col = FIELD_TO_COLUMN[key];
                if (!col) return; // ignore arrays / complex structures
                if (col === 'anticipated_attendees' || col === 'charge_days') {
                    out[col] = (val === '' || isNaN(val)) ? null : parseInt(val);
                } else if (col === 'budget') {
                    const num = parseFloat(val);
                    out[col] = isNaN(num) ? null : num;
                } else {
                    out[col] = val;
                }
            });
            return sanitizeSurveyDoc(out);
        }

        // ================= NORMALIZED FETCH / HYDRATION =================
        async function fetchSurvey(params) {
            // params: { survey_id?, r2_quote_number? }
            const id = params?.survey_id || params?.r2_quote_number;
            const { row: baseRow } = await fetchSurveyRowByAnyId(id);
            if (!baseRow) return null;
            const surveyUUID = baseRow.id;
            // Parallel child fetches (ignore failures individually)
            const [contactsRes, teamRes, roomsRes, accessRes, photosRes, agendaRes, guidelinesRes, avRes] = await Promise.all([
                supabase.from(TABLES.CONTACTS).select('*').eq('survey_id', surveyUUID).is('deleted_at', null),
                supabase.from(TABLES.TEAM).select('*').eq('survey_id', surveyUUID).is('deleted_at', null).order('position', { ascending: true }),
                supabase.from(TABLES.ROOMS).select('*').eq('survey_id', surveyUUID).is('deleted_at', null).order('position', { ascending: true }),
                supabase.from(TABLES.ACCESS).select('*').eq('survey_id', surveyUUID).is('deleted_at', null).order('access_date', { ascending: true }),
                supabase.from(TABLES.PHOTOS).select('*').eq('survey_id', surveyUUID).is('deleted_at', null).order('created_at', { ascending: true }),
                supabase.from(TABLES.AGENDA).select('*').eq('survey_id', surveyUUID).is('deleted_at', null).order('uploaded_at', { ascending: false }),
                supabase.from(TABLES.GUIDELINES).select('*').eq('survey_id', surveyUUID).maybeSingle(),
                supabase.from(TABLES.INHOUSE_AV).select('*').eq('survey_id', surveyUUID).maybeSingle()
            ]).catch(e => { console.error('Parallel fetch error', e); return []; });

            const children = {
                contacts: (contactsRes?.data || []).map(row => ({ ...row })),
                team: (teamRes?.data || []).map(row => ({ ...row })),
                rooms: (roomsRes?.data || []).map(row => ({ ...row })),
                access: (accessRes?.data || []).map(row => ({ ...row })),
                photos: (photosRes?.data || []).map(row => ({ ...row })),
                agenda: (agendaRes?.data || []).map(row => ({ ...row })),
                guidelines: guidelinesRes?.data || null,
                inhouse_av: avRes?.data || null
            };
            return mapRowToUIData(baseRow, children);
        }

        function mapRowToUIData(row, children = null) { // extended to accept normalized children
            if (!row) return {};
            const data = {};
            // (existing mapping logic retained below)
            // Basic mappings back to UI keys
            if ('event_name' in row) data['event-name'] = row.event_name || '';
            if ('venue_name' in row) data['venue-name'] = row.venue_name || '';
            if ('client_business' in row) data['client-business'] = row.client_business || '';
            if ('status' in row) data['status'] = row.status || '';
            if ('show_start_date' in row) { data['event-date'] = row.show_start_date || ''; data['show-start-date'] = row.show_start_date || ''; }
            if ('show_start_time' in row) { data['event-start-time'] = row.show_start_time || ''; data['show-start-time'] = row.show_start_time || ''; }
            if ('show_end_time' in row) { data['event-end-time'] = row.show_end_time || ''; data['show-end-time'] = row.show_end_time || ''; }
            const schedMap = [['load-in-date','load_in_date'],['load-in-time','load_in_time'],['setup-date','setup_date'],['setup-time','setup_time'],['rehearsal-date','rehearsal_date'],['rehearsal-time','rehearsal_time'],['strike-date','strike_date'],['strike-time','strike_time']];
            schedMap.forEach(([ui, db]) => { if (db in row) data[ui] = row[db] || ''; });
            if ('indoor_outdoor' in row) data['indoor-outdoor'] = row.indoor_outdoor || '';
            if ('anticipated_attendees' in row) data['anticipated-attendees'] = row.anticipated_attendees ?? '';
            if ('charge_days' in row) data['charge-days'] = row.charge_days ?? '';
            if ('budget' in row) data['budget'] = row.budget || '';
            if ('survey_date' in row) data['survey-date'] = row.survey_date || '';
            if ('survey_team' in row) data['survey-team'] = row.survey_team || '';
            if ('project_manager' in row) data['project-manager'] = row.project_manager || '';
            if ('account_rep' in row) data['account-rep'] = row.account_rep || '';
            if ('event_contact_name' in row) data['event-contact-name'] = row.event_contact_name || '';
            if ('event_contact_email' in row) data['event-contact-email'] = row.event_contact_email || '';
            if ('event_contact_phone' in row) data['event-contact-phone'] = row.event_contact_phone || '';
            if ('event_contact_title' in row) data['event-contact-title'] = row.event_contact_title || '';
            if ('client_name' in row) data['client-name'] = row.client_name || '';
            if ('client_email' in row) data['client-email'] = row.client_email || '';
            if ('client_cell' in row) data['client-cell'] = row.client_cell || '';
            if ('client_address' in row) data['client-address'] = row.client_address || '';
            if ('client_company' in row) data['client-company'] = row.client_company || '';
            if ('client_title' in row) data['client-title'] = row.client_title || '';
            if ('tax_status' in row) data['tax-status'] = row.tax_status || '';
            if ('r2_quote_number' in row) data['r2-quote-number'] = row.r2_quote_number || '';
            if ('survey_id' in row) data['r2-number'] = row.survey_id;
            // Normalized children
            if (children) {
                if (children.rooms) data['rooms'] = children.rooms.sort((a,b)=> (a.position??0)-(b.position??0));
                if (children.guidelines) data['guidelines'] = children.guidelines;
                if (children.contacts) {
                    data['client-contacts'] = children.contacts.filter(c=>c.category==='client' && !c.deleted_at);
                    data['venue-contacts'] = children.contacts.filter(c=>c.category==='venue' && !c.deleted_at);
                    data['inhouse-av-contacts'] = children.contacts.filter(c=>c.category==='inhouse_av' && !c.deleted_at);
                    data['event-contacts'] = children.contacts.filter(c=>c.category==='event_contact' && !c.deleted_at);
                }
                if (children.team) data['survey-team-members'] = children.team;
                if (children.access) data['room-access'] = children.access.sort((a,b)=> (a.position??0)-(b.position??0));
                if (children.photos) {
                    // Group normalized flat photos array by section for legacy UI structure
                    const grouped = {};
                    children.photos.forEach(p => {
                        const key = p.section || 'uncategorized';
                        (grouped[key] || (grouped[key] = [])).push(p);
                    });
                    data['photos'] = grouped;
                }
                if (children.agenda) data['agenda-files'] = children.agenda;
                if (children.inhouse_av) data['inhouse-av'] = children.inhouse_av;
            }
            // Legacy fallback merge (if any) remains for old rows
            if ('survey_data' in row && row.survey_data && typeof row.survey_data === 'object') {
                const legacy = row.survey_data || {};
                Object.assign(data, { ...legacy, ...data });
            }
            return data;
        }

        // ================= UPSERT HELPERS =================
        async function saveSurveyBase(simplePatch) {
            if (!window.surveyRowUuid) return;
            const cols = mapPatchToColumns(simplePatch);
            if (Object.keys(cols).length === 0) return;
            const { error } = await supabase.from(TABLES.SURVEYS).update(cols).eq('id', window.surveyRowUuid).select('id').maybeSingle();
            if (error) console.error('saveSurveyBase error', error);
        }

        function ensureId(item) { return item.id || crypto.randomUUID(); }
        function normalizePositions(list) { return (list||[]).map((x,i)=> ({ ...x, id: ensureId(x), position: i })); }

        async function upsertInHouseAV(obj) {
            if (!window.surveyRowUuid) return;
            const payload = { survey_id: window.surveyRowUuid, enabled: !!obj.enabled, company_name: obj.company_name || null };
            const { error } = await supabase.from(TABLES.INHOUSE_AV).upsert(payload, { onConflict: 'survey_id' }).select('survey_id').maybeSingle();
            if (error) console.error('upsertInHouseAV error', error);
        }

        async function upsertContacts(list, category) {
            if (!window.surveyRowUuid) return;
            const normalized = normalizePositions(list).map(c => ({
                id: c.id,
                survey_id: window.surveyRowUuid,
                category,
                name: c.name || null,
                title: c.title || null,
                email: c.email || null,
                phone: c.phone || null,
                phone_type: PHONE_TYPES.includes(c.phone_type) ? c.phone_type : 'cell',
                excluded: !!c.excluded,
                note: c.note || null,
                position: c.position
            }));
            if (normalized.length === 0) return; // policy: exclusion handled at row level
            const { error } = await supabase.from(TABLES.CONTACTS).upsert(normalized, { onConflict: 'id' }).select('id');
            if (error) console.error('upsertContacts error', error);
        }

        async function upsertTeam(list) {
            if (!window.surveyRowUuid) return;
            const normalized = normalizePositions(list).map(m => ({ id: m.id, survey_id: window.surveyRowUuid, name: m.name || 'Member', role: m.role || null, position: m.position }));
            const { data: existing } = await supabase.from(TABLES.TEAM).select('id').eq('survey_id', window.surveyRowUuid).is('deleted_at', null);
            const existingIds = new Set((existing||[]).map(r=>r.id));
            const keepIds = new Set(normalized.map(r=>r.id));
            const toDelete = [...existingIds].filter(id=> !keepIds.has(id));
            if (toDelete.length) await supabase.from(TABLES.TEAM).delete().in('id', toDelete);
            if (normalized.length) {
                const { error } = await supabase.from(TABLES.TEAM).upsert(normalized, { onConflict: 'id' }).select('id');
                if (error) console.error('upsertTeam error', error);
            }
        }

        async function upsertRooms(list) {
            if (!window.surveyRowUuid) return;
            const normalized = normalizePositions(list).map(r => ({ ...r, id: r.id, survey_id: window.surveyRowUuid }));
            const { data: existing } = await supabase.from(TABLES.ROOMS).select('id').eq('survey_id', window.surveyRowUuid).is('deleted_at', null);
            const existingIds = new Set((existing||[]).map(r=>r.id));
            const keepIds = new Set(normalized.map(r=>r.id));
            const toDelete = [...existingIds].filter(id=> !keepIds.has(id));
            if (toDelete.length) await supabase.from(TABLES.ROOMS).delete().in('id', toDelete);
            if (normalized.length) {
                const { error } = await supabase.from(TABLES.ROOMS).upsert(normalized, { onConflict: 'id' }).select('id');
                if (error) console.error('upsertRooms error', error);
            }
        }

        async function upsertRoomAccess(list) {
            if (!window.surveyRowUuid) return;
            const normalized = normalizePositions(list).map(a => ({ ...a, id: a.id, survey_id: window.surveyRowUuid }));
            const { data: existing } = await supabase.from(TABLES.ACCESS).select('id').eq('survey_id', window.surveyRowUuid).is('deleted_at', null);
            const existingIds = new Set((existing||[]).map(r=>r.id));
            const keepIds = new Set(normalized.map(r=>r.id));
            const toDelete = [...existingIds].filter(id=> !keepIds.has(id));
            if (toDelete.length) await supabase.from(TABLES.ACCESS).delete().in('id', toDelete);
            if (normalized.length) {
                const { error } = await supabase.from(TABLES.ACCESS).upsert(normalized, { onConflict: 'id' }).select('id');
                if (error) console.error('upsertRoomAccess error', error);
            }
        }

        async function upsertGuidelines(obj) {
            if (!window.surveyRowUuid || !obj) return;
            const payload = { survey_id: window.surveyRowUuid, important_info: obj.important_info||[], due_dates: obj.due_dates||[], raw_text: obj.raw_text||null };
            const { error } = await supabase.from(TABLES.GUIDELINES).upsert(payload, { onConflict: 'survey_id' }).select('survey_id').maybeSingle();
            if (error) console.error('upsertGuidelines error', error);
        }

        async function upsertAgenda(list) {
            if (!window.surveyRowUuid) return;
            const normalized = (list||[]).map(a => ({ ...a, id: a.id || crypto.randomUUID(), survey_id: window.surveyRowUuid }));
            if (!normalized.length) return;
            const { error } = await supabase.from(TABLES.AGENDA).upsert(normalized, { onConflict: 'id' }).select('id');
            if (error) console.error('upsertAgenda error', error);
        }

        async function upsertPhotos(grouped) {
            if (!window.surveyRowUuid || !grouped) return;
            // grouped is an object: sectionName -> photo[]; flatten
            const flat = Object.entries(grouped).flatMap(([section, arr]) => (arr||[]).map(p => ({ ...p, section })));
            const normalized = flat.map(p => ({ ...p, id: p.id || crypto.randomUUID(), survey_id: window.surveyRowUuid }));
            if (!normalized.length) return;
            const { error } = await supabase.from(TABLES.PHOTOS).upsert(normalized, { onConflict: 'id' }).select('id');
            if (error) console.error('upsertPhotos error', error);
        }

        async function saveComposite(patch) {
            if (!window.surveyRowUuid) { console.warn('No survey UUID for saveComposite'); return; }
            // Optimistic snapshot for rollback
            const beforeState = { ...fullSurveyData };
            try {
                if (patch.simple) await saveSurveyBase(patch.simple);
                if (patch.inhouse_av) await upsertInHouseAV(patch.inhouse_av);
                if (patch['client-contacts']) await upsertContacts(patch['client-contacts'], 'client');
                if (patch['venue-contacts']) await upsertContacts(patch['venue-contacts'], 'venue');
                if (patch['inhouse-av-contacts']) await upsertContacts(patch['inhouse-av-contacts'], 'inhouse_av');
                if (patch['event-contacts']) await upsertContacts(patch['event-contacts'], 'event_contact');
                if (patch['survey-team-members']) await upsertTeam(patch['survey-team-members']);
                if (patch['rooms']) await upsertRooms(patch['rooms']);
                if (patch['room-access']) await upsertRoomAccess(patch['room-access']);
                if (patch['photos']) await upsertPhotos(patch['photos']);
                if (patch['agenda-files']) await upsertAgenda(patch['agenda-files']);
                if (patch['guidelines']) await upsertGuidelines(patch['guidelines']);
                // AI analysis currently only stored in composite JSON; ensure future persistence hook here if moved to own table
                if (patch['ai-analysis'] || patch['ai-analysis-timestamp']) {
                    // No separate table yet; already part of composite simple/list payload
                }
            } catch (e) {
                // Rollback UI model (optimistic failure)
                fullSurveyData = beforeState;
                showNotification('Save failed - changes rolled back', 'error');
                throw e;
            }
        }

        // ---- Save queue to avoid concurrent overlapping writes ----
        let saveQueue = Promise.resolve();
        function enqueueCompositeSave(patch){
            saveQueue = saveQueue.then(()=> saveComposite(patch)).catch(()=>{}); // swallow inside chain (already notified)
            return saveQueue;
        }

        // ================= CREATE NEW SURVEY =================
        async function createNewSurvey({ survey_id, r2_quote_number, starter }) {
            const base = { survey_id, r2_quote_number: r2_quote_number || null, survey_date: new Date().toISOString().slice(0,10), survey_team: starter || null, status: 'Draft' };
            const { data, error } = await supabase.from(TABLES.SURVEYS).insert(base).select('id,survey_id').single();
            if (error) { console.error('createNewSurvey error', error); return null; }
            window.surveyRowUuid = data.id; window.appId = data.survey_id; return data;
        }

        // ================= REALTIME SUBSCRIPTIONS =================
        let normalizedChannels = [];
        function unsubscribeSurveyChannels() { normalizedChannels.forEach(ch => supabase.removeChannel(ch)); normalizedChannels = []; }
        function subscribeSurveyChannels() {
            if (!window.surveyRowUuid) return;
            unsubscribeSurveyChannels();
            const tables = [TABLES.SURVEYS, TABLES.INHOUSE_AV, TABLES.CONTACTS, TABLES.TEAM, TABLES.ROOMS, TABLES.ACCESS, TABLES.PHOTOS, TABLES.AGENDA, TABLES.GUIDELINES];
            tables.forEach(tbl => {
                const channel = supabase.channel(`${tbl}-survey-${window.surveyRowUuid}`).on('postgres_changes', { event: '*', schema: 'public', table: tbl, filter: `survey_id=eq.${window.surveyRowUuid}` }, payload => {
                    handleTableEvent(tbl, payload);
                }).subscribe(status => { if (status==='SUBSCRIBED') console.log('Subscribed', tbl); });
                normalizedChannels.push(channel);
            });
        }

        async function handleTableEvent(table, payload) { // minimal incremental refresh
            console.debug('RT event', table, payload.eventType);
            try {
                if (table === TABLES.SURVEYS) {
                    const { row } = await fetchSurveyRowByAnyId(window.appId);
                    if (row) { const merged = mapRowToUIData(row); updateSurveyData(merged, false); }
                    return;
                }
                if (table === TABLES.ROOMS) {
                    const { data, error } = await supabase.from(TABLES.ROOMS).select('*').eq('survey_id', window.surveyRowUuid).is('deleted_at', null).order('position');
                    if (!error) updateSurveyData({ rooms: (data||[]).map(r=> ({ id:r.id, name:r.name, type:r.type, position:r.position, capacity:r.capacity })) }, false);
                    return;
                }
                if (table === TABLES.ACCESS) {
                    const { data, error } = await supabase.from(TABLES.ACCESS).select('*').eq('survey_id', window.surveyRowUuid).is('deleted_at', null).order('position');
                    if (!error) updateSurveyData({ 'room-access': data||[] }, false);
                    return;
                }
                if (table === TABLES.CONTACTS) {
                    const { data, error } = await supabase.from(TABLES.CONTACTS).select('*').eq('survey_id', window.surveyRowUuid).is('deleted_at', null);
                    if (!error) {
                        const client = []; const venue=[]; const av=[]; const event=[];
                        (data||[]).forEach(c=> { (c.category==='client'?client: c.category==='venue'?venue: c.category==='inhouse_av'?av: event).push(c); });
                        updateSurveyData({ 'client-contacts': client, 'venue-contacts': venue, 'inhouse-av-contacts': av, 'event-contacts': event }, false);
                    }
                    return;
                }
                if (table === TABLES.TEAM) {
                    const { data, error } = await supabase.from(TABLES.TEAM).select('*').eq('survey_id', window.surveyRowUuid).is('deleted_at', null).order('position');
                    if (!error) updateSurveyData({ 'survey-team-members': data||[] }, false);
                    return;
                }
                if (table === TABLES.GUIDELINES) {
                    const { data, error } = await supabase.from(TABLES.GUIDELINES).select('*').eq('survey_id', window.surveyRowUuid).maybeSingle();
                    if (!error && data) updateSurveyData({ guidelines: { originalText: data.raw_text, results:{ importantInfo:data.important_info||[], dueDates:data.due_dates||[] }, processedBy:data.processed_by, processedAt:data.processed_at } }, false);
                    return;
                }
                if (table === TABLES.PHOTOS) {
                    // Lightweight update: just refresh counts (full list on demand)
                    const { count } = await supabase.from(TABLES.PHOTOS).select('*', { count:'exact', head:true }).eq('survey_id', window.surveyRowUuid).is('deleted_at', null);
                    updateSurveyData({ photoCount: count }, false);
                    return;
                }
                if (table === TABLES.AGENDA) {
                    const { data, error } = await supabase.from(TABLES.AGENDA).select('*').eq('survey_id', window.surveyRowUuid).is('deleted_at', null).order('uploaded_at', { ascending:false });
                    if (!error) updateSurveyData({ 'agenda-files': data||[] }, false);
                    return;
                }
            } catch(e){ console.error('Incremental RT update failed', e); }
        }

        // ---- Throttled room/access update helpers to reduce rapid consecutive saves ----
        let pendingRoomPersistTimer = null; const THROTTLE_ROOM_MS = 800;
        async function throttledPersistRooms(newRooms){
            if (pendingRoomPersistTimer) clearTimeout(pendingRoomPersistTimer);
            updateSurveyData({ rooms: newRooms }, false); // optimistic UI
            pendingRoomPersistTimer = setTimeout(()=> enqueueCompositeSave(buildCompositeFromDelta({ rooms:newRooms })), THROTTLE_ROOM_MS);
        }
        let pendingAccessPersistTimer = null; const THROTTLE_ACCESS_MS = 800;
        async function throttledPersistAccess(newAccess){
            if (pendingAccessPersistTimer) clearTimeout(pendingAccessPersistTimer);
            updateSurveyData({ 'room-access': newAccess }, false);
            pendingAccessPersistTimer = setTimeout(()=> enqueueCompositeSave(buildCompositeFromDelta({ 'room-access':newAccess })), THROTTLE_ACCESS_MS);
        }

        // ================= SOFT DELETE / RESTORE RPC WRAPPERS =================
        async function deleteSurveySoft() {
            if (!window.surveyRowUuid) return;
            const { error } = await supabase.rpc('soft_delete_survey', { _id: window.surveyRowUuid });
            if (error) console.error('deleteSurveySoft error', error); else console.log('Survey soft-deleted');
        }
        async function restoreSurvey() {
            if (!window.surveyRowUuid) return;
            const { error } = await supabase.rpc('restore_survey', { _id: window.surveyRowUuid });
            if (error) console.error('restoreSurvey error', error); else console.log('Survey restored');
        }

        // ================= CLIENT SEEDING HELPERS =================
        async function seedClientSelection(client) {
            if (!client || !window.surveyRowUuid) return;
            // Update base fields
            await supabase.from(TABLES.SURVEYS).update({ client_id: client.id, client_business: client.business_name, client_address: client.business_address, tax_status: client.tax_status }).eq('id', window.surveyRowUuid);
            // RPC to seed contacts if empty
            await supabase.rpc('seed_survey_from_client', { _survey_id: window.surveyRowUuid, _client_id: client.id });
            await refreshNormalizedChildren();
        }
        async function setPrimaryClientContact(contactId) {
            if (!contactId || !window.surveyRowUuid) return;
            await supabase.rpc('set_survey_primary_client_contact', { _survey_id: window.surveyRowUuid, _client_contact_id: contactId });
            const { row } = await fetchSurveyRowByAnyId(window.appId);
            if (row) updateSurveyData(mapRowToUIData(row), false);
        }

        async function saveSurveyToDatabase(silent = false) {
            if (!supabase || !window.appId) return;
            
            try {
                // Check if this is a new survey that needs a proper R2 number
                if (window.appId.startsWith('NEW-') && !silent) {
                    const r2Number = prompt('Please enter the R2 order number for this survey (e.g., 0912345):');
                    if (!r2Number) {
                        if (!silent) alert('Save cancelled - R2 number is required');
                        return;
                    }
                    
                    // Check if this R2 number already exists
                    const existing = await checkExistingSurvey(r2Number);
                    if (existing && existing.exists) {
                        const proceed = confirm(`A survey with R2 number ${r2Number} already exists. Do you want to update it instead?`);
                        if (!proceed) {
                            if (!silent) alert('Save cancelled');
                            return;
                        }
                    }
                    
                    // Update the survey ID to the proper R2 number
                    window.appId = r2Number;
                    
                    // Update URL
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('id', r2Number);
                    window.history.pushState({}, '', newUrl);
                    
                    // Update the R2 number field in the data
                    fullSurveyData['r2-number'] = r2Number;
                    
                    console.log('Updated survey ID from temporary to:', r2Number);
                }

                const currentData = await getCurrentSurveyData();
                // Split simple vs arrays according to FIELD_TO_COLUMN keys
                const simplePatch = {};
                Object.keys(currentData).forEach(k => { if (FIELD_TO_COLUMN[k]) simplePatch[k] = currentData[k]; });
                const composite = {
                    simple: simplePatch,
                    'client-contacts': currentData['client-contacts'] || [],
                    'venue-contacts': currentData['venue-contacts'] || [],
                    'inhouse-av-contacts': currentData['inhouse-av-contacts'] || [],
                    'event-contacts': currentData['event-contacts'] || [],
                    'survey-team-members': currentData['survey-team-members'] || [],
                    'rooms': currentData['rooms'] || [],
                    'room-access': currentData['room-access'] || [],
                    'photos': currentData['photos'] || [],
                    'agenda-files': currentData['agenda-files'] || [],
                    'guidelines': currentData['guidelines'] || null,
                    inhouse_av: currentData['inhouse-av'] || null
                };
                await saveComposite(composite);
                
                // Console notification for successful manual save
                console.log(`[Survey Save] COMPOSITE success`, {
                    survey_id: window.appId,
                    updated_by: window.currentUserEmail || currentUserName,
                    at: new Date().toISOString()
                });

                if (!silent) {
                    logActivity(`Manually saved survey "${window.appId}" to database`);
                    // Show success notification only for manual saves
                    showNotification('Survey saved to database successfully!', 'success');
                }
                
                // Update local data with metadata (don't trigger auto-save for metadata updates)
                await updateSurveyData({ 
                    version: surveyDoc.version,
                    lastSavedToDatabase: new Date().toISOString()
                }, false);
                
            } catch (error) {
                console.error('Error saving survey to database:', error);
                if (!silent) {
                    showNotification('Failed to save survey to database', 'error');
                }
            }
        }

        async function checkExistingSurvey(r2Number) {
            if (!supabase) {
                console.log('Supabase not available - skipping duplicate check');
                return null;
            }
            
            try {
                // Check if there's already a survey for this R2 (survey_id OR r2_quote_number canonical 7-char code)
                const { data: surveyData, error: surveyError } = await supabase
                    .from('surveys')
                    .select('id,survey_id,r2_quote_number,status,created_by,updated_by,event_name,venue_name')
                    .or(`survey_id.eq.${r2Number},r2_quote_number.eq.${r2Number}`)
                    .limit(1)
                    .maybeSingle();

                if (surveyData) {
                    return {
                        exists: true,
                        data: surveyData
                    };
                }
                // Not found or acceptable no-row state
                return null;
            } catch (error) {
                // Swallow benign not-found errors in live validation
                console.warn('Error checking existing survey (ignored):', error?.message || error);
                return null;
            }
        }

        async function showDuplicateSurveyDialog(existingSurvey) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const surveyData = existingSurvey.data || {};
                const eventName = surveyData.event_name || 'Unknown Event';
                const lastUpdated = surveyData.updated_at;
                const lastUpdatedBy = surveyData.updated_by || 'Unknown';
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-md w-full mx-4 p-6">
                        <div class="mb-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-2">Survey Already Exists</h2>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-yellow-800">
                                    <strong>A survey already exists for this R2 number.</strong>
                                </p>
                            </div>
                            <div class="space-y-2 text-sm text-gray-600">
                                <p><strong>Event:</strong> ${eventName}</p>
                                <p><strong>Venue:</strong> ${surveyData.venue_name || 'TBD'}</p>
                                <p><strong>Status:</strong> ${surveyData.status || 'In Progress'}</p>
                                ${lastUpdated ? `<p><strong>Last Updated:</strong> ${formatDate(lastUpdated)} by ${lastUpdatedBy}</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button id="edit-existing" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Edit Existing Survey
                            </button>
                            <button id="create-new" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                Create New Survey (with timestamp)
                            </button>
                            <button id="cancel-action" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listeners
                modal.querySelector('#edit-existing').addEventListener('click', () => {
                    modal.remove();
                    resolve('edit');
                });
                
                modal.querySelector('#create-new').addEventListener('click', () => {
                    modal.remove();
                    resolve('new');
                });
                
                modal.querySelector('#cancel-action').addEventListener('click', () => {
                    modal.remove();
                    resolve('cancel');
                });
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Slide out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        async function searchSurveys(query = '', statusFilter = 'all') {
            console.log('searchSurveys called with:', { query, statusFilter, supabase: !!supabase });
            
            if (!supabase) {
                console.error('Supabase client not available');
                return [];
            }
            
            try {
                // Query the correct 'surveys' table with all available columns
                let queryBuilder = supabase
                    .from('surveys')
                    .select('id, survey_id, event_name, venue_name, client_business, status, version, created_by, updated_by, created_at, updated_at')
                    .order('updated_at', { ascending: false });

                // Add status filter if not 'all'
                if (statusFilter !== 'all') {
                    queryBuilder = queryBuilder.eq('status', statusFilter);
                }

                console.log('Executing Supabase query...');
                const { data: surveysData, error } = await queryBuilder;

                console.log('Supabase response:', { data: surveysData, error });

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                const surveys = [];
                
                if (surveysData && Array.isArray(surveysData)) {
                    console.log(`Processing ${surveysData.length} survey records`);
                    
                    surveysData.forEach(surveyData => {
                        console.log('Processing survey record:', surveyData);
                        
                        const clientBusiness = surveyData.client_business || 'Client TBD';
                        const finalEventName = surveyData.event_name || 'Unnamed Event';
                        const finalVenueName = surveyData.venue_name || 'Venue TBD';
                        
                        // If no query is provided, include all surveys (for initial load)
                        const matchesQuery = !query || query.length < 1 || 
                            finalEventName?.toLowerCase().includes(query.toLowerCase()) ||
                            finalVenueName?.toLowerCase().includes(query.toLowerCase()) ||
                            clientBusiness?.toLowerCase().includes(query.toLowerCase()) ||
                            surveyData.survey_id?.toLowerCase().includes(query.toLowerCase());
                        
                        if (matchesQuery) {
                            const processedSurvey = {
                                id: surveyData.id,
                                surveyId: surveyData.survey_id,
                                eventName: finalEventName,
                                venueName: finalVenueName,
                                clientBusiness: clientBusiness,
                                lastUpdated: surveyData.updated_at,
                                updatedBy: surveyData.updated_by,
                                status: surveyData.status || 'In Progress',
                                createdAt: surveyData.created_at,
                                createdBy: surveyData.created_by,
                                version: surveyData.version || 1,
                                ...surveyData
                            };
                            console.log('Adding processed survey:', processedSurvey);
                            surveys.push(processedSurvey);
                        }
                    });
                } else {
                    console.log('No surveys data received or data is not an array');
                }
                
                console.log(`Returning ${surveys.length} surveys after filtering`);
                
                return surveys.sort((a, b) => {
                    const aDate = new Date(a.lastUpdated || 0);
                    const bDate = new Date(b.lastUpdated || 0);
                    return bDate - aDate;
                });
            } catch (error) {
                console.error('Error searching surveys:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                return [];
            }
        }

        async function loadSurveyData(surveyId) {
            if (!supabase) return null;
            
            try {
                const { data: surveyData, error } = await supabase
                    .from('surveys')
                    .select('id, survey_id, survey_data, event_name, venue_name, status, version, created_by, updated_by, created_at, updated_at')
                    .eq('survey_id', surveyId)
                    .single();

                if (error) throw error;
                return surveyData;
            } catch (error) {
                console.error('Error loading survey data:', error);
            }
            return null;
        }

        async function deleteSurvey(surveyId) {
            if (!supabase) return false;
            
            // Check admin permissions
            if (!checkAccess('deleteSurvey')) {
                alert('Access denied. Only administrators can delete surveys.');
                return false;
            }
            
            try {
                const { error } = await supabase
                    .from('surveys')
                    .delete()
                    .eq('survey_id', surveyId);

                if (error) throw error;
                logActivity(`Deleted survey "${surveyId}" from database`);
                return true;
            } catch (error) {
                console.error('Error deleting survey:', error);
                return false;
            }
        }

        async function getSurveyHistory(surveyId) {
            if (!db) return [];
            
            // Only managers and admins can view history
            if (!checkAccess('viewHistory')) {
                return [];
            }
            
            try {
                const historyRef = collection(db, `surveyDatabase/${surveyId}/history`);
                const historyQuery = query(historyRef, orderBy("timestamp", "desc"));
                const historySnapshot = await getDocs(historyQuery);
                
                const history = [];
                historySnapshot.forEach(doc => {
                    history.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return history;
            } catch (error) {
                console.error('Error getting survey history:', error);
                return [];
            }
        }

        function showSurveyBrowser() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">Survey Browser</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex gap-4 items-center">
                            <div class="flex-1">
                                <input type="text" id="modal-survey-search" placeholder="Search by event name, venue, client, or R2 number..." 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                            </div>
                            <select id="modal-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">All Status</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Archived">Archived</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <div id="modal-survey-results">
                            <p class="text-gray-500 text-center py-8">Loading surveys...</p>
                        </div>
                    </div>
                    <div class="p-6 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                ${window.currentUserRole === 'admin' || window.currentUserRole === 'manager' ? 'Manager/Admin: Can view history and all surveys' : 'User: Can search and edit surveys'}
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup real-time search functionality
            const searchInput = modal.querySelector('#modal-survey-search');
            const statusFilter = modal.querySelector('#modal-status-filter');
            let searchTimeout;
            
            // Function to perform search with debouncing
            const performSearch = () => {
                console.log('performSearch triggered, input value:', searchInput.value);
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    console.log('Debounced search executing, input value:', searchInput.value);
                    await searchSurveysInBrowser();
                }, 300); // 300ms delay for better performance
            };
            
            // Real-time search as user types
            searchInput.addEventListener('input', (e) => {
                console.log('Input event fired, value:', e.target.value);
                performSearch();
            });
            
            // Search when status filter changes
            statusFilter.addEventListener('change', performSearch);
            
            // Search on enter key
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    searchSurveysInBrowser();
                }
            });
            
            // Load all surveys initially
            console.log('About to call searchSurveysInBrowser for initial load');
            searchSurveysInBrowser().then(() => {
                console.log('Initial searchSurveysInBrowser completed');
            }).catch(error => {
                console.error('Initial searchSurveysInBrowser failed:', error);
                const resultsDiv = document.getElementById('modal-survey-results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500 mb-2">Failed to load surveys</p>
                            <p class="text-sm text-gray-600 mb-4">Error: ${error.message}</p>
                            <button onclick="searchSurveysInBrowser()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Retry
                            </button>
                        </div>
                    `;
                }
            });
            
            searchInput.focus();
        }

        // Store all surveys for client-side filtering
        let allSurveys = [];
        
        async function searchSurveysInBrowser() {
            console.log('=== searchSurveysInBrowser START ===');
            const searchInput = document.getElementById('modal-survey-search');
            const statusFilter = document.getElementById('modal-status-filter');
            const resultsDiv = document.getElementById('modal-survey-results');
            
            console.log('DOM elements found:', {
                searchInput: !!searchInput,
                statusFilter: !!statusFilter,
                resultsDiv: !!resultsDiv
            });
            
            if (!resultsDiv) {
                console.error('Results div not found - this is a critical error');
                return;
            }
            
            // DEBUG: Check if there are multiple elements with same ID
            const allSearchInputs = document.querySelectorAll('#modal-survey-search');
            console.log('Found', allSearchInputs.length, 'elements with ID modal-survey-search');
            
            // Try different ways to get the value
            const query1 = searchInput ? searchInput.value.trim().toLowerCase() : '';
            const query2 = searchInput ? searchInput.getAttribute('value') || '' : '';
            const query3 = allSearchInputs.length > 0 ? allSearchInputs[0].value.trim().toLowerCase() : '';
            
            console.log('Value attempts:', { 
                method1_value: query1, 
                method2_getAttribute: query2,
                method3_querySelector: query3,
                elementValue: searchInput?.value,
                elementOuterHTML: searchInput?.outerHTML
            });
            
            const query = query1 || query3; // Use whichever method works
            const status = statusFilter ? statusFilter.value : 'all';
            
            console.log('Final search parameters:', { query, status });
            
            // If this is the first load (no cached surveys), fetch from database
            if (allSurveys.length === 0) {
                console.log('First load - fetching all surveys from database');
                resultsDiv.innerHTML = '<p class="text-center py-8">Loading surveys...</p>';
                
                try {
                    allSurveys = await searchSurveys('', 'all'); // Get all surveys
                    console.log('Loaded', allSurveys.length, 'surveys from database');
                } catch (error) {
                    console.error('Error loading surveys:', error);
                    resultsDiv.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500 mb-2">Error loading surveys</p>
                            <p class="text-sm text-gray-600 mb-4">Error: ${error.message}</p>
                            <button onclick="searchSurveysInBrowser()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Retry
                            </button>
                        </div>
                    `;
                    return;
                }
            }
            
            // Filter surveys client-side for real-time search
            let filteredSurveys = allSurveys;
            
            // Apply status filter
            if (status !== 'all') {
                filteredSurveys = filteredSurveys.filter(survey => survey.status === status);
            }
            
            // Apply text search filter
            if (query.length > 0) {
                console.log('Applying text search for query:', query);
                filteredSurveys = filteredSurveys.filter(survey => {
                    const searchableText = [
                        survey.eventName || '',
                        survey.venueName || '',
                        survey.clientBusiness || '',
                        survey.surveyId || '',
                        survey.updatedBy || '',
                        survey.createdBy || ''
                    ].join(' ').toLowerCase();
                    
                    const matches = searchableText.includes(query);
                    if (matches) {
                        console.log('Match found for survey:', survey.surveyId, 'searchable text:', searchableText);
                    }
                    
                    return matches;
                });
                console.log('After text filter:', filteredSurveys.length, 'surveys remain');
            }
            
            console.log('Filtered to', filteredSurveys.length, 'surveys');
            
            try {
                if (filteredSurveys.length === 0) {
                    const message = query.length > 0 || status !== 'all'
                        ? 'No surveys found matching your search criteria' 
                        : 'No surveys found in the database. Create your first survey to get started!';
                    resultsDiv.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500 mb-4">${message}</p>
                            ${query.length === 0 && status === 'all' ? `
                                <button onclick="this.closest('.fixed').remove(); document.getElementById('new-survey-btn').click();" 
                                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                    Create First Survey
                                </button>
                            ` : ''}
                        </div>
                    `;
                    return;
                }
                
                console.log('About to generate HTML for', filteredSurveys.length, 'filtered surveys');
                
                const surveyHTML = filteredSurveys.map(survey => {
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900">${survey.eventName || 'Unnamed Event'}</h3>
                                    <p class="text-gray-600">Venue: ${survey.venueName || 'Venue TBD'}</p>
                                    <p class="text-gray-600">Client: ${survey.clientBusiness || 'Client TBD'}</p>
                                    <p class="text-sm text-gray-500">R2#: ${survey.surveyId || 'Unknown'}</p>
                                    <p class="text-sm text-gray-500">
                                        Last updated: ${formatDate(survey.lastUpdated)} by ${survey.updatedBy || 'Unknown'}
                                    </p>
                                    ${survey.createdAt ? `<p class="text-xs text-gray-400">Created: ${formatDate(survey.createdAt)} by ${survey.createdBy || 'Unknown'}</p>` : ''}
                                </div>
                                <div class="flex flex-col gap-2 ml-4">
                                    <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(survey.status)}">
                                        ${survey.status || 'In Progress'}
                                    </span>
                                    <div class="flex gap-2">
                                        <button onclick="openSurvey('${survey.surveyId}'); this.closest('.fixed').remove();" 
                                                class="bg-teal-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700">
                                            Open
                                        </button>
                                        ${(window.currentUserRole === 'admin' || window.currentUserRole === 'manager') ? `
                                            <button onclick="viewSurveyHistory('${survey.surveyId}')" 
                                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                                History
                                            </button>
                                        ` : ''}
                                        ${window.currentUserRole === 'admin' ? `
                                            <button onclick="confirmDeleteSurvey('${survey.surveyId}', '${survey.eventName || 'Unknown'}')" 
                                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                                Delete
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                resultsDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="mb-4 text-sm text-gray-600">
                            ${query.length > 0 || status !== 'all' ? 
                                `Found ${filteredSurveys.length} of ${allSurveys.length} surveys` : 
                                `Found ${filteredSurveys.length} survey${filteredSurveys.length === 1 ? '' : 's'}`
                            }
                        </div>
                        ${surveyHTML}
                    </div>
                `;
                
                console.log('Survey browser HTML updated successfully with filtering');
                
            } catch (htmlError) {
                console.error('Error generating survey HTML:', htmlError);
                resultsDiv.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500 mb-2">Error displaying surveys</p>
                        <p class="text-sm text-gray-600 mb-4">HTML Generation Error: ${htmlError.message}</p>
                        <button onclick="refreshSurveysCache(); searchSurveysInBrowser()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Try Again
                        </button>
                    </div>
                `;
            }
            
            console.log('=== searchSurveysInBrowser END ===');
        }

        // Function to refresh the surveys cache
        function refreshSurveysCache() {
            allSurveys = []; // Clear the cache to force a fresh database fetch
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                date = new Date(timestamp);
            }
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Completed': return 'bg-green-100 text-green-800';
                case 'In Progress': return 'bg-yellow-100 text-yellow-800';
                case 'Archived': return 'bg-gray-100 text-gray-800';
                default: return 'bg-blue-100 text-blue-800';
            }
        }

        function openSurvey(surveyId) {
            // Close the modal first
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();

            // Navigate to the survey without full page reload
            startSurvey(surveyId, '', '');
        }

        async function viewSurveyHistory(surveyId) {
            if (!checkAccess('viewHistory')) {
                alert('Access denied. You do not have permission to view survey history.');
                return;
            }
            
            const history = await getSurveyHistory(surveyId);
            
            const historyModal = document.createElement('div');
            historyModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
            historyModal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold">Survey History - ${surveyId}</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        ${history.length > 0 ? `
                            <div class="space-y-3">
                                ${history.map(entry => `
                                    <div class="border-l-4 border-blue-500 pl-4 py-2">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium">${entry.description}</p>
                                                <p class="text-sm text-gray-600">by ${entry.userName}</p>
                                            </div>
                                            <span class="text-sm text-gray-500">${formatDate(entry.timestamp)}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-gray-500 text-center py-8">No history available for this survey</p>
                        `}
                    </div>
                    <div class="p-6 border-t border-gray-200">
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(historyModal);
        }

        async function confirmDeleteSurvey(surveyId, eventName) {
            if (!checkAccess('deleteSurvey')) {
                alert('Access denied. Only administrators can delete surveys.');
                return;
            }
            
            const confirmed = confirm(`Are you sure you want to permanently delete the survey for "${eventName}" (${surveyId})?\n\nThis action cannot be undone and will delete all associated data including photos and files.`);
            
            if (confirmed) {
                const success = await deleteSurvey(surveyId);
                if (success) {
                    alert('Survey deleted successfully.');
                    // Refresh the cache and search results
                    refreshSurveysCache();
                    window.searchSurveysInBrowser();
                } else {
                    alert('Failed to delete survey.');
                }
            }
        }

        // Auto-save survey to database when significant changes are made
        let autoSaveTimeout;
        let lastAutoSaveData = null;
        
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                try {
                    // Get current data to check if anything actually changed
                    const currentData = await getCurrentSurveyData();
                    const currentDataString = JSON.stringify(currentData);
                    
                    // Only auto-save if data has actually changed since last auto-save
                    if (lastAutoSaveData === currentDataString) {
                        return; // No changes, skip auto-save
                    }
                    
                    await saveSurveyToDatabase(true); // Silent auto-save
                    lastAutoSaveData = currentDataString;
                    
                    if(saveStatus) {
                        saveStatus.innerHTML = '<span class="text-green-600">✓ Auto-saved</span>';
                        setTimeout(() => { if(saveStatus) saveStatus.textContent = ''; }, 2000);
                    }
                } catch (error) {
                    console.error('Auto-save failed:', error);
                    if(saveStatus) {
                        saveStatus.innerHTML = '<span class="text-red-600">⚠ Auto-save failed</span>';
                        setTimeout(() => { if(saveStatus) saveStatus.textContent = ''; }, 3000);
                    }
                }
            }, 10000); // Auto-save 10 seconds after last change (increased from 3)
        }

        // AI Assistant Functions
        async function initializeAI() {
            // Check if AI system is enabled by admin (stored in Firebase)
            await checkAISystemStatus();
            
            // Update UI based on AI availability
            updateAIButtonVisibility();
            
            // If system is enabled, check for stored user preferences
            if (aiSystemEnabled) {
                const userAIEnabled = localStorage.getItem('userAIEnabled') === 'true';
                if (userAIEnabled) {
                    aiAssistanceEnabled = true;
                    updateAIStatus();
                }
            }
        }

        async function checkAISystemStatus() {
            try {
                if (!supabase) {
                    aiSystemEnabled = false;
                    openAIKey = null;
                    return;
                }
                
                // Check if AI system is enabled in the database
                const { data: aiConfig, error } = await supabase
                    .from('system_config').select('setting_name,setting_value')
                    .eq('setting_name', 'ai_settings')
                    .single();
                
                if (aiConfig && !error) {
                    const configData = aiConfig.setting_value || {};
                    aiSystemEnabled = configData.enabled || false;
                    openAIKey = configData.apiKey || null;
                } else {
                    aiSystemEnabled = false;
                    openAIKey = null;
                }
            } catch (error) {
                console.error('Error checking AI system status:', error);
                aiSystemEnabled = false;
            }
        }

        function updateAIButtonVisibility() {
            const aiBtn = document.getElementById('ai-assistant-btn');
            const aiStatus = document.getElementById('ai-status');
            
            if (aiSystemEnabled && aiBtn) {
                aiBtn.classList.remove('hidden');
                if (aiAssistanceEnabled) {
                    aiStatus?.classList.remove('hidden');
                }
            } else {
                aiBtn?.classList.add('hidden');
                aiStatus?.classList.add('hidden');
            }
        }

        function showAISettings() {
            console.log('showAISettings called');
            const modal = document.getElementById('ai-settings-modal');
            const userRole = window.currentUserRole || getUserRole();
            
            console.log('Modal element:', modal);
            console.log('User role:', userRole);
            console.log('Current user role from window:', window.currentUserRole);
            
            if (!modal) {
                console.error('AI settings modal not found');
                return;
            }
            
            // Configure modal based on user role
            if (userRole === 'admin') {
                console.log('Setting up admin AI modal');
                setupAdminAIModal();
            } else {
                console.log('Setting up user AI modal');
                setupUserAIModal();
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            console.log('AI settings modal should now be visible');
        }

        function setupAdminAIModal() {
            console.log('setupAdminAIModal called');
            const title = document.getElementById('ai-modal-title');
            const adminConfig = document.getElementById('admin-ai-config');
            const userFeatures = document.getElementById('user-ai-features');
            const disabledMessage = document.getElementById('ai-disabled-message');
            const statusDisplay = document.getElementById('ai-status-display');
            
            console.log('Modal elements found:', {
                title: !!title,
                adminConfig: !!adminConfig,
                userFeatures: !!userFeatures,
                disabledMessage: !!disabledMessage,
                statusDisplay: !!statusDisplay
            });
            
            if (title) title.textContent = 'AI System Configuration (Admin)';
            adminConfig?.classList.remove('hidden');
            userFeatures?.classList.add('hidden');
            disabledMessage?.classList.add('hidden');
            statusDisplay?.classList.remove('hidden');
            
            // Set current values
            const enableToggle = document.getElementById('enable-ai-system');
            const keySection = document.getElementById('api-key-section');
            const keyInput = document.getElementById('openai-key-input');
            const disableBtn = document.getElementById('disable-ai-system');
            
            if (enableToggle) {
                enableToggle.checked = aiSystemEnabled;
                enableToggle.addEventListener('change', () => {
                    if (enableToggle.checked) {
                        keySection?.classList.remove('hidden');
                    } else {
                        keySection?.classList.add('hidden');
                    }
                });
                
                // Trigger change to set initial state
                enableToggle.dispatchEvent(new Event('change'));
            }
            
            if (keyInput && openAIKey) {
                keyInput.value = openAIKey;
                console.log('Pre-filled API key input with existing key');
            }
            
            if (disableBtn) {
                if (aiSystemEnabled) {
                    disableBtn.classList.remove('hidden');
                }
            }
            
            setupAdminAIListeners();
            updateAIStatus();
        }

        function setupUserAIModal() {
            const title = document.getElementById('ai-modal-title');
            const adminConfig = document.getElementById('admin-ai-config');
            const userFeatures = document.getElementById('user-ai-features');
            const disabledMessage = document.getElementById('ai-disabled-message');
            const statusDisplay = document.getElementById('ai-status-display');
            
            if (title) title.textContent = 'AI Assistant Settings';
            adminConfig?.classList.add('hidden');
            
            if (aiSystemEnabled) {
                userFeatures?.classList.remove('hidden');
                disabledMessage?.classList.add('hidden');
                statusDisplay?.classList.remove('hidden');
                
                // Set current user preferences
                const aiToggle = document.getElementById('ai-assistance-toggle');
                if (aiToggle) {
                    aiToggle.checked = aiAssistanceEnabled;
                }
                
                setupUserAIListeners();
                updateAIStatus();
            } else {
                userFeatures?.classList.add('hidden');
                disabledMessage?.classList.remove('hidden');
                statusDisplay?.classList.add('hidden');
            }
        }

        function setupAdminAIListeners() {
            const saveBtn = document.getElementById('save-api-key');
            const testBtn = document.getElementById('test-api-key');
            const toggleBtn = document.getElementById('toggle-key-visibility');
            const keyInput = document.getElementById('openai-key-input');
            const disableBtn = document.getElementById('disable-ai-system');
            
            // Save and enable AI system
            saveBtn?.addEventListener('click', async () => {
                const key = keyInput?.value.trim();
                const enableToggle = document.getElementById('enable-ai-system');
                
                if (!enableToggle?.checked) {
                    showNotification('Please enable the AI system first', 'error');
                    return;
                }
                
                if (!key || !key.startsWith('sk-')) {
                    showNotification('Please enter a valid OpenAI API key', 'error');
                    return;
                }
                
                try {
                    // Save to Supabase
                    if (supabase) {
                        const { error } = await supabase
                            .from('system_config')
                            .upsert({
                                setting_name: 'ai_settings',
                                setting_value: {
                                    enabled: true,
                                    apiKey: key,
                                    enabledBy: window.currentUserEmail || currentUserName,
                                    enabledAt: new Date().toISOString()
                                }
                            }, {
                                onConflict: 'setting_name'
                            });
                        
                        if (error) throw error;
                    }
                    
                    openAIKey = key;
                    aiSystemEnabled = true;
                    testBtn.disabled = false;
                    
                    showNotification('AI system enabled successfully!', 'success');
                    updateAIButtonVisibility();
                    updateAIStatus();
                    
                    logActivity('Enabled AI system for all users');
                    
                } catch (error) {
                    console.error('Error saving AI config:', error);
                    showNotification('Failed to save AI configuration', 'error');
                }
            });
            
            // Disable AI system
            disableBtn?.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to disable the AI system for all users?')) return;
                
                try {
                    if (supabase) {
                        const { error } = await supabase
                            .from('system_config')
                            .upsert({
                                setting_name: 'ai_settings',
                                setting_value: {
                                    enabled: false,
                                    apiKey: null,
                                    disabledBy: window.currentUserEmail || currentUserName,
                                    disabledAt: new Date().toISOString()
                                }
                            }, {
                                onConflict: 'setting_name'
                            });
                        
                        if (error) throw error;
                    }
                    
                    openAIKey = null;
                    aiSystemEnabled = false;
                    aiAssistanceEnabled = false;
                    
                    showNotification('AI system disabled', 'success');
                    updateAIButtonVisibility();
                    closeAISettings();
                    
                    logActivity('Disabled AI system');
                    
                } catch (error) {
                    console.error('Error disabling AI system:', error);
                    showNotification('Failed to disable AI system', 'error');
                }
            });
            
            // Test API connection
            testBtn?.addEventListener('click', async () => {
                if (openAIKey) {
                    testBtn.disabled = true;
                    testBtn.textContent = 'Testing...';
                    
                    const isValid = await testOpenAIConnection();
                    
                    testBtn.disabled = false;
                    testBtn.textContent = 'Test Connection';
                    
                    if (isValid) {
                        showNotification('API connection successful!', 'success');
                    } else {
                        showNotification('API connection failed. Check your key.', 'error');
                    }
                }
            });
            
            // Toggle key visibility
            toggleBtn?.addEventListener('click', () => {
                if (keyInput) {
                    keyInput.type = keyInput.type === 'password' ? 'text' : 'password';
                    toggleBtn.textContent = keyInput.type === 'password' ? '👁️' : '🙈';
                }
            });
        }

        function setupUserAIListeners() {
            const aiToggle = document.getElementById('ai-assistance-toggle');
            
            // AI assistance toggle for users
            aiToggle?.addEventListener('change', () => {
                aiAssistanceEnabled = aiToggle.checked;
                localStorage.setItem('userAIEnabled', aiToggle.checked.toString());
                
                updateAIStatus();
                if (aiAssistanceEnabled) {
                    startAIAssistance();
                } else {
                    stopAIAssistance();
                }
                
                logActivity(aiAssistanceEnabled ? 'Enabled AI assistance' : 'Disabled AI assistance');
            });
        }

        function closeAISettings() {
            const modal = document.getElementById('ai-settings-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        async function testOpenAIConnection() {
            if (!openAIKey) {
                console.error('No OpenAI API key provided');
                return false;
            }
            
            try {
                console.log('Testing OpenAI API connection...');
                const response = await fetch('https://api.openai.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${openAIKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log('OpenAI API connection successful');
                    return true;
                } else {
                    console.error('OpenAI API error:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('OpenAI connection test failed:', error);
                return false;
            }
        }

        function updateAIStatus() {
            const statusDiv = document.getElementById('ai-status');
            const statusDisplay = document.getElementById('ai-status-display');
            const aiBtn = document.getElementById('ai-assistant-btn');
            const btnText = document.getElementById('ai-btn-text');
            
            if (aiSystemEnabled && openAIKey) {
                statusDiv?.classList.remove('hidden');
                statusDisplay?.classList.remove('hidden');
                
                // Update button text based on user role
                if (btnText) {
                    const userRole = getUserRole();
                    if (userRole === 'admin') {
                        btnText.textContent = 'AI Configuration';
                    } else {
                        btnText.textContent = aiAssistanceEnabled ? 'AI Assistant (On)' : 'AI Assistant (Off)';
                    }
                }
                
                const statusContent = document.getElementById('ai-status-content');
                if (statusContent) {
                    const userRole = getUserRole();
                    if (userRole === 'admin') {
                        statusContent.innerHTML = `
                            <p>✅ AI System: Enabled</p>
                            <p>🔑 API Key: Configured</p>
                            <p>👥 Available to: All Users</p>
                            <p>📋 Agenda Analysis: Available</p>
                        `;
                    } else {
                        statusContent.innerHTML = `
                            <p>✅ AI System: Available</p>
                            <p>🤖 Your AI Assistance: ${aiAssistanceEnabled ? 'Active' : 'Inactive'}</p>
                            <p>📋 Agenda Analysis: Available</p>
                        `;
                    }
                }
            } else {
                statusDiv?.classList.add('hidden');
                if (getUserRole() !== 'admin') {
                    statusDisplay?.classList.add('hidden');
                }
            }
        }

        function startAIAssistance() {
            if (!openAIKey) return;
            
            aiSuggestionsActive = true;
            showAISuggestions();
            
            // Generate initial suggestions based on current data
            generateAISuggestions();
        }

        function stopAIAssistance() {
            aiSuggestionsActive = false;
            hideAISuggestions();
        }

        function showAISuggestions() {
            const panel = document.getElementById('ai-suggestions-panel');
            if (panel) {
                panel.classList.remove('hidden');
            }
        }

        function hideAISuggestions() {
            const panel = document.getElementById('ai-suggestions-panel');
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        async function generateAISuggestions() {
            if (!openAIKey || !aiSuggestionsActive) return;
            
            try {
                const currentData = await getCurrentSurveyData();
                const currentSection = getCurrentActiveSection();
                
                const prompt = createAISuggestionsPrompt(currentData, currentSection);
                const suggestions = await callOpenAI(prompt, 'suggestions');
                
                displayAISuggestions(suggestions);
            } catch (error) {
                console.error('Failed to generate AI suggestions:', error);
            }
        }

        function createAISuggestionsPrompt(data, section) {
            const eventName = data['event-name'] || 'Unknown Event';
            const venueName = data['venue-name'] || 'TBD';
            const attendeeCount = data['attendee-count'] || 'Unknown';
            
            return `You are an expert AV technician and event planner. Based on the following site survey information, provide 3-5 specific, actionable suggestions for the "${section}" section:

Event: ${eventName}
Venue: ${venueName}
Expected Attendees: ${attendeeCount}
Current Section: ${section}

Current Data: ${JSON.stringify(data, null, 2)}

Focus on:
1. AV equipment recommendations
2. Technical considerations for the venue
3. Important questions to ask during the site survey
4. Potential challenges to watch for
5. Setup best practices

Provide concise, practical suggestions that a technician can immediately act upon. Format as a JSON array of objects with "category" and "suggestion" fields.`;
        }

        async function callOpenAI(prompt, type = 'chat') {
            if (!openAIKey) throw new Error('No API key configured');
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openAIKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert AV technician and event planning assistant. Provide practical, actionable advice.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: type === 'agenda' ? 2000 : 1000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status}`);
                }
                
                const result = await response.json();
                return result.choices[0].message.content;
            } catch (error) {
                console.error('OpenAI API call failed:', error);
                throw error;
            }
        }

        function displayAISuggestions(suggestions) {
            const content = document.getElementById('ai-suggestions-content');
            if (!content) return;
            
            try {
                const parsed = JSON.parse(suggestions);
                const html = parsed.map(item => `
                    <div class="mb-3 p-3 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                        <div class="font-medium text-purple-800">${item.category}</div>
                        <div class="text-sm text-purple-700 mt-1">${item.suggestion}</div>
                    </div>
                `).join('');
                
                content.innerHTML = html;
            } catch (error) {
                // Fallback to plain text if JSON parsing fails
                content.innerHTML = `
                    <div class="p-3 bg-purple-50 rounded-lg">
                        <div class="text-sm text-purple-700">${suggestions}</div>
                    </div>
                `;
            }
        }

        // Agenda Analysis Functions
        async function analyzeAgenda(agendaText, fileName = 'uploaded-agenda') {
            if (!openAIKey) {
                showNotification('AI analysis requires OpenAI API key configuration', 'error');
                return null;
            }
            
            try {
                const prompt = createAgendaAnalysisPrompt(agendaText);
                const analysis = await callOpenAI(prompt, 'agenda');
                
                return parseAgendaAnalysis(analysis);
            } catch (error) {
                console.error('Agenda analysis failed:', error);
                showNotification('Failed to analyze agenda. Please try again.', 'error');
                return null;
            }
        }

        function createAgendaAnalysisPrompt(agendaText) {
            return `Analyze this event agenda and extract key information to help set up a site survey. Provide a JSON response with the following structure:

{
  "eventInfo": {
    "name": "extracted event name",
    "description": "brief description",
    "dates": ["YYYY-MM-DD"],
    "estimatedAttendees": number,
    "eventType": "conference/meeting/presentation/etc"
  },
  "venueRequirements": {
    "suggestedVenueName": "if mentioned",
    "locationRequirements": "indoor/outdoor/specific needs"
  },
  "sessions": [
    {
      "name": "session name",
      "startTime": "HH:MM",
      "endTime": "HH:MM",
      "date": "YYYY-MM-DD",
      "description": "session description",
      "estimatedAttendees": number,
      "avRequirements": ["microphones", "projector", "etc"],
      "roomType": "main hall/breakout/etc"
    }
  ],
  "rooms": [
    {
      "name": "suggested room name",
      "purpose": "main presentation/breakout/etc",
      "capacity": estimated_number,
      "avNeeds": ["equipment needed"],
      "layout": "theater/classroom/rounds/etc"
    }
  ],
  "schedule": {
    "earliestStart": "HH:MM",
    "latestEnd": "HH:MM",
    "breaks": ["break times"],
    "meals": ["meal times and types"]
  },
  "technicalRequirements": {
    "avEquipment": ["list of needed equipment"],
    "specialNeeds": ["any special requirements"],
    "internetRequirements": "high/medium/low bandwidth needs",
    "powerRequirements": "special power needs"
  }
}

Agenda to analyze:
${agendaText}

Please be thorough but practical in your analysis. If information is not clear, make reasonable assumptions based on typical event patterns.`;
        }

        function parseAgendaAnalysis(analysisText) {
            try {
                return JSON.parse(analysisText);
            } catch (error) {
                console.error('Failed to parse agenda analysis:', error);
                return null;
            }
        }

        function showAgendaAnalysisResults(analysis) {
            if (!analysis) return;
            
            const modal = document.getElementById('agenda-analysis-modal');
            const content = document.getElementById('agenda-analysis-content');
            
            if (!modal || !content) return;
            
            content.innerHTML = createAgendaAnalysisHTML(analysis);
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Setup apply button
            const applyBtn = document.getElementById('apply-ai-suggestions');
            applyBtn?.addEventListener('click', () => {
                applyAgendaAnalysis(analysis);
                closeAgendaAnalysis();
            });
        }

        function createAgendaAnalysisHTML(analysis) {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Event Information -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-3">📅 Event Information</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Name:</strong> ${analysis.eventInfo?.name || 'Not specified'}</p>
                            <p><strong>Type:</strong> ${analysis.eventInfo?.eventType || 'Not specified'}</p>
                            <p><strong>Estimated Attendees:</strong> ${analysis.eventInfo?.estimatedAttendees || 'Not specified'}</p>
                            <p><strong>Dates:</strong> ${analysis.eventInfo?.dates?.join(', ') || 'Not specified'}</p>
                        </div>
                    </div>
                    
                    <!-- Venue Requirements -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-3">🏢 Venue Requirements</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Suggested Venue:</strong> ${analysis.venueRequirements?.suggestedVenueName || 'Not specified'}</p>
                            <p><strong>Location Type:</strong> ${analysis.venueRequirements?.locationRequirements || 'Not specified'}</p>
                        </div>
                    </div>
                    
                    <!-- Rooms -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-800 mb-3">🚪 Suggested Rooms</h3>
                        <div class="space-y-3">
                            ${analysis.rooms?.map(room => `
                                <div class="bg-white p-3 rounded border">
                                    <p class="font-medium">${room.name}</p>
                                    <p class="text-xs text-gray-600">Capacity: ${room.capacity} | Layout: ${room.layout}</p>
                                    <p class="text-xs text-gray-600">AV: ${room.avNeeds?.join(', ') || 'None specified'}</p>
                                </div>
                            `).join('') || '<p class="text-sm text-gray-600">No rooms identified</p>'}
                        </div>
                    </div>
                    
                    <!-- Schedule -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-yellow-800 mb-3">⏰ Schedule Overview</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Start:</strong> ${analysis.schedule?.earliestStart || 'Not specified'}</p>
                            <p><strong>End:</strong> ${analysis.schedule?.latestEnd || 'Not specified'}</p>
                            <p><strong>Breaks:</strong> ${analysis.schedule?.breaks?.join(', ') || 'Not specified'}</p>
                            <p><strong>Meals:</strong> ${analysis.schedule?.meals?.join(', ') || 'Not specified'}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sessions -->
                <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">📋 Sessions</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        ${analysis.sessions?.map(session => `
                            <div class="bg-white p-3 rounded border">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <p class="font-medium">${session.name}</p>
                                        <p class="text-sm text-gray-600">${session.description}</p>
                                        <p class="text-xs text-gray-500">
                                            ${session.date} | ${session.startTime} - ${session.endTime} | 
                                            ${session.estimatedAttendees} attendees
                                        </p>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        AV: ${session.avRequirements?.join(', ') || 'None'}
                                    </div>
                                </div>
                            </div>
                        `).join('') || '<p class="text-sm text-gray-600">No sessions identified</p>'}
                    </div>
                </div>
                
                <!-- Technical Requirements -->
                <div class="mt-6 bg-red-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-red-800 mb-3">⚡ Technical Requirements</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="font-medium">AV Equipment:</p>
                            <ul class="list-disc list-inside text-xs text-gray-600">
                                ${analysis.technicalRequirements?.avEquipment?.map(item => `<li>${item}</li>`).join('') || '<li>Not specified</li>'}
                            </ul>
                        </div>
                        <div>
                            <p class="font-medium">Special Requirements:</p>
                            <ul class="list-disc list-inside text-xs text-gray-600">
                                ${analysis.technicalRequirements?.specialNeeds?.map(item => `<li>${item}</li>`).join('') || '<li>None specified</li>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeAgendaAnalysis() {
            const modal = document.getElementById('agenda-analysis-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        async function applyAgendaAnalysis(analysis) {
            if (!analysis) return;
            
            try {
                const updates = {};
                
                // Apply event information
                if (analysis.eventInfo) {
                    if (analysis.eventInfo.name) updates['event-name'] = analysis.eventInfo.name;
                    if (analysis.eventInfo.estimatedAttendees) updates['attendee-count'] = analysis.eventInfo.estimatedAttendees;
                    if (analysis.eventInfo.dates && analysis.eventInfo.dates[0]) updates['event-date'] = analysis.eventInfo.dates[0];
                }
                
                // Apply venue information
                if (analysis.venueRequirements?.suggestedVenueName) {
                    updates['venue-name'] = analysis.venueRequirements.suggestedVenueName;
                }
                
                // Apply schedule information
                if (analysis.schedule) {
                    if (analysis.schedule.earliestStart) updates['event-start-time'] = analysis.schedule.earliestStart;
                    if (analysis.schedule.latestEnd) updates['event-end-time'] = analysis.schedule.latestEnd;
                }
                
                // Apply room data
                if (analysis.rooms && analysis.rooms.length > 0) {
                    analysis.rooms.forEach((room, index) => {
                        const roomPrefix = `room-${index + 1}`;
                        updates[`${roomPrefix}-name`] = room.name;
                        updates[`${roomPrefix}-capacity`] = room.capacity;
                        updates[`${roomPrefix}-layout`] = room.layout;
                        updates[`${roomPrefix}-av-needs`] = room.avNeeds?.join(', ') || '';
                        updates[`${roomPrefix}-purpose`] = room.purpose;
                    });
                }
                
                // Store the full analysis for reference
                updates['ai-analysis'] = analysis;
                updates['ai-analysis-timestamp'] = new Date().toISOString();
                
                // Apply all updates
                await updateSurveyData(updates, true);
                
                logActivity(`Applied AI agenda analysis suggestions`);
                showNotification('AI suggestions applied successfully!', 'success');
                
                // Re-render sections to show updated data
                const currentData = await getCurrentSurveyData();
                renderAllSections(currentData);
                
            } catch (error) {
                console.error('Failed to apply agenda analysis:', error);
                showNotification('Failed to apply suggestions. Please try again.', 'error');
            }
        }

        // --- Dashboard: New Survey Modal ---
        function showNewSurveyModal() {
            const modal = document.getElementById('new-survey-modal');
            if (!modal) { console.warn('new-survey-modal element not found'); return; }
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Defensive: ensure modal elements exist before manipulating
            // (Prevents TypeError reading classList on null during rapid typing/open)
            const ensure = id => document.getElementById(id);

            const closeBtn = document.getElementById('close-new-survey-modal');
            const cancelBtn = document.getElementById('cancel-new-survey-btn');
            const createBtn = document.getElementById('create-survey-btn');
            const nameInput = document.getElementById('new-survey-name');
            const r2Input = document.getElementById('new-survey-r2');
            const venueInput = document.getElementById('new-survey-venue');
            // New simplified R2 only flow elements (top portion of modal)
            const startR2Input = document.getElementById('start-r2-input');
            const startGoBtn = document.getElementById('start-r2-go-btn');
            const startDupMsg = document.getElementById('start-r2-duplicate-msg');
            const startWithoutBtn = document.getElementById('start-without-r2-btn');
            // Ensure status message + button state elements exist (idempotent)
            let statusMsg = modal.querySelector('#r2-duplicate-status');
            if (!statusMsg) {
                statusMsg = document.createElement('div');
                statusMsg.id = 'r2-duplicate-status';
                statusMsg.className = 'mt-2 text-sm';
                r2Input?.parentElement?.appendChild(statusMsg);
            }

            const goBtn = createBtn; // alias semantic

            const VALID_R2_REGEX = /^(?=.*\d)[A-Za-z0-9]{7}$/; // 7 chars, must include at least one digit, alnum only
            let lastCheckedValue = '';
            let duplicateFound = false;
            let pendingCheck = null;

            function updateGoButtonState() {
                if (!goBtn) return;
                const val = (r2Input?.value||'').trim();
                const validFormat = VALID_R2_REGEX.test(val);
                if (!validFormat) {
                    goBtn.disabled = true;
                    goBtn.classList.add('opacity-50','cursor-not-allowed');
                } else if (duplicateFound) {
                    goBtn.disabled = true;
                    goBtn.classList.add('opacity-50','cursor-not-allowed');
                } else {
                    goBtn.disabled = false;
                    goBtn.classList.remove('opacity-50','cursor-not-allowed');
                }
            }

            async function performDuplicateCheck(currentVal) {
                duplicateFound = false;
                statusMsg.textContent = '';
                statusMsg.className = 'mt-2 text-sm';
                if (!VALID_R2_REGEX.test(currentVal)) { updateGoButtonState(); return; }
                try {
                    const existing = await checkExistingSurvey(currentVal);
                    if (existing) {
                        duplicateFound = true;
                        statusMsg.textContent = 'A survey exists - proceed to edit existing';
                        statusMsg.classList.add('text-red-600','font-medium');
                    } else {
                        statusMsg.textContent = '';
                    }
                } catch(e) {
                    console.warn('Duplicate check failed', e);
                } finally {
                    updateGoButtonState();
                }
            }

            const cleanupListeners = () => {
                closeBtn && closeBtn.removeEventListener('click', onClose);
                cancelBtn && cancelBtn.removeEventListener('click', onClose);
                createBtn && createBtn.removeEventListener('click', onCreate);
            };
            const onClose = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                cleanupListeners();
                if (nameInput) nameInput.value='';
                if (r2Input) r2Input.value='';
                if (venueInput) venueInput.value='';
                if (startR2Input) startR2Input.value='';
                if (startDupMsg) { startDupMsg.classList.add('hidden'); startDupMsg.textContent='A Survey for this Order has already been created.'; }
                if (startGoBtn) { startGoBtn.disabled = true; startGoBtn.textContent='Go'; }
            };
            const onCreate = async () => {
                const eventName = (nameInput?.value||'').trim();
                const r2Number = (r2Input?.value||'').trim();
                const venueName = (venueInput?.value||'').trim();
                if (!eventName || !r2Number) { alert('Please provide both Event Name and R2 Number.'); return; }
                try {
                    const existing = await checkExistingSurvey(r2Number);
                    if (existing) {
                        const action = await showDuplicateSurveyDialog(existing);
                        if (action === 'edit') { onClose(); startSurvey(r2Number, eventName, venueName); return; }
                        if (action === 'new') { const newR2 = `${r2Number}_${Date.now()}`; onClose(); startSurvey(newR2, eventName, venueName); return; }
                        return; // cancel
                    }
                    onClose();
                    startSurvey(r2Number, eventName, venueName);
                } catch (e) {
                    console.error('Create survey failed', e); alert('Failed to create survey');
                }
            };
            closeBtn && closeBtn.addEventListener('click', onClose, { once: true });
            cancelBtn && cancelBtn.addEventListener('click', onClose, { once: true });
            createBtn && createBtn.addEventListener('click', onCreate, { once: true });
            nameInput && nameInput.focus();

            // --- New R2 quick start logic ---
            const VALID_R2_REGEX_TOP = /^(?=.*\d)[A-Za-z0-9]{7}$/;
            let r2CheckTimer = null;
            async function evaluateTopR2(val){
                if (!startGoBtn) return;
                const trimmed = val.trim();
                const valid = VALID_R2_REGEX_TOP.test(trimmed);
                startGoBtn.disabled = !valid; // provisional
                startGoBtn.textContent = 'Go';
                startGoBtn.classList.remove('bg-blue-600');
                startGoBtn.classList.add('bg-green-600');
                if (startDupMsg) { startDupMsg.classList.add('hidden'); }
                if (!valid) return;
                try {
                    const existing = await checkExistingSurvey(trimmed);
                    if (existing) {
                        // Duplicate -> change button to EDIT
                        startGoBtn.textContent = 'Edit';
                        startGoBtn.disabled = false;
                        startGoBtn.classList.remove('bg-green-600');
                        startGoBtn.classList.add('bg-blue-600');
                        if (startDupMsg) {
                            startDupMsg.textContent = 'A survey exists - proceed to edit existing';
                            startDupMsg.classList.remove('hidden');
                        }
                    }
                } catch(err){ console.warn('R2 quick duplicate check failed', err); }
            }
            startR2Input && startR2Input.addEventListener('input', e => {
                const v = e.target.value;
                if (r2CheckTimer) clearTimeout(r2CheckTimer);
                r2CheckTimer = setTimeout(()=> evaluateTopR2(v), 250);
            });
            startGoBtn && startGoBtn.addEventListener('click', async () => {
                if (!startR2Input) return;
                const val = startR2Input.value.trim();
                if (!VALID_R2_REGEX_TOP.test(val)) return;
                const existing = await checkExistingSurvey(val);
                if (existing) {
                    // Open existing survey directly
                    onClose();
                    startSurvey(val, existing.data?.event_name || '', existing.data?.venue_name || '');
                } else {
                    // Launch create path (reuse createNewSurveyDirect or startSurvey depending on flow)
                    onClose();
                    startSurvey(val, '', '');
                }
            });
            startWithoutBtn && startWithoutBtn.addEventListener('click', () => {
                // Start survey without R2 -> generate temporary ID or proceed with existing flow
                onClose();
                createNewSurveyDirect && createNewSurveyDirect();
            });

            // Add guarded input listeners (if previously missing) for real-time validation
            [nameInput, r2Input].filter(Boolean).forEach(inp => {
                if (!inp.dataset.boundValidation) {
                    inp.dataset.boundValidation = '1';
                    inp.addEventListener('input', () => {
                        if (!modal || modal.classList.contains('hidden')) return; // modal closed
                        if (inp === r2Input) {
                            const val = inp.value.trim();
                            // Format validation immediate feedback
                            if (val.length === 7) {
                                // Debounce duplicate check
                                if (pendingCheck) clearTimeout(pendingCheck);
                                pendingCheck = setTimeout(() => {
                                    if (lastCheckedValue !== val) {
                                        lastCheckedValue = val;
                                        performDuplicateCheck(val);
                                    }
                                }, 250);
                            } else {
                                duplicateFound = false;
                                statusMsg.textContent = '';
                                updateGoButtonState();
                            }
                            // Add simple border color for invalid length/format once user types
                            const validFormat = VALID_R2_REGEX.test(val);
                            inp.classList.toggle('border-red-500', val.length>0 && !validFormat);
                        }
                    });
                }
            });
            // Initial state
            updateGoButtonState();
        }

        // Enhance native date inputs for consistent styling and icon
        function enhanceDateInputs(root=document){
            const inputs = root.querySelectorAll('input[type="date"]:not([data-enhanced-date])');
            inputs.forEach(inp => {
                inp.setAttribute('data-enhanced-date','1');
                const wrap = document.createElement('span');
                wrap.className = 'date-field-wrapper';
                const icon = document.createElement('span');
                icon.className = 'date-field-icon';
                icon.textContent = '📅';
                // Preserve width by copying existing computed width if inline style not set
                if (!inp.style.width) inp.style.width = '100%';
                inp.parentNode.insertBefore(wrap, inp);
                wrap.appendChild(icon);
                wrap.appendChild(inp);
            });
        }

        // Make functions globally available
        window.handlePhotoDelete = handlePhotoDelete;
        window.showWelcomeModal = showWelcomeModal;
        window.showSurveyBrowser = showSurveyBrowser;
        window.searchSurveysInBrowser = searchSurveysInBrowser;
        window.openSurvey = openSurvey;
        window.viewSurveyHistory = viewSurveyHistory;
        window.confirmDeleteSurvey = confirmDeleteSurvey;
        window.saveSurveyToDatabase = saveSurveyToDatabase;
        window.showNotification = showNotification;
        window.checkExistingSurvey = checkExistingSurvey;
        window.showDuplicateSurveyDialog = showDuplicateSurveyDialog;
        window.returnToDashboard = returnToDashboard;
        window.createNewSurveyDirect = createNewSurveyDirect;
        
        // AI functions
        window.showAISettings = showAISettings;
        window.closeAISettings = closeAISettings;
        window.hideAISuggestions = hideAISuggestions;
        window.closeAgendaAnalysis = closeAgendaAnalysis;
        window.analyzeAgenda = analyzeAgenda;
        window.showAgendaAnalysisResults = showAgendaAnalysisResults;
        window.checkAISystemStatus = checkAISystemStatus;
        window.updateAIButtonVisibility = updateAIButtonVisibility;
        
        // Agenda functions  
        window.viewAgendaFile = viewAgendaFile;
        window.deleteAgendaFile = deleteAgendaFile;
        window.analyzeSpecificAgenda = analyzeSpecificAgenda;

        // Dashboard functions
        window.openVenueDetails = openVenueDetails;
        window.showNewSurveyModal = showNewSurveyModal;
        window.showVenueLookupModal = showVenueLookupModal;
        window.performVenueSearch = performVenueSearch;
        window.startSurvey = startSurvey;
        window.initializeMainApp = initializeMainApp;

        // Initialize the survey application
        showWelcomeModal();
    enhanceDateInputs(document);
        
        // Initialize AI when the app starts
        initializeAI();

        // Auto-flush pending changes on page unload
        window.addEventListener('beforeunload', () => {
            flushPendingChanges();
        });

    // (Removed duplicate setupAgendaUpload definition; single authoritative version defined earlier with progress UI.)
        
        // Make agenda functions globally available
        window.deleteAgendaFile = deleteAgendaFile;

        // Room Access Management Functions
        function setupRoomAccess(data) {
            loadVenueRoomsSelector(data['venue-name']);
            renderRoomAccessList(data.roomAccess || []);
            
            // Add room access button
            const addBtn = document.getElementById('add-room-access-btn');
            if (addBtn) {
                addBtn.addEventListener('click', () => addRoomAccess());
            }
        }
        
        async function loadVenueRoomsSelector(venueName) {
            const selector = document.getElementById('venue-rooms-selector');
            if (!selector || !venueName) {
                if (selector) selector.innerHTML = '';
                return;
            }
            
            try {
                // Load venue data to get existing rooms
                const venueData = await loadVenueData(venueName);
                if (venueData && venueData.rooms && venueData.rooms.length > 0) {
                    selector.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-lg font-medium text-blue-900 mb-2">Available Rooms from Venue Database</h4>
                            <p class="text-sm text-blue-700 mb-3">Select rooms from previous surveys for this venue:</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                ${venueData.rooms.map(room => `
                                    <button type="button" onclick="selectVenueRoom('${room.id}', '${room.name}', '${room.type}')" 
                                            class="text-left bg-white border border-blue-300 rounded p-2 hover:bg-blue-100 transition-colors">
                                        <div class="font-medium text-blue-900">${room.name}</div>
                                        <div class="text-xs text-blue-600">${room.type}</div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    selector.innerHTML = `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <p class="text-gray-600">No existing rooms found for this venue. Add rooms in the Rooms section, then return here to set access times.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading venue rooms:', error);
                selector.innerHTML = '';
            }
        }
        
        function selectVenueRoom(roomId, roomName, roomType) {
            // Check if room is already in access list
            const currentData = getCurrentSurveyData();
            const roomAccess = (currentData.roomAccess || []);
            
            if (roomAccess.find(r => r.roomId === roomId)) {
                alert('This room is already in your access schedule.');
                return;
            }
            
            addRoomAccess(roomId, roomName, roomType);
        }
        
        async function addRoomAccess(roomId = null, roomName = '', roomType = '') {
            const currentData = await getCurrentSurveyData();
            const roomAccess = currentData.roomAccess || [];
            
            const newRoomAccess = {
                id: `access_${Date.now()}`,
                roomId: roomId || `custom_${Date.now()}`,
                roomName: roomName || 'New Room',
                roomType: roomType || 'General',
                accessDate: '',
                accessTime: '',
                accessEndTime: '',
                accessNotes: '',
                isCustom: !roomId // Track if this is a custom room or from venue database
            };
            
            roomAccess.push(newRoomAccess);
            await updateSurveyData({ roomAccess });
            renderRoomAccessList(roomAccess);
            logActivity(`Added room access schedule for: ${newRoomAccess.roomName}`);
        }
        
        function renderRoomAccessList(roomAccess = []) {
            const container = document.getElementById('room-access-list');
            if (!container) return;
            
            if (roomAccess.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>No room access scheduled yet.</p>
                        <p class="text-sm">Select rooms from above or click "Add Room Access" to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = roomAccess.map(access => `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-start">
                        <div>
                            <label class="form-label text-sm">Room Name</label>
                            <input type="text" value="${access.roomName}" 
                                   onchange="updateRoomAccess('${access.id}', 'roomName', this.value)"
                                   class="form-input text-sm">
                        </div>
                        <div>
                            <label class="form-label text-sm">Access Date</label>
                            <input type="date" value="${access.accessDate || ''}" 
                                   onchange="updateRoomAccess('${access.id}', 'accessDate', this.value)"
                                   class="form-input text-sm">
                        </div>
                        <div>
                            <label class="form-label text-sm">Start Time</label>
                            <input type="time" value="${access.accessTime || ''}" 
                                   onchange="updateRoomAccess('${access.id}', 'accessTime', this.value)"
                                   class="form-input text-sm">
                        </div>
                        <div>
                            <label class="form-label text-sm">End Time</label>
                            <input type="time" value="${access.accessEndTime || ''}" 
                                   onchange="updateRoomAccess('${access.id}', 'accessEndTime', this.value)"
                                   class="form-input text-sm">
                        </div>
                    </div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label class="form-label text-sm">Access Notes</label>
                            <input type="text" value="${access.accessNotes || ''}" 
                                   onchange="updateRoomAccess('${access.id}', 'accessNotes', this.value)"
                                   placeholder="Special instructions, key codes, contact info..."
                                   class="form-input text-sm">
                        </div>
                        <div class="flex justify-end space-x-2">
                            <span class="text-xs text-gray-500 px-2 py-1 bg-gray-100 rounded">${access.roomType}</span>
                            <button type="button" onclick="removeRoomAccess('${access.id}')" 
                                    class="text-red-600 hover:text-red-800 px-2 py-1 text-sm">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function updateRoomAccess(accessId, field, value) {
            const currentData = await getCurrentSurveyData();
            const roomAccess = currentData.roomAccess || [];
            
            const access = roomAccess.find(a => a.id === accessId);
            if (access) {
                access[field] = value;
                await updateSurveyData({ roomAccess });
                logActivity(`Updated room access: ${access.roomName} - ${field}`);
            }
        }
        
        async function removeRoomAccess(accessId) {
            if (!confirm('Remove this room from the access schedule?')) return;
            
            const currentData = await getCurrentSurveyData();
            let roomAccess = currentData.roomAccess || [];
            const roomToRemove = roomAccess.find(a => a.id === accessId);
            
            roomAccess = roomAccess.filter(a => a.id !== accessId);
            await updateSurveyData({ roomAccess });
            
            if (roomToRemove) {
                logActivity(`Removed room access: ${roomToRemove.roomName}`);
            }
            renderRoomAccessList(roomAccess);
        }
        
        // Make room access functions globally available
        window.selectVenueRoom = selectVenueRoom;
        window.updateRoomAccess = updateRoomAccess;
        window.removeRoomAccess = removeRoomAccess;

        // Venue database functions
        
        function initializeVenueDatabase() {
            // No initialization needed for Supabase - using direct client
        }

        async function saveVenueToDatabase(venueData) {
            if (!supabase) return;
            
            // Check if user has permission to save venue data
            if (!checkAccess('createVenue')) {
                alert('Access denied. You do not have permission to save venue data.');
                return;
            }
            
            try {
                const venueDoc = {
                    venue_name: venueData.venueName,
                    venue_address: venueData.venueAddress || '',
                    venue_contact: venueData.venueContact || '',
                    venue_email: venueData.venueEmail || '',
                    venue_phone: venueData.venuePhone || '',
                    venue_contact_title: venueData.venueContactTitle || '',
                    venue_manager_name: venueData.venueManagerName || '',
                    venue_manager_email: venueData.venueManagerEmail || '',
                    venue_manager_phone: venueData.venueManagerPhone || '',
                    venue_data: {
                        logistics: venueData.logistics || {},
                        rooms: venueData.rooms || [],
                        guidelines: venueData.guidelines || {},
                        photos: venueData.photos || {}
                    },
                    updated_at: new Date().toISOString(),
                    updated_by: window.currentUserEmail || currentUserName
                };
                
                const { error } = await supabase
                    .from('venues')
                    .upsert(venueDoc, {
                        onConflict: 'venue_name'
                    });

                if (error) throw error;
                
                logActivity(`Saved venue "${venueData.venueName}" to database`);
            } catch (error) {
                console.error('Error saving venue to database:', error);
            }
        }

        async function searchVenues(query) {
            if (!supabase || !query || query.length < 2) return [];
            
            // Users with 'user' role cannot see venue lists for security
            if (!checkAccess('viewVenueList')) {
                return [];
            }
            
            try {
                const { data: venues, error } = await supabase
                    .from('venues')
                    .select('*')
                    .ilike('venue_name', `%${query}%`)
                    .order('venue_name');

                if (error) throw error;
                
                return venues.map(venue => ({
                    id: venue.venue_name,
                    venueName: venue.venue_name,
                    ...venue.venue_data
                })) || [];
            } catch (error) {
                console.error('Error searching venues:', error);
                return [];
            }
        }

        async function loadVenueData(venueId) {
            if (!supabase) return null;
            
            try {
                const { data: venue, error } = await supabase
                    .from('venues')
                    .select('*')
                    .eq('venue_name', venueId)
                    .single();

                if (error) throw error;
                
                return venue ? {
                    venueName: venue.venue_name,
                    ...venue.venue_data
                } : null;
            } catch (error) {
                console.error('Error loading venue data:', error);
                return null;
            }
        }

        function setupVenueAutocomplete() {
            const venueInput = document.getElementById('venue-name');
            const suggestionsDiv = document.getElementById('venue-suggestions');
            
            if (!venueInput || !suggestionsDiv) return;
            
            let searchTimeout;
            
            venueInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    if (query.length >= 2) {
                        const venues = await searchVenues(query);
                        showVenueSuggestions(venues, suggestionsDiv);
                    } else {
                        hideSuggestions(suggestionsDiv);
                    }
                }, 300);
            });
            
            venueInput.addEventListener('blur', () => {
                // Delay hiding to allow clicking on suggestions
                setTimeout(() => hideSuggestions(suggestionsDiv), 200);
            });
            
            venueInput.addEventListener('focus', async () => {
                const query = venueInput.value.trim();
                if (query.length >= 2) {
                    const venues = await searchVenues(query);
                    showVenueSuggestions(venues, suggestionsDiv);
                }
            });
        }

        function showVenueSuggestions(venues, suggestionsDiv) {
            if (venues.length === 0) {
                hideSuggestions(suggestionsDiv);
                return;
            }
            
            suggestionsDiv.innerHTML = venues.map(venue => `
                <div class="venue-suggestion p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 last:border-b-0" data-venue-id="${venue.id}">
                    <div class="font-semibold text-gray-900">${venue.venueName}</div>
                    <div class="text-sm text-gray-600">${venue.venueAddress || 'No address'}</div>
                    <div class="text-xs text-gray-400">Last updated by ${venue.updatedBy || 'Unknown'}</div>
                </div>
            `).join('');
            
            suggestionsDiv.classList.remove('hidden');
            
            // Add click handlers
            suggestionsDiv.querySelectorAll('.venue-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', () => {
                    const venueId = suggestion.dataset.venueId;
                    loadAndPopulateVenue(venueId);
                    hideSuggestions(suggestionsDiv);
                });
            });
        }

        function hideSuggestions(suggestionsDiv) {
            suggestionsDiv.classList.add('hidden');
        }

        async function loadAndPopulateVenue(venueId) {
            // Check if user has permission to load venue data
            if (!checkAccess('editOwnVenue')) {
                alert('Access denied. You do not have permission to load venue data.');
                return;
            }
            
            const venueData = await loadVenueData(venueId);
            if (!venueData) return;
            
            // Show confirmation dialog
            const confirmed = confirm(`Load data from "${venueData.venueName}"? This will populate venue details, logistics, rooms, and guidelines. Your current data will be merged with the saved venue data.`);
            
            if (!confirmed) return;
            
            // Update base survey with selected venue fields first
            await updateSurveyData({ 'venue-name': venueData.venueName, 'venue-address': venueData.venueAddress }, false);

            // Ensure we have the survey row UUID (fetch if missing)
            if (!window.surveyRowUuid) {
                const { row } = await fetchSurveyRowByAnyId(window.appId);
                if (row) window.surveyRowUuid = row.id; else {
                    console.warn('Cannot seed venue: survey row UUID not found');
                    return;
                }
            }

            try {
                // Call RPC to seed normalized data (rooms, guidelines, venue contacts)
                const { error: seedError } = await supabase.rpc('seed_survey_from_venue', {
                    _survey_id: window.surveyRowUuid,
                    _venue_id: venueId
                });
                if (seedError) {
                    console.error('Venue seeding RPC failed:', seedError);
                    showNotification('Failed to seed venue data', 'error');
                } else {
                    console.log('[Seed] Venue data cloned via RPC');
                }
            } catch (e) {
                console.error('Venue seeding exception:', e);
            }

            // Refresh child data from normalized tables
            await refreshNormalizedChildren();
            logActivity(`Seeded survey from venue "${venueData.venueName}"`);
        }

        // Fetch normalized child entities and merge into in-memory model for rendering
        async function refreshNormalizedChildren() {
            if (!supabase || !window.surveyRowUuid) return;
            try {
                const [roomsRes, guidelinesRes, venueContactsRes] = await Promise.all([
                    supabase.from('rooms').select('*').eq('survey_id', window.surveyRowUuid).is('deleted_at', null).order('position', { ascending: true }),
                    supabase.from('guidelines').select('*').eq('survey_id', window.surveyRowUuid).maybeSingle(),
                    supabase.from('survey_contacts').select('*').eq('survey_id', window.surveyRowUuid).eq('category', 'venue').is('deleted_at', null).order('created_at', { ascending: true })
                ]);
                const current = await getCurrentSurveyData();
                const patch = { ...current };
                if (!roomsRes.error) {
                    patch.rooms = (roomsRes.data || []).map(r => ({
                        id: r.id,
                        name: r.name,
                        type: r.type,
                        capacity: r.capacity,
                        layout: r.layout,
                        dimensions: r.dimensions,
                        ceilingHeight: r.ceiling_height,
                        electrical: r.electrical,
                        rigging: r.rigging,
                        soundPatch: r.sound_patch,
                        doorSize: r.door_size,
                        wifiAvailable: r.wifi_available,
                        wifiNotes: r.wifi_notes,
                        hardlineAvailable: r.hardline_available,
                        hardlineNotes: r.hardline_notes,
                        miscNotes: r.misc_notes,
                        position: r.position
                    }));
                }
                if (!guidelinesRes.error && guidelinesRes.data) {
                    const g = guidelinesRes.data;
                    patch.guidelines = {
                        results: {
                            importantInfo: Array.isArray(g.important_info) ? g.important_info : [],
                            dueDates: Array.isArray(g.due_dates) ? g.due_dates : []
                        },
                        originalText: g.raw_text,
                        processedBy: g.processed_by,
                        processedAt: g.processed_at
                    };
                }
                if (!venueContactsRes.error) {
                    patch['venue-contacts'] = (venueContactsRes.data || []).map(c => ({
                        id: c.id,
                        name: c.name,
                        title: c.title,
                        email: c.email,
                        phone: c.phone,
                        phoneType: c.phone_type,
                        note: c.note,
                        excluded: c.excluded || false
                    }));
                }
                await updateSurveyData(patch);
            } catch (e) {
                console.error('refreshNormalizedChildren failed:', e);
            }
        }

        // Edit room functionality
        let editingRoomId = null;

        function setupRoomEditListeners(section) {
            section.querySelectorAll('.edit-room-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const roomId = btn.dataset.roomId;
                    editRoom(roomId);
                });
            });
        }

        async function editRoom(roomId) {
            const currentData = await getCurrentSurveyData();
            const room = currentData.rooms?.find(r => r.id === roomId);
            
            if (!room) return;
            
            // Populate form with room data
            const form = document.getElementById('rooms-form');
            if (!form) return;
            
            form['room-type'].value = room.type;
            form['room-name'].value = room.name;
            form['room-capacity'].value = room.capacity || '';
            form['room-layout'].value = room.layout || '';
            form['room-dimensions'].value = room.dimensions || '';
            form['room-ceiling-height'].value = room.ceilingHeight || '';
            form['room-electrical'].value = room.electrical || '';
            form['room-rigging'].value = room.rigging || '';
            form['room-sound-patch'].value = room.soundPatch || '';
            form['room-door-size'].value = room.doorSize || '';
            form['room-wifi-available'].checked = room.wifiAvailable || false;
            form['room-hardline-available'].checked = room.hardlineAvailable || false;
            form['room-wifi-notes'].value = room.wifiNotes || '';
            form['room-hardline-notes'].value = room.hardlineNotes || '';
            form['room-misc-notes'].value = room.miscNotes || '';
            
            // Change form behavior
            editingRoomId = roomId;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Room';
            submitBtn.className = 'bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700';
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.textContent = 'Cancel Edit';
            cancelBtn.className = 'bg-gray-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-gray-600 ml-3';
            cancelBtn.onclick = cancelRoomEdit;
            submitBtn.parentNode.appendChild(cancelBtn);
            
            // Show photos for the room being edited
            const photos = currentData.photos || {};
            renderPhotos('new-room-photos', photos[`rooms-${roomId}`]);
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelRoomEdit() {
            editingRoomId = null;
            const form = document.getElementById('rooms-form');
            if (!form) return;
            
            form.reset();
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Room';
            submitBtn.className = 'bg-teal-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-teal-700';
            
            // Remove cancel button
            const cancelBtn = form.querySelector('button[type="button"]');
            if (cancelBtn) cancelBtn.remove();
            
            // Clear photos
            renderPhotos('new-room-photos', []);
        }

        // Auto-save venue data when survey is updated
        async function autoSaveVenueData() {
            const currentData = await getCurrentSurveyData();
            
            if (currentData['venue-name'] && currentData['venue-address']) {
                const venueData = {
                    venueName: currentData['venue-name'],
                    venueAddress: currentData['venue-address'],
                    venueContact: currentData['venue-contact'],
                    venueEmail: currentData['venue-email'],
                    venuePhone: currentData['venue-phone'],
                    venueContactTitle: currentData['venue-contact-title'],
                    venueManagerName: currentData['venue-manager-name'],
                    venueManagerEmail: currentData['venue-manager-email'],
                    venueManagerPhone: currentData['venue-manager-phone'],
                    logistics: {
                        'dock-location': currentData['dock-location'],
                        'dock-door-height': currentData['dock-door-height'],
                        'trailer-53-support': currentData['trailer-53-support'],
                        'cab-parking': currentData['cab-parking'],
                        'num-dock-spaces': currentData['num-dock-spaces'],
                        'dock-plate-type': currentData['dock-plate-type'],
                        'ramp-available': currentData['ramp-available'],
                        'ramp-dimensions': currentData['ramp-dimensions'],
                        'dock-access-process': currentData['dock-access-process'],
                        'dock-coordinator': currentData['dock-coordinator'],
                        'dock-schedule': currentData['dock-schedule'],
                        'freight-elevator-distance': currentData['freight-elevator-distance'],
                        'freight-elevator-dimensions': currentData['freight-elevator-dimensions'],
                        'max-item-size': currentData['max-item-size']
                    },
                    rooms: currentData.rooms || [],
                    guidelines: currentData.guidelines || {},
                    photos: currentData.photos || {}
                };
                
                await saveVenueToDatabase(venueData);
            }
        }

        async function offerAgendaAnalysis(uploadedFiles) {
            // Show a prompt asking if user wants AI analysis
            const shouldAnalyze = await showAgendaAnalysisPrompt(uploadedFiles);
            
            if (shouldAnalyze) {
                await performAgendaAnalysis(uploadedFiles);
            }
        }

        function showAgendaAnalysisPrompt(files) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">AI Agenda Analysis</h3>
                        <p class="text-gray-600 mb-4">
                            Would you like the AI assistant to analyze the uploaded agenda and help automatically organize your event?
                        </p>
                        <p class="text-sm text-gray-500 mb-6">
                            The AI can help create rooms, sessions, and populate the schedule based on the agenda content.
                        </p>
                        <div class="flex space-x-3">
                            <button id="analyze-yes" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Yes, Analyze
                            </button>
                            <button id="analyze-no" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                                Not Now
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('#analyze-yes').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(true);
                });
                
                modal.querySelector('#analyze-no').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(false);
                });
                
                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(false);
                    }
                });
            });
        }

        async function uploadAgendaFile(file) {
            const timestamp = Date.now();
            const fileName = `agenda_${timestamp}_${file.name}`;
            const storageRef = ref(storage, `surveys/${appId}/agenda/${fileName}`);
            
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            
            return {
                id: fileName,
                name: file.name,
                type: file.type,
                size: file.size,
                url: downloadURL,
                uploadedBy: currentUserName,
                uploadedAt: timestamp
            };
        }

        function renderAgendaFiles(files) {
            const filesContainer = document.getElementById('agenda-files');
            if (!filesContainer) return;
            
            if (files.length === 0) {
                filesContainer.innerHTML = '';
                return;
            }
            
            filesContainer.innerHTML = `
                <div class="border-t pt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Uploaded Files:</h4>
                    <div class="space-y-2">
                        ${files.map(file => `
                            <div class="flex items-center justify-between bg-white p-3 rounded border">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0">
                                        ${getFileIcon(file.type)}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                                        <p class="text-xs text-gray-500">
                                            ${formatFileSize(file.size)} • Uploaded by ${file.uploadedBy} • 
                                            ${new Date(file.uploadedAt).toLocaleDateString()}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="viewAgendaFile('${file.url}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                        View
                                    </button>
                                    <button onclick="deleteAgendaFile('${file.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                        Delete
                                    </button>
                                    ${openAIKey ? `<button onclick="analyzeSpecificAgenda('${file.id}')" class="text-purple-600 hover:text-purple-800 text-sm">
                                        AI Analyze
                                    </button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') {
                return '<span class="text-red-600 text-xl">📄</span>';
            } else if (fileType.includes('word') || fileType.includes('document')) {
                return '<span class="text-blue-600 text-xl">📝</span>';
            } else if (fileType.startsWith('image/')) {
                return '<span class="text-green-600 text-xl">🖼️</span>';
            }
            return '<span class="text-gray-600 text-xl">📁</span>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function deleteAgendaFile(fileId) {
            if (!confirm('Are you sure you want to delete this agenda file?')) return;
            
            try {
                // Delete from storage
                const storageRef = ref(storage, `surveys/${appId}/agenda/${fileId}`);
                await deleteObject(storageRef);
                
                // Update survey data
                const currentData = await getCurrentSurveyData();
                const files = (currentData.agendaFiles || []).filter(file => file.id !== fileId);
                await updateSurveyData({ agendaFiles: files }, true);
                
                // Re-render files
                renderAgendaFiles(files);
                
                logActivity(`Deleted agenda file`);
                showNotification('Agenda file deleted successfully', 'success');
                
            } catch (error) {
                console.error('Failed to delete agenda file:', error);
                showNotification('Failed to delete file. Please try again.', 'error');
            }
        }

        function viewAgendaFile(url) {
            window.open(url, '_blank');
        }

        async function performAgendaAnalysis(files) {
            try {
                showNotification('Analyzing agenda with AI...', 'info');
                
                // For now, we'll use the first file for analysis
                // In a real implementation, you might want to combine multiple files
                const firstFile = files[0];
                
                // Extract text from the file (this is a simplified approach)
                const agendaText = await extractTextFromFile(firstFile);
                
                if (!agendaText) {
                    showNotification('Could not extract text from agenda file. Please try a different format.', 'error');
                    return;
                }
                
                // Analyze with AI
                const analysis = await analyzeAgenda(agendaText, firstFile.name);
                
                if (analysis) {
                    showAgendaAnalysisResults(analysis);
                } else {
                    showNotification('AI analysis failed. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('Agenda analysis failed:', error);
                showNotification('Failed to analyze agenda. Please try again.', 'error');
            }
        }

        async function analyzeSpecificAgenda(fileId) {
            const currentData = await getCurrentSurveyData();
            const file = (currentData.agendaFiles || []).find(f => f.id === fileId);
            
            if (file) {
                await performAgendaAnalysis([file]);
            }
        }

        async function extractTextFromFile(file) {
            // This is a simplified approach - in a real implementation you would
            // use proper document parsing libraries or OCR for images
            if (file.type === 'application/pdf') {
                // For PDF files, you'd typically use PDF.js or send to a service
                return `[PDF content from ${file.name} - text extraction would be implemented here]`;
            } else if (file.type.includes('word') || file.type.includes('document')) {
                // For Word documents, you'd use a library like mammoth.js
                return `[Word document content from ${file.name} - text extraction would be implemented here]`;
            } else if (file.type.startsWith('image/')) {
                // For images, you'd use OCR like Tesseract.js
                return `[Image content from ${file.name} - OCR would be implemented here]`;
            }
            
            return null;
        }

        function preserveFocusAndRender(sectionElement, renderFunction) {
            const activeElement = document.activeElement;
            const activeElementId = activeElement ? activeElement.id : null;
            const selectionStart = activeElement ? activeElement.selectionStart : null;
            const selectionEnd = activeElement ? activeElement.selectionEnd : null;

            renderFunction();

            if (activeElementId && sectionElement.contains(document.getElementById(activeElementId))) {
                const newActiveElement = document.getElementById(activeElementId);
                if (newActiveElement) {
                    newActiveElement.focus();
                    if (newActiveElement.setSelectionRange && selectionStart != null && selectionEnd != null) {
                        newActiveElement.setSelectionRange(selectionStart, selectionEnd);
                    }
                }
            }
        }
        
        function renderEventInfoSection(data) {
            const section = document.getElementById('event-info');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Event Information</h2>
                    <p class="text-gray-600 mb-6">Enter the core details about the event, schedule, and agenda.</p>
                    
                    <!-- Event Information Section -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4">Basic Event Details</h3>
                            <div class="flex items-center gap-4">
                                <label for="survey-status" class="form-label text-sm mb-0">Survey Status:</label>
                                <select id="survey-status" class="form-input w-auto text-sm">
                                    <option value="In Progress" ${data.status === 'In Progress' || !data.status ? 'selected' : ''}>In Progress</option>
                                    <option value="Completed" ${data.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    <option value="Archived" ${data.status === 'Archived' ? 'selected' : ''}>Archived</option>
                                    ${checkAccess('editAnySurvey') ? `<option value="Review Required" ${data.status === 'Review Required' ? 'selected' : ''}>Review Required</option>` : ''}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label for="event-name" class="form-label">Event Name</label><input type="text" id="event-name" class="form-input" placeholder="e.g., Harmony Festival 2024" value="${data['event-name'] || ''}"></div>
                            <div><label for="r2-quote-number" class="form-label">R2 Quote Number</label><input type="text" id="r2-quote-number" class="form-input" placeholder="e.g., 0911234" value="${data['r2-quote-number'] || data['r2-number'] || ''}"></div>
                            <div><label for="anticipated-attendees" class="form-label">Anticipated Attendees</label><input type="number" id="anticipated-attendees" class="form-input" placeholder="e.g., 500" value="${data['anticipated-attendees'] || ''}"></div>
                            <div>
                                <label class="form-label">Indoor/Outdoor</label>
                                <select id="indoor-outdoor" class="form-input">
                                    <option value="">Select...</option>
                                    <option value="indoor" ${data['indoor-outdoor'] === 'indoor' ? 'selected' : ''}>Indoor</option>
                                    <option value="outdoor" ${data['indoor-outdoor'] === 'outdoor' ? 'selected' : ''}>Outdoor</option>
                                    <option value="both" ${data['indoor-outdoor'] === 'both' ? 'selected' : ''}>Both</option>
                                </select>
                            </div>
                            <div><label for="charge-days" class="form-label"># Charge Days</label><input type="number" id="charge-days" class="form-input" placeholder="e.g., 3" value="${data['charge-days'] || ''}"></div>
                            <div><label for="budget" class="form-label">Budget</label><input type="text" id="budget" class="form-input" placeholder="e.g., $15,000" value="${data['budget'] || ''}"></div>
                        </div>
                    </div>

                    <!-- Schedule Section -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-teal-700 border-l-4 border-teal-500 pl-4">Event Schedule</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-teal-600 text-white">
                                        <th class="border border-gray-300 px-4 py-2 text-left font-medium">Activity</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left font-medium">Date</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left font-medium">Time</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left font-medium">Specific Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Load in:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="load-in-date" class="form-input border-0 p-1" value="${data['load-in-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="load-in-time" class="form-input border-0 p-1" value="${data['load-in-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="load-in-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['load-in-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Setup:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="setup-date" class="form-input border-0 p-1" value="${data['setup-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="setup-time" class="form-input border-0 p-1" value="${data['setup-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="setup-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['setup-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Rehearsal:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="rehearsal-date" class="form-input border-0 p-1" value="${data['rehearsal-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="rehearsal-time" class="form-input border-0 p-1" value="${data['rehearsal-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="rehearsal-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['rehearsal-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Show Start:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="show-start-date" class="form-input border-0 p-1" value="${data['show-start-date'] || data['event-start-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="show-start-time" class="form-input border-0 p-1" value="${data['show-start-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="show-start-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['show-start-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Show End:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="show-end-date" class="form-input border-0 p-1" value="${data['show-end-date'] || data['event-end-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="show-end-time" class="form-input border-0 p-1" value="${data['show-end-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="show-end-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['show-end-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Strike:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="strike-date" class="form-input border-0 p-1" value="${data['strike-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="strike-time" class="form-input border-0 p-1" value="${data['strike-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="strike-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['strike-notes'] || ''}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Agenda Upload Section -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-teal-700 border-l-4 border-teal-500 pl-4">Event Agenda</h3>
                        <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="mt-4">
                                    <label for="agenda-upload" class="cursor-pointer">
                                        <span class="mt-2 block text-sm font-medium text-gray-900">Upload event agenda</span>
                                        <span class="mt-1 block text-sm text-gray-600">PDF, DOC, DOCX, or image files up to 10MB</span>
                                    </label>
                                    <input id="agenda-upload" name="agenda-upload" type="file" class="sr-only" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                                </div>
                            </div>
                            <div id="agenda-files" class="mt-4"></div>
                        </div>
                    </div>
                `;
                
                // Add event listeners for all form elements
                section.querySelectorAll('.form-input, select').forEach(input => {
                    input.addEventListener('input', handleFormChange);
                    input.addEventListener('change', handleFormChange);
                });
                
                // Setup agenda file upload
                setupAgendaUpload();
                
                // Render existing agenda files
                renderAgendaFiles(data.agendaFiles || []);
                
                // Setup AI assistance triggers for form changes
                if (aiAssistanceEnabled) {
                    section.addEventListener('input', () => {
                        generateAISuggestions();
                    });
                }
            });
        }

        function renderClientInfoSection(data) {
            const section = document.getElementById('client-info');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Client Information</h2>
                    <p class="text-gray-600 mb-6">Enter all client contact and business details for this event.</p>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Client Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label for="client-business" class="form-label">Client Business</label><input type="text" id="client-business" class="form-input" placeholder="e.g., ABC Corporation" value="${data['client-business'] || ''}"></div>
                            <div id="client-business-suggestions" class="mt-1 border border-gray-300 rounded hidden bg-white shadow"></div>
                            <div class="mt-4">
                                <label class="form-label" for="primary-client-contact">Primary Client Contact</label>
                                <select id="primary-client-contact" class="form-input"><option value="">-- Select (after business) --</option>${(data['client-contacts']||[]).map(c=>`<option value="${c.id}" ${data['client-name'] && data['client-email'] && c.email===data['client-email'] ? 'selected' : ''}>${c.name||'Unnamed'}${c.title? ' – '+c.title:''}</option>`).join('')}</select>
                            </div>
                            <div><label for="client-name" class="form-label">Client Name</label><input type="text" id="client-name" class="form-input" placeholder="e.g., John Smith" value="${data['client-name'] || data['client-contact'] || ''}"></div>
                            <div><label for="client-title" class="form-label">Client Title</label><input type="text" id="client-title" class="form-input" placeholder="e.g., Event Manager" value="${data['client-title'] || ''}"></div>
                            <div><label for="client-cell" class="form-label">Client Phone</label><input type="tel" id="client-cell" class="form-input" placeholder="e.g., 555-123-4567" value="${data['client-cell'] || ''}"></div>
                            <div><label for="client-email" class="form-label">Client Email</label><input type="email" id="client-email" class="form-input" placeholder="e.g., john@abccorp.com" value="${data['client-email'] || ''}"></div>
                            <div><label for="client-address" class="form-label">Client Address</label><input type="text" id="client-address" class="form-input" placeholder="e.g., 123 Business St, City, State" value="${data['client-address'] || ''}"></div>
                            <div>
                                <label class="form-label">Tax Status</label>
                                <select id="tax-status" class="form-input">
                                    <option value="">Select...</option>
                                    <option value="taxable" ${data['tax-status'] === 'taxable' ? 'selected' : ''}>Taxable</option>
                                    <option value="tax-exempt" ${data['tax-status'] === 'tax-exempt' ? 'selected' : ''}>Tax Exempt</option>
                                    <option value="non-profit" ${data['tax-status'] === 'non-profit' ? 'selected' : ''}>Non-Profit</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Event Contact Information</h3>
                        <p class="text-gray-600 mb-4">Primary event contact (may be different from client)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="event-contact-name" class="form-label">Event Contact Name</label><input type="text" id="event-contact-name" class="form-input" placeholder="e.g., Sarah Johnson" value="${data['event-contact-name'] || ''}"></div>
                            <div><label for="event-contact-title" class="form-label">Event Contact Title</label><input type="text" id="event-contact-title" class="form-input" placeholder="e.g., Event Coordinator" value="${data['event-contact-title'] || ''}"></div>
                            <div><label for="event-contact-phone" class="form-label">Event Contact Phone</label><input type="tel" id="event-contact-phone" class="form-input" placeholder="e.g., 555-987-6543" value="${data['event-contact-phone'] || ''}"></div>
                            <div><label for="event-contact-email" class="form-label">Event Contact Email</label><input type="email" id="event-contact-email" class="form-input" placeholder="e.g., sarah@abccorp.com" value="${data['event-contact-email'] || ''}"></div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-4">Client Contacts</h3>
                        <div id="client-contacts-form" class="p-4 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="md:col-span-1">
                                <label for="client-contact-name" class="form-label">Contact Name</label>
                                <input type="text" id="client-contact-name" class="form-input" placeholder="e.g., Alex Morgan">
                            </div>
                            <div>
                                <label for="client-contact-title" class="form-label">Job Title</label>
                                <input type="text" id="client-contact-title" class="form-input" placeholder="e.g., Account Rep">
                            </div>
                            <div>
                                <label for="client-contact-email" class="form-label">Contact Email</label>
                                <input type="email" id="client-contact-email" class="form-input" placeholder="name@client.com">
                            </div>
                            <div>
                                <label for="client-contact-phone" class="form-label">Contact Phone</label>
                                <input type="tel" id="client-contact-phone" class="form-input" placeholder="555-555-5555">
                            </div>
                            <div>
                                <label for="client-contact-phone-type" class="form-label">Phone Type</label>
                                <select id="client-contact-phone-type" class="form-input">
                                    <option value="cell">Cell</option>
                                    <option value="office">Office</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            <div class="md:col-span-5 flex justify-end">
                                <button type="button" id="add-client-contact" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">Add Contact</button>
                            </div>
                        </div>
                        <div id="client-contacts-list" class="mt-6 space-y-3"></div>
                    </div>
                `;
                
                // Add event listeners for all form elements
                section.querySelectorAll('.form-input, select').forEach(input => {
                    input.addEventListener('input', handleFormChange);
                    input.addEventListener('change', handleFormChange);
                });

                // Client Contacts logic
                const clientContacts = Array.isArray(data['client-contacts']) ? data['client-contacts'] : [];
                const clientListEl = section.querySelector('#client-contacts-list');
                const clientAddBtn = section.querySelector('#add-client-contact');

                function renderClientContacts() {
                    if (!clientListEl) return;
                    const primaryEmail = data['client-email'];
                    clientListEl.innerHTML = clientContacts.map((c, idx) => {
                        const excluded = !!c.excluded;
                        const name = c.name || '';
                        const title = c.title || '';
                        const email = c.email || '';
                        const phone = c.phone || '';
                        const phoneType = c.phoneType || '';
                        const note = c.note || '';
                        const displayTitle = excluded && title ? `EX-${title.replace(/^EX-/, '')}` : title;
                        const isPrimary = primaryEmail && email && email === primaryEmail;
                        return `
                            <div class="p-3 rounded border ${excluded ? 'bg-gray-100 text-gray-500 line-through' : 'bg-white'}">
                                <div class="flex justify-between items-start gap-3">
                                    <div>
                                        <div class="font-medium">${name || '(No name)'} ${isPrimary ? '<span class=\"ml-2 inline-block px-2 py-0.5 text-xs rounded bg-teal-100 text-teal-700 border border-teal-300\">Primary</span>' : ''} <span class="text-sm text-gray-500">${displayTitle}</span></div>
                                        <div class="text-sm">${email || ''}</div>
                                        <div class="text-sm">${phone || ''} ${phoneType ? `(${phoneType})` : ''}</div>
                                        ${excluded && note ? `<div class="text-xs text-gray-500 mt-1">${note}</div>` : ''}
                                    </div>
                                    <div class="flex-shrink-0 flex gap-2">
                                        ${!excluded ? `
                                            <button type="button" data-action="edit" data-index="${idx}" class="px-2 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Edit</button>
                                            <button type="button" data-action="exclude" data-index="${idx}" class="px-2 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">EX</button>
                                        ` : `
                                            <button type="button" data-action="restore" data-index="${idx}" class="px-2 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">Restore</button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                clientAddBtn?.addEventListener('click', async () => {
                    const name = section.querySelector('#client-contact-name').value.trim();
                    const title = section.querySelector('#client-contact-title').value.trim();
                    const email = section.querySelector('#client-contact-email').value.trim();
                    const phone = section.querySelector('#client-contact-phone').value.trim();
                    const phoneType = section.querySelector('#client-contact-phone-type').value;
                    if (!name && !email && !phone) return;
                    clientContacts.push({ name, title, email, phone, phoneType, excluded: false });
                    renderClientContacts();
                    // clear
                    section.querySelector('#client-contact-name').value = '';
                    section.querySelector('#client-contact-title').value = '';
                    section.querySelector('#client-contact-email').value = '';
                    section.querySelector('#client-contact-phone').value = '';
                    section.querySelector('#client-contact-phone-type').value = 'cell';
                    await updateSurveyData({ 'client-contacts': clientContacts }, true);
                });

                clientListEl?.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    const action = btn.getAttribute('data-action');
                    if (Number.isNaN(idx) || !clientContacts[idx]) return;
                    if (action === 'edit') {
                        window.openContactEditor(clientContacts, idx, 'client');
                    } else if (action === 'exclude') {
                        const user = window.currentUserEmail || currentUserName || 'Unknown user';
                        const ts = new Date().toLocaleString();
                        const origTitle = clientContacts[idx].title || '';
                        const exTitle = origTitle.startsWith('EX-') ? origTitle : `EX-${origTitle}`;
                        clientContacts[idx] = { ...clientContacts[idx], excluded: true, title: exTitle, note: `Edited by ${user} on ${ts}` };
                        renderClientContacts();
                        await updateSurveyData({ 'client-contacts': clientContacts }, true);
                    } else if (action === 'restore') {
                        const { excluded, note, ...rest } = clientContacts[idx];
                        const cleanTitle = (rest.title || '').replace(/^EX-/, '');
                        clientContacts[idx] = { ...rest, title: cleanTitle, excluded: false };
                        renderClientContacts();
                        await updateSurveyData({ 'client-contacts': clientContacts }, true);
                    }
                });

                renderClientContacts();
            });
        }

        function renderVenueInfoSection(data) {
            const section = document.getElementById('venue-info');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Venue Information</h2>
                    <p class="text-gray-600 mb-6">Enter venue details and survey team information.</p>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Venue Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="relative">
                                <label for="venue-name" class="form-label">Venue Name</label>
                                <input type="text" id="venue-name" class="form-input" placeholder="e.g., Sunset Meadows Park" value="${data['venue-name'] || ''}" autocomplete="off">
                                <div id="venue-suggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-60 overflow-y-auto z-10 hidden"></div>
                            </div>
                            <div><label for="venue-address" class="form-label">Venue Address</label><input type="text" id="venue-address" class="form-input" placeholder="123 Park Ave, City, State" value="${data['venue-address'] || ''}"></div>
                            <div><label for="venue-contact" class="form-label">Main Venue Contact</label><input type="text" id="venue-contact" class="form-input" placeholder="Mike R. - 555-123-4567" value="${data['venue-contact'] || ''}"></div>
                            <div><label for="venue-email" class="form-label">Venue Email</label><input type="email" id="venue-email" class="form-input" placeholder="contact@venue.com" value="${data['venue-email'] || ''}"></div>
                            <div><label for="venue-phone" class="form-label">Venue Phone</label><input type="tel" id="venue-phone" class="form-input" placeholder="555-123-4567" value="${data['venue-phone'] || ''}"></div>
                            <div><label for="venue-contact-title" class="form-label">Contact Title</label><input type="text" id="venue-contact-title" class="form-input" placeholder="e.g., Event Manager" value="${data['venue-contact-title'] || ''}"></div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-4">Venue Contacts</h3>
                        <div id="venue-contacts-form" class="p-4 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="md:col-span-1">
                                <label for="venue-contact-name" class="form-label">Contact Name</label>
                                <input type="text" id="venue-contact-name" class="form-input" placeholder="e.g., Sarah Wilson">
                            </div>
                            <div>
                                <label for="venue-contact-form-title" class="form-label">Job Title</label>
                                <input type="text" id="venue-contact-form-title" class="form-input" placeholder="e.g., Event Manager">
                            </div>
                            <div>
                                <label for="venue-contact-email" class="form-label">Contact Email</label>
                                <input type="email" id="venue-contact-email" class="form-input" placeholder="name@venue.com">
                            </div>
                            <div>
                                <label for="venue-contact-phone" class="form-label">Contact Phone</label>
                                <input type="tel" id="venue-contact-phone" class="form-input" placeholder="555-123-4567">
                            </div>
                            <div>
                                <label for="venue-contact-phone-type" class="form-label">Phone Type</label>
                                <select id="venue-contact-phone-type" class="form-input">
                                    <option value="cell">Cell</option>
                                    <option value="office">Office</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            <div class="md:col-span-5 flex justify-end">
                                <button type="button" id="add-venue-contact" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">Add Contact</button>
                            </div>
                        </div>
                        <div id="venue-contacts-list" class="mt-6 space-y-3"></div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-4">In-House AV Company</h3>
                        <label class="flex items-center gap-3 mb-4">
                            <input type="checkbox" id="inhouse-av-enabled" class="form-checkbox">
                            <span>There is an in-house AV provider at this venue</span>
                        </label>
                        <div id="inhouse-av-block" class="hidden space-y-4 transition-opacity">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-1">
                                    <label for="inhouse-av-name" class="form-label">Company Name</label>
                                    <input type="text" id="inhouse-av-name" class="form-input" placeholder="e.g., Venue AV Co.">
                                </div>
                            </div>
                            <div id="inhouse-contacts-form" class="p-4 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                                <div class="md:col-span-1">
                                    <label for="inhouse-contact-name" class="form-label">Contact Name</label>
                                    <input type="text" id="inhouse-contact-name" class="form-input" placeholder="e.g., Chris Lee">
                                </div>
                                <div>
                                    <label for="inhouse-contact-title" class="form-label">Job Title</label>
                                    <input type="text" id="inhouse-contact-title" class="form-input" placeholder="e.g., Sales Manager">
                                </div>
                                <div>
                                    <label for="inhouse-contact-email" class="form-label">Contact Email</label>
                                    <input type="email" id="inhouse-contact-email" class="form-input" placeholder="name@avco.com">
                                </div>
                                <div>
                                    <label for="inhouse-contact-phone" class="form-label">Contact Phone</label>
                                    <input type="tel" id="inhouse-contact-phone" class="form-input" placeholder="555-987-6543">
                                </div>
                                <div>
                                    <label for="inhouse-contact-phone-type" class="form-label">Phone Type</label>
                                    <select id="inhouse-contact-phone-type" class="form-input">
                                        <option value="cell">Cell</option>
                                        <option value="office">Office</option>
                                        <option value="general">General</option>
                                    </select>
                                </div>
                                <div class="md:col-span-5 flex justify-end">
                                    <button type="button" id="add-inhouse-contact" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">Add Contact</button>
                                </div>
                            </div>
                            <div id="inhouse-contacts-list" class="mt-6 space-y-3"></div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Survey Team Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="survey-date" class="form-label">Survey Date</label><input type="date" id="survey-date" class="form-input" value="${data['survey-date'] || ''}"></div>
                            <div><label for="survey-team" class="form-label">Survey Completed by</label><input type="text" id="survey-team" class="form-input" placeholder="e.g., Alex Greene" value="${data['survey-team'] || ''}"></div>
                        </div>
                        <div class="mt-6">
                            <label class="flex items-center gap-3">
                                <input type="checkbox" id="add-team-members-enabled" class="form-checkbox">
                                <span>Add additional Survey Team members</span>
                            </label>
                            <div id="team-members-block" class="hidden mt-4">
                                <div id="team-members-form" class="p-4 border border-gray-200 rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                                    <div class="md:col-span-2">
                                        <label for="team-member-name" class="form-label">Team Member Name</label>
                                        <input type="text" id="team-member-name" class="form-input" placeholder="e.g., John Doe">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="team-member-role" class="form-label">Role</label>
                                        <input type="text" id="team-member-role" class="form-input" placeholder="e.g., Lead Tech, Account Rep">
                                    </div>
                                    <div class="md:col-span-1 flex justify-end">
                                        <button type="button" id="add-team-member" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">Add</button>
                                    </div>
                                </div>
                                <div id="team-members-list" class="mt-4 space-y-3"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners for all form elements
                section.querySelectorAll('.form-input, select').forEach(input => {
                    input.addEventListener('input', handleFormChange);
                    input.addEventListener('change', handleFormChange);
                });
                
                // Setup venue autocomplete
                setupVenueAutocomplete();

                // Initialize contacts list
                const contacts = Array.isArray(data['venue-contacts']) ? data['venue-contacts'] : [];
                const listEl = section.querySelector('#venue-contacts-list');
                const addBtn = section.querySelector('#add-venue-contact');

                function renderContacts() {
                    if (!listEl) return;
                    listEl.innerHTML = contacts.map((c, idx) => {
                        const excluded = !!c.excluded;
                        const name = c.name || '';
                        const title = c.title || '';
                        const email = c.email || '';
                        const phone = c.phone || '';
                        const phoneType = c.phoneType || '';
                        const note = c.note || '';
                        const displayTitle = excluded && title ? `EX-${title}` : title;
                        return `
                            <div class="p-3 rounded border ${excluded ? 'bg-gray-100 text-gray-500 line-through' : 'bg-white'}">
                                <div class="flex justify-between items-start gap-3">
                                    <div>
                                        <div class="font-medium">${name || '(No name)'} <span class="text-sm text-gray-500">${displayTitle}</span></div>
                                        <div class="text-sm">${email || ''}</div>
                                        <div class="text-sm">${phone || ''} ${phoneType ? `(${phoneType})` : ''}</div>
                                        ${excluded && note ? `<div class="text-xs text-gray-500 mt-1">${note}</div>` : ''}
                                    </div>
                                    <div class="flex-shrink-0 flex gap-2">
                                        ${!excluded ? `
                                            <button type="button" data-action="edit" data-index="${idx}" class="px-2 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Edit</button>
                                            <button type="button" data-action="exclude" data-index="${idx}" class="px-2 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">EX</button>
                                        ` : `
                                            <button type="button" data-action="restore" data-index="${idx}" class="px-2 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">Restore</button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                function clearForm() {
                    section.querySelector('#venue-contact-name').value = '';
                    section.querySelector('#venue-contact-form-title').value = '';
                    section.querySelector('#venue-contact-email').value = '';
                    section.querySelector('#venue-contact-phone').value = '';
                    section.querySelector('#venue-contact-phone-type').value = 'cell';
                }

                addBtn?.addEventListener('click', async () => {
                    const name = section.querySelector('#venue-contact-name').value.trim();
                    const title = section.querySelector('#venue-contact-form-title').value.trim();
                    const email = section.querySelector('#venue-contact-email').value.trim();
                    const phone = section.querySelector('#venue-contact-phone').value.trim();
                    const phoneType = section.querySelector('#venue-contact-phone-type').value;
                    if (!name && !email && !phone) return; // require at least some info
                    contacts.push({ name, title, email, phone, phoneType, excluded: false });
                    renderContacts();
                    clearForm();
                    await updateSurveyData({ 'venue-contacts': contacts }, true);
                });

                listEl?.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    const action = btn.getAttribute('data-action');
                    if (Number.isNaN(idx) || !contacts[idx]) return;
                    if (action === 'edit') {
                        window.openContactEditor(contacts, idx, 'venue');
                    } else if (action === 'exclude') {
                        const user = window.currentUserEmail || currentUserName || 'Unknown user';
                        const ts = new Date().toLocaleString();
                        const origTitle = contacts[idx].title || '';
                        const exTitle = origTitle.startsWith('EX-') ? origTitle : `EX-${origTitle}`;
                        contacts[idx] = { ...contacts[idx], excluded: true, title: exTitle, note: `Edited by ${user} on ${ts}` };
                        renderContacts();
                        await updateSurveyData({ 'venue-contacts': contacts }, true);
                    } else if (action === 'restore') {
                        const { excluded, note, ...rest } = contacts[idx];
                        // Remove EX prefix from title if present
                        const cleanTitle = (rest.title || '').replace(/^EX-/, '');
                        contacts[idx] = { ...rest, title: cleanTitle, excluded: false };
                        renderContacts();
                        await updateSurveyData({ 'venue-contacts': contacts }, true);
                    }
                });

                // Survey date default to created_at if empty
                const surveyDateEl = section.querySelector('#survey-date');
                if (surveyDateEl && !surveyDateEl.value) {
                    const createdAt = (fullSurveyData && fullSurveyData.created_at) || null;
                    if (createdAt) {
                        const d = new Date(createdAt);
                        if (!isNaN(d.getTime())) surveyDateEl.value = d.toISOString().split('T')[0];
                    } else {
                        surveyDateEl.value = new Date().toISOString().split('T')[0];
                    }
                    // persist the defaulted date
                    updateSurveyData({ 'survey-date': surveyDateEl.value }, false);
                }
                surveyDateEl?.addEventListener('change', async () => {
                    await updateSurveyData({ 'survey-date': surveyDateEl.value || null }, false);
                });

                // Prefill Survey Completed by with starter user if empty
                const surveyTeamEl = section.querySelector('#survey-team');
                if (surveyTeamEl && !surveyTeamEl.value) {
                    const starterName = window.currentUserName || 'Survey User';
                    surveyTeamEl.value = starterName;
                    updateSurveyData({ 'survey-team': starterName }, false);
                }
                surveyTeamEl?.addEventListener('input', async () => {
                    await updateSurveyData({ 'survey-team': surveyTeamEl.value }, false);
                });

                // Team members simple add/edit/remove
                const teamMembersEnabledEl = section.querySelector('#add-team-members-enabled');
                const teamMembersBlockEl = section.querySelector('#team-members-block');
                const teamMembersListEl = section.querySelector('#team-members-list');
                const teamMembers = Array.isArray(data['survey-team-members']) ? data['survey-team-members'] : [];

                function renderTeamMembers() {
                    if (!teamMembersListEl) return;
                    teamMembersListEl.innerHTML = teamMembers.map((m, idx) => `
                        <div class=\"p-3 rounded border bg-white\">
                            <div class=\"flex justify-between items-center gap-3\">
                                <div>
                                    <div class=\"font-medium\">${m.name || '(No name)'}${m.role ? ` — <span class=\\\"text-sm text-gray-600\\\">${m.role}</span>` : ''}</div>
                                </div>
                                <div class=\"flex-shrink-0 flex gap-2\">
                                    <button type=\"button\" data-action=\"edit\" data-index=\"${idx}\" class=\"px-2 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700\">Edit</button>
                                    <button type=\"button\" data-action=\"remove\" data-index=\"${idx}\" class=\"px-2 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700\">Remove</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                teamMembersEnabledEl?.addEventListener('change', () => {
                    const enabled = teamMembersEnabledEl.checked;
                    teamMembersBlockEl?.classList.toggle('hidden', !enabled);
                });

                section.querySelector('#add-team-member')?.addEventListener('click', async () => {
                    const nameEl = section.querySelector('#team-member-name');
                    const roleEl = section.querySelector('#team-member-role');
                    const name = nameEl.value.trim();
                    const role = roleEl.value.trim();
                    if (!name && !role) return;
                    teamMembers.push({ name, role });
                    renderTeamMembers();
                    nameEl.value = '';
                    roleEl.value = '';
                    await updateSurveyData({ 'survey-team-members': teamMembers }, true);
                });

                teamMembersListEl?.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    const action = btn.getAttribute('data-action');
                    if (Number.isNaN(idx) || !teamMembers[idx]) return;
                    if (action === 'edit') {
                        const m = teamMembers[idx];
                        section.querySelector('#team-member-name').value = m.name || '';
                        section.querySelector('#team-member-role').value = m.role || '';
                        teamMembers.splice(idx, 1);
                        renderTeamMembers();
                        await updateSurveyData({ 'survey-team-members': teamMembers }, true);
                    } else if (action === 'remove') {
                        teamMembers.splice(idx, 1);
                        renderTeamMembers();
                        await updateSurveyData({ 'survey-team-members': teamMembers }, true);
                    }
                });

                if (teamMembers.length > 0) {
                    if (teamMembersEnabledEl) teamMembersEnabledEl.checked = true;
                    teamMembersBlockEl?.classList.remove('hidden');
                }

                renderTeamMembers();

                // In-house AV: state, renderers, handlers
                const inhouse = data['inhouse-av'] || {};
                const inhouseEnabledEl = section.querySelector('#inhouse-av-enabled');
                const inhouseBlockEl = section.querySelector('#inhouse-av-block');
                const inhouseNameEl = section.querySelector('#inhouse-av-name');
                const inhouseAddBtn = section.querySelector('#add-inhouse-contact');
                const inhouseListEl = section.querySelector('#inhouse-contacts-list');
                const inhouseContacts = Array.isArray(inhouse.contacts) ? inhouse.contacts : [];

                if (inhouseEnabledEl) inhouseEnabledEl.checked = !!inhouse.enabled;
                if (inhouseBlockEl) inhouseBlockEl.classList.toggle('hidden', !inhouse.enabled);
                if (inhouseNameEl) inhouseNameEl.value = inhouse.name || '';

                function renderInhouseContacts() {
                    if (!inhouseListEl) return;
                    inhouseListEl.innerHTML = inhouseContacts.map((c, idx) => {
                        const excluded = !!c.excluded;
                        const name = c.name || '';
                        const title = c.title || '';
                        const email = c.email || '';
                        const phone = c.phone || '';
                        const phoneType = c.phoneType || '';
                        const note = c.note || '';
                        const displayTitle = excluded && title ? `EX-${title.replace(/^EX-/, '')}` : title;
                        return `
                            <div class="p-3 rounded border ${excluded ? 'bg-gray-100 text-gray-500 line-through' : 'bg-white'}">
                                <div class="flex justify-between items-start gap-3">
                                    <div>
                                        <div class="font-medium">${name || '(No name)'} <span class="text-sm text-gray-500">${displayTitle}</span></div>
                                        <div class="text-sm">${email || ''}</div>
                                        <div class="text-sm">${phone || ''} ${phoneType ? `(${phoneType})` : ''}</div>
                                        ${excluded && note ? `<div class="text-xs text-gray-500 mt-1">${note}</div>` : ''}
                                    </div>
                                    <div class="flex-shrink-0 flex gap-2">
                                        ${!excluded ? `
                                            <button type="button" data-action="edit" data-index="${idx}" class="px-2 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Edit</button>
                                            <button type="button" data-action="exclude" data-index="${idx}" class="px-2 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">EX</button>
                                        ` : `
                                            <button type="button" data-action="restore" data-index="${idx}" class="px-2 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">Restore</button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                function applyInhouseVisualState(enabled) {
                    if (!inhouseBlockEl) return;
                    inhouseBlockEl.classList.toggle('opacity-40', !enabled);
                    inhouseBlockEl.classList.toggle('pointer-events-none', !enabled);
                    // Keep block visible if has contacts or name even when disabled? For clarity we hide when off and empty.
                    const hasData = (inhouseNameEl && inhouseNameEl.value.trim()) || inhouseContacts.length;
                    if (!enabled && !hasData) inhouseBlockEl.classList.add('hidden'); else inhouseBlockEl.classList.remove('hidden');
                    // Disable all inputs inside when not enabled
                    inhouseBlockEl.querySelectorAll('input,select,button,textarea').forEach(el => {
                        if (el.id === 'inhouse-av-enabled') return;
                        el.disabled = !enabled;
                    });
                }
                applyInhouseVisualState(!!inhouse.enabled);
                inhouseEnabledEl?.addEventListener('change', async () => {
                    const enabled = inhouseEnabledEl.checked;
                    applyInhouseVisualState(enabled);
                    const doc = { 'inhouse-av': { enabled, name: inhouseNameEl?.value || '', contacts: inhouseContacts } };
                    await updateSurveyData(doc, true);
                });

                inhouseNameEl?.addEventListener('input', async () => {
                    const doc = { 'inhouse-av': { enabled: inhouseEnabledEl?.checked || false, name: inhouseNameEl.value, contacts: inhouseContacts } };
                    await updateSurveyData(doc, false);
                });

                inhouseAddBtn?.addEventListener('click', async () => {
                    const name = section.querySelector('#inhouse-contact-name').value.trim();
                    const title = section.querySelector('#inhouse-contact-title').value.trim();
                    const email = section.querySelector('#inhouse-contact-email').value.trim();
                    const phone = section.querySelector('#inhouse-contact-phone').value.trim();
                    const phoneType = section.querySelector('#inhouse-contact-phone-type').value;
                    // Ensure block enabled
                    if (inhouseEnabledEl && !inhouseEnabledEl.checked) {
                        inhouseEnabledEl.checked = true;
                        applyInhouseVisualState(true);
                    }
                    // Create new contact object (even if blank to allow modal entry)
                    const newContact = { name, title, email, phone, phoneType, excluded: false };
                    inhouseContacts.push(newContact);
                    renderInhouseContacts();
                    // Persist immediately so modal edits have an id slot
                    const doc = { 'inhouse-av': { enabled: inhouseEnabledEl?.checked || false, name: inhouseNameEl?.value || '', contacts: inhouseContacts } };
                    await updateSurveyData(doc, true);
                    // Clear inline form fields
                    section.querySelector('#inhouse-contact-name').value = '';
                    section.querySelector('#inhouse-contact-title').value = '';
                    section.querySelector('#inhouse-contact-email').value = '';
                    section.querySelector('#inhouse-contact-phone').value = '';
                    section.querySelector('#inhouse-contact-phone-type').value = 'cell';
                    // Open unified contact editor for the newly added contact
                    window.openContactEditor(inhouseContacts, inhouseContacts.length - 1, 'inhouse_av');
                });

                inhouseListEl?.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const idx = parseInt(btn.getAttribute('data-index'), 10);
                    const action = btn.getAttribute('data-action');
                    if (Number.isNaN(idx) || !inhouseContacts[idx]) return;
                    if (action === 'edit') {
                        window.openContactEditor(inhouseContacts, idx, 'inhouse_av');
                    } else if (action === 'exclude') {
                        const user = window.currentUserEmail || currentUserName || 'Unknown user';
                        const ts = new Date().toLocaleString();
                        const origTitle = inhouseContacts[idx].title || '';
                        const exTitle = origTitle.startsWith('EX-') ? origTitle : `EX-${origTitle}`;
                        inhouseContacts[idx] = { ...inhouseContacts[idx], excluded: true, title: exTitle, note: `Edited by ${user} on ${ts}` };
                        renderInhouseContacts();
                        const doc = { 'inhouse-av': { enabled: inhouseEnabledEl?.checked || false, name: inhouseNameEl?.value || '', contacts: inhouseContacts } };
                        await updateSurveyData(doc, true);
                    } else if (action === 'restore') {
                        const { excluded, note, ...rest } = inhouseContacts[idx];
                        const cleanTitle = (rest.title || '').replace(/^EX-/, '');
                        inhouseContacts[idx] = { ...rest, title: cleanTitle, excluded: false };
                        renderInhouseContacts();
                        const doc = { 'inhouse-av': { enabled: inhouseEnabledEl?.checked || false, name: inhouseNameEl?.value || '', contacts: inhouseContacts } };
                        await updateSurveyData(doc, true);
                    }
                });

                // Initial render
                renderInhouseContacts();
                // If inhouse is enabled, ensure block visible
                if (inhouseEnabledEl?.checked) inhouseBlockEl?.classList.remove('hidden');

                // Initial render
                renderContacts();
            });
        }

        function renderLogisticsSection(data) {
            const section = document.getElementById('logistics');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Venue & Access Logistics</h2>
                    <p class="text-gray-600 mb-6">Document all logistical details for load-in, load-out, and internal freight movement.</p>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-bold mb-4">Dock & Trailer Access</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="dock-location" class="form-label">Dock Location/Street Access</label><input type="text" id="dock-location" class="form-input" placeholder="e.g., Accessed from Main Street on the north side" value="${data['dock-location'] || ''}"></div>
                                <div><label for="dock-door-height" class="form-label">Dock Door Height</label><input type="text" id="dock-door-height" class="form-input" placeholder="e.g., 14' high" value="${data['dock-door-height'] || ''}"></div>
                                <div>
                                    <label class="form-label">Can it accommodate a 53' semi trailer?</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="trailer-53-support" value="yes" ${data['trailer-53-support'] === 'yes' ? 'checked' : ''}> Yes</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="trailer-53-support" value="no" ${data['trailer-53-support'] === 'no' ? 'checked' : ''}> No</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="trailer-53-support" value="unconfirmed" ${data['trailer-53-support'] === 'unconfirmed' || !data['trailer-53-support'] ? 'checked' : ''}> Unconfirmed</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">Can a cab remain attached without blocking traffic?</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="cab-parking" value="yes" ${data['cab-parking'] === 'yes' ? 'checked' : ''}> Yes</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="cab-parking" value="no" ${data['cab-parking'] === 'no' ? 'checked' : ''}> No</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="cab-parking" value="unconfirmed" ${data['cab-parking'] === 'unconfirmed' || !data['cab-parking'] ? 'checked' : ''}> Unconfirmed</label>
                                    </div>
                                </div>
                            </div>
                            ${createPhotoUploadArea('logistics', 'dock-access')}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Equipment & Ramps</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="num-dock-spaces" class="form-label">Number of Dock Spaces</label><input type="number" id="num-dock-spaces" class="form-input" placeholder="e.g., 3" value="${data['num-dock-spaces'] || ''}"></div>
                                <div>
                                    <label class="form-label">Dock Plate Available?</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-plate-type" value="motorized" ${data['dock-plate-type'] === 'motorized' ? 'checked' : ''}> Motorized</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-plate-type" value="manual" ${data['dock-plate-type'] === 'manual' ? 'checked' : ''}> Manual</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-plate-type" value="none" ${data['dock-plate-type'] === 'none' || !data['dock-plate-type'] ? 'checked' : ''}> None</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">Ramp Available?</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="ramp-available" value="yes" ${data['ramp-available'] === 'yes' ? 'checked' : ''}> Yes</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="ramp-available" value="no" ${data['ramp-available'] === 'no' || !data['ramp-available'] ? 'checked' : ''}> No</label>
                                    </div>
                                </div>
                                <div><label for="ramp-dimensions" class="form-label">Ramp Dimensions</label><input type="text" id="ramp-dimensions" class="form-input" placeholder="e.g., 6'W x 20'L" value="${data['ramp-dimensions'] || ''}"></div>
                            </div>
                            ${createPhotoUploadArea('logistics', 'equipment-ramps')}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Access & Coordination</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="dock-access-process" class="form-label">Process for Accessing the Dock</label><input type="text" id="dock-access-process" class="form-input" placeholder="e.g., Ring doorbell, check in with security" value="${data['dock-access-process'] || ''}"></div>
                                <div><label for="dock-coordinator" class="form-label">Dock Access Coordinator</label><input type="text" id="dock-coordinator" class="form-input" placeholder="e.g., Building Manager Jane Doe - 555-123-4567" value="${data['dock-coordinator'] || ''}"></div>
                                <div class="md:col-span-2">
                                    <label class="form-label">Dock Schedule</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-schedule" value="first-come" ${data['dock-schedule'] === 'first-come' || !data['dock-schedule'] ? 'checked' : ''}> First-Come, First-Served</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-schedule" value="scheduled" ${data['dock-schedule'] === 'scheduled' ? 'checked' : ''}> Scheduled</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Freight Elevator & Internal Movement</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="freight-elevator-distance" class="form-label">Distance from Dock to Freight Elevator</label><input type="text" id="freight-elevator-distance" class="form-input" placeholder="e.g., 150' straight shot" value="${data['freight-elevator-distance'] || ''}"></div>
                                <div><label for="freight-elevator-dimensions" class="form-label">Freight Elevator Dimensions & Weight Capacity</label><input type="text" id="freight-elevator-dimensions" class="form-input" placeholder="e.g., 8'W x 10'D x 8'H, 5,000 lbs" value="${data['freight-elevator-dimensions'] || ''}"></div>
                                <div class="md:col-span-2"><label for="max-item-size" class="form-label">Tallest & Longest Item that can be moved</label><textarea id="max-item-size" rows="3" class="form-input" placeholder="e.g., 7' tall, 10' long. Notes: Hallway turns are tight past the kitchen.">${data['max-item-size'] || ''}</textarea></div>
                            </div>
                            ${createPhotoUploadArea('logistics', 'freight-elevator')}
                        </div>
                        
                        <!-- Room Access Scheduling Section -->
                        <div>
                            <h3 class="text-xl font-bold mb-4">Room Access Schedule</h3>
                            <p class="text-gray-600 mb-4">Specify access times for each room being used during the event.</p>
                            
                            <!-- Load existing venue rooms if available -->
                            <div id="venue-rooms-selector" class="mb-6"></div>
                            
                            <!-- Room access table -->
                            <div id="room-access-container">
                                <div class="mb-4 flex justify-between items-center">
                                    <h4 class="text-lg font-semibold">Selected Rooms & Access Times</h4>
                                    <button type="button" id="add-room-access-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">
                                        Add Room Access
                                    </button>
                                </div>
                                <div id="room-access-list" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>`;
                
                section.querySelectorAll('.form-input, .form-checkbox, textarea').forEach(input => input.addEventListener('input', handleFormChange));
                
                // Setup photo upload functionality
                setupPhotoUploadListeners(section);
                
                // Setup room access functionality
                setupRoomAccess(data);
                
                // Render existing photos
                const photos = data.photos || {};
                renderPhotos('logistics-dock-access', photos['logistics-dock-access']);
                renderPhotos('logistics-equipment-ramps', photos['logistics-equipment-ramps']);
                renderPhotos('logistics-freight-elevator', photos['logistics-freight-elevator']);
            });
        }

        function renderRoomsSection(data) {
            const section = document.getElementById('rooms');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                const rooms = data.rooms || [];
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Rooms & Spaces</h2>
                    <p class="text-gray-600 mb-6">Add rooms and their technical specifications. All data is saved in real-time for the team to see.</p>
                    <form id="rooms-form" class="relative p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-6">
                        <!-- Top-right Add Room button (inline inside form) -->
                        <button id="rooms-add-top" type="submit" class="hidden md:block absolute top-4 right-4 bg-teal-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-teal-700">Add Room</button>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div><label for="room-type" class="form-label">Room Type</label><select id="room-type" class="form-input" required><option>General Session</option><option>Breakout Room</option><option>Exhibit Hall</option><option>Registration</option><option>Office</option><option>Green Room</option><option>Other</option></select></div>
                            <div><label for="room-name" class="form-label">Room Name</label><input type="text" id="room-name" class="form-input" placeholder="e.g., Ballroom A" required></div>
                            <div><label for="room-capacity" class="form-label">Capacity</label><input type="number" id="room-capacity" class="form-input" placeholder="e.g., 150"></div>
                            <div><label for="room-layout" class="form-label">Layout Style</label><select id="room-layout" class="form-input"><option value="">Select...</option><option>Theater</option><option>Classroom</option><option>Rounds</option><option>U-Shape</option><option>Conference</option><option>Banquet</option><option>Reception</option><option>Other</option></select></div>
                        </div>
                        <div class="space-y-4 pt-4 border-t border-gray-200 mt-4">
                            <h3 class="font-semibold text-lg">Technical & A/V Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="room-dimensions" class="form-label">Dimensions (L x W)</label><input type="text" id="room-dimensions" class="form-input" placeholder="e.g., 50' x 75'"></div>
                                <div><label for="room-ceiling-height" class="form-label">Ceiling Height</label><input type="text" id="room-ceiling-height" class="form-input" placeholder="e.g., 20'"></div>
                                <div><label for="room-electrical" class="form-label">Available Electrical</label><input type="text" id="room-electrical" class="form-input" placeholder="e.g., 4x 20A Circuits, 1x 50A Panel"></div>
                                <div><label for="room-rigging" class="form-label">Rigging Options</label><input type="text" id="room-rigging" class="form-input" placeholder="e.g., Limited grid, 500 lbs per point"></div>
                                <div><label for="room-sound-patch" class="form-label">Sound Patch</label><input type="text" id="room-sound-patch" class="form-input" placeholder="e.g., Yes, at FOH location"></div>
                                <div><label for="room-door-size" class="form-label">Largest Door Access Size</label><input type="text" id="room-door-size" class="form-input" placeholder="e.g., 7'W x 8'H"></div>
                            </div>
                        </div>
                        <div class="space-y-4 pt-4 border-t border-gray-200 mt-4">
                            <h3 class="font-semibold text-lg">Connectivity Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="form-checkbox-label"><input type="checkbox" id="room-wifi-available" class="form-checkbox"> Wi-Fi Available</label></div>
                                <div><label class="form-checkbox-label"><input type="checkbox" id="room-hardline-available" class="form-checkbox"> Hardline Available</label></div>
                                <div><label for="room-wifi-notes" class="form-label">Wi-Fi Notes</label><textarea id="room-wifi-notes" rows="3" class="form-input"></textarea></div>
                                <div><label for="room-hardline-notes" class="form-label">Hardline Notes</label><textarea id="room-hardline-notes" rows="3" class="form-input"></textarea></div>
                                <div class="md:col-span-2"><label for="room-misc-notes" class="form-label">Miscellaneous Notes</label><textarea id="room-misc-notes" rows="3" class="form-input"></textarea></div>
                            </div>
                        </div>
                        <div class="space-y-4 pt-4 border-t border-gray-200 mt-4">
                            <h3 class="font-semibold text-lg">Room Photos</h3>
                            ${createPhotoUploadArea('new-room', 'photos')}
                        </div>
                        <div class="flex justify-end pt-4"><button type="submit" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-teal-700">Add Room</button></div>
                    </form>
                    <div id="rooms-list" class="space-y-6 mt-8"></div>
                `;

                const roomsListEl = section.querySelector('#rooms-list');
                roomsListEl.innerHTML = ''; 
                if (rooms.length === 0) {
                    roomsListEl.innerHTML = '<p class="text-gray-500 text-center">No rooms added yet. Use the form above to add one.</p>';
                } else {
                    const photos = data.photos || {};
                    const groupedRooms = rooms.reduce((acc, room) => {
                        (acc[room.type] = acc[room.type] || []).push(room);
                        return acc;
                    }, {});

                    Object.keys(groupedRooms).sort().forEach(type => {
                        const roomTypeSection = document.createElement('div');
                        roomTypeSection.innerHTML = `<h3 class="text-xl font-bold text-gray-800 mb-2">${type} Rooms</h3><div class="space-y-4 mb-6"></div>`;
                        const container = roomTypeSection.querySelector('div');
                        
                        groupedRooms[type].forEach(room => {
                            const roomElement = document.createElement('div');
                            roomElement.className = 'bg-gray-100 p-4 rounded-lg border border-gray-200 shadow-sm draggable-room';
                            roomElement.setAttribute('draggable','true');
                            roomElement.dataset.roomId = room.id;
                            roomElement.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                            <span class="cursor-move inline-block text-gray-400 drag-handle" title="Drag to reorder" aria-label="Drag to reorder">☰</span>
                                            ${room.name}
                                        </h4>
                                        ${room.capacity ? `<p class="text-sm text-gray-600">Capacity: ${room.capacity}${room.layout ? ` | Layout: ${room.layout}` : ''}</p>` : ''}
                                    </div>
                                    <div class="flex gap-2">
                                        <button data-room-id="${room.id}" class="edit-room-btn text-blue-500 hover:text-blue-700 p-1 rounded-full" title="Edit room">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                            </svg>
                                        </button>
                                        <button data-room-id="${room.id}" class="delete-room-btn text-red-500 hover:text-red-700 p-1 rounded-full" title="Delete room">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600 grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <p><strong>Dimensions:</strong> ${room.dimensions || 'N/A'}</p>
                                    <p><strong>Ceiling Height:</strong> ${room.ceilingHeight || 'N/A'}</p>
                                    <p><strong>Electrical:</strong> ${room.electrical || 'N/A'}</p>
                                    <p><strong>Rigging:</strong> ${room.rigging || 'N/A'}</p>
                                    <p><strong>Sound Patch:</strong> ${room.soundPatch || 'N/A'}</p>
                                    <p><strong>Door Size:</strong> ${room.doorSize || 'N/A'}</p>
                                    <div class="md:col-span-2 mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <div><p><strong>Wi-Fi:</strong> ${room.wifiAvailable ? 'Yes' : 'No'}</p><p class="text-xs pl-2">${room.wifiNotes || ''}</p></div>
                                        <div><p><strong>Hardline:</strong> ${room.hardlineAvailable ? 'Yes' : 'No'}</p><p class="text-xs pl-2">${room.hardlineNotes || ''}</p></div>
                                    </div>
                                    <div class="md:col-span-2 mt-2"><p><strong>Notes:</strong> ${room.miscNotes || 'N/A'}</p></div>
                                </div>
                                ${createPhotoUploadArea('rooms', room.id)}`;
                            container.appendChild(roomElement);
                            
                            // Setup photo functionality for this room
                            setupPhotoUploadListeners(roomElement);
                            renderPhotos(`rooms-${room.id}`, photos[`rooms-${room.id}`]);
                        });
                        roomsListEl.appendChild(roomTypeSection);
                    });
                    // Attach drag/drop listeners (once per render)
                    initRoomDragAndDrop();
                }

                section.querySelector('#rooms-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    
                    const roomData = {
                        type: form['room-type'].value,
                        name: form['room-name'].value,
                        capacity: parseInt(form['room-capacity'].value) || null,
                        layout: form['room-layout'].value,
                        dimensions: form['room-dimensions'].value,
                        ceilingHeight: form['room-ceiling-height'].value,
                        electrical: form['room-electrical'].value,
                        rigging: form['room-rigging'].value,
                        soundPatch: form['room-sound-patch'].value,
                        doorSize: form['room-door-size'].value,
                        wifiAvailable: form['room-wifi-available'].checked,
                        hardlineAvailable: form['room-hardline-available'].checked,
                        wifiNotes: form['room-wifi-notes'].value,
                        hardlineNotes: form['room-hardline-notes'].value,
                        miscNotes: form['room-misc-notes'].value,
                    };
                    
                    let updatedRooms;
                    
                    if (editingRoomId) {
                        // Editing existing room
                        roomData.id = editingRoomId;
                        updatedRooms = rooms.map(room => room.id === editingRoomId ? roomData : room);
                        logActivity(`Updated room: "${roomData.name}"`);
                        
                        // Handle photos for edited room
                        const currentData = await getCurrentSurveyData();
                        const photos = currentData.photos || {};
                        const newRoomPhotos = photos['new-room-photos'] || [];
                        
                        if (newRoomPhotos.length > 0) {
                            // Move photos from new-room area to the actual room
                            photos[`rooms-${editingRoomId}`] = [...(photos[`rooms-${editingRoomId}`] || []), ...newRoomPhotos];
                            delete photos['new-room-photos'];
                            await updateSurveyData({ photos });
                        }
                        
                        cancelRoomEdit();
                    } else {
                        // Adding new room
                        roomData.id = `room_${Date.now()}`;
                        updatedRooms = [...rooms, roomData];
                        logActivity(`Added room: "${roomData.name}"`);
                        
                        // Handle photos for new room
                        const currentData = await getCurrentSurveyData();
                        const photos = currentData.photos || {};
                        const newRoomPhotos = photos['new-room-photos'] || [];
                        
                        if (newRoomPhotos.length > 0) {
                            photos[`rooms-${roomData.id}`] = newRoomPhotos;
                            delete photos['new-room-photos'];
                            await updateSurveyData({ photos });
                        }
                        
                        form.reset();
                        // focus first logical text field after adding
                        setTimeout(()=>{ try { form['room-name'].focus(); } catch(_){} },0);
                    }
                    
                    updateSurveyData({ rooms: updatedRooms });
                    
                    // Auto-save venue data
                    setTimeout(autoSaveVenueData, 1000);
                });
                
                // Setup photo upload for room form
                setupPhotoUploadListeners(section);
                
                // Setup edit room listeners
                setupRoomEditListeners(section);
                
                // Render photos for new room area
                const photos = data.photos || {};
                renderPhotos('new-room-photos', photos['new-room-photos'] || []);

                // Removed floating FAB. Top-right button inside form submits via the same handler.

                section.querySelectorAll('.delete-room-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const roomIdToDelete = btn.dataset.roomId;
                        const roomToDelete = rooms.find(r => r.id === roomIdToDelete);
                        
                        if (!roomToDelete) return;
                        
                        const confirmed = confirm(`Are you sure you want to delete the room "${roomToDelete.name}"? This will also delete all associated photos.`);
                        
                        if (!confirmed) return;
                        
                        const updatedRooms = rooms.filter(r => r.id !== roomIdToDelete);
                        
                        // Also delete photos for this room
                        const currentData = await getCurrentSurveyData();
                        const photos = currentData.photos || {};
                        const roomPhotos = photos[`rooms-${roomIdToDelete}`] || [];
                        
                        // Delete photos from storage
                        for (const photo of roomPhotos) {
                            try {
                                await deletePhoto(photo.id);
                            } catch (error) {
                                console.error('Error deleting room photo:', error);
                            }
                        }
                        
                        // Remove photos from database
                        delete photos[`rooms-${roomIdToDelete}`];
                        
                        await updateSurveyData({ rooms: updatedRooms, photos });
                        logActivity(`Deleted room: "${roomToDelete.name}"`);
                        
                        // Auto-save venue data
                        setTimeout(autoSaveVenueData, 1000);
                    });
                });

                // --- Drag & Drop Reorder Implementation ---
                function initRoomDragAndDrop(){
                    const draggables = section.querySelectorAll('.draggable-room');
                    let dragSrc = null;
                    draggables.forEach(el => {
                        el.addEventListener('dragstart', e => {
                            dragSrc = el;
                            e.dataTransfer.effectAllowed = 'move';
                            el.classList.add('opacity-50');
                        });
                        el.addEventListener('dragend', () => {
                            el.classList.remove('opacity-50');
                        });
                        el.addEventListener('dragover', e => {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';
                        });
                        el.addEventListener('drop', async e => {
                            e.preventDefault();
                            if (!dragSrc || dragSrc===el) return;
                            // Insert before target
                            const parent = el.parentElement; // type container
                            if (parent && dragSrc.parentElement===parent){
                                parent.insertBefore(dragSrc, el);
                            } else {
                                // Different type sections: place before target's section element
                                try { el.parentElement.insertBefore(dragSrc, el); } catch(_){}
                            }
                            await persistRoomOrder();
                        });
                    });
                }
                async function persistRoomOrder(){
                    // Collect new order by DOM appearance
                    const all = Array.from(section.querySelectorAll('.draggable-room'));
                    if (!all.length) return;
                    const map = new Map(rooms.map(r=>[r.id,r]));
                    const reordered = all.map((el, idx) => ({ ...map.get(el.dataset.roomId), position: idx }));
                    await updateSurveyData({ rooms: reordered }, true);
                    logActivity('Reordered rooms');
                }
            });
        }
        
        function renderVenueGuidelinesSection(data) {
            const section = document.getElementById('venue-guidelines');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                const guidelinesData = data.guidelines || {};
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Venue Guidelines Processor</h2>
                    <div id="guidelines-content"></div>`;

                const contentEl = section.querySelector('#guidelines-content');
                if (guidelinesData.results) {
                    const processedAt = guidelinesData.processedAt ? new Date(guidelinesData.processedAt).toLocaleString() : 'Unknown';
                    const processedBy = guidelinesData.processedBy || 'Unknown';
                    
                    contentEl.innerHTML = `
                        <div id="processing-results" class="space-y-10">
                            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-green-600">✅</span>
                                        <span class="font-medium text-gray-800">AI Processing Complete</span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        Processed by ${processedBy} on ${processedAt}
                                    </div>
                                </div>
                                <div class="mt-4 flex flex-wrap gap-2">
                                    <button id="open-guidelines-split-editor-btn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Open Split Editor</button>
                                    <button id="reprocess-guidelines-btn" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">Reprocess (no edit)</button>
                                </div>
                            </div>
                            <div id="results-container" class="space-y-6">
                                <div class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg shadow-md">
                                    <h2 class="text-2xl font-bold mb-4 text-blue-800">📅 Due Dates & Deadlines</h2>
                                    ${guidelinesData.results.dueDates.length > 0 ? 
                                        `<ul class="list-disc pl-5 space-y-3">${guidelinesData.results.dueDates.map(item => `<li><span class="font-semibold">${item.task}:</span> <span class="bg-blue-200 text-blue-800 px-2 py-1 rounded-full text-sm">${item.dueDate}</span></li>`).join('')}</ul>` :
                                        `<p class="text-blue-700">No specific due dates found in the guidelines.</p>`
                                    }
                                </div>
                                <div class="bg-green-50 border-l-4 border-green-600 p-6 rounded-lg shadow-md">
                                    <h2 class="text-2xl font-bold mb-4 text-green-800">📋 Important Information</h2>
                                    ${guidelinesData.results.importantInfo.length > 0 ?
                                        `<ul class="list-disc pl-5 space-y-3">${guidelinesData.results.importantInfo.map(item => `<li>${item}</li>`).join('')}</ul>` :
                                        `<p class="text-green-700">No specific important information extracted.</p>`
                                    }
                                </div>
                            </div>
                            <div class="bg-gray-100 p-6 rounded-lg shadow-inner mt-10">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800">📄 Original Guidelines</h3>
                                <div class="bg-gray-200 p-4 rounded-lg max-h-60 overflow-y-auto font-mono text-sm whitespace-pre-wrap">${guidelinesData.originalText}</div>
                                <button id="reset-guidelines-btn" class="mt-4 w-full py-2 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600">Process New Document</button>
                            </div>
                            <div id="guidelines-split-editor" class="hidden"></div>
                        </div>`;
                } else {
                    // Check if AI is available to show appropriate message
                    const aiAvailable = aiSystemEnabled && openAIKey;
                    const statusMessage = aiAvailable 
                        ? "Paste your venue's regulations below. Our AI will extract key information and due dates, and save them for the whole team to see."
                        : "⚠️ AI processing is not available. Please contact an administrator to enable AI features. You can still paste guidelines manually for reference.";
                    
                    const statusClass = aiAvailable ? "text-gray-600" : "text-orange-600 bg-orange-50 border border-orange-200 rounded-lg p-3";
                    
                    contentEl.innerHTML = `
                        <p class="${statusClass} mb-6 text-center max-w-2xl mx-auto">${statusMessage}</p>
                        <textarea id="guidelines-text" class="w-full p-4 border rounded-lg min-h-[300px] font-mono text-sm" placeholder="Paste guidelines here...">${guidelinesData.originalText || ''}</textarea>
                        <div id="error-container" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                        <button id="process-guidelines-btn" class="mt-6 w-full py-3 text-white font-bold ${aiAvailable ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'} rounded-lg" ${!aiAvailable ? 'disabled' : ''}>
                            ${aiAvailable ? '🤖 Extract Key Info & Due Dates with AI' : '🚫 AI Processing Unavailable'}
                        </button>
                        <div id="loading-indicator" class="hidden flex items-center justify-center p-10"><div class="loader h-10 w-10 border-4 border-blue-600 border-t-transparent rounded-full"></div><p class="ml-4">Processing with AI...</p></div>`;
                }

                const processBtn = section.querySelector('#process-guidelines-btn');
                if(processBtn) processBtn.addEventListener('click', handleGuidelinesProcessing);
                const resetBtn = section.querySelector('#reset-guidelines-btn');
                if(resetBtn) resetBtn.addEventListener('click', () => { updateSurveyData({ guidelines: {} }); logActivity('Reset Venue Guidelines processor.'); });
                const reprocessQuickBtn = section.querySelector('#reprocess-guidelines-btn');
                if(reprocessQuickBtn) reprocessQuickBtn.addEventListener('click', async () => { const original = guidelinesData.originalText || ''; await reprocessGuidelines(original, guidelinesData); });
                const openSplitBtn = section.querySelector('#open-guidelines-split-editor-btn');
                if(openSplitBtn) openSplitBtn.addEventListener('click', () => openGuidelinesSplitEditor(guidelinesData));

                function openGuidelinesSplitEditor(current) {
                    if (!aiSystemEnabled || !openAIKey) { showNotification('AI not available for split editor', 'error'); return; }
                    const host = section.querySelector('#guidelines-split-editor');
                    host.classList.remove('hidden');
                    host.innerHTML = `
                        <div class="border border-gray-300 rounded-lg p-4 space-y-4 bg-white shadow-sm focus:outline-none" role="dialog" aria-modal="true" aria-labelledby="guidelines-split-editor-title" aria-describedby="guidelines-split-editor-desc">
                            <div class="flex flex-wrap justify-between items-center gap-3">
                                <h3 id="guidelines-split-editor-title" class="text-lg font-semibold">Split Editor & Diff</h3>
                                <div id="guidelines-split-editor-desc" class="text-xs text-gray-500">Compare & update extracted data after edits. Press Esc to close. Ctrl+Enter to reprocess.</div>
                                <button id="guidelines-cancel-edit" class="ml-auto px-2 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded" aria-label="Close split editor">✕</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-medium mb-2">Editable Guidelines Text</h4>
                                    <textarea id="guidelines-edit-text" class="w-full h-80 p-3 border rounded font-mono text-sm" aria-label="Editable guidelines text">${(current.originalText||'').replace(/`/g,'&#96;')}</textarea>
                                    <div class="flex flex-wrap gap-2 mt-3">
                                        <button id="guidelines-reprocess-updated" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" aria-label="Reprocess updated text (Ctrl+Enter)">Reprocess Updated Text</button>
                                        <button id="guidelines-reprocess-updated-quick" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700" aria-label="Reprocess without saving edits preview" hidden>Quick Reprocess</button>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-medium mb-2">Parsed Results Diff</h4>
                                    <div id="guidelines-diff-legend" class="flex flex-wrap gap-2 text-xs mb-2" aria-label="Diff legend">
                                        <span class="px-2 py-1 rounded bg-green-100 text-green-800">Added</span>
                                        <span class="px-2 py-1 rounded bg-red-100 text-red-800">Removed</span>
                                        <span class="px-2 py-1 rounded bg-gray-100 text-gray-700">Unchanged</span>
                                    </div>
                                    <div id="guidelines-diff-live" class="sr-only" aria-live="polite"></div>
                                    <div id="guidelines-diff-results" class="space-y-4 text-sm" tabindex="0" aria-label="Diff results"></div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 pt-2 border-t">Accessibility: Tab cycles within editor. Esc closes.</div>
                        </div>`;
                    host.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    const dialog = host.querySelector('[role="dialog"]');
                    const cancelBtn = host.querySelector('#guidelines-cancel-edit');
                    cancelBtn.addEventListener('click', ()=> closeSplitEditor());
                    const reprocessBtn = host.querySelector('#guidelines-reprocess-updated');
                    reprocessBtn.addEventListener('click', async () => {
                        const newText = host.querySelector('#guidelines-edit-text').value.trim();
                        if (!newText) { showNotification('Please enter guidelines text', 'error'); return; }
                        await reprocessGuidelines(newText, current, host.querySelector('#guidelines-diff-results'));
                    });
                    // Focus management
                    const firstFocus = host.querySelector('#guidelines-edit-text');
                    if (firstFocus) firstFocus.focus();
                    function getFocusables(){
                        return Array.from(dialog.querySelectorAll('button, [href], textarea, input, select, [tabindex]:not([tabindex="-1"])'))
                            .filter(el=> !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
                    }
                    dialog.addEventListener('keydown', e => {
                        if (e.key === 'Escape') { e.stopPropagation(); closeSplitEditor(); }
                        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { reprocessBtn.click(); }
                        if (e.key === 'Tab') {
                            const f = getFocusables(); if (!f.length) return; const idx = f.indexOf(document.activeElement); let next = idx + (e.shiftKey ? -1 : 1);
                            if (next < 0) { next = f.length -1; e.preventDefault(); f[next].focus(); }
                            else if (next >= f.length){ next = 0; e.preventDefault(); f[next].focus(); }
                        }
                    });
                    function closeSplitEditor(){ host.classList.add('hidden'); }
                }

                async function reprocessGuidelines(text, previous, diffContainer) {
                    try {
                        showNotification('Reprocessing guidelines...', 'info');
                        if (!aiSystemEnabled || !openAIKey) throw new Error('AI disabled');
                        if (diffContainer) diffContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Processing...</div>';
                        const prompt = `You are an expert event planning assistant. Analyze the following venue guidelines and extract IMPORTANT INFO and DUE DATES. Respond ONLY valid JSON with keys importantInfo (array) and dueDates (array of {task,dueDate}).\n\n${text}`;
                        const response = await fetch('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: { 'Authorization': `Bearer ${openAIKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'gpt-3.5-turbo', messages: [ { role:'system', content:'You are an expert event planning assistant.' }, { role:'user', content: prompt } ], response_format:{ type:'json_object' }, temperature:0.3, max_tokens: 1800 }) });
                        if (!response.ok) throw new Error('API error '+response.status);
                        const json = await response.json();
                        const content = json.choices?.[0]?.message?.content || '{}';
                        let parsed = {};
                        try { parsed = JSON.parse(content); } catch(_){ throw new Error('Invalid JSON from AI'); }
                        parsed.importantInfo = Array.isArray(parsed.importantInfo) ? parsed.importantInfo : [];
                        parsed.dueDates = Array.isArray(parsed.dueDates) ? parsed.dueDates : [];
                        const prevInfo = previous.results?.importantInfo || [];
                        const prevDue = previous.results?.dueDates || [];
                        const infoDiff = diffSimpleArray(prevInfo, parsed.importantInfo);
                        const dueDiff = diffDueDates(prevDue, parsed.dueDates);
                        if (diffContainer) diffContainer.innerHTML = renderDiffHTML(infoDiff, dueDiff);
                        const live = document.getElementById('guidelines-diff-live');
                        if (live) {
                            const addedInfo = infoDiff.filter(i=>i.state==='added').length;
                            const removedInfo = infoDiff.filter(i=>i.state==='removed').length;
                            const addedDue = dueDiff.filter(i=>i.state==='added').length;
                            const removedDue = dueDiff.filter(i=>i.state==='removed').length;
                            live.textContent = `Diff updated: ${addedInfo} info added, ${removedInfo} removed; ${addedDue} due dates added, ${removedDue} removed.`;
                        }
                        const newGuidelines = { originalText: text, results: parsed, processedAt: new Date().toISOString(), processedBy: window.currentUserEmail || currentUserName };
                        await updateSurveyData({ guidelines: newGuidelines });
                        logActivity('Reprocessed venue guidelines via split editor');
                        showNotification('Guidelines reprocessed & saved', 'success');
                    } catch(e) {
                        console.error('Reprocess error', e);
                        showNotification('Failed to reprocess: '+e.message, 'error');
                        if (diffContainer) diffContainer.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded">${e.message}</div>`;
                    }
                }
                function diffSimpleArray(before, after) {
                    const beforeSet = new Set(before); const afterSet = new Set(after); const items = [];
                    before.forEach(item => { if (afterSet.has(item)) items.push({ value:item, state:'unchanged' }); else items.push({ value:item, state:'removed' }); });
                    after.forEach(item => { if (!beforeSet.has(item)) items.push({ value:item, state:'added' }); });
                    return items;
                }
                function diffDueDates(before, after) {
                    const key = o => (o.task||'')+'|'+(o.dueDate||''); const beforeMap = new Map(before.map(o=>[key(o), o])); const afterMap = new Map(after.map(o=>[key(o), o])); const items = [];
                    before.forEach(o => { if (afterMap.has(key(o))) items.push({ value:o, state:'unchanged' }); else items.push({ value:o, state:'removed' }); });
                    after.forEach(o => { if (!beforeMap.has(key(o))) items.push({ value:o, state:'added' }); });
                    return items;
                }
                function renderDiffHTML(infoDiff, dueDiff) {
                    const badge = st => st==='added' ? 'bg-green-100 text-green-800' : st==='removed' ? 'bg-red-100 text-red-800 line-through' : 'bg-gray-100 text-gray-700';
                    const infoHtml = infoDiff.length ? `<ul class="space-y-1">${infoDiff.map(i=>`<li class="px-2 py-1 rounded ${badge(i.state)}">${i.value}</li>`).join('')}</ul>` : '<p class="text-gray-500">No important info</p>';
                    const dueHtml = dueDiff.length ? `<ul class="space-y-1">${dueDiff.map(i=>`<li class="px-2 py-1 rounded ${badge(i.state)}"><span class="font-medium">${i.value.task}</span>: ${i.value.dueDate||'N/A'}</li>`).join('')}</ul>` : '<p class="text-gray-500">No due dates</p>';
                    return `<div class="space-y-6"><div><h5 class="font-semibold mb-2">Due Dates</h5>${dueHtml}</div><div><h5 class="font-semibold mb-2">Important Info</h5>${infoHtml}</div></div>`;
                }
            });
        }

        async function handleGuidelinesProcessing() {
            const guidelinesTextarea = document.getElementById('guidelines-text');
            const guidelinesText = guidelinesTextarea.value.trim();
            const errorContainer = document.getElementById('error-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const processBtn = document.getElementById('process-guidelines-btn');

            if (!guidelinesText) {
                errorContainer.textContent = 'Please paste some text to process.';
                errorContainer.classList.remove('hidden');
                return;
            }

            // Check if AI system is available
            if (!aiSystemEnabled || !openAIKey) {
                errorContainer.textContent = 'AI system is not available. Please contact an administrator to enable AI features.';
                errorContainer.classList.remove('hidden');
                return;
            }

            errorContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            guidelinesTextarea.disabled = true;
            processBtn.disabled = true;

            const prompt = `You are an expert event planning assistant. Analyze the following venue guidelines and extract:

1. Important information that event planners need to know
2. Tasks with specific due dates or deadlines

Please provide your response in JSON format with:
- "importantInfo": array of key venue rules, restrictions, requirements, and policies
- "dueDates": array of objects with "task" and "dueDate" properties for any deadlines mentioned

Venue Guidelines:
${guidelinesText}

Focus on practical information that would affect event planning, setup, logistics, and operations.`;
            
            try {
                console.log('Processing venue guidelines with OpenAI...');
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openAIKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert event planning assistant. Always respond with valid JSON.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.3,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`OpenAI API Error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                const aiResponse = result.choices[0].message.content;
                console.log('OpenAI response:', aiResponse);
                
                let parsedData;
                try {
                    parsedData = JSON.parse(aiResponse);
                } catch (parseError) {
                    console.error('Failed to parse AI response:', parseError);
                    throw new Error('AI response was not valid JSON. Please try again.');
                }

                // Ensure we have the expected structure
                if (!parsedData.importantInfo) parsedData.importantInfo = [];
                if (!parsedData.dueDates) parsedData.dueDates = [];

                const guidelinesResult = {
                    originalText: guidelinesText,
                    results: parsedData,
                    processedAt: new Date().toISOString(),
                    processedBy: window.currentUserEmail || currentUserName
                };

                await updateSurveyData({ guidelines: guidelinesResult });
                logActivity('Processed venue guidelines with AI assistant.');
                showNotification('Venue guidelines processed successfully!', 'success');

            } catch (e) {
                console.error("Error processing guidelines:", e);
                errorContainer.textContent = `Failed to process guidelines: ${e.message}`;
                errorContainer.classList.remove('hidden');
                showNotification('Failed to process venue guidelines. Please try again.', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                guidelinesTextarea.disabled = false;
                processBtn.disabled = false;
            }
        }

        function renderWrapUpSection(data) {
            const section = document.getElementById('wrap-up');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Wrap-Up & Recommendations</h2>
                    <p class="text-gray-600 mb-6">Conclude the survey by summarizing your key findings, listing actionable items, and providing an overall assessment.</p>
                    <div class="space-y-6">
                        <div><label for="key-findings" class="form-label">Key Findings</label><textarea id="key-findings" name="key-findings" rows="5" class="form-input" placeholder="Summarize the most important points...">${data['key-findings'] || ''}</textarea></div>
                        <div><label for="action-items" class="form-label">Action Items</label><textarea id="action-items" name="action-items" rows="5" class="form-input" placeholder="List specific tasks that need to be addressed...">${data['action-items'] || ''}</textarea></div>
                        <div><label for="assessment" class="form-label">Overall Assessment</label><textarea id="assessment" name="assessment" rows="3" class="form-input" placeholder="Provide a final recommendation...">${data['assessment'] || ''}</textarea></div>
                        ${createPhotoUploadArea('wrap-up', 'final-documentation')}
                    </div>`;
                
                section.querySelectorAll('.form-input, textarea').forEach(input => input.addEventListener('input', handleFormChange));
                
                // Setup photo upload functionality
                setupPhotoUploadListeners(section);
                
                // Render existing photos
                const photos = data.photos || {};
                renderPhotos('wrap-up-final-documentation', photos['wrap-up-final-documentation']);
            });
        }
        
        // --- MODIFIED SUMMARY SECTION ---
        function renderSummaryExportSection(data) {
            const section = document.getElementById('summary-export');
            if (!section) return;

            preserveFocusAndRender(section, () => {
                const na = '<span class="text-gray-400">N/A</span>';
                
                // Helper for Logistics radio buttons
                const formatRadio = (value) => {
                    if (!value) return na;
                    return value.charAt(0).toUpperCase() + value.slice(1).replace('-', ' ');
                };
                
                // Render Rooms
                const rooms = data.rooms || [];
                const photos = data.photos || {};
                let roomsHtml = `<p class="text-gray-500">No rooms have been added.</p>`;
                if (rooms.length > 0) {
                     roomsHtml = Object.entries(rooms.reduce((acc, room) => {
                        (acc[room.type] = acc[room.type] || []).push(room);
                        return acc;
                    }, {})).map(([type, roomList]) => `
                        <div class="mb-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">${type} Rooms</h4>
                            ${roomList.map(room => {
                                const roomPhotos = photos[`rooms-${room.id}`] || [];
                                const photoHtml = roomPhotos.length > 0 ? `
                                    <div class="mt-2">
                                        <h6 class="text-sm font-medium text-gray-600 mb-1">📸 Photos:</h6>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            ${roomPhotos.map(photo => `<img src="${photo.url}" alt="${photo.name}" class="w-full h-20 object-cover rounded border">`).join('')}
                                        </div>
                                    </div>
                                ` : '';
                                
                                return `
                                    <div class="p-3 mb-2 border-l-4 border-gray-200 bg-gray-50 rounded-r-lg">
                                        <h5 class="font-bold text-gray-800">${room.name || na}</h5>
                                        <dl class="mt-1 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Dimensions:</dt><dd class="text-gray-800">${room.dimensions || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Ceiling:</dt><dd class="text-gray-800">${room.ceilingHeight || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Electrical:</dt><dd class="text-gray-800">${room.electrical || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Rigging:</dt><dd class="text-gray-800">${room.rigging || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Sound Patch:</dt><dd class="text-gray-800">${room.soundPatch || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Largest Door:</dt><dd class="text-gray-800">${room.doorSize || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Wi-Fi:</dt><dd class="text-gray-800">${room.wifiAvailable ? `Yes (${room.wifiNotes || 'No notes'})` : 'No'}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Hardline:</dt><dd class="text-gray-800">${room.hardlineAvailable ? `Yes (${room.hardlineNotes || 'No notes'})` : 'No'}</dd></div>
                                            <div class="col-span-full flex"><dt class="w-28 font-medium text-gray-500">Misc Notes:</dt><dd class="text-gray-800">${room.miscNotes || na}</dd></div>
                                        </dl>
                                        ${photoHtml}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `).join('');
                }

                // Helper function to create photo section for summary
                const createPhotoSummary = (sectionName, title) => {
                    const sectionPhotos = photos[sectionName] || [];
                    if (sectionPhotos.length === 0) return '';
                    
                    return `
                        <div class="mt-3">
                            <h5 class="text-sm font-medium text-gray-600 mb-2">📸 ${title} Photos:</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                ${sectionPhotos.map(photo => `<img src="${photo.url}" alt="${photo.name}" class="w-full h-20 object-cover rounded border">`).join('')}
                            </div>
                        </div>
                    `;
                };

                // Render Venue Guidelines
                const guidelinesData = data.guidelines || {};
                let guidelinesHtml = `<p class="text-gray-500">No venue guidelines have been processed.</p>`;
                if (guidelinesData.results) {
                    guidelinesHtml = `
                        <div class="mb-2">
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">Important Information</h4>
                            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-800">${guidelinesData.results.importantInfo.map(item => `<li>${item}</li>`).join('') || na}</ul>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">Due Dates</h4>
                            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-800">${guidelinesData.results.dueDates.map(item => `<li><strong>${item.task}:</strong> ${item.dueDate}</li>`).join('') || na}</ul>
                        </div>
                    `;
                }

                section.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Event Summary: ${appId}</h2>
                        <button id="print-summary-btn" class="no-print bg-teal-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-teal-700 transition-colors">Print Summary</button>
                    </div>
                    <div id="summary-content" class="space-y-6 text-sm">
                        
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Event Information</h3>
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Event Name:</dt><dd>${data['event-name'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">R2 Quote Number:</dt><dd>${data['r2-quote-number'] || data['r2-number'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Status:</dt><dd>${data['status'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Anticipated Attendees:</dt><dd>${data['anticipated-attendees'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Indoor/Outdoor:</dt><dd>${data['indoor-outdoor'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Charge Days:</dt><dd>${data['charge-days'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Budget:</dt><dd>${data['budget'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Business:</dt><dd>${data['client-business'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Name:</dt><dd>${data['client-name'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Cell:</dt><dd>${data['client-cell'] ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"tel:${data['client-cell']}\">${data['client-cell']}</a>` : na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Email:</dt><dd>${data['client-email'] ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"mailto:${data['client-email']}\">${data['client-email']}</a>` : na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Company:</dt><dd>${data['client-company'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Address:</dt><dd>${data['client-address'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Tax Status:</dt><dd>${data['tax-status'] || na}</dd></div>
                                <div class="col-span-full h-2"></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-700">Event Contact</dt></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Name:</dt><dd>${data['event-contact-name'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Title:</dt><dd>${data['event-contact-title'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Email:</dt><dd>${data['event-contact-email'] ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"mailto:${data['event-contact-email']}\">${data['event-contact-email']}</a>` : na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Phone:</dt><dd>${data['event-contact-phone'] ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"tel:${data['event-contact-phone']}\">${data['event-contact-phone']}</a>` : na}</dd></div>
                            </dl>
                        </div>

                        ${(Array.isArray(data['client-contacts']) && data['client-contacts'].length > 0) ? `
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Client Contacts</h3>
                            <ul class="space-y-1">
                                ${[...data['client-contacts']].sort((a,b) => Number(!!a.excluded) - Number(!!b.excluded)).map(c => {
                                    const excluded = !!c.excluded;
                                    const t = c.title || '';
                                    const displayTitle = excluded && t ? `EX-${t.replace(/^EX-/, '')}` : t;
                                    const email = c.email ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"mailto:${c.email}\">${c.email}</a>` : '';
                                    const phone = c.phone ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"tel:${c.phone}\">${c.phone}</a>` : '';
                                    const isPrimary = data['client-email'] && c.email === data['client-email'];
                                    const badge = isPrimary ? ' <span class=\"ml-1 px-1.5 py-0.5 text-[10px] rounded bg-teal-600 text-white\">PRIMARY</span>' : '';
                                    const line = `${c.name || ''}${badge}${displayTitle ? ' — ' + displayTitle : ''}${email ? ' — ' + email : ''}${phone ? ' — ' + phone : ''}${c.phoneType ? ' (' + c.phoneType + ')' : ''}`;
                                    const note = c.note ? `<div class="text-xs text-gray-500">${c.note}</div>` : '';
                                    return `<li class="${excluded ? 'line-through text-gray-500' : ''}">${line}${note}</li>`;
                                }).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Event Schedule</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Activity</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Date</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Time</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Load in</td><td class="border border-gray-300 px-4 py-2">${data['load-in-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['load-in-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['load-in-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Setup</td><td class="border border-gray-300 px-4 py-2">${data['setup-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['setup-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['setup-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Rehearsal</td><td class="border border-gray-300 px-4 py-2">${data['rehearsal-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['rehearsal-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['rehearsal-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Show Start</td><td class="border border-gray-300 px-4 py-2">${data['show-start-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['show-start-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['show-start-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Show End</td><td class="border border-gray-300 px-4 py-2">${data['show-end-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['show-end-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['show-end-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Strike</td><td class="border border-gray-300 px-4 py-2">${data['strike-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['strike-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['strike-notes'] || na}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${(data.agendaFiles && data.agendaFiles.length > 0) ? `
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Event Agenda Files</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${data.agendaFiles.map(file => `
                                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded border">
                                        <div class="flex-shrink-0">${getFileIcon(file.type)}</div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                                            <p class="text-xs text-gray-500">${formatFileSize(file.size)} • ${new Date(file.uploadedAt).toLocaleDateString()}</p>
                                        </div>
                                        <a href="${file.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View</a>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Venue Information</h3>
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Venue Name:</dt><dd>${data['venue-name'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Venue Address:</dt><dd>${data['venue-address'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Survey Date:</dt><dd>${data['survey-date'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Survey Completed by:</dt><dd>${data['survey-team'] || na}</dd></div>
                                ${Array.isArray(data['survey-team-members']) && data['survey-team-members'].length > 0 ? `
                                <div class="md:col-span-2">
                                    <dt class="w-32 font-semibold text-gray-600">Additional Team:</dt>
                                    <dd>
                                        <ul class="list-disc ml-5">
                                            ${data['survey-team-members'].map(m => `<li>${m.name || ''}${m.role ? ` — <span class=\"text-gray-600\">${m.role}</span>` : ''}</li>`).join('')}
                                        </ul>
                                    </dd>
                                </div>` : ''}
                            </dl>
                        </div>

                        ${(Array.isArray(data['venue-contacts']) && data['venue-contacts'].length > 0) ? `
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Venue Contacts</h3>
                            <ul class="space-y-1">
                                ${[...data['venue-contacts']].sort((a,b) => Number(!!a.excluded) - Number(!!b.excluded)).map(c => {
                                    const excluded = !!c.excluded;
                                    const t = c.title || '';
                                    const displayTitle = excluded && t ? `EX-${t.replace(/^EX-/, '')}` : t;
                                    const email = c.email ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"mailto:${c.email}\">${c.email}</a>` : '';
                                    const phone = c.phone ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"tel:${c.phone}\">${c.phone}</a>` : '';
                                    const line = `${c.name || ''}${displayTitle ? ' — ' + displayTitle : ''}${email ? ' — ' + email : ''}${phone ? ' — ' + phone : ''}${c.phoneType ? ' (' + c.phoneType + ')' : ''}`;
                                    const note = c.note ? `<div class="text-xs text-gray-500">${c.note}</div>` : '';
                                    return `<li class="${excluded ? 'line-through text-gray-500' : ''}">${line}${note}</li>`;
                                }).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${(data['inhouse-av']) ? (() => {
                            const av = data['inhouse-av'] || {};
                            const enabled = !!av.enabled;
                            const name = av.name || '';
                            const contacts = Array.isArray(av.contacts) ? av.contacts : [];
                            return `
                            <div class="p-4 border rounded-lg bg-white">
                                <h3 class="text-xl font-bold mb-3 border-b pb-2">In-House AV</h3>
                                <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                    <div class="flex"><dt class="w-40 font-semibold text-gray-600">In-House AV Provided?</dt><dd>${enabled ? 'Yes' : 'No'}</dd></div>
                                    ${enabled || name ? `<div class=\"flex\"><dt class=\"w-40 font-semibold text-gray-600\">Company Name:</dt><dd>${name || '—'}</dd></div>` : ''}
                                </dl>
                                ${contacts.length > 0 ? `
                                    <div class="mt-3">
                                        <h4 class="text-md font-semibold text-gray-700 mb-2">Contacts</h4>
                                        <ul class="space-y-1">
                                            ${[...contacts].sort((a,b) => Number(!!a.excluded) - Number(!!b.excluded)).map(c => {
                                                const excluded = !!c.excluded;
                                                const t = c.title || '';
                                                const displayTitle = excluded && t ? `EX-${t.replace(/^EX-/, '')}` : t;
                                                const email = c.email ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"mailto:${c.email}\">${c.email}</a>` : '';
                                                const phone = c.phone ? `<a class=\"text-blue-600 hover:text-blue-800\" href=\"tel:${c.phone}\">${c.phone}</a>` : '';
                                                const line = `${c.name || ''}${displayTitle ? ' — ' + displayTitle : ''}${email ? ' — ' + email : ''}${phone ? ' — ' + phone : ''}${c.phoneType ? ' (' + c.phoneType + ')' : ''}`;
                                                const note = c.note ? `<div class=\"text-xs text-gray-500\">${c.note}</div>` : '';
                                                return `<li class=\"${excluded ? 'line-through text-gray-500' : ''}\">${line}${note}</li>`;
                                            }).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>`;
                        })() : ''}

                        ${(data.roomAccess && data.roomAccess.length > 0) ? `
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Room Access Schedule</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Room</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Date</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Start Time</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">End Time</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.roomAccess.map(access => `
                                            <tr>
                                                <td class="border border-gray-300 px-4 py-2 font-medium">${access.roomName}</td>
                                                <td class="border border-gray-300 px-4 py-2">${access.accessDate || na}</td>
                                                <td class="border border-gray-300 px-4 py-2">${access.accessTime || na}</td>
                                                <td class="border border-gray-300 px-4 py-2">${access.accessEndTime || na}</td>
                                                <td class="border border-gray-300 px-4 py-2">${access.accessNotes || na}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Venue & Access Logistics</h3>
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Dock Location:</dt><dd class="pl-4">${data['dock-location'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Dock Door Height:</dt><dd>${data['dock-door-height'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Number of Dock Spaces:</dt><dd>${data['num-dock-spaces'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Accommodates 53' semi?</dt><dd>${formatRadio(data['trailer-53-support'])}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Cab can remain attached?</dt><dd>${formatRadio(data['cab-parking'])}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Dock Plate:</dt><dd>${formatRadio(data['dock-plate-type'])}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Ramp Available?</dt><dd>${data['ramp-available'] === 'yes' ? 'Yes' : 'No'}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Ramp Dimensions:</dt><dd class="pl-4">${data['ramp-dimensions'] || na}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Dock Access Process:</dt><dd class="pl-4">${data['dock-access-process'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Dock Coordinator:</dt><dd>${data['dock-coordinator'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Dock Schedule:</dt><dd>${formatRadio(data['dock-schedule'])}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Distance to Freight Elevator:</dt><dd class="pl-4">${data['freight-elevator-distance'] || na}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Freight Elevator Dimensions:</dt><dd class="pl-4">${data['freight-elevator-dimensions'] || na}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Max Item Size for Movement:</dt><dd class="pl-4">${data['max-item-size'] || na}</dd></div>
                            </dl>
                            ${createPhotoSummary('logistics-dock-access', 'Dock Access')}
                            ${createPhotoSummary('logistics-equipment-ramps', 'Equipment & Ramps')}
                            ${createPhotoSummary('logistics-freight-elevator', 'Freight Elevator')}
                        </div>

                         <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Rooms & Spaces</h3>
                            ${roomsHtml}
                        </div>

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Venue Guidelines</h3>
                            ${guidelinesHtml}
                        </div>

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Wrap-Up & Recommendations</h3>
                            <div class="space-y-4">
                                <div><h4 class="font-semibold text-gray-600">Key Findings:</h4><p class="mt-1 pl-4 whitespace-pre-wrap">${data['key-findings'] || na}</p></div>
                                <div><h4 class="font-semibold text-gray-600">Action Items:</h4><p class="mt-1 pl-4 whitespace-pre-wrap">${data['action-items'] || na}</p></div>
                                <div><h4 class="font-semibold text-gray-600">Overall Assessment:</h4><p class="mt-1 pl-4 whitespace-pre-wrap">${data['assessment'] || na}</p></div>
                            </div>
                            ${createPhotoSummary('wrap-up-final-documentation', 'Final Documentation')}
                        </div>
                    </div>
                `;

                section.querySelector('#print-summary-btn').addEventListener('click', () => {
                    const printableContent = section.querySelector('#summary-content').innerHTML;
                    const printableArea = document.getElementById('printable-area');
                    printableArea.innerHTML = `<div class="p-8">${printableContent}</div>`;
                    window.print();
                });
            });
        }

        function renderActivityLog(activityData) {
            const section = document.getElementById('activity');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `<h2 class="text-2xl font-bold mb-6 border-b pb-3">Activity Log</h2><div id="activity-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>`;
                const activityList = section.querySelector('#activity-list');
                if (!activityList) return;
                if (activityData.length === 0) {
                    activityList.innerHTML = '<p class="text-gray-500 text-center">No activity yet. Changes to the form will be logged here.</p>';
                    return;
                }
                activityList.innerHTML = '';
                activityData.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm';
                    const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'Loading...';
                    
                    // Enhanced display for change summaries
                    let descriptionHtml = `<p>${log.description}</p>`;
                    if (log.changes && log.changes.length > 1) {
                        descriptionHtml = `
                            <p class="mb-2">${log.description}</p>
                            <details class="text-sm">
                                <summary class="cursor-pointer text-blue-600 hover:text-blue-800">View details (${log.changes.length} changes)</summary>
                                <ul class="mt-2 ml-4 space-y-1">
                                    ${log.changes.map(change => `<li class="text-gray-700">• ${change}</li>`).join('')}
                                </ul>
                            </details>
                        `;
                    }
                    
                    logElement.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-semibold text-gray-800">${log.user_name || 'Anonymous'}</p>
                            <p class="text-sm text-gray-500">${timestamp}</p>
                        </div>
                        <p class="text-xs font-mono text-gray-400 mb-2">Email: ${log.user_email}${log.section ? ` • Section: ${log.section}` : ''}</p>
                        ${descriptionHtml}`;
                    activityList.appendChild(logElement);
                });
            });
        }      

    </script>

    <!-- Authentication & Authorization Script -->
    <script type="module">
        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: "1a7bd6d9-44d3-489c-9f71-0541a0a38b5c", // Replace with your Azure App Registration Client ID
                authority: "https://login.microsoftonline.com/ce2e8146-47b9-4422-a1a4-f107d68b5803", // Replace with your tenant ID
                redirectUri: "https://ita.com/wp-content/themes/utech-child/Surveys-Beta/site-survey.html" // Must match Azure AD exactly
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        // Login request configuration
        const loginRequest = {
            scopes: ["User.Read", "profile", "openid", "email"]
        };

        // Initialize MSAL instance
        let msalInstance;
        let currentUser = null;

        // User roles mapping
        const userRoles = {
            'alex.greene@ita.com': 'admin'
            // Additional roles will be stored in Firebase
        };

        // Initialize authentication
        async function initAuth() {
            try {
                // For Live Server development - check if we're in localhost
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log('Development mode - bypassing Microsoft SSO');
                    // Create mock user for development
                    currentUser = {
                        account: {
                            username: 'alex.greene@ita.com',
                            name: 'Alex Greene (Dev)',
                            idTokenClaims: {
                                email: 'alex.greene@ita.com'
                            }
                        }
                    };
                    
                    // Immediately show main app and hide auth container for development
                    showMainApp();
                    
                    // Set up the authenticated user
                    window.currentUserEmail = 'alex.greene@ita.com';
                    window.currentUserName = 'Alex Greene (Dev)';
                    window.currentUserRole = 'admin';
                    
                    // Update UI
                    updateUserInterface('Alex Greene (Dev)', 'alex.greene@ita.com', 'admin');
                    
                    // Track user session in development mode
                    await trackUserSession('alex.greene@ita.com', 'Alex Greene (Dev)', 'admin');
                    
                    // Initialize the survey app
                    initializeSurveyApp();
                    return;
                }

                // Production mode - use real Microsoft SSO
                // Wait for MSAL to be available
                let attempts = 0;
                while (typeof msal === 'undefined' && attempts < 100) {
                    console.log(`Waiting for MSAL to load... attempt ${attempts + 1}`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof msal === 'undefined') {
                    console.error('MSAL library failed to load after waiting');
                    alert('Authentication library failed to load. Please refresh the page and try again.');
                    return;
                }
                
                console.log('MSAL is available, initializing...');
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();

                // Check if user is already logged in
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentUser = { account: accounts[0] };
                    await handleSuccessfulLogin();
                } else {
                    showAuthContainer();
                }
            } catch (error) {
                console.error('Auth initialization error:', error);
                showAuthContainer();
            }
        }

        // Handle Microsoft login
        async function handleMicrosoftLogin() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Development bypass
                return;
            }

            try {
                // Check if MSAL is available
                if (typeof msal === 'undefined') {
                    alert('Authentication library is not loaded. Please refresh the page and try again.');
                    return;
                }
                
                // Check if msalInstance is initialized
                if (!msalInstance) {
                    alert('Authentication system is not initialized. Please refresh the page and try again.');
                    return;
                }
                
                showAuthLoading();
                console.log('Attempting Microsoft login with config:', {
                    clientId: msalConfig.auth.clientId,
                    authority: msalConfig.auth.authority,
                    redirectUri: msalConfig.auth.redirectUri,
                    currentUrl: window.location.href
                });
                
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                currentUser = loginResponse;
                await handleSuccessfulLogin();
            } catch (error) {
                console.error('Login error details:', error);
                console.error('Error code:', error.errorCode);
                console.error('Error message:', error.errorMessage);
                console.error('Current URL:', window.location.href);
                console.error('Configured redirect URI:', msalConfig.auth.redirectUri);
                
                hideAuthLoading();
                
                // More detailed error message
                let errorMsg = 'Login failed. ';
                if (error.errorCode === 'redirect_uri_mismatch') {
                    errorMsg += 'The redirect URI does not match what is configured in Azure AD. ';
                    errorMsg += `Expected: ${msalConfig.auth.redirectUri}, Current: ${window.location.href}`;
                } else if (error.errorCode) {
                    errorMsg += `Error: ${error.errorCode} - ${error.errorMessage}`;
                } else {
                    errorMsg += 'Please check the browser console for details and try again.';
                }
                
                alert(errorMsg);
            }
        }

        // Handle successful login
        async function handleSuccessfulLogin() {
            try {
                // Get user info
                const email = currentUser.account.idTokenClaims?.email || currentUser.account.username;
                const name = currentUser.account.name || email;
                
                // Determine user role
                const role = await getUserRoleFromDatabase(email);
                
                // Update UI
                updateUserInterface(name, email, role);
                
                // Track user session
                await trackUserSession(email, name, role);
                
                // Initialize AI system (wait for database to be ready)
                setTimeout(async () => {
                    if (window.db) {
                        try {
                            // Wait for the main module functions to be available
                            let attempts = 0;
                            while (!window.checkAISystemStatus && attempts < 50) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                attempts++;
                            }
                            
                            if (window.checkAISystemStatus) {
                                await window.checkAISystemStatus();
                                if (window.updateAIButtonVisibility) {
                                    window.updateAIButtonVisibility();
                                }
                            }
                        } catch (error) {
                            console.warn('AI initialization skipped:', error);
                        }
                    }
                }, 1000);
                
                // Show main application
                showMainApp();
                
                // Initialize the existing survey application
                initializeSurveyApp();
                
            } catch (error) {
                console.error('Post-login setup error:', error);
                alert('Setup failed. Please refresh and try again.');
            }
        }

        // Get user role from Supabase or default mapping
        async function getUserRoleFromDatabase(email) {
            try {
                // Try to get role from Supabase using the database function
                const supabase = window.supabaseClient || window.supabase;
                if (!supabase) {
                    console.error('Database not available for role lookup');
                    // Fallback to hardcoded admin check
                    return email === 'alex.greene@ita.com' ? 'admin' : 'user';
                }
                
                const { data: userRole, error } = await supabase.rpc('get_or_create_user_role', {
                    user_email: email
                });
                
                if (!error && userRole) {
                    return userRole;
                }
                
                // If the function doesn't exist, fallback to direct table lookup
                const { data: roleData, error: roleError } = await supabase
                    .from('user_roles')
                    .select('role')
                    .eq('email', email)
                    .single();
                
                if (roleData && !roleError) {
                    return roleData.role || 'user';
                }
                
                // Final fallback - check hardcoded admin
                if (email === 'alex.greene@ita.com') {
                    return 'admin';
                }
                
                // Default role
                return 'user';
            } catch (error) {
                console.error('Error getting user role:', error);
                // Fallback to hardcoded admin check
                return email === 'alex.greene@ita.com' ? 'admin' : 'user';
            }
        }

        // Update user interface based on role
        function updateUserInterface(name, email, role) {
            // Update user display in both headers (dashboard + survey)
            const displayNameEls = document.querySelectorAll('#dashboard-header #user-display-name, #survey-header #user-display-name');
            const roleEls = document.querySelectorAll('#dashboard-header #user-role, #survey-header #user-role');
            const avatarEls = document.querySelectorAll('#dashboard-header #user-avatar, #survey-header #user-avatar');
            displayNameEls.forEach(el => el.textContent = name);
            roleEls.forEach(el => el.textContent = role.charAt(0).toUpperCase() + role.slice(1));
            const parts = (name || '').trim().split(/\s+/);
            const initials = parts.length >= 2 ? (parts[0][0] + parts[parts.length - 1][0]) : (parts[0] ? parts[0][0] : 'U');
            avatarEls.forEach(el => el.textContent = initials.toUpperCase());

            // Update dropdown elements in both headers
            const dropdownNameEls = document.querySelectorAll('#dashboard-header #dropdown-user-name, #survey-header #dropdown-user-name');
            const dropdownEmailEls = document.querySelectorAll('#dashboard-header #dropdown-user-email, #survey-header #dropdown-user-email');
            dropdownNameEls.forEach(el => el.textContent = name);
            dropdownEmailEls.forEach(el => el.textContent = email);
            
            // Show admin indicator if admin (both headers)
            const dashboardAdminChip = document.querySelector('#dashboard-header #admin-indicator');
            const surveyAdminBanner = document.getElementById('admin-banner');
            const surveyDropdownAdminChip = document.querySelector('#survey-header #admin-indicator');
            const adminSections = document.querySelectorAll('#dashboard-header #admin-section, #survey-header #admin-section');
            if (role === 'admin') {
                dashboardAdminChip?.classList.remove('hidden');
                surveyAdminBanner?.classList.remove('hidden');
                surveyDropdownAdminChip?.classList.remove('hidden');
                adminSections.forEach(el => el.classList.remove('hidden'));
            } else {
                dashboardAdminChip?.classList.add('hidden');
                surveyAdminBanner?.classList.add('hidden');
                surveyDropdownAdminChip?.classList.add('hidden');
                adminSections.forEach(el => el.classList.add('hidden'));
            }
            
            // Store current user info globally
            window.currentUserEmail = email;
            window.currentUserName = name;
            window.currentUserRole = role;
        }

        // Track user session in Firebase
        async function trackUserSession(email, name, role) {
            try {
                console.log('Tracking user session:', { email, name, role });
                
                const supabase = window.supabaseClient || window.supabase;
                if (!supabase) {
                    console.error('Database not available after waiting');
                    // Set role locally without database
                    window.currentUserRole = email === 'alex.greene@ita.com' ? 'admin' : 'user';
                    return;
                }
                
                // Use the upsert_user_session function to handle role assignment
                const { data, error } = await supabase.rpc('upsert_user_session', {
                    user_email: email,
                    user_name: name
                });
                
                if (error) {
                    console.error('Error tracking user session:', error);
                    console.log('Database tables may not exist yet. Please run the supabase_tables.sql script.');
                    // Fallback to direct insert if function doesn't exist
                    const { error: fallbackError } = await supabase
                        .from('user_sessions')
                        .upsert({
                            email: email,
                            name: name,
                            role: email === 'alex.greene@ita.com' ? 'admin' : 'user',
                            last_active: new Date().toISOString(),
                            login_time: new Date().toISOString()
                        }, {
                            onConflict: 'email'
                        });
                    
                    if (fallbackError) {
                        console.log('Database tables not available - continuing without session tracking');
                        // Set role locally without database
                        window.currentUserRole = email === 'alex.greene@ita.com' ? 'admin' : 'user';
                    } else {
                        console.log('User session tracked successfully (fallback)');
                        // Update the current user role based on the database or default logic
                        window.currentUserRole = email === 'alex.greene@ita.com' ? 'admin' : 'user';
                    }
                } else {
                    console.log('User session tracked successfully');
                    // The function returns the actual role from the database
                    window.currentUserRole = data || (email === 'alex.greene@ita.com' ? 'admin' : 'user');
                }
            } catch (error) {
                console.error('Error tracking session:', error);
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                // Remove from active sessions
                if (window.currentUserEmail) {
                    const db = window.db;
                    if (db) {
                        await deleteDoc(doc(db, 'activeSessions', window.currentUserEmail));
                    }
                }
                
                // Logout from MSAL if not in development
                if (msalInstance && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    await msalInstance.logoutPopup();
                }
                
                // Reset state
                currentUser = null;
                window.currentUserEmail = null;
                window.currentUserName = null;
                window.currentUserRole = null;
                
                // Show auth container
                showAuthContainer();
                
            } catch (error) {
                console.error('Logout error:', error);
                location.reload(); // Force reload on error
            }
        }

        // Set user role (admin only) - WordPress version
        async function setUserRole(email, role) {
            if (!checkAccess('manageUsers')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            try {
                // Use WordPress REST API
                const response = await fetch('/wp-json/site-survey/v1/user-roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-WP-Nonce': window.wpNonce || ''
                    },
                    body: JSON.stringify({
                        email: email,
                        role: mapToWordPressRole(role)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`User role set successfully: ${email} -> ${role}`);
                    loadUserRolesList(); // Refresh user roles display
                    logActivity(`Updated user role: ${email} is now ${role}`);
                } else {
                    throw new Error(result.message || 'Failed to update user role');
                }
                
            } catch (error) {
                console.error('Error setting user role:', error);
                
                // Fallback: Show manual instructions
                const manualInstructions = `
WordPress Admin Instructions:
1. Go to WordPress Admin → Users
2. Find user: ${email}
3. Edit user and change role to: ${mapToWordPressRole(role)}
4. Or use WordPress Admin → Tools → Site Survey Users

Error: ${error.message}
                `;
                
                if (confirm('Automatic role update failed. Would you like to see manual instructions?')) {
                    alert(manualInstructions);
                }
                
                // Log for admin reference
                logActivity(`MANUAL ACTION NEEDED: Set ${email} role to ${role} - Auto-update failed`);
            }
        }

        async function loadUserRolesList() {
            if (!checkAccess('manageUsers')) return;
            
            try {
                // Try to load from WordPress first
                const response = await fetch('/wp-json/site-survey/v1/users', {
                    headers: {
                        'X-WP-Nonce': window.wpNonce || ''
                    }
                });
                
                let users = [];
                
                if (response.ok) {
                    const wpUsers = await response.json();
                    users = wpUsers.map(user => ({
                        email: user.email,
                        role: mapFromWordPressRole(user.roles[0]),
                        name: user.name,
                        updatedBy: 'WordPress',
                        updatedAt: user.date
                    }));
                } else {
                    // Fallback to mock data
                    users = [
                        {
                            email: 'alex.greene@ita.com',
                            role: 'admin',
                            name: 'Alex Greene',
                            updatedBy: 'System',
                            updatedAt: new Date().toISOString()
                        }
                    ];
                }
                
                const container = document.getElementById('user-roles-list');
                if (!container) return;
                
                if (users.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No user roles defined yet</p>';
                    return;
                }
                
                container.innerHTML = users.map(user => `
                    <div class="flex justify-between items-center p-2 bg-white rounded border">
                        <div>
                            <span class="font-medium">${user.email}</span>
                            <span class="text-sm text-gray-500 ml-2 px-2 py-1 rounded ${getRoleColorClass(user.role)}">${user.role.toUpperCase()}</span>
                            ${user.name ? `<br><small class="text-gray-400">${user.name}</small>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editUserRole('${user.email}', '${user.role}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                Edit
                            </button>
                            <button onclick="removeUserRole('${user.email}')" class="text-red-600 hover:text-red-800 text-sm">
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading user roles:', error);
                const container = document.getElementById('user-roles-list');
                if (container) {
                    container.innerHTML = `
                        <div class="p-2 bg-yellow-50 border border-yellow-200 rounded">
                            <p class="text-sm text-yellow-800">
                                Unable to load users from WordPress. 
                                <a href="/wp-admin/tools.php?page=site-survey-users" target="_blank" class="underline">
                                    Manage users in WordPress Admin
                                </a>
                            </p>
                        </div>
                    `;
                }
            }
        }
        
        function editUserRole(email, currentRole) {
            const emailInput = document.getElementById('role-email');
            const roleSelect = document.getElementById('role-select');
            
            if (emailInput) emailInput.value = email;
            if (roleSelect) roleSelect.value = currentRole;
        }
        
        function getRoleColorClass(role) {
            switch(role) {
                case 'admin': return 'bg-red-100 text-red-800';
                case 'manager': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        async function removeUserRole(email) {
            if (!checkAccess('manageUsers')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            if (!confirm(`Remove survey access for ${email}? They will lose access to the site survey system.`)) {
                return;
            }
            
            try {
                // In WordPress, we'll change their role to 'subscriber' (basic user)
                await setUserRole(email, 'user'); // This will map to basic subscriber role
                logActivity(`Removed site survey access: ${email}`);
                loadUserRolesList(); // Refresh display
                
            } catch (error) {
                console.error('Error removing user role:', error);
                alert('Failed to remove user role: ' + error.message);
            }
        }

        // Make functions globally accessible
        window.removeUserRole = removeUserRole;
        window.editUserRole = editUserRole;

        // Load active users for admin panel
        async function loadActiveUsers() {
            console.log('Loading active users...');
            try {
                const db = window.db;
                if (!db) {
                    console.error('Database not initialized');
                    const activeUsersList = document.getElementById('active-users-list');
                    if (activeUsersList) {
                        activeUsersList.innerHTML = '<p class="text-red-500">Database not available</p>';
                    }
                    return;
                }
                
                const activeSessions = await getDocs(query(collection(db, 'activeSessions'), orderBy('lastActive', 'desc')));
                const activeUsersList = document.getElementById('active-users-list');
                
                if (!activeUsersList) {
                    console.error('Active users list element not found');
                    return;
                }
                
                console.log('Active sessions found:', activeSessions.size);
                
                if (activeSessions.empty) {
                    activeUsersList.innerHTML = '<p class="text-gray-500">No active users</p>';
                    return;
                }
                
                activeUsersList.innerHTML = '';
                activeSessions.forEach(doc => {
                    const session = doc.data();
                    console.log('Session data:', session);
                    const userElement = document.createElement('div');
                    userElement.className = 'flex justify-between items-center p-2 bg-white rounded border';
                    userElement.innerHTML = `
                        <div>
                            <div class="font-medium">${session.name}</div>
                            <div class="text-sm text-gray-500">${session.email}</div>
                            <div class="text-xs text-blue-600">${session.role}</div>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${session.lastActive ? new Date(session.lastActive.seconds * 1000).toLocaleString() : 'Unknown'}
                        </div>
                    `;
                    activeUsersList.appendChild(userElement);
                });
            } catch (error) {
                console.error('Error loading active users:', error);
                const activeUsersList = document.getElementById('active-users-list');
                if (activeUsersList) {
                    activeUsersList.innerHTML = '<p class="text-red-500">Error loading users</p>';
                }
            }
        }

        // Load survey records for admin panel
        async function loadSurveyRecords() {
            console.log('Loading survey records...');
            try {
                const db = window.db;
                if (!db) {
                    console.error('Database not initialized');
                    const surveyRecords = document.getElementById('survey-records');
                    if (surveyRecords) {
                        surveyRecords.innerHTML = '<p class="text-red-500">Database not available</p>';
                    }
                    return;
                }
                
                // Get all artifacts (surveys)
                const artifactsSnapshot = await getDocs(collection(db, 'artifacts'));
                const surveyRecords = document.getElementById('survey-records');
                
                if (!surveyRecords) {
                    console.error('Survey records element not found');
                    return;
                }
                
                console.log('Survey records found:', artifactsSnapshot.size);
                
                if (artifactsSnapshot.empty) {
                    surveyRecords.innerHTML = '<p class="text-gray-500">No survey records found</p>';
                    return;
                }
                
                surveyRecords.innerHTML = '';
                
                for (const artifactDoc of artifactsSnapshot.docs) {
                    const artifactId = artifactDoc.id;
                    
                    try {
                        // Get the main survey data
                        const surveyDoc = await getDoc(doc(db, 'artifacts', artifactId, 'public', 'data', 'survey', 'main'));
                        
                        if (surveyDoc.exists()) {
                            const surveyData = surveyDoc.data();
                            const recordElement = document.createElement('div');
                            recordElement.className = 'p-3 bg-white rounded border mb-2 hover:bg-gray-50 cursor-pointer';
                            recordElement.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900">R2# ${artifactId}</div>
                                        <div class="text-sm text-gray-600">${surveyData['event-name'] || 'No event name'}</div>
                                        <div class="text-sm text-gray-500">${surveyData['venue-name'] || 'No venue'}</div>
                                        <div class="text-xs text-gray-400">
                                            Survey Date: ${surveyData['survey-date'] || 'Not set'}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400">
                                            Rooms: ${(surveyData.rooms || []).length}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            Photos: ${Object.keys(surveyData.photos || {}).length} sections
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Add click handler to view survey
                            recordElement.addEventListener('click', () => {
                                window.open(`?id=${encodeURIComponent(artifactId)}`, '_blank');
                            });
                            
                            surveyRecords.appendChild(recordElement);
                        }
                    } catch (docError) {
                        console.log(`No survey data for artifact ${artifactId}:`, docError);
                    }
                }
                
            } catch (error) {
                console.error('Error loading survey records:', error);
                const surveyRecords = document.getElementById('survey-records');
                if (surveyRecords) {
                    surveyRecords.innerHTML = '<p class="text-red-500">Error loading survey records</p>';
                }
            }
        }

        // UI Helper Functions
        function showAuthContainer() {
            // Only show auth container in production mode
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        }

        function showMainApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        function showAuthLoading() {
            document.getElementById('auth-content').classList.add('hidden');
            document.getElementById('auth-loading').classList.remove('hidden');
        }

        function hideAuthLoading() {
            document.getElementById('auth-content').classList.remove('hidden');
            document.getElementById('auth-loading').classList.add('hidden');
        }

        // Initialize existing survey app functionality
        function initializeSurveyApp() {
            // Wait for the main module to load before calling showWelcomeModal
            const waitForWelcomeModal = () => {
                if (window.showWelcomeModal) {
                    window.showWelcomeModal();
                } else {
                    // Wait a bit more for the module to load
                    setTimeout(waitForWelcomeModal, 100);
                }
            };
            waitForWelcomeModal();
        }

        // Check access permissions for operations
        function checkAccess(operation) {
            const role = window.currentUserRole;
            
            switch (operation) {
                case 'viewAllRecords':
                    return role === 'admin' || role === 'manager';
                case 'editAllRecords':
                    return role === 'admin';
                case 'manageUsers':
                    return role === 'admin';
                case 'createVenue':
                case 'editOwnVenue':
                    return true; // All roles can create/edit
                case 'viewVenueList':
                    return role !== 'user'; // Users can't see venue list
                default:
                    return false;
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize authentication first
            initAuth();
            
            // Auth event listeners
            document.getElementById('login-btn').addEventListener('click', handleMicrosoftLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // User menu setup handled in setupUserMenu()
            
            // Admin panel
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            const adminModal = document.getElementById('admin-modal');
            const closeAdminModal = document.getElementById('close-admin-modal');
            
            if (adminPanelBtn && adminModal) {
                adminPanelBtn.addEventListener('click', function() {
                    console.log('Admin panel button clicked');
                    adminModal.classList.remove('hidden');
                    adminModal.classList.add('flex');
                    loadActiveUsers();
                    loadSurveyRecords();
                    loadUserRolesList(); // Load user roles list
                });
            } else {
                // Not all views include an admin panel button; this is expected in some routes
                console.debug('Admin panel elements not present in this view');
            }
            
            if (closeAdminModal && adminModal) {
                closeAdminModal.addEventListener('click', function() {
                    console.log('Close admin modal clicked');
                    adminModal.classList.add('hidden');
                    adminModal.classList.remove('flex');
                });
            }
            
            // AI admin panel
            const aiAdminBtn = document.getElementById('ai-admin-btn');
            if (aiAdminBtn) {
                aiAdminBtn.addEventListener('click', function() {
                    console.log('AI admin button clicked');
                    showAISettings();
                });
            } else {
                // Optional control; safe to ignore when absent
                console.debug('AI admin button not present in this view');
            }
            
            document.getElementById('set-role-btn').addEventListener('click', function() {
                const email = document.getElementById('role-email').value;
                const role = document.getElementById('role-select').value;
                if (email && role) {
                    setUserRole(email, role);
                    document.getElementById('role-email').value = '';
                }
            });
        });

        // Update last active timestamp periodically
        setInterval(async function() {
            if (window.currentUserEmail) {
                try {
                    const db = window.db;
                    if (db) {
                        await setDoc(doc(db, 'activeSessions', window.currentUserEmail), {
                            lastActive: serverTimestamp()
                        }, { merge: true });
                    }
                } catch (error) {
                    console.error('Error updating last active:', error);
                }
            }
        }, 60000); // Every minute
    </script>

    </div> <!-- End main-app -->
</body>
<!-- Unified Contact Edit Modal -->
<div id="contact-edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
    <div class="bg-white w-full max-w-lg rounded-lg shadow-lg p-6 relative">
        <button id="contact-edit-close" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700" aria-label="Close contact editor">✕</button>
        <h3 id="contact-edit-title" class="text-xl font-semibold mb-4">Edit Contact</h3>
        <form id="contact-edit-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="form-label" for="contact-edit-name">Name</label>
                    <input id="contact-edit-name" type="text" class="form-input" />
                </div>
                <div>
                    <label class="form-label" for="contact-edit-title-input">Title</label>
                    <input id="contact-edit-title-input" type="text" class="form-input" />
                </div>
                <div>
                    <label class="form-label" for="contact-edit-email">Email</label>
                    <input id="contact-edit-email" type="email" class="form-input" />
                </div>
                <div>
                    <label class="form-label" for="contact-edit-phone">Phone</label>
                    <input id="contact-edit-phone" type="tel" class="form-input" />
                </div>
                <div>
                    <label class="form-label" for="contact-edit-phone-type">Phone Type</label>
                    <select id="contact-edit-phone-type" class="form-input">
                        <option value="cell">Cell</option>
                        <option value="office">Office</option>
                        <option value="general">General</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="form-label" for="contact-edit-note">Note</label>
                    <textarea id="contact-edit-note" class="form-input" rows="2" placeholder="Internal note for exclusion / context"></textarea>
                </div>
            </div>
            <div class="flex items-center justify-between pt-2 border-t mt-4">
                <div class="text-xs text-gray-500 space-y-1">
                    <div><span class="font-semibold">Exclude</span>: hides contact from primary lists but retains history (sets excluded=true).</div>
                    <div><span class="font-semibold">Restore</span>: makes excluded contact active again.</div>
                </div>
                <div class="flex gap-2">
                    <button type="button" id="contact-edit-exclude" class="px-3 py-1.5 rounded bg-red-600 text-white text-sm hover:bg-red-700" title="Exclude (soft hide) this contact">Exclude</button>
                    <button type="button" id="contact-edit-restore" class="px-3 py-1.5 rounded bg-gray-600 text-white text-sm hover:bg-gray-700 hidden" title="Restore previously excluded contact">Restore</button>
                    <button type="submit" class="px-4 py-1.5 rounded bg-teal-600 text-white text-sm hover:bg-teal-700">Save</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script>
// Unified Contact Edit Modal Logic
(()=>{
    const modal = document.getElementById('contact-edit-modal');
    if (!modal) return;
    const closeBtn = document.getElementById('contact-edit-close');
    const form = document.getElementById('contact-edit-form');
    const excludeBtn = document.getElementById('contact-edit-exclude');
    const restoreBtn = document.getElementById('contact-edit-restore');
    const titleEl = document.getElementById('contact-edit-title');
    let currentListRef = null; // array reference
    let currentIndex = -1;
    let currentCategory = null; // 'client' | 'venue' | 'inhouse_av'
    function open(listRef, index, category){
        currentListRef = listRef; currentIndex = index; currentCategory = category;
        const c = listRef[index];
        titleEl.textContent = c && c.name ? `Edit Contact: ${c.name}` : 'New Contact';
        form.querySelector('#contact-edit-name').value = c?.name || '';
        form.querySelector('#contact-edit-title-input').value = c?.title || '';
        form.querySelector('#contact-edit-email').value = c?.email || '';
        form.querySelector('#contact-edit-phone').value = c?.phone || '';
        form.querySelector('#contact-edit-phone-type').value = c?.phoneType || 'cell';
        form.querySelector('#contact-edit-note').value = c?.note || '';
        excludeBtn.classList.toggle('hidden', !!c?.excluded);
        restoreBtn.classList.toggle('hidden', !c?.excluded);
        modal.classList.remove('hidden'); modal.classList.add('flex');
        form.querySelector('#contact-edit-name').focus();
    }
    function close(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
    closeBtn?.addEventListener('click', close);
    modal.addEventListener('click', e=>{ if (e.target===modal) close(); });
    form.addEventListener('submit', async (e)=>{
        e.preventDefault(); if (!currentListRef || currentIndex<0) return close();
        const c = currentListRef[currentIndex]; if (!c) return close();
        Object.assign(c, {
            name: form.querySelector('#contact-edit-name').value.trim(),
            title: form.querySelector('#contact-edit-title-input').value.trim(),
            email: form.querySelector('#contact-edit-email').value.trim(),
            phone: form.querySelector('#contact-edit-phone').value.trim(),
            phoneType: form.querySelector('#contact-edit-phone-type').value,
            note: form.querySelector('#contact-edit-note').value.trim()
        });
        await persist();
        close();
    });
    excludeBtn?.addEventListener('click', async ()=>{ if (currentListRef && currentIndex>-1){ const c=currentListRef[currentIndex]; const user=window.currentUserEmail||currentUserName||'User'; const ts=new Date().toLocaleString(); c.excluded=true; c.note = c.note || `Excluded by ${user} on ${ts}`; if (!/^EX-/.test(c.title||'')) c.title = c.title?`EX-${c.title}`:'EX'; await persist(); close(); }});
    restoreBtn?.addEventListener('click', async ()=>{ if (currentListRef && currentIndex>-1){ const c=currentListRef[currentIndex]; c.excluded=false; if (c.title) c.title = c.title.replace(/^EX-/, ''); await persist(); close(); }});
    async function persist(){
        if (!currentCategory) return;
        const key = currentCategory==='client' ? 'client-contacts' : currentCategory==='venue' ? 'venue-contacts' : 'inhouse-av';
        if (key==='inhouse-av') {
            const existing = fullSurveyData['inhouse-av']||{}; existing.contacts = currentListRef; await updateSurveyData({ 'inhouse-av': existing }, true);
        } else {
            await updateSurveyData({ [key]: currentListRef }, true);
        }
        // Re-render relevant section
        if (key==='client-contacts') renderClientInfoSection(fullSurveyData);
        if (key==='venue-contacts') renderVenueInfoSection(fullSurveyData);
        if (key==='inhouse-av') renderVenueInfoSection(fullSurveyData); // shares section
    }
    // Expose open helper
    window.openContactEditor = open;
})();
</script>
</html>