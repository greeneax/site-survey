<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Event Site Survey</title>
    <!-- Microsoft Authentication Library (MSAL) -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
    <script>
        // Verify MSAL loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof msal === 'undefined') {
                console.error('MSAL library failed to load. Please check your internet connection.');
                console.error('Trying to load from alternative CDN...');
                
                // Try loading from alternative CDN
                const msalScript = document.createElement('script');
                msalScript.src = 'https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js';
                msalScript.onload = function() {
                    console.log('MSAL loaded from alternative CDN');
                };
                msalScript.onerror = function() {
                    console.error('Failed to load MSAL from alternative CDN');
                };
                document.head.appendChild(msalScript);
            } else {
                console.log('MSAL library loaded successfully');
            }
        });
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .nav-btn {
            transition: all 0.3s ease;
            color: #475569;
        }
        .nav-btn.active {
            background-color: #0d9488;
            color: white;
            box-shadow: 0 4px 14px 0 rgba(13, 148, 136, 0.25);
        }

        /* Hamburger Menu Styles */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 8px;
            background: none;
            border: none;
            z-index: 50;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background: #4B5563;
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            
            .main-nav {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                background: white;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                transition: left 0.3s ease;
                z-index: 40;
                padding-top: 80px;
                overflow-y: auto;
            }
            
            .main-nav.open {
                left: 0;
            }
            
            .nav-btn {
                width: 100%;
                justify-content: flex-start;
                padding: 16px 24px;
                margin: 4px 0;
                border-radius: 0;
                font-size: 16px;
                text-align: left;
                flex-direction: row;
            }
            
            .nav-btn span:first-child {
                margin-right: 12px;
            }
            
            .nav-btn span:last-child {
                font-size: 16px;
                margin-top: 0;
            }
            
            .nav-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.5);
                z-index: 30;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            
            .nav-overlay.open {
                opacity: 1;
                visibility: visible;
            }
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }
        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.flex {
            display: flex;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .loader {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            background-color: #f9fafb;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .photo-upload-area:hover {
            border-color: #0d9488;
            background-color: #f0fdfa;
        }
        .photo-upload-area.dragover {
            border-color: #0d9488;
            background-color: #e6fffa;
        }
        .photo-preview {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .photo-item {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        .photo-delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .photo-delete-btn:hover {
            background-color: rgba(220, 38, 38, 0.9);
        }
        
        /* Collaborative Editing Styles */
        .collaborative-user-indicator {
            animation: slideInFromRight 0.3s ease-out;
        }
        
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .field-being-edited {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        /* Authentication Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .auth-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            margin: 1rem;
        }
        .user-menu {
            position: relative;
            display: inline-block;
        }
        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
        }
        .user-dropdown.show {
            display: block;
        }
        .admin-panel {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .access-denied {
            background: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }
        .venue-suggestion {
            transition: background-color 0.2s;
        }
        .venue-suggestion:hover {
            background-color: #f3f4f6;
        }
        #venue-suggestions {
            border-top: none;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        @media print {
            body > *:not(#printable-area) {
                display: none;
            }
            #printable-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                font-size: 12px;
            }
            .no-print {
                display: none !important;
            }
            body {
                background-color: #fff;
            }
            #summary-content h2, #summary-content h3 {
                color: #000;
            }
        }
        
        /* AI Assistant Styles */
        .field-being-edited {
            border-color: #8b5cf6 !important;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1) !important;
        }
        
        .ai-suggestion-highlight {
            background-color: rgba(139, 92, 246, 0.1);
            border-left: 4px solid #8b5cf6;
        }
        
        /* Agenda Upload Styles */
        .agenda-upload-area {
            transition: all 0.2s ease;
        }
        
        .agenda-upload-area:hover {
            border-color: #6b7280;
            background-color: #f9fafb;
        }
        
        .agenda-upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        /* AI Status Indicator */
        #ai-status {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseConfig = {
            url: 'https://iasddcsryzgtcasuxioc.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhc2RkY3NyeXpndGNhc3V4aW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NDA3NDcsImV4cCI6MjA3MDAxNjc0N30.fwZ-uDhkWIai76XW7AYgdwoUkuo_D52ypCQ6tEvtScY'
        };
        
        // Export for use by auth system
        window.supabaseConfig = supabaseConfig;
        
        // Export for global access
        window.supabaseClient = null;
    </script>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container hidden">
        <div class="auth-card">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Site Survey Portal</h1>
                <p class="text-gray-600 mt-2">Sign in with your Microsoft account</p>
            </div>
            <div id="auth-content">
                <button id="login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    Sign in with Microsoft
                </button>
            </div>
            <div id="auth-loading" class="hidden text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2 text-gray-600">Signing you in...</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Container (shows after login) -->
    <div id="dashboard-container" class="hidden min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <!-- Dashboard Header with User Menu -->
        <header id="dashboard-header" class="bg-white shadow-sm border-b border-gray-200">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <!-- Site Survey Portal title removed to avoid duplication with fixed header -->
                    </div>
                    
                    <!-- User Menu -->
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center space-x-3 bg-gray-50 hover:bg-gray-100 rounded-lg px-4 py-2 transition-colors">
                            <div id="user-avatar" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-medium">
                                U
                            </div>
                            <div class="text-left">
                                <p id="user-display-name" class="text-sm font-medium text-gray-800">Loading...</p>
                                <p id="user-role" class="text-xs text-gray-500">User</p>
                            </div>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div id="user-dropdown" class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50 hidden">
                            <div class="px-4 py-3 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-800" id="dropdown-user-name">User Name</p>
                                <p class="text-sm text-gray-500" id="dropdown-user-email">user@company.com</p>
                                <div id="admin-indicator" class="hidden mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        Administrator
                                    </span>
                                </div>
                            </div>
                            
                            <div id="admin-section" class="hidden">
                                <div class="py-1">
                                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">Admin Tools</p>
                                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                        </svg>
                                        Manage Users
                                    </button>
                                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        System Settings
                                    </button>
                                </div>
                                <div class="border-t border-gray-100"></div>
                            </div>
                            
                            <div id="manager-section" class="hidden">
                                <div class="py-1">
                                    <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">Manager Tools</p>
                                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        View Reports
                                    </button>
                                </div>
                                <div class="border-t border-gray-100"></div>
                            </div>
                            
                            <div class="py-1">
                                <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                    <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Profile Settings
                                </button>
                                <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                    <svg class="w-4 h-4 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container mx-auto px-4 py-8">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">Welcome to Site Survey Portal</h1>
                <p class="text-xl text-gray-600">What would you like to do today?</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                <!-- New Site Survey -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-8 text-center">
                    <div class="bg-green-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">New Site Survey</h3>
                    <p class="text-gray-600 mb-6">Start a fresh site survey for a new event. You'll be taken directly to the survey form to enter all details.</p>
                    <button id="new-survey-btn" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition-colors font-medium">
                        Start New Survey
                    </button>
                </div>

                <!-- Edit Existing Survey -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-8 text-center">
                    <div class="bg-blue-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Edit Existing Survey</h3>
                    <p class="text-gray-600 mb-6">Continue working on a survey that's already in progress or needs updates.</p>
                    <button id="edit-survey-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Browse Surveys
                    </button>
                </div>

                <!-- Venue Lookup -->
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-8 text-center">
                    <div class="bg-purple-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Venue Lookup</h3>
                    <p class="text-gray-600 mb-6">Search and view detailed information about venues from previous surveys.</p>
                    <button id="venue-lookup-btn" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                        Search Venues
                    </button>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="mt-16 max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Recent Activity</h2>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div id="recent-activity" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">Loading recent activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden until survey is selected) -->
    <div id="main-app" class="hidden"></div>

    <!-- User Header -->
    <div class="bg-white shadow-sm border-b px-6 py-3 flex justify-between items-center no-print">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-semibold text-gray-800">Live Event Site Survey</h1>
            <div id="admin-indicator" class="hidden px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full font-medium">
                Admin Access
            </div>
        </div>
        <div class="user-menu">
            <button id="user-menu-btn" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-colors">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-medium" id="user-avatar">
                </div>
                <span id="user-display-name" class="text-gray-700 font-medium"></span>
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="user-dropdown" class="user-dropdown">
                <div class="p-3 border-b border-gray-200">
                    <p class="text-sm text-gray-600">Signed in as</p>
                    <p id="user-email" class="text-sm font-medium text-gray-800"></p>
                    <p id="user-role" class="text-xs text-blue-600 font-medium mt-1"></p>
                </div>
                <div id="admin-section" class="hidden p-3 border-b border-gray-200">
                    <button id="admin-panel-btn" class="w-full text-left text-sm text-gray-700 hover:text-blue-600 transition-colors">
                        Admin Panel
                    </button>
                    <button id="ai-admin-btn" class="w-full text-left text-sm text-gray-700 hover:text-purple-600 transition-colors mt-2">
                        AI Configuration
                    </button>
                </div>
                <div class="p-3">
                    <button id="logout-btn" class="w-full text-left text-sm text-red-600 hover:text-red-700 transition-colors">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="modal no-print hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Admin Panel</h2>
                <button id="close-admin-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Active Users -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">Active Users</h3>
                    <div id="active-users-list" class="space-y-2">
                        <!-- Will be populated with active users -->
                    </div>
                </div>
                
                <!-- User Management -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">User Roles</h3>
                    
                    <!-- Add new user role -->
                    <div class="space-y-3 mb-4">
                        <div>
                            <label class="form-label">Email Address</label>
                            <input type="email" id="role-email" class="form-input" placeholder="user@ita.com">
                        </div>
                        <div>
                            <label class="form-label">Role</label>
                            <select id="role-select" class="form-input">
                                <option value="user">User</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button id="set-role-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Set User Role
                        </button>
                    </div>
                    
                    <!-- Existing user roles -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Current User Roles</h4>
                        <div id="user-roles-list" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- Will be populated with user roles -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Survey Records -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-3">Survey Records</h3>
                <div id="survey-records" class="bg-gray-50 p-4 rounded-lg max-h-64 overflow-y-auto">
                    <!-- Will be populated with survey records -->
                </div>
            </div>
        </div>
    </div>

    <!-- New Survey Modal -->
    <div id="new-survey-modal" class="modal no-print hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Create New Site Survey</h2>
                <button id="close-new-survey-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="new-survey-name" class="form-label">Event Name</label>
                    <input type="text" id="new-survey-name" class="form-input" placeholder="e.g., Annual Conference 2025" required />
                </div>
                <div>
                    <label for="new-survey-r2" class="form-label">R2 Order Number</label>
                    <input type="text" id="new-survey-r2" class="form-input" placeholder="e.g., 0912345" required />
                </div>
                <div>
                    <label for="new-survey-venue" class="form-label">Venue Name (Optional)</label>
                    <input type="text" id="new-survey-venue" class="form-input" placeholder="e.g., Convention Center" />
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="create-survey-btn" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    Create Survey
                </button>
                <button id="cancel-new-survey-btn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Venue Lookup Modal -->
    <div id="venue-lookup-modal" class="modal no-print hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Venue Database Lookup</h2>
                <button id="close-venue-lookup-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="flex gap-4">
                    <div class="flex-1">
                        <input type="text" id="venue-search-input" placeholder="Search venues by name, address, or location..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button id="venue-search-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        Search
                    </button>
                </div>
            </div>
            
            <div id="venue-search-results" class="max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-center py-8">Enter a venue name to search</p>
            </div>
        </div>
    </div>

    <!-- Welcome Modal (Legacy - for direct R2 access) -->
    <div id="welcome-modal" class="modal no-print hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Live Event Site Survey</h2>
            <p class="text-gray-600 mb-6">Please enter your name and the R2# for the event to begin.</p>
            <div class="space-y-4">
                <div>
                    <label for="user-name-input" class="form-label">Your Name</label>
                    <input type="text" id="user-name-input" class="form-input" placeholder="e.g., Jane Doe" required />
                </div>
                <div>
                    <label for="r2-number-input" class="form-label">Event R2#</label>
                    <input type="text" id="r2-number-input" class="form-input" placeholder="e.g., 0911234" required />
                </div>
            </div>
            <button id="load-survey-btn" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-teal-700 transition-colors mt-6">
                Load Survey
            </button>
        </div>
    </div>
    
    <div class="container mx-auto p-4 max-w-7xl no-print" style="display: none;">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-900">Live Event Site Survey</h1>
            <p id="header-subtitle" class="text-lg text-gray-600 mt-1">A Collaborative Checklist for Technicians</p>
            <div class="mt-4 flex justify-center gap-4">
                <button onclick="returnToDashboard()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 shadow-md">
                    <span>🏠</span>
                    <span>Back to Dashboard</span>
                </button>
                <button onclick="showSurveyBrowser()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 shadow-md">
                    <span>🔍</span>
                    <span>Browse Surveys</span>
                </button>
                <button onclick="saveSurveyToDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 shadow-md">
                    <span>💾</span>
                    <span>Save to Database</span>
                </button>
                <button id="ai-assistant-btn" onclick="showAISettings()" class="hidden bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 shadow-md">
                    <span>🤖</span>
                    <span id="ai-btn-text">AI Assistant</span>
                </button>
                <div class="bg-green-600/20 text-green-800 px-4 py-2 rounded-lg flex items-center gap-2">
                    <span>✨</span>
                    <span class="text-sm">Auto-save enabled</span>
                </div>
                <div id="ai-status" class="hidden bg-purple-600/20 text-purple-800 px-4 py-2 rounded-lg flex items-center gap-2">
                    <span>🧠</span>
                    <span class="text-sm">AI Assistant active</span>
                </div>
            </div>
        </header>

        <nav class="sticky top-0 z-10 bg-white/80 backdrop-blur-sm rounded-xl shadow-md mb-8 p-2">
            <!-- Mobile hamburger button -->
            <button class="hamburger md:hidden" id="mobile-menu-btn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <!-- Desktop navigation -->
            <div class="hidden md:flex justify-center items-center gap-2 md:gap-4">
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="event-info">
                    <span class="text-2xl">📅</span>
                    <span class="text-xs font-medium mt-1">Event Info</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="client-info">
                    <span class="text-2xl">👤</span>
                    <span class="text-xs font-medium mt-1">Client Info</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="venue-info">
                    <span class="text-2xl">🏢</span>
                    <span class="text-xs font-medium mt-1">Venue Info</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="logistics">
                    <span class="text-2xl">🗺️</span>
                    <span class="text-xs font-medium mt-1">Logistics</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="rooms">
                    <span class="text-2xl">🚪</span>
                    <span class="text-xs font-medium mt-1">Rooms</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="venue-guidelines">
                    <span class="text-2xl">📜</span>
                    <span class="text-xs font-medium mt-1">Guidelines</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="wrap-up">
                    <span class="text-2xl">✅</span>
                    <span class="text-xs font-medium mt-1">Wrap-Up</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="summary-export">
                    <span class="text-2xl">📄</span>
                    <span class="text-xs font-medium mt-1">Summary</span>
                </button>
                <button class="nav-btn flex-1 md:flex-none flex flex-col items-center p-3 rounded-lg" data-target="activity">
                    <span class="text-2xl">🕰️</span>
                    <span class="text-xs font-medium mt-1">Activity</span>
                </button>
            </div>
            
            <!-- Mobile navigation overlay -->
            <div class="nav-overlay md:hidden" id="nav-overlay"></div>
            
            <!-- Mobile navigation menu -->
            <div class="main-nav md:hidden" id="mobile-nav">
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="event-info">
                    <span class="text-2xl">📅</span>
                    <span class="text-sm font-medium">Event Information</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="client-info">
                    <span class="text-2xl">👤</span>
                    <span class="text-sm font-medium">Client Information</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="venue-info">
                    <span class="text-2xl">🏢</span>
                    <span class="text-sm font-medium">Venue Information</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="logistics">
                    <span class="text-2xl">🗺️</span>
                    <span class="text-sm font-medium">Logistics</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="rooms">
                    <span class="text-2xl">🚪</span>
                    <span class="text-sm font-medium">Rooms</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="venue-guidelines">
                    <span class="text-2xl">📜</span>
                    <span class="text-sm font-medium">Venue Guidelines</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="wrap-up">
                    <span class="text-2xl">✅</span>
                    <span class="text-sm font-medium">Wrap-Up</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="summary-export">
                    <span class="text-2xl">📄</span>
                    <span class="text-sm font-medium">Summary</span>
                </button>
                <button class="nav-btn flex items-center p-3 rounded-lg" data-target="activity">
                    <span class="text-2xl">🕰️</span>
                    <span class="text-sm font-medium">Activity</span>
                </button>
            </div>
        </nav>

        <main id="app-content" class="space-y-8">
            <section id="event-info" class="content-section active p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="client-info" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="venue-info" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="logistics" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="rooms" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="venue-guidelines" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="wrap-up" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="summary-export" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
            <section id="activity" class="content-section p-4 md:p-8 bg-white rounded-xl shadow-lg"></section>
        </main>
        
        <footer class="text-center mt-8 p-4 border-t border-gray-200">
             <div id="save-status" class="text-sm text-gray-500 mb-2 h-5"></div>
             <p class="text-xs text-gray-400">User: <span id="user-display" class="font-mono">Loading...</span></p>
             <p class="text-xs text-gray-400">Survey: <span id="survey-info" class="font-mono">Version 1</span></p>
        </footer>
    </div>
    
    <!-- Survey Browser Modal -->
    <div id="survey-browser-modal" class="modal no-print hidden">
        <div class="modal-content max-w-6xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Browse Surveys</h2>
                <button onclick="closeSurveyBrowser()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="flex gap-4 mb-6">
                <input type="text" id="survey-search" placeholder="Search by R2#, Event Name, or Venue..." class="flex-1 form-input">
                <select id="status-filter" class="form-input">
                    <option value="all">All Status</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Draft">Draft</option>
                </select>
                <button onclick="searchSurveysInBrowser()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Search
                </button>
            </div>
            
            <div id="survey-results" class="max-h-96 overflow-y-auto">
                <p class="text-center py-8 text-gray-500">Enter a search term to find surveys</p>
            </div>
        </div>
    </div>

    <!-- AI Settings Modal -->
    <div id="ai-settings-modal" class="modal no-print hidden">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold" id="ai-modal-title">AI Assistant</h2>
                <button onclick="closeAISettings()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Admin-only API Key Configuration -->
                <div id="admin-ai-config" class="hidden bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">System Configuration (Admin Only)</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="enable-ai-system" class="form-checkbox">
                            <div>
                                <span class="font-medium">Enable AI System</span>
                                <p class="text-sm text-gray-600">Allow users to access AI features</p>
                            </div>
                        </label>
                        
                        <div id="api-key-section" class="hidden">
                            <label class="form-label">OpenAI API Key</label>
                            <div class="flex gap-2">
                                <input type="password" id="openai-key-input" class="form-input flex-1" placeholder="sk-...">
                                <button id="toggle-key-visibility" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                                    👁️
                                </button>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">This key will be stored securely and shared with all users</p>
                            
                            <div class="flex gap-3 mt-3">
                                <button id="save-api-key" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    Save & Enable AI
                                </button>
                                <button id="test-api-key" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors" disabled>
                                    Test Connection
                                </button>
                                <button id="disable-ai-system" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors hidden">
                                    Disable AI System
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User AI Features -->
                <div id="user-ai-features" class="hidden bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">AI Features</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="ai-assistance-toggle" class="form-checkbox">
                            <div>
                                <span class="font-medium">Enable AI Assistance</span>
                                <p class="text-sm text-gray-600">Get real-time suggestions for AV setup and site survey questions</p>
                            </div>
                        </label>
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="agenda-analysis-toggle" class="form-checkbox" checked>
                            <div>
                                <span class="font-medium">Agenda Analysis</span>
                                <p class="text-sm text-gray-600">Automatically analyze uploaded agendas to suggest rooms and schedule</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- AI Status -->
                <div id="ai-status-display" class="bg-blue-50 p-4 rounded-lg hidden">
                    <h3 class="text-lg font-semibold mb-2 text-blue-800">AI Assistant Status</h3>
                    <div id="ai-status-content" class="text-sm text-blue-700">
                        <!-- Status content will be populated here -->
                    </div>
                </div>
                
                <!-- System Disabled Message -->
                <div id="ai-disabled-message" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 hidden">
                    <div class="flex items-center">
                        <span class="text-yellow-600 text-xl mr-3">⚠️</span>
                        <div>
                            <h3 class="font-semibold text-yellow-800">AI Assistant Not Available</h3>
                            <p class="text-sm text-yellow-700">The AI assistant has not been configured by an administrator.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Suggestions Panel -->
    <div id="ai-suggestions-panel" class="fixed right-4 top-20 w-80 bg-white shadow-lg rounded-lg border border-purple-200 hidden z-40">
        <div class="bg-purple-600 text-white p-3 rounded-t-lg flex justify-between items-center">
            <span class="font-medium">🤖 AI Suggestions</span>
            <button onclick="hideAISuggestions()" class="text-purple-200 hover:text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="ai-suggestions-content" class="p-4 max-h-96 overflow-y-auto">
            <!-- AI suggestions will be populated here -->
        </div>
    </div>

    <!-- Agenda Analysis Modal -->
    <div id="agenda-analysis-modal" class="modal no-print hidden">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Agenda Analysis Results</h2>
                <button onclick="closeAgendaAnalysis()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="agenda-analysis-content" class="space-y-6">
                <!-- Analysis results will be populated here -->
            </div>
            
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
                <button onclick="closeAgendaAnalysis()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    No, I'll fill manually
                </button>
                <button id="apply-ai-suggestions" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    Apply AI Suggestions
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Use the config from head
        const config = window.supabaseConfig;
        
        // Check if configuration is valid before initializing
        function isValidSupabaseConfig(config) {
            return config.url && 
                   config.anonKey && 
                   config.url !== 'YOUR_SUPABASE_URL' && 
                   config.anonKey !== 'YOUR_SUPABASE_ANON_KEY' &&
                   config.url.startsWith('https://') &&
                   config.url.includes('.supabase.co');
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        let appId = urlParams.get('id'); 

        let supabase = null;
        let currentUserId = null;
        let currentUserName = localStorage.getItem('siteSurveyUserName');
        let formInputTimeout;
        let fullSurveyData = {};
        let previousFieldValues = {}; // Track previous values for change detection
        let pendingChanges = {}; // Buffer changes by minute and user
        let changeFlushTimeout;
        
        let userDisplay, saveStatus;

        // Initialize Supabase only if configuration is valid
        if (isValidSupabaseConfig(config)) {
            try {
                supabase = createClient(config.url, config.anonKey);
                window.supabaseClient = supabase; // Make globally accessible
                console.log('Supabase initialized successfully');
                console.log('Supabase URL:', config.url);
                console.log('Supabase client:', supabase);
                
                // Test the connection
                supabase.from('survey_database').select('count', { count: 'exact', head: true })
                    .then(({ count, error }) => {
                        if (error) {
                            console.error('Supabase connection test failed:', error);
                        } else {
                            console.log('Supabase connection test successful. Table row count:', count);
                        }
                    });
                    
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                showConfigurationError();
            }
        } else {
            console.error('Invalid Supabase configuration - please update the config values');
            console.log('Config received:', config);
            showConfigurationError();
        }

        // Export for use by auth system
        window.supabase = supabase;

        // Check database setup
        async function checkDatabaseSetup() {
            if (!supabase) return false;
            
            try {
                // Try to query a simple table to see if database is set up
                const { data, error } = await supabase
                    .from('system_config').select('setting_name,setting_value')
                    .limit(1);
                    
                if (error && error.code === 'PGRST205') {
                    console.warn('Database tables not found. Please run the supabase_tables.sql script to set up the database.');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.warn('Database connection issue:', error);
                return false;
            }
        }

        function showConfigurationError() {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-0 left-0 w-full bg-red-600 text-white p-4 text-center z-50';
            errorDiv.innerHTML = `
                <h3 class="font-bold">Configuration Error</h3>
                <p>Supabase is not configured. Please contact your administrator to set up the database connection.</p>
                <p class="text-sm mt-2">The application will run in read-only mode.</p>
            `;
            document.body.appendChild(errorDiv);
        }

        // AI Configuration
        let openAIKey = null;
        let aiAssistanceEnabled = false;
        let aiSuggestionsActive = false;
        let aiSystemEnabled = false; // Admin-controlled global setting

        // Legacy welcome modal function for compatibility
        function showWelcomeModal() {
            const urlParams = new URLSearchParams(window.location.search);
            const directAppId = urlParams.get('id');

            if (directAppId) {
                // Direct R2 access - skip legacy modal and go directly to survey
                console.log('Direct survey access detected, initializing survey:', directAppId);
                
                // Set up basic user info from localStorage or default
                if (!currentUserName) {
                    currentUserName = localStorage.getItem('siteSurveyUserName') || 'Survey User';
                    window.currentUserName = currentUserName;
                }
                
                // Initialize the main app directly
                initializeMainApp(directAppId);
            } else {
                // No direct R2 - check authentication and show appropriate interface
                console.log('Initializing authentication for dashboard mode');
                initializeAuthentication();
            }
        }

        function initializeAuthentication() {
            // Check if user is already authenticated via Microsoft SSO
            if (window.currentUserEmail && window.currentUserName) {
                showDashboard();
            } else {
                showAuthContainer();
            }
        }

        function showAuthContainer() {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('main-app').classList.add('hidden');

            // Make sure the survey container is hidden
            const mainContainer = document.querySelector('.container');
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }

            // Setup login button
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    // This would trigger Microsoft SSO
                    // For now, simulate successful authentication
                    simulateAuthentication();
                });
            }
        }

        function simulateAuthentication() {
            // This is a placeholder - in real implementation, this would be handled by Microsoft SSO
            const authLoading = document.getElementById('auth-loading');
            const authContent = document.getElementById('auth-content');
            
            authContent.classList.add('hidden');
            authLoading.classList.remove('hidden');
            
            setTimeout(async () => {
                // Simulate successful authentication - you can change the email to test different roles
                // Use 'alex.greene@ita.com' to test admin role
                window.currentUserEmail = 'alex.greene@ita.com'; // Change this to test different users
                window.currentUserName = window.currentUserEmail === 'alex.greene@ita.com' ? 'Alex Greene' : 'Site Survey User';
                
                // Determine role from database or default logic
                let role;
                try {
                    role = await getUserRoleFromDatabase(window.currentUserEmail);
                } catch (error) {
                    console.log('getUserRoleFromDatabase function not available, using default role logic');
                    role = window.currentUserEmail === 'alex.greene@ita.com' ? 'admin' : 'user';
                }
                window.currentUserRole = role;
                
                // Set currentUserId for Supabase operations
                if (window.currentUserEmail) {
                    currentUserId = btoa(window.currentUserEmail).replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
                    currentUserName = window.currentUserName;
                }
                
                // Track user session in database
                await trackUserSession(window.currentUserEmail, window.currentUserName, window.currentUserRole);
                
                showDashboard();
            }, 2000);
        }

        async function showDashboard() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');

            // Make sure the survey container is hidden
            const mainContainer = document.querySelector('.container');
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }

            // Check database setup
            const dbReady = await checkDatabaseSetup();
            if (!dbReady) {
                console.log('Running in offline mode - some features may not be available');
            }

            // Setup dashboard button handlers
            setupDashboardButtons();
            
            // Setup user menu
            setupUserMenu();
            
            // Load recent activity (only if database is ready)
            if (dbReady) {
                loadRecentActivity();
            } else {
                const activityDiv = document.getElementById('recent-activity');
                if (activityDiv) {
                    activityDiv.innerHTML = '<p class="text-orange-500 text-center py-8">Database not configured - running in offline mode</p>';
                }
            }
        }

        function setupDashboardButtons() {
            const newSurveyBtn = document.getElementById('new-survey-btn');
            const editSurveyBtn = document.getElementById('edit-survey-btn');
            const venueLookupBtn = document.getElementById('venue-lookup-btn');

            if (newSurveyBtn) {
                newSurveyBtn.addEventListener('click', createNewSurveyDirect);
            }

            if (editSurveyBtn) {
                editSurveyBtn.addEventListener('click', showSurveyBrowser);
            }

            if (venueLookupBtn) {
                venueLookupBtn.addEventListener('click', showVenueLookupModal);
            }
        }

        function createNewSurveyDirect() {
            // Generate a user-friendly temporary R2 number for the new survey
            const timestamp = Date.now();
            const dateStr = new Date().toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD format
            const timeStr = new Date().toTimeString().slice(0, 5).replace(':', ''); // HHMM format
            const tempR2Number = `NEW-${dateStr}-${timeStr}`;
            
            // Hide dashboard and show survey container
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('dashboard-header')?.classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Immediately show the survey container
            const mainContainer = document.querySelector('.container');
            if (mainContainer) {
                mainContainer.style.display = 'block';
                mainContainer.style.visibility = 'visible';
                mainContainer.style.opacity = '1';
                console.log('Survey container made visible');
            }
            
            // Set the app ID and initialize the survey
            window.appId = tempR2Number;
            
            // Update URL without refresh
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('id', tempR2Number);
            window.history.pushState({}, '', newUrl);
            
            // Initialize the main application with empty data
            initializeMainApp(tempR2Number, '', '');
            
            console.log('Created new survey with ID:', tempR2Number);
        }

        function returnToDashboard() {
            // Hide main app and show dashboard
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            document.getElementById('dashboard-header')?.classList.remove('hidden');
            
            // Also hide the container
            const mainContainer = document.querySelector('.container');
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }
            
            // Clear the survey ID from URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('id');
            window.history.pushState({}, '', newUrl);
            
            // Clear current survey data if it's a temporary survey
            if (window.appId && (window.appId.startsWith('NEW-') || window.appId.startsWith('SURVEY_'))) {
                window.appId = null;
                fullSurveyData = {};
            }
            
            console.log('Returned to dashboard');
        }

        function setupUserMenu() {
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown');
            const logoutBtn = document.getElementById('logout-btn');
            
            // Get DOM elements first
            const adminSection = document.getElementById('admin-section');
            const managerSection = document.getElementById('manager-section');

            // Get user role and populate UI
            const userRole = window.currentUserRole || 'user';
            const userName = window.currentUserName || 'Unknown User';
            const userEmail = window.currentUserEmail || 'unknown@example.com';

            // Update user display
            try {
                updateUserInterface(userName, userEmail, userRole);
            } catch (error) {
                console.log('updateUserInterface function not available, updating UI manually');
                // Manual UI update as fallback
                const userDisplayName = document.getElementById('user-display-name');
                const userRoleElement = document.getElementById('user-role');
                const userAvatar = document.getElementById('user-avatar');
                const dropdownUserName = document.getElementById('dropdown-user-name');
                const dropdownUserEmail = document.getElementById('dropdown-user-email');
                
                if (userDisplayName) userDisplayName.textContent = userName;
                if (userRoleElement) userRoleElement.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                if (userAvatar) userAvatar.textContent = userName.charAt(0).toUpperCase();
                if (dropdownUserName) dropdownUserName.textContent = userName;
                if (dropdownUserEmail) dropdownUserEmail.textContent = userEmail;
                
                // Show admin indicator if admin
                if (userRole === 'admin') {
                    const adminIndicator = document.getElementById('admin-indicator');
                    if (adminIndicator) adminIndicator.classList.remove('hidden');
                }
            }

            // Toggle dropdown
            if (userMenuButton) {
                userMenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!userMenuButton.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.add('hidden');
                }
            });

            // Handle logout
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            // Setup admin section button handlers
            const adminButtons = adminSection?.querySelectorAll('button[class*="text-left"]');
            adminButtons?.forEach(button => {
                if (button.textContent.includes('Manage Users')) {
                    button.addEventListener('click', () => {
                        userDropdown.classList.add('hidden');
                        showAdminModal();
                    });
                } else if (button.textContent.includes('System Settings')) {
                    button.addEventListener('click', () => {
                        userDropdown.classList.add('hidden');
                        showSystemSettings();
                    });
                }
            });

            // Setup manager section button handlers
            const managerButtons = managerSection?.querySelectorAll('button[class*="text-left"]');
            managerButtons?.forEach(button => {
                if (button.textContent.includes('View Reports')) {
                    button.addEventListener('click', () => {
                        userDropdown.classList.add('hidden');
                        showManagerReports();
                    });
                }
            });

            // Setup profile settings button - target the button that contains "Profile Settings" text
            const allButtons = userDropdown?.querySelectorAll('button[class*="text-left"]');
            allButtons?.forEach(button => {
                if (button.textContent.includes('Profile Settings')) {
                    button.addEventListener('click', () => {
                        userDropdown.classList.add('hidden');
                        showProfileSettings();
                    });
                }
            });

            // Show/hide role-specific sections
            if (userRole === 'admin') {
                adminSection.classList.remove('hidden');
                managerSection.classList.remove('hidden');
            } else if (userRole === 'manager') {
                managerSection.classList.remove('hidden');
            }
        }

        // Simple getUserRole function for dashboard (fallback if database function not available)
        function getUserRole(email = null) {
            const userEmail = email || window.currentUserEmail || '';
            
            // Check hardcoded admin first
            if (userEmail === 'alex.greene@ita.com') {
                return 'admin';
            }
            
            // Check URL parameters for testing
            const urlParams = new URLSearchParams(window.location.search);
            const testRole = urlParams.get('role');
            if (testRole && ['admin', 'manager', 'user'].includes(testRole)) {
                return testRole;
            }
            
            // Default role
            return 'user';
        }

        // Admin and Manager dropdown functions
        function showAdminModal() {
            const modal = document.getElementById('admin-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                console.log('Opening admin panel');
            } else {
                alert('Admin panel is not available in this interface. Please use the main survey application for full admin features.');
            }
        }

        function showSystemSettings() {
            alert('System settings feature is coming soon. This will allow administrators to configure global application settings.');
        }

        function showManagerReports() {
            alert('Manager reports feature is coming soon. This will show survey statistics and team performance metrics.');
        }

        function showProfileSettings() {
            alert('Profile settings feature is coming soon. This will allow users to update their personal information and preferences.');
        }

        function handleLogout() {
            // Clear any stored user data
            window.currentUserEmail = null;
            window.currentUserName = null;
            window.currentUserRole = null;
            
            // Reset to authentication screen
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            
            console.log('User logged out');
        }

        function showNewSurveyModal() {
            const modal = document.getElementById('new-survey-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Setup modal handlers
            const closeBtn = document.getElementById('close-new-survey-modal');
            const cancelBtn = document.getElementById('cancel-new-survey-btn');
            const createBtn = document.getElementById('create-survey-btn');

            const closeModal = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                // Clear form
                document.getElementById('new-survey-name').value = '';
                document.getElementById('new-survey-r2').value = '';
                document.getElementById('new-survey-venue').value = '';
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            createBtn.addEventListener('click', async () => {
                const eventName = document.getElementById('new-survey-name').value.trim();
                const r2Number = document.getElementById('new-survey-r2').value.trim();
                const venueName = document.getElementById('new-survey-venue').value.trim();

                if (!eventName || !r2Number) {
                    alert('Please provide both Event Name and R2 Number.');
                    return;
                }

                // Check if survey already exists
                const existingSurvey = await checkExistingSurvey(r2Number);
                
                if (existingSurvey) {
                    const action = await showDuplicateSurveyDialog(existingSurvey);
                    if (action === 'edit') {
                        closeModal();
                        startSurvey(r2Number, eventName, venueName);
                    } else if (action === 'new') {
                        // Create new survey with timestamp suffix
                        const newR2 = `${r2Number}_${Date.now()}`;
                        closeModal();
                        startSurvey(newR2, eventName, venueName);
                    }
                    // If action is 'cancel', do nothing
                } else {
                    closeModal();
                    startSurvey(r2Number, eventName, venueName);
                }
            });
        }

        function showVenueLookupModal() {
            const modal = document.getElementById('venue-lookup-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Setup modal handlers
            const closeBtn = document.getElementById('close-venue-lookup-modal');
            const searchBtn = document.getElementById('venue-search-btn');
            const searchInput = document.getElementById('venue-search-input');

            const closeModal = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.getElementById('venue-search-input').value = '';
                document.getElementById('venue-search-results').innerHTML = '<p class="text-gray-500 text-center py-8">Enter a venue name to search</p>';
            };

            closeBtn.addEventListener('click', closeModal);
            
            searchBtn.addEventListener('click', performVenueSearch);
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performVenueSearch();
                }
            });
        }

        async function performVenueSearch() {
            const query = document.getElementById('venue-search-input').value.trim();
            const resultsDiv = document.getElementById('venue-search-results');

            if (query.length < 2) {
                resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Please enter at least 2 characters</p>';
                return;
            }

            resultsDiv.innerHTML = '<p class="text-center py-8">Searching venues...</p>';

            try {
                const venues = await searchVenues(query);
                
                if (venues.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No venues found matching your search</p>';
                    return;
                }

                resultsDiv.innerHTML = `
                    <div class="space-y-4">
                        ${venues.map(venue => `
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="openVenueDetails('${venue.venueName}')">
                                <h3 class="text-lg font-semibold text-gray-900">${venue.venueName}</h3>
                                <p class="text-gray-600">${venue.venueAddress || 'Address not available'}</p>
                                <p class="text-sm text-gray-500">
                                    Last updated: ${formatDate(venue.updated_at)} by ${venue.updated_by || 'Unknown'}
                                </p>
                                <div class="mt-2 flex gap-2">
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                        ${venue.rooms?.length || 0} Rooms
                                    </span>
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                        Previous Surveys Available
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Venue search error:', error);
                resultsDiv.innerHTML = '<p class="text-red-500 text-center py-8">Error searching venues</p>';
            }
        }

        function openVenueDetails(venueName) {
            // Close the venue lookup modal
            document.getElementById('venue-lookup-modal').classList.add('hidden');
            document.getElementById('venue-lookup-modal').classList.remove('flex');
            
            // Show venue details - for now, just show a summary
            alert(`Venue Details for: ${venueName}\n\nThis would show detailed venue information, previous surveys, photos, and allow creating a new survey for this venue.`);
        }

        function startSurvey(r2Number, eventName, venueName) {
            // Hide dashboard and show main app
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('dashboard-header')?.classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Set the app ID and initialize the survey
            window.appId = r2Number;
            
            // Update URL without refresh
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('id', r2Number);
            window.history.pushState({}, '', newUrl);
            
            // Initialize the main application
            initializeMainApp(r2Number, eventName, venueName);
        }

        function showLegacyWelcomeModal(appId) {
            // Legacy path for direct R2 access
            const welcomeModal = document.getElementById('welcome-modal');
            const mainContainer = document.querySelector('.container');

            document.title = `Survey | ${appId}`;
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('dashboard-header')?.classList.add('hidden');
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            if (welcomeModal) welcomeModal.classList.add('flex');

            const loadSurveyBtn = document.getElementById('load-survey-btn');
            const userNameInput = document.getElementById('user-name-input');
            const r2NumberInput = document.getElementById('r2-number-input');

            if (currentUserName && userNameInput) {
                userNameInput.value = currentUserName;
            }

            if (r2NumberInput) {
                r2NumberInput.value = appId;
            }

            if (loadSurveyBtn) {
                loadSurveyBtn.addEventListener('click', async () => {
                    const name = userNameInput ? userNameInput.value.trim() : '';
                    const r2 = r2NumberInput ? r2NumberInput.value.trim() : '';

                    if (name && r2) {
                        localStorage.setItem('siteSurveyUserName', name);
                        window.currentUserName = name;
                        welcomeModal.classList.add('hidden');
                        welcomeModal.classList.remove('flex');
                        initializeMainApp(r2, '', '');
                    } else {
                        alert('Please provide both your name and the event R2#.');
                    }
                });
            }
        }

        function initializeMainApp(r2Number, eventName = '', venueName = '') {
            // Set global app ID
            window.appId = r2Number;
            
            // Ensure currentUserId is set for Supabase operations
            if (window.currentUserEmail && !currentUserId) {
                currentUserId = btoa(window.currentUserEmail).replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
                currentUserName = window.currentUserName;
            }
            
            // Get the main container and make it visible
            const mainContainer = document.querySelector('.container');
            if (mainContainer) {
                mainContainer.style.display = 'block';
            }

            // Make sure the main-app div is visible and contains the survey content
            const mainAppDiv = document.getElementById('main-app');
            if (mainAppDiv && mainContainer) {
                // Instead of moving the container, just make both visible
                mainContainer.style.display = 'block';
                mainContainer.style.visibility = 'visible';
                mainContainer.style.opacity = '1';
                mainAppDiv.classList.remove('hidden');
                
                // Make sure the container is visible within the viewport
                mainContainer.style.position = 'relative';
                mainContainer.style.zIndex = '1';
                
                // Apply survey-specific visibility fixes
                if (window.appId) {
                    // Force all content sections to be visible
                    const sections = mainContainer.querySelectorAll('.content-section');
                    sections.forEach(section => {
                        section.style.display = 'block';
                        section.style.visibility = 'visible';
                        section.style.opacity = '1';
                    });
                    
                    // Ensure navigation is visible
                    const nav = mainContainer.querySelector('nav');
                    if (nav) {
                        nav.style.display = 'block';
                        nav.style.visibility = 'visible';
                    }
                    
                    // Ensure header is visible
                    const header = mainContainer.querySelector('header');
                    if (header) {
                        header.style.display = 'block';
                        header.style.visibility = 'visible';
                    }
                }
                
                console.log('Made container and main-app visible with survey fixes');
            }

            userDisplay = document.getElementById('user-display');
            saveStatus = document.getElementById('save-status');
            
            initializeAppAndAuth();
            setupUI();

            // Pre-populate data if provided
            if (eventName || venueName) {
                setTimeout(async () => {
                    const initialData = {};
                    if (eventName) initialData['event-name'] = eventName;
                    if (venueName) initialData['venue-name'] = venueName;
                    if (r2Number) initialData['r2-number'] = r2Number;
                    
                    await updateSurveyData(initialData, false);
                }, 1000);
            }

            // Ensure the survey content is rendered with a small delay to let the DOM settle
            setTimeout(() => {
                console.log('Timeout reached - attempting to render sections');
                console.log('Current appId:', window.appId);
                console.log('fullSurveyData:', fullSurveyData);
                
                if (window.appId) {
                    const data = fullSurveyData || { 'r2-number': window.appId };
                    console.log('About to render sections with data:', data);
                    console.log('Event info section exists:', !!document.getElementById('event-info'));
                    console.log('Client info section exists:', !!document.getElementById('client-info'));
                    
                    // Force ensure sections are visible first
                    const sections = document.querySelectorAll('.content-section');
                    console.log('Found sections:', sections.length);
                    sections.forEach((section, index) => {
                        console.log(`Section ${index}: ${section.id}, display: ${section.style.display}, visible: ${section.style.visibility}`);
                        section.style.display = 'block';
                        section.style.visibility = 'visible';
                        section.style.opacity = '1';
                        section.classList.remove('hidden');
                    });
                    
                    try {
                        renderAllSections(data);
                        console.log('renderAllSections completed successfully');
                        
                        // Double check that content was rendered
                        const eventSection = document.getElementById('event-info');
                        if (eventSection) {
                            console.log('Event section content length:', eventSection.innerHTML.length);
                            console.log('Event section has content:', eventSection.innerHTML.length > 100);
                        }
                    } catch (error) {
                        console.error('Error in renderAllSections:', error);
                    }
                    
                    // Force visibility check and fix
                    setTimeout(() => {
                        const eventSection = document.getElementById('event-info');
                        if (eventSection) {
                            const computedStyle = window.getComputedStyle(eventSection);
                            console.log('Event section computed display:', computedStyle.display);
                            console.log('Event section classes:', eventSection.className);
                            
                            // Force the active section to be visible
                            eventSection.style.display = 'block';
                            eventSection.style.visibility = 'visible';
                            eventSection.style.opacity = '1';
                        }
                        
                        // Also check the container visibility
                        const container = document.querySelector('.container');
                        if (container) {
                            console.log('Container computed display:', window.getComputedStyle(container).display);
                        }
                        
                        console.log('Rendered sections for new survey');
                    }, 100);
                }
            }, 500);
        }

        async function loadRecentActivity() {
            const activityDiv = document.getElementById('recent-activity');
            
            try {
                // Get recent surveys for this user
                const recentSurveys = await getRecentSurveys();
                
                if (recentSurveys.length === 0) {
                    activityDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No recent activity found</p>';
                    return;
                }

                activityDiv.innerHTML = recentSurveys.map(survey => `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${survey.eventName || 'Unnamed Event'}</h4>
                            <p class="text-sm text-gray-600">R2#: ${survey.surveyId} • ${survey.venueName || 'Venue TBD'}</p>
                            <p class="text-xs text-gray-500">Last updated: ${formatDate(survey.lastUpdated)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(survey.status)}">
                                ${survey.status || 'In Progress'}
                            </span>
                            <button onclick="openSurvey('${survey.surveyId}')" 
                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                Open
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                activityDiv.innerHTML = '<p class="text-red-500 text-center py-8">Error loading recent activity</p>';
            }
        }

        async function getRecentSurveys() {
            if (!supabase) return [];
            
            try {
                // Get recent surveys for current user
                const { data: surveys, error } = await supabase
                    .from('surveys')
                    .select('id, survey_id, survey_data, event_name, venue_name, status, version, created_by, updated_by, created_at, updated_at')
                    .eq('updated_by', window.currentUserEmail || currentUserName)
                    .order('updated_at', { ascending: false })
                    .limit(5);

                if (error) throw error;
                
                return surveys.map(survey => ({
                    surveyId: survey.survey_id,
                    eventName: survey.event_name || 'Unnamed Event',
                    venueName: survey.venue_name || 'Venue TBD',
                    status: survey.status || 'In Progress',
                    lastUpdated: survey.updated_at,
                    ...survey
                })) || [];
            } catch (error) {
                console.error('Error fetching recent surveys:', error);
                return [];
            }
        }

        function initializeAppAndAuth() {
            try {
                // Use authenticated user from Microsoft SSO
                currentUserName = window.currentUserName || currentUserName;
                
                // Initialize Supabase auth listener only if Supabase is available
                if (supabase) {
                    // For this application, we use Microsoft SSO for authentication
                    // Supabase is used only for data storage, not authentication
                    
                    // Use a consistent user ID based on the authenticated user
                    if (window.currentUserEmail) {
                        // Create a deterministic user ID from email for consistent database access
                        currentUserId = btoa(window.currentUserEmail).replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
                        updateUserDisplay();
                        initializeSupabaseListeners();
                    } else {
                        console.log('Waiting for Microsoft SSO authentication to complete...');
                    }
                } else {
                    console.log('Supabase not available - running in offline mode');
                    // Set a fallback user ID for offline mode
                    currentUserId = `offline_${Date.now()}`;
                    updateUserDisplay();
                    // Initialize UI without database features
                    initializeOfflineMode();
                }
            } catch (e) {
                console.error("Failed to initialize app:", e);
                document.body.innerHTML = '<div class="text-center p-8 text-red-600">Failed to initialize. Check console for details.</div>';
            }
        }

        function initializeOfflineMode() {
            console.log('Running in offline mode - database features disabled');
            // Initialize basic UI without database dependencies
            if (saveStatus) {
                saveStatus.textContent = 'Offline Mode - Changes not saved';
                saveStatus.className = 'text-orange-600';
            }
        }
        
        function initializeSupabaseListeners() {
            // Initialize venue database
            initializeVenueDatabase();
            
            // Initialize survey database
            initializeSurveyDatabase();
            
            // Initialize role system
            initializeRoleSystem();
            
            // Initialize collaborative editing
            initializeCollaborativeEditing();

            // Initialize mobile menu
            initializeMobileMenu();

            // Subscribe to survey data changes
            setupSurveyDataSubscription();
            
            // Subscribe to activity log changes
            setupActivityLogSubscription();
        }

        async function setupSurveyDataSubscription() {
            // Skip database query for new surveys that don't exist yet
            if (window.appId && window.appId.startsWith('NEW-')) {
                console.log('New survey detected, initializing with empty data');
                const data = {
                    'r2-number': window.appId
                };
                fullSurveyData = data;
                Object.keys(data).forEach(key => {
                    previousFieldValues[key] = data[key];
                });
                renderAllSections(data);
                return;
            }

            // Get initial data for existing surveys
            const { data: surveyData, error: surveyError } = await supabase
                .from('surveys').select('survey_id,status::text,created_by::text,updated_by::text,survey_data::text')
                .eq('survey_id', window.appId)
                .single();

            if (surveyError && surveyError.code !== 'PGRST116') { // PGRST116 = no rows returned
                console.error("Error fetching survey data:", surveyError);
            } else {
                const data = surveyData?.survey_data || {};
                if (!surveyData) {
                    data['r2-number'] = window.appId; 
                }
                
                // Store current data and update previous values tracker
                fullSurveyData = data;
                if (Object.keys(previousFieldValues).length === 0) {
                    // First load - populate previous values
                    previousFieldValues = { ...data };
                }
                
                renderAllSections(data);
                if (!surveyData) {
                    updateSurveyData({ 'r2-number': window.appId }, false); // Don't auto-save on initialization
                }
            }

            // Set up real-time subscription
            const surveySubscription = supabase
                .channel(`survey-${window.appId}`)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'surveys',
                    filter: `survey_id=eq.${window.appId}`
                }, (payload) => {
                    const data = payload.new?.survey_data || {};
                    fullSurveyData = data;
                    renderAllSections(data);
                })
                .subscribe();
        }

        async function setupActivityLogSubscription() {
            // Temporarily disabled activity log due to database schema issues
            console.log('Activity log subscription disabled - will be re-enabled after database schema update');
            return;
            
            // Get initial activity data
            const { data: activityData, error: activityError } = await supabase
                .from('survey_activity').select('survey_id,created_by::text,updated_by::text,timestamp::text')
                .eq('survey_id', window.appId)
                .order('timestamp', { ascending: false });

            if (activityError) {
                console.error("Error fetching activity log:", activityError);
            } else {
                renderActivityLog(activityData || []);
            }

            // Set up real-time subscription for activity
            const activitySubscription = supabase
                .channel(`activity-${window.appId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'survey_activity',
                    filter: `survey_id=eq.${window.appId}`
                }, async () => {
                    // Refetch activity data when new activity is added
                    const { data: newActivityData } = await supabase
                        .from('survey_activity').select('survey_id,created_by::text,updated_by::text,timestamp::text')
                        .eq('survey_id', window.appId)
                        .order('timestamp', { ascending: false });
                    
                    renderActivityLog(newActivityData || []);
                })
                .subscribe();
        }

        function setupUI() {
            console.log('setupUI called');
            
            // Ensure survey interface is visible if we have an appId
            if (window.appId) {
                const mainContainer = document.querySelector('.container');
                if (mainContainer) {
                    mainContainer.style.display = 'block';
                    mainContainer.style.visibility = 'visible';
                    mainContainer.style.opacity = '1';
                }
                
                // Make sure all content sections are visible
                const sections = document.querySelectorAll('.content-section');
                sections.forEach(section => {
                    section.style.display = 'block';
                    section.style.visibility = 'visible';
                    section.style.opacity = '1';
                });
                
                // Make sure navigation is visible and styled
                const nav = document.querySelector('nav');
                if (nav) {
                    nav.style.display = 'block';
                    nav.style.visibility = 'visible';
                }
            }
            
            const headerSubtitle = document.getElementById('header-subtitle');
            if (headerSubtitle) {
                headerSubtitle.textContent = `A Collaborative Checklist for R2# ${window.appId}`;
            }

            const navButtons = document.querySelectorAll('.nav-btn');
            console.log('Found nav buttons:', navButtons.length);
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    console.log('Nav button clicked, target:', targetId);
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.classList.add('active');
                        console.log('Section activated:', targetId);
                    } else {
                        console.error('Target section not found:', targetId);
                    }
                    if(currentUserName) {
                        // Removed tab viewing activity tracking
                        // Update presence with current section
                        updateUserPresence();
                    }
                    // Close mobile menu when item is clicked
                    closeMobileMenu();
                });
            });
            const firstNavBtn = document.querySelector('.nav-btn[data-target="event-info"]');
            if (firstNavBtn) {
                console.log('Clicking first nav button');
                firstNavBtn.click();
                
                // Force the first section to be visible with inline styles
                setTimeout(() => {
                    const eventInfoSection = document.getElementById('event-info');
                    if (eventInfoSection) {
                        eventInfoSection.style.display = 'block';
                        eventInfoSection.style.visibility = 'visible';
                        eventInfoSection.style.opacity = '1';
                        eventInfoSection.style.position = 'relative';
                        eventInfoSection.style.zIndex = '10';
                        eventInfoSection.style.background = 'white';
                        eventInfoSection.style.minHeight = '200px';
                        console.log('Forced event-info section to be visible');
                        
                        // Also force the container to be extra visible - but only when survey is active
                        const container = document.querySelector('.container');
                        if (container && window.appId) {
                            container.style.display = 'block';
                            container.style.visibility = 'visible';
                            container.style.opacity = '1';
                            container.style.position = 'relative';
                            container.style.zIndex = '1';
                            
                            // Override any problematic CSS
                            container.style.height = 'auto';
                            container.style.maxHeight = 'none';
                            container.style.overflow = 'visible';
                            container.style.transform = 'none';
                            
                            console.log('Applied forced container styles');
                        }
                        
                        // Force the active content section to be visible with clean styling
                        const activeSection = document.querySelector('.content-section.active');
                        if (activeSection) {
                            activeSection.style.display = 'block';
                            activeSection.style.visibility = 'visible';
                            activeSection.style.opacity = '1';
                            activeSection.style.position = 'relative';
                            activeSection.style.zIndex = '10';
                            activeSection.style.backgroundColor = 'white';
                            activeSection.style.minHeight = '200px';
                            activeSection.style.padding = '2rem';
                            activeSection.style.margin = '1rem 0';
                            // Remove the red border for a cleaner look
                            activeSection.style.border = '1px solid #e5e7eb';
                            activeSection.style.borderRadius = '0.75rem';
                            activeSection.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
                        }
                        
                        // Make sure navigation is visible when survey is active
                        const header = container?.querySelector('header');
                        const nav = container?.querySelector('nav');
                        if (header && window.appId) {
                            header.style.display = 'block';
                            header.style.visibility = 'visible';
                            header.style.opacity = '1';
                        }
                        if (nav && window.appId) {
                            nav.style.display = 'block';
                            nav.style.visibility = 'visible';
                            nav.style.opacity = '1';
                        }
                    }
                }, 100);
            } else {
                console.error('First nav button not found');
            }
        }

        function initializeMobileMenu() {
            const hamburger = document.getElementById('mobile-menu-btn');
            const mobileNav = document.getElementById('mobile-nav');
            const navOverlay = document.getElementById('nav-overlay');
            
            if (hamburger) {
                hamburger.addEventListener('click', toggleMobileMenu);
            }
            
            if (navOverlay) {
                navOverlay.addEventListener('click', closeMobileMenu);
            }
        }

        function toggleMobileMenu() {
            const hamburger = document.getElementById('mobile-menu-btn');
            const mobileNav = document.getElementById('mobile-nav');
            const navOverlay = document.getElementById('nav-overlay');
            
            hamburger.classList.toggle('active');
            mobileNav.classList.toggle('open');
            navOverlay.classList.toggle('open');
            
            // Prevent body scroll when menu is open
            document.body.style.overflow = mobileNav.classList.contains('open') ? 'hidden' : '';
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('mobile-menu-btn');
            const mobileNav = document.getElementById('mobile-nav');
            const navOverlay = document.getElementById('nav-overlay');
            
            hamburger.classList.remove('active');
            mobileNav.classList.remove('open');
            navOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }

        function updateUserDisplay() {
            const userRole = getUserRole();
            const roleColors = {
                'admin': 'text-red-600 font-bold',
                'manager': 'text-blue-600 font-semibold',
                'user': 'text-gray-600'
            };
            
            if(userDisplay) {
                userDisplay.innerHTML = `${currentUserName || 'Anonymous'} (${currentUserId}) - <span class="${roleColors[userRole] || 'text-gray-600'}">${userRole.toUpperCase()}</span>`;
            }
        }

        function renderAllSections(data = {}) {
            console.log('renderAllSections called with data:', data);
            console.log('Event info element:', document.getElementById('event-info'));
            
            // Ensure all sections are visible before rendering
            if (window.appId) {
                const sections = document.querySelectorAll('.content-section');
                sections.forEach(section => {
                    section.style.display = 'block';
                    section.style.visibility = 'visible';
                    section.style.opacity = '1';
                });
            }
            
            renderEventInfoSection(data);
            renderClientInfoSection(data);
            renderVenueInfoSection(data);
            renderLogisticsSection(data);
            renderRoomsSection(data);
            renderVenueGuidelinesSection(data);
            renderWrapUpSection(data);
            renderSummaryExportSection(data);
            
            // Update survey info display
            const surveyInfo = document.getElementById('survey-info');
            if (surveyInfo) {
                const version = data.version || 1;
                const status = data.status || 'In Progress';
                const lastSaved = data.lastSavedToDatabase ? new Date(data.lastSavedToDatabase).toLocaleDateString() : 'Never';
                surveyInfo.textContent = `Version ${version} | ${status} | Last saved: ${lastSaved}`;
            }
        }
        
        async function updateSurveyData(dataObject, triggerAutoSave = false) {
            if (!currentUserId || !window.appId) return;
            if(saveStatus) saveStatus.textContent = 'Saving...';
            try {
                // Merge with existing data
                const mergedData = { ...fullSurveyData, ...dataObject };
                
                const { error } = await supabase
                    .from('surveys')
                    .upsert({
                        survey_id: window.appId,
                        survey_data: mergedData,
                        updated_at: new Date().toISOString(),
                        updated_by: window.currentUserEmail || currentUserId
                    }, {
                        onConflict: 'survey_id'
                    });

                if (error) throw error;

                if(saveStatus) {
                    saveStatus.textContent = 'All changes saved.';
                    setTimeout(() => { if(saveStatus) saveStatus.textContent = ''; }, 2000);
                }
                
                // Only schedule auto-save for significant changes, not every field update
                if (triggerAutoSave) {
                    scheduleAutoSave();
                }
                
            } catch (e) {
                console.error("Error updating document:", e);
                if(saveStatus) saveStatus.textContent = 'Error saving.';
            }
        }
        
        function handleFormChange(event) {
            const target = event.target;
            let fieldName = target.name || target.id;
            let newValue = target.type === 'checkbox' ? target.checked : target.value;
            
            // Map survey-status to status
            if (fieldName === 'survey-status') {
                fieldName = 'status';
            }
            
            if (target.type === 'radio') {
                if (!target.checked) return;
            }

            // Get previous value for change tracking
            const previousValue = previousFieldValues[fieldName];
            
            // Only proceed if value actually changed
            if (previousValue === newValue) return;

            clearTimeout(formInputTimeout);
            
            // Show typing indicator for collaborative editing
            showTypingIndicator(fieldName, target);
            
            formInputTimeout = setTimeout(() => {
                // Define which fields should trigger auto-save to database
                const significantFields = [
                    'event-name', 'venue-name', 'client-business', 'status',
                    'event-date', 'event-start-time', 'event-end-time',
                    'attendee-count', 'contact-name', 'contact-email', 'contact-phone'
                ];
                
                const shouldTriggerAutoSave = significantFields.includes(fieldName) || 
                                            fieldName.startsWith('room-') || 
                                            fieldName.includes('agenda');
                
                const dataObject = { [fieldName]: newValue };
                updateSurveyData(dataObject, shouldTriggerAutoSave);
                
                // Track the change for activity logging
                queueFieldChange(fieldName, previousValue, newValue);
                
                // Update previous value tracker
                previousFieldValues[fieldName] = newValue;
                
                // Hide typing indicator
                hideTypingIndicator(fieldName);
                
                // Auto-save venue data if venue-related fields changed
                if (['venue-name', 'venue-address', 'venue-contact'].includes(fieldName) ||
                    fieldName.startsWith('dock-') || fieldName.startsWith('freight-') ||
                    fieldName.includes('ramp') || fieldName.includes('trailer') || fieldName.includes('cab')) {
                    setTimeout(autoSaveVenueData, 2000);
                }
            }, 500);
        }

        async function showTypingIndicator(fieldName, element) {
            if (!currentUserId) return;
            
            try {
                await supabase
                    .from('user_presence')
                    .upsert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || currentUserName,
                        is_typing: true,
                        typing_field: fieldName,
                        last_active: new Date().toISOString()
                    }, {
                        onConflict: 'survey_id,user_email'
                    });
                
                // Add visual indicator to the field
                element.classList.add('field-being-edited');
            } catch (error) {
                console.error('Error showing typing indicator:', error);
            }
        }

        async function hideTypingIndicator(fieldName) {
            if (!currentUserId) return;
            
            try {
                await supabase
                    .from('user_presence')
                    .upsert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || currentUserName,
                        is_typing: false,
                        typing_field: null,
                        last_active: new Date().toISOString()
                    }, {
                        onConflict: 'survey_id,user_email'
                    });
                
                // Remove visual indicator from all fields with this name
                document.querySelectorAll(`[name="${fieldName}"], #${fieldName}`).forEach(el => {
                    el.classList.remove('field-being-edited');
                });
            } catch (error) {
                console.error('Error hiding typing indicator:', error);
            }
        }

        // Collaborative Editing Features
        let collaborativeUsers = new Map();

        function initializeCollaborativeEditing() {
            // Temporarily disabled collaborative editing due to database schema issues
            console.log('Collaborative editing disabled - will be re-enabled after database schema update');
            return;
            
            if (!supabase || !window.appId || !currentUserId) return;
            
            // Update user presence
            updateUserPresence();
            
            // Set up real-time subscription for user presence
            setupUserPresenceSubscription();
            
            // Clean up presence on page unload
            window.addEventListener('beforeunload', () => {
                cleanupUserPresence();
            });
            
            // Heartbeat to maintain presence
            setInterval(updateUserPresence, 30000); // Every 30 seconds
        }

        async function setupUserPresenceSubscription() {
            // Get initial user presence data
            const { data: presenceData, error: presenceError } = await supabase
                .from('user_presence').select('survey_id,user_email::text,last_seen::text')
                .eq('survey_id', window.appId);

            if (presenceError) {
                console.error("Error fetching user presence:", presenceError);
            } else {
                updateActiveUsersDisplay(presenceData || []);
            }

            // Set up real-time subscription for user presence
            const presenceSubscription = supabase
                .channel(`presence-${window.appId}`)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'user_presence',
                    filter: `survey_id=eq.${window.appId}`
                }, async () => {
                    // Refetch presence data when changes occur
                    const { data: newPresenceData } = await supabase
                        .from('user_presence').select('survey_id,user_email::text,last_seen::text')
                        .eq('survey_id', window.appId);
                    
                    updateActiveUsersDisplay(newPresenceData || []);
                })
                .subscribe();
        }

        async function updateUserPresence() {
            if (!currentUserId) return;
            
            try {
                const { error } = await supabase
                    .from('user_presence')
                    .upsert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || currentUserName,
                        user_name: currentUserName || 'Anonymous',
                        last_active: new Date().toISOString(),
                        current_section: getCurrentActiveSection(),
                        is_typing: false,
                        typing_field: null
                    }, {
                        onConflict: 'survey_id,user_email'
                    });

                if (error) throw error;
            } catch (error) {
                console.error('Error updating user presence:', error);
            }
        }

        async function cleanupUserPresence() {
            if (!currentUserId) return;
            
            try {
                await supabase
                    .from('user_presence')
                    .delete()
                    .eq('survey_id', window.appId)
                    .eq('user_email', window.currentUserEmail || currentUserName);
            } catch (error) {
                console.error('Error cleaning up user presence:', error);
            }
        }

        function getCurrentActiveSection() {
            const activeSection = document.querySelector('.content-section.active');
            return activeSection ? activeSection.id : 'general';
        }

        function updateActiveUsersDisplay(presenceData) {
            collaborativeUsers.clear();
            const now = new Date();
            
            presenceData.forEach(userData => {
                const lastActive = new Date(userData.last_active);
                const currentUserIdentifier = window.currentUserEmail || currentUserName;
                
                // Consider user active if they were active in the last 2 minutes
                if (lastActive && (now - lastActive) < 120000 && userData.user_email !== currentUserIdentifier) {
                    collaborativeUsers.set(userData.user_email, {
                        userId: userData.user_email,
                        userName: userData.user_name,
                        userEmail: userData.user_email,
                        lastActive: lastActive,
                        currentSection: userData.current_section,
                        isTyping: userData.is_typing,
                        typingField: userData.typing_field
                    });
                }
            });
            
            renderCollaborativeIndicators();
        }

        function renderCollaborativeIndicators() {
            // Update header with active users count
            updateHeaderWithActiveUsers();
            
            // Add indicators to sections where users are active
            updateSectionIndicators();
        }

        function updateHeaderWithActiveUsers() {
            let indicator = document.getElementById('collaborative-indicator');
            
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'collaborative-indicator';
                indicator.className = 'flex items-center gap-2 text-sm text-gray-600';
                
                const header = document.querySelector('header');
                if (header) {
                    const buttonsDiv = header.querySelector('.mt-4');
                    if (buttonsDiv) {
                        buttonsDiv.appendChild(indicator);
                    }
                }
            }
            
            if (collaborativeUsers.size > 0) {
                const userNames = Array.from(collaborativeUsers.values()).map(user => user.userName);
                indicator.innerHTML = `
                    <span class="flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <span>${collaborativeUsers.size} other user(s) online: ${userNames.join(', ')}</span>
                    </span>
                `;
            } else {
                indicator.innerHTML = '';
            }
        }

        function updateSectionIndicators() {
            // Remove existing indicators
            document.querySelectorAll('.collaborative-user-indicator').forEach(el => el.remove());
            
            // Add indicators for each section where users are active
            collaborativeUsers.forEach(user => {
                if (user.currentSection) {
                    const sectionElement = document.getElementById(user.currentSection);
                    if (sectionElement) {
                        const indicator = document.createElement('div');
                        indicator.className = 'collaborative-user-indicator absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs flex items-center gap-1';
                        indicator.innerHTML = `
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                            <span>${user.userName} is here</span>
                        `;
                        
                        // Make sure section has relative positioning
                        sectionElement.style.position = 'relative';
                        sectionElement.appendChild(indicator);
                    }
                }
            });
        }

        function queueFieldChange(fieldName, previousValue, newValue) {
            if (!currentUserId || !currentUserName) return;
            
            const now = new Date();
            const minuteKey = `${currentUserId}_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            if (!pendingChanges[minuteKey]) {
                pendingChanges[minuteKey] = {
                    userId: currentUserId,
                    userName: currentUserName,
                    timestamp: now,
                    changes: [],
                    section: getCurrentActiveSection()
                };
            }
            
            // Format the change description
            const friendlyFieldName = getFriendlyFieldName(fieldName);
            let changeDescription;
            
            if (previousValue === undefined || previousValue === null || previousValue === '') {
                changeDescription = `Added ${friendlyFieldName}: "${newValue}"`;
            } else {
                changeDescription = `Changed ${friendlyFieldName} from "${previousValue}" to "${newValue}"`;
            }
            
            pendingChanges[minuteKey].changes.push(changeDescription);
            
            // Clear existing timeout and set new one
            clearTimeout(changeFlushTimeout);
            changeFlushTimeout = setTimeout(flushPendingChanges, 3000); // Flush after 3 seconds of inactivity
        }

        function getFriendlyFieldName(fieldName) {
            const fieldNameMap = {
                'event-name': 'Event Name',
                'venue-name': 'Venue Name',
                'client-business': 'Client Business',
                'client-name': 'Client Name',
                'client-cell': 'Client Phone',
                'client-email': 'Client Email',
                'r2-quote-number': 'R2 Quote Number',
                'anticipated-attendees': 'Anticipated Attendees',
                'charge-days': 'Charge Days',
                'budget': 'Budget',
                'venue-address': 'Venue Address',
                'venue-contact': 'Venue Contact',
                'status': 'Survey Status',
                'dock-location': 'Dock Location',
                'dock-door-height': 'Dock Door Height',
                'num-dock-spaces': 'Number of Dock Spaces'
            };
            
            return fieldNameMap[fieldName] || fieldName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        async function flushPendingChanges() {
            if (Object.keys(pendingChanges).length === 0) return;
            
            try {
                for (const [minuteKey, batch] of Object.entries(pendingChanges)) {
                    const summary = batch.changes.length === 1 
                        ? batch.changes[0]
                        : `Made ${batch.changes.length} changes: ${batch.changes.join(', ')}`;
                    
                    await supabase
                        .from('survey_activity')
                        .insert({
                            survey_id: window.appId,
                            user_email: window.currentUserEmail || 'anonymous',
                            user_name: batch.userName,
                            description: summary,
                            section: batch.section,
                            timestamp: new Date().toISOString(),
                            change_count: batch.changes.length,
                            changes: batch.changes
                        });
                }
                
                // Clear pending changes
                pendingChanges = {};
                
            } catch (e) {
                console.error("Error flushing activity changes: ", e);
            }
        }

        async function logActivity(description) {
            // For non-field changes (like file uploads, AI processing, etc.)
            if (!currentUserId || !currentUserName) return;
            try {
                await supabase
                    .from('survey_activity')
                    .insert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || 'anonymous',
                        user_name: currentUserName,
                        description: description,
                        section: getCurrentActiveSection(),
                        timestamp: new Date().toISOString(),
                        change_count: 1
                    });
                
                // Update presence with current activity
                await supabase
                    .from('user_presence')
                    .upsert({
                        survey_id: window.appId,
                        user_email: window.currentUserEmail || currentUserName,
                        last_active: new Date().toISOString()
                    }, {
                        onConflict: 'survey_id,user_email'
                    });
            } catch (e) {
                console.error("Error adding activity log: ", e);
            }
        }

        // Photo handling functions
        async function uploadPhoto(file, section, photoId = null) {
            if (!currentUserId) return null;
            
            try {
                const timestamp = Date.now();
                const fileName = photoId || `${section}_${timestamp}_${file.name}`;
                const filePath = `surveys/${window.appId}/photos/${fileName}`;
                
                const { data, error } = await supabase.storage
                    .from('survey-files')
                    .upload(filePath, file);

                if (error) throw error;

                const { data: { publicUrl } } = supabase.storage
                    .from('survey-files')
                    .getPublicUrl(filePath);
                
                return {
                    id: fileName,
                    url: publicUrl,
                    name: file.name,
                    uploadedBy: currentUserName,
                    uploadedAt: timestamp,
                    section: section
                };
            } catch (error) {
                console.error("Error uploading photo:", error);
                throw error;
            }
        }

        async function deletePhoto(photoId) {
            if (!currentUserId) return;
            
            try {
                const filePath = `surveys/${window.appId}/photos/${photoId}`;
                const { error } = await supabase.storage
                    .from('survey-files')
                    .remove([filePath]);

                if (error) throw error;
            } catch (error) {
                console.error("Error deleting photo:", error);
                throw error;
            }
        }

        function createPhotoUploadArea(sectionName, fieldName = null) {
            const fieldId = fieldName ? `${sectionName}-${fieldName}` : sectionName;
            const displayName = fieldName ? fieldName.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) : sectionName.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            return `
                <div class="photo-section mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <h4 class="font-semibold text-gray-700 mb-3">📸 Photos - ${displayName}</h4>
                    
                    <div class="photo-upload-area mb-4" data-section="${fieldId}">
                        <input type="file" id="photo-input-${fieldId}" accept="image/*" capture="environment" multiple class="hidden">
                        <div class="upload-content">
                            <svg class="mx-auto h-12 w-12 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="text-gray-600 mb-2">Drop photos here or click to select</p>
                            <button type="button" class="photo-upload-btn bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700" data-target="photo-input-${fieldId}">
                                📷 Choose Photos / Take Photo
                            </button>
                        </div>
                    </div>
                    
                    <div id="photo-grid-${fieldId}" class="photo-grid"></div>
                </div>
            `;
        }

        function setupPhotoUploadListeners(container) {
            const uploadAreas = container.querySelectorAll('.photo-upload-area');
            
            uploadAreas.forEach(area => {
                const sectionName = area.dataset.section;
                const input = area.querySelector(`#photo-input-${sectionName}`);
                const uploadBtn = area.querySelector('.photo-upload-btn');
                
                // Upload button click
                uploadBtn?.addEventListener('click', () => {
                    input?.click();
                });
                
                // File input change
                input?.addEventListener('change', (e) => {
                    handlePhotoUpload(e.target.files, sectionName);
                });
                
                // Drag and drop
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });
                
                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });
                
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    handlePhotoUpload(e.dataTransfer.files, sectionName);
                });
            });
        }

        async function handlePhotoUpload(files, sectionName) {
            if (!files || files.length === 0) return;
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    alert('Please select only image files.');
                    continue;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('File size must be less than 5MB.');
                    continue;
                }
                
                try {
                    const photoData = await uploadPhoto(file, sectionName);
                    
                    // Add to survey data
                    const currentData = await getCurrentSurveyData();
                    const photos = currentData.photos || {};
                    if (!photos[sectionName]) photos[sectionName] = [];
                    photos[sectionName].push(photoData);
                    
                    await updateSurveyData({ photos });
                    logActivity(`Uploaded photo "${file.name}" to ${sectionName} section`);
                    
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert('Failed to upload photo. Please try again.');
                }
            }
        }

        async function handlePhotoDelete(photoId, sectionName) {
            try {
                await deletePhoto(photoId);
                
                // Remove from survey data
                const currentData = await getCurrentSurveyData();
                const photos = currentData.photos || {};
                if (photos[sectionName]) {
                    photos[sectionName] = photos[sectionName].filter(photo => photo.id !== photoId);
                    if (photos[sectionName].length === 0) {
                        delete photos[sectionName];
                    }
                }
                
                await updateSurveyData({ photos });
                logActivity(`Deleted photo from ${sectionName} section`);
                
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete photo. Please try again.');
            }
        }

        function renderPhotos(sectionName, photos = []) {
            const grid = document.getElementById(`photo-grid-${sectionName}`);
            if (!grid) return;
            
            if (photos.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 text-center py-4">No photos uploaded yet.</p>';
                return;
            }
            
            grid.innerHTML = photos.map(photo => `
                <div class="photo-item">
                    <img src="${photo.url}" alt="${photo.name}" class="photo-preview w-full h-32 object-cover">
                    <div class="p-2 bg-white">
                        <p class="text-xs text-gray-600 truncate" title="${photo.name}">${photo.name}</p>
                        <p class="text-xs text-gray-400">By ${photo.uploadedBy}</p>
                    </div>
                    <button class="photo-delete-btn" onclick="handlePhotoDelete('${photo.id}', '${sectionName}')" title="Delete photo">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        async function getCurrentSurveyData() {
            // Return empty data for new surveys that don't exist in database yet
            if (window.appId && window.appId.startsWith('NEW-')) {
                return fullSurveyData || {};
            }

            try {
                const { data: surveyData, error } = await supabase
                    .from('surveys').select('survey_id,status::text,created_by::text,updated_by::text,survey_data::text')
                    .eq('survey_id', window.appId)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    console.error('Error fetching current survey data:', error);
                    return {};
                }

                return surveyData?.survey_data || {};
            } catch (error) {
                console.error('Error fetching current survey data:', error);
                return {};
            }
        }

        // Role-based Access Control (WordPress Integration)
        let wpUserData = null;
        
        function initializeRoleSystem() {
            // Load WordPress user data if available
            loadWordPressUserData();
        }
        
        function loadWordPressUserData() {
            // Check if WordPress user data is available (set by PHP)
            if (typeof window.wpUser !== 'undefined') {
                wpUserData = window.wpUser;
                console.log('WordPress user data loaded:', wpUserData);
            } else {
                console.log('No WordPress user data found, using fallback system');
            }
        }
        
        async function updateUserRole(userEmail, newRole) {
            if (!checkAccess('manageUsers')) {
                throw new Error('Access denied - admin privileges required');
            }
            
            try {
                // Call WordPress REST API to update user role
                const response = await fetch('/wp-json/wp/v2/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-WP-Nonce': window.wpNonce || '' // WordPress nonce for security
                    },
                    body: JSON.stringify({
                        action: 'update_user_role',
                        email: userEmail,
                        role: mapToWordPressRole(newRole)
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update user role in WordPress');
                }
                
                logActivity(`Updated user role: ${userEmail} is now ${newRole}`);
                return true;
                
            } catch (error) {
                console.error('Error updating user role:', error);
                // Fallback: Log the action for manual processing
                logActivity(`ADMIN ACTION NEEDED: Set ${userEmail} role to ${newRole}`);
                throw error;
            }
        }
        
        function mapToWordPressRole(appRole) {
            // Map our application roles to WordPress roles
            switch(appRole) {
                case 'admin': return 'administrator';
                case 'manager': return 'site_survey_manager'; // Custom role
                case 'user': return 'site_survey_user'; // Custom role
                default: return 'subscriber';
            }
        }
        
        async function getUsersList() {
            if (!checkAccess('manageUsers')) {
                return [];
            }
            
            try {
                // Fetch WordPress users with survey-related roles
                const response = await fetch('/wp-json/wp/v2/users?roles=administrator,site_survey_manager,site_survey_user', {
                    headers: {
                        'X-WP-Nonce': window.wpNonce || ''
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch users from WordPress');
                }
                
                const users = await response.json();
                return users.map(user => ({
                    email: user.email,
                    role: mapFromWordPressRole(user.roles[0]),
                    name: user.name,
                    updatedBy: 'WordPress',
                    updatedAt: user.date_modified || user.date
                })).sort((a, b) => a.email.localeCompare(b.email));
                
            } catch (error) {
                console.error('Error getting users list:', error);
                // Return mock data for development
                return [
                    {
                        email: 'alex.greene@ita.com',
                        role: 'admin',
                        name: 'Alex Greene',
                        updatedBy: 'System',
                        updatedAt: new Date().toISOString()
                    }
                ];
            }
        }
        
        function mapFromWordPressRole(wpRole) {
            // Map WordPress roles back to our application roles
            switch(wpRole) {
                case 'administrator': return 'admin';
                case 'site_survey_manager': return 'manager';
                case 'site_survey_user': return 'user';
                default: return 'user';
            }
        }

        function checkAccess(permission) {
            const userRole = getUserRole();
            
            const permissions = {
                'user': [
                    'createSurvey',
                    'editOwnSurvey',
                    'viewSurvey'
                ],
                'manager': [
                    'createSurvey',
                    'editOwnSurvey',
                    'viewSurvey',
                    'editAnySurvey',
                    'viewHistory',
                    'createVenue',
                    'editOwnVenue',
                    'viewVenueList'
                ],
                'admin': [
                    'createSurvey',
                    'editOwnSurvey',
                    'viewSurvey',
                    'editAnySurvey',
                    'viewHistory',
                    'deleteSurvey',
                    'createVenue',
                    'editOwnVenue',
                    'editAnyVenue',
                    'viewVenueList',
                    'deleteVenue',
                    'manageUsers',
                    'manageRoles'
                ]
            };
            
            return permissions[userRole]?.includes(permission) || false;
        }

        // Survey Management Functions
        
        function initializeSurveyDatabase() {
            // No initialization needed for Supabase - using direct client
        }

        async function saveSurveyToDatabase(silent = false) {
            if (!supabase || !window.appId) return;
            
            try {
                // Check if this is a new survey that needs a proper R2 number
                if (window.appId.startsWith('NEW-') && !silent) {
                    const r2Number = prompt('Please enter the R2 order number for this survey (e.g., 0912345):');
                    if (!r2Number) {
                        if (!silent) alert('Save cancelled - R2 number is required');
                        return;
                    }
                    
                    // Check if this R2 number already exists
                    const existing = await checkExistingSurvey(r2Number);
                    if (existing && existing.exists) {
                        const proceed = confirm(`A survey with R2 number ${r2Number} already exists. Do you want to update it instead?`);
                        if (!proceed) {
                            if (!silent) alert('Save cancelled');
                            return;
                        }
                    }
                    
                    // Update the survey ID to the proper R2 number
                    window.appId = r2Number;
                    
                    // Update URL
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('id', r2Number);
                    window.history.pushState({}, '', newUrl);
                    
                    // Update the R2 number field in the data
                    fullSurveyData['r2-number'] = r2Number;
                    
                    console.log('Updated survey ID from temporary to:', r2Number);
                }

                const currentData = await getCurrentSurveyData();
                
                const surveyDoc = {
                    survey_id: window.appId,
                    event_name: currentData['event-name'] || 'Unnamed Event',
                    venue_name: currentData['venue-name'] || 'TBD',
                    client_business: currentData['client-business'] || '',
                    status: currentData.status || 'In Progress',
                    updated_at: new Date().toISOString(),
                    updated_by: window.currentUserEmail || currentUserName,
                    survey_data: currentData,
                    version: (currentData.version || 0) + 1,
                    tags: currentData.tags || [],
                    
                    // Event contact fields
                    event_contact_name: currentData['event-contact-name'] || '',
                    event_contact_email: currentData['event-contact-email'] || '',
                    event_contact_phone: currentData['event-contact-phone'] || '',
                    event_contact_title: currentData['event-contact-title'] || '',
                    
                    // Client information fields
                    client_name: currentData['client-name'] || currentData['client-contact'] || '',
                    client_email: currentData['client-email'] || '',
                    client_cell: currentData['client-cell'] || '',
                    client_address: currentData['client-address'] || '',
                    client_company: currentData['client-company'] || currentData['client-business'] || '',
                    client_title: currentData['client-title'] || '',
                    tax_status: currentData['tax-status'] || '',
                    
                    // Event details
                    r2_quote_number: currentData['r2-quote-number'] || currentData['r2-number'] || '',
                    anticipated_attendees: parseInt(currentData['anticipated-attendees']) || null,
                    event_date: currentData['event-date'] || '',
                    event_start_time: currentData['event-start-time'] || '',
                    event_end_time: currentData['event-end-time'] || '',
                    charge_days: parseInt(currentData['charge-days']) || null,
                    budget: currentData['budget'] || '',
                    
                    // Survey team information
                    survey_date: currentData['survey-date'] || '',
                    survey_team: currentData['survey-team'] || '',
                    project_manager: currentData['project-manager'] || '',
                    account_rep: currentData['account-rep'] || '',
                    
                    // Room fields (for primary room if exists)
                    room_capacity: currentData.rooms && currentData.rooms[0] ? parseInt(currentData.rooms[0].capacity) || null : null,
                    room_layout: currentData.rooms && currentData.rooms[0] ? currentData.rooms[0].layout || '' : '',
                    room_setup_notes: currentData.rooms && currentData.rooms[0] ? currentData.rooms[0].setupNotes || '' : ''
                };
                
                const { error } = await supabase
                    .from('surveys')
                    .upsert(surveyDoc, {
                        onConflict: 'survey_id'
                    });

                if (error) throw error;
                
                if (!silent) {
                    logActivity(`Manually saved survey "${window.appId}" to database`);
                    // Show success notification only for manual saves
                    showNotification('Survey saved to database successfully!', 'success');
                }
                
                // Update local data with metadata (don't trigger auto-save for metadata updates)
                await updateSurveyData({ 
                    version: surveyDoc.version,
                    lastSavedToDatabase: new Date().toISOString()
                }, false);
                
            } catch (error) {
                console.error('Error saving survey to database:', error);
                if (!silent) {
                    showNotification('Failed to save survey to database', 'error');
                }
            }
        }

        async function checkExistingSurvey(r2Number) {
            if (!supabase) {
                console.log('Supabase not available - skipping duplicate check');
                return null;
            }
            
            try {
                // Check if there's already a survey for this R2
                const { data: surveyData, error: surveyError } = await supabase
                    .from('surveys').select('survey_id,status::text,created_by::text,updated_by::text,survey_data::text')
                    .eq('survey_id', r2Number)
                    .single();

                if (surveyData && !surveyError) {
                    // Also check the survey database for additional info
                    const { data: dbSurvey } = await supabase
                        .from('survey_database').select('survey_id,created_by::text,updated_by::text')
                        .eq('survey_id', r2Number)
                        .single();

                    return {
                        exists: true,
                        data: surveyData.survey_data,
                        dbData: dbSurvey
                    };
                }
                
                // Also check the survey database directly
                const { data: dbSurvey, error: dbError } = await supabase
                    .from('survey_database').select('survey_id,created_by::text,updated_by::text')
                    .eq('survey_id', r2Number)
                    .single();

                if (dbSurvey && !dbError) {
                    return {
                        exists: true,
                        data: null,
                        dbData: dbSurvey
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error checking existing survey:', error);
                return null;
            }
        }

        async function showDuplicateSurveyDialog(existingSurvey) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const surveyData = existingSurvey.dbData || existingSurvey.data || {};
                const eventName = surveyData.eventName || surveyData['event-name'] || 'Unknown Event';
                const lastUpdated = surveyData.lastUpdated || surveyData.lastSavedToDatabase;
                const lastUpdatedBy = surveyData.updatedBy || surveyData.lastUpdatedBy || 'Unknown';
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-md w-full mx-4 p-6">
                        <div class="mb-4">
                            <h2 class="text-xl font-bold text-gray-900 mb-2">Survey Already Exists</h2>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-yellow-800">
                                    <strong>A survey already exists for this R2 number.</strong>
                                </p>
                            </div>
                            <div class="space-y-2 text-sm text-gray-600">
                                <p><strong>Event:</strong> ${eventName}</p>
                                <p><strong>Venue:</strong> ${surveyData.venueName || surveyData['venue-name'] || 'TBD'}</p>
                                <p><strong>Status:</strong> ${surveyData.status || 'In Progress'}</p>
                                ${lastUpdated ? `<p><strong>Last Updated:</strong> ${formatDate(lastUpdated)} by ${lastUpdatedBy}</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button id="edit-existing" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Edit Existing Survey
                            </button>
                            <button id="create-new" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                Create New Survey (with timestamp)
                            </button>
                            <button id="cancel-action" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listeners
                modal.querySelector('#edit-existing').addEventListener('click', () => {
                    modal.remove();
                    resolve('edit');
                });
                
                modal.querySelector('#create-new').addEventListener('click', () => {
                    modal.remove();
                    resolve('new');
                });
                
                modal.querySelector('#cancel-action').addEventListener('click', () => {
                    modal.remove();
                    resolve('cancel');
                });
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Slide out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        async function searchSurveys(query = '', statusFilter = 'all') {
            console.log('searchSurveys called with:', { query, statusFilter, supabase: !!supabase });
            
            if (!supabase) {
                console.error('Supabase client not available');
                return [];
            }
            
            try {
                // Query the correct 'surveys' table with all available columns
                let queryBuilder = supabase
                    .from('surveys')
                    .select('id, survey_id, survey_data, event_name, venue_name, status, version, created_by, updated_by, created_at, updated_at')
                    .order('updated_at', { ascending: false });

                // Add status filter if not 'all'
                if (statusFilter !== 'all') {
                    queryBuilder = queryBuilder.eq('status', statusFilter);
                }

                console.log('Executing Supabase query...');
                const { data: surveysData, error } = await queryBuilder;

                console.log('Supabase response:', { data: surveysData, error });

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                const surveys = [];
                
                if (surveysData && Array.isArray(surveysData)) {
                    console.log(`Processing ${surveysData.length} survey records`);
                    
                    surveysData.forEach(surveyData => {
                        console.log('Processing survey record:', surveyData);
                        
                        // Extract data from survey_data JSONB field
                        let clientBusiness = 'Client TBD';
                        let eventName = 'Unnamed Event';
                        let venueName = 'Venue TBD';
                        
                        if (surveyData.survey_data) {
                            try {
                                // Parse JSON if it's a string, or use directly if it's already an object
                                let parsedSurveyData = surveyData.survey_data;
                                if (typeof parsedSurveyData === 'string') {
                                    parsedSurveyData = JSON.parse(parsedSurveyData);
                                }
                                
                                // Extract all the key fields from survey_data
                                clientBusiness = parsedSurveyData['client-business'] || 
                                               parsedSurveyData.clientBusiness || 
                                               'Client TBD';
                                               
                                eventName = parsedSurveyData['event-name'] || 
                                           parsedSurveyData.eventName || 
                                           'Unnamed Event';
                                           
                                venueName = parsedSurveyData['venue-name'] || 
                                           parsedSurveyData.venueName || 
                                           'Venue TBD';
                                
                                console.log('Extracted survey data:', { clientBusiness, eventName, venueName });
                            } catch (parseError) {
                                console.error('Error parsing survey_data JSON:', parseError);
                                clientBusiness = 'Client TBD';
                                eventName = 'Unnamed Event';
                                venueName = 'Venue TBD';
                            }
                        }
                        
                        // Use database columns if available, otherwise use extracted data
                        const finalEventName = surveyData.event_name || eventName;
                        const finalVenueName = surveyData.venue_name || venueName;
                        
                        // If no query is provided, include all surveys (for initial load)
                        const matchesQuery = !query || query.length < 1 || 
                            finalEventName?.toLowerCase().includes(query.toLowerCase()) ||
                            finalVenueName?.toLowerCase().includes(query.toLowerCase()) ||
                            clientBusiness?.toLowerCase().includes(query.toLowerCase()) ||
                            surveyData.survey_id?.toLowerCase().includes(query.toLowerCase());
                        
                        if (matchesQuery) {
                            const processedSurvey = {
                                id: surveyData.id,
                                surveyId: surveyData.survey_id,
                                eventName: finalEventName,
                                venueName: finalVenueName,
                                clientBusiness: clientBusiness,
                                lastUpdated: surveyData.updated_at,
                                updatedBy: surveyData.updated_by,
                                status: surveyData.status || 'In Progress',
                                createdAt: surveyData.created_at,
                                createdBy: surveyData.created_by,
                                version: surveyData.version || 1,
                                surveyData: surveyData.survey_data,
                                ...surveyData
                            };
                            console.log('Adding processed survey:', processedSurvey);
                            surveys.push(processedSurvey);
                        }
                    });
                } else {
                    console.log('No surveys data received or data is not an array');
                }
                
                console.log(`Returning ${surveys.length} surveys after filtering`);
                
                return surveys.sort((a, b) => {
                    const aDate = new Date(a.lastUpdated || 0);
                    const bDate = new Date(b.lastUpdated || 0);
                    return bDate - aDate;
                });
            } catch (error) {
                console.error('Error searching surveys:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                return [];
            }
        }

        async function loadSurveyData(surveyId) {
            if (!supabase) return null;
            
            try {
                const { data: surveyData, error } = await supabase
                    .from('surveys')
                    .select('id, survey_id, survey_data, event_name, venue_name, status, version, created_by, updated_by, created_at, updated_at')
                    .eq('survey_id', surveyId)
                    .single();

                if (error) throw error;
                return surveyData;
            } catch (error) {
                console.error('Error loading survey data:', error);
            }
            return null;
        }

        async function deleteSurvey(surveyId) {
            if (!supabase) return false;
            
            // Check admin permissions
            if (!checkAccess('deleteSurvey')) {
                alert('Access denied. Only administrators can delete surveys.');
                return false;
            }
            
            try {
                const { error } = await supabase
                    .from('surveys')
                    .delete()
                    .eq('survey_id', surveyId);

                if (error) throw error;
                logActivity(`Deleted survey "${surveyId}" from database`);
                return true;
            } catch (error) {
                console.error('Error deleting survey:', error);
                return false;
            }
        }

        async function getSurveyHistory(surveyId) {
            if (!db) return [];
            
            // Only managers and admins can view history
            if (!checkAccess('viewHistory')) {
                return [];
            }
            
            try {
                const historyRef = collection(db, `surveyDatabase/${surveyId}/history`);
                const historyQuery = query(historyRef, orderBy("timestamp", "desc"));
                const historySnapshot = await getDocs(historyQuery);
                
                const history = [];
                historySnapshot.forEach(doc => {
                    history.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return history;
            } catch (error) {
                console.error('Error getting survey history:', error);
                return [];
            }
        }

        function showSurveyBrowser() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">Survey Browser</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex gap-4 items-center">
                            <div class="flex-1">
                                <input type="text" id="modal-survey-search" placeholder="Search by event name, venue, client, or R2 number..." 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                            </div>
                            <select id="modal-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">All Status</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Archived">Archived</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <div id="modal-survey-results">
                            <p class="text-gray-500 text-center py-8">Loading surveys...</p>
                        </div>
                    </div>
                    <div class="p-6 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                ${window.currentUserRole === 'admin' || window.currentUserRole === 'manager' ? 'Manager/Admin: Can view history and all surveys' : 'User: Can search and edit surveys'}
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup real-time search functionality
            const searchInput = modal.querySelector('#modal-survey-search');
            const statusFilter = modal.querySelector('#modal-status-filter');
            let searchTimeout;
            
            // Function to perform search with debouncing
            const performSearch = () => {
                console.log('performSearch triggered, input value:', searchInput.value);
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    console.log('Debounced search executing, input value:', searchInput.value);
                    await searchSurveysInBrowser();
                }, 300); // 300ms delay for better performance
            };
            
            // Real-time search as user types
            searchInput.addEventListener('input', (e) => {
                console.log('Input event fired, value:', e.target.value);
                performSearch();
            });
            
            // Search when status filter changes
            statusFilter.addEventListener('change', performSearch);
            
            // Search on enter key
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    searchSurveysInBrowser();
                }
            });
            
            // Load all surveys initially
            console.log('About to call searchSurveysInBrowser for initial load');
            searchSurveysInBrowser().then(() => {
                console.log('Initial searchSurveysInBrowser completed');
            }).catch(error => {
                console.error('Initial searchSurveysInBrowser failed:', error);
                const resultsDiv = document.getElementById('modal-survey-results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500 mb-2">Failed to load surveys</p>
                            <p class="text-sm text-gray-600 mb-4">Error: ${error.message}</p>
                            <button onclick="searchSurveysInBrowser()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Retry
                            </button>
                        </div>
                    `;
                }
            });
            
            searchInput.focus();
        }

        // Store all surveys for client-side filtering
        let allSurveys = [];
        
        async function searchSurveysInBrowser() {
            console.log('=== searchSurveysInBrowser START ===');
            const searchInput = document.getElementById('modal-survey-search');
            const statusFilter = document.getElementById('modal-status-filter');
            const resultsDiv = document.getElementById('modal-survey-results');
            
            console.log('DOM elements found:', {
                searchInput: !!searchInput,
                statusFilter: !!statusFilter,
                resultsDiv: !!resultsDiv
            });
            
            if (!resultsDiv) {
                console.error('Results div not found - this is a critical error');
                return;
            }
            
            // DEBUG: Check if there are multiple elements with same ID
            const allSearchInputs = document.querySelectorAll('#modal-survey-search');
            console.log('Found', allSearchInputs.length, 'elements with ID modal-survey-search');
            
            // Try different ways to get the value
            const query1 = searchInput ? searchInput.value.trim().toLowerCase() : '';
            const query2 = searchInput ? searchInput.getAttribute('value') || '' : '';
            const query3 = allSearchInputs.length > 0 ? allSearchInputs[0].value.trim().toLowerCase() : '';
            
            console.log('Value attempts:', { 
                method1_value: query1, 
                method2_getAttribute: query2,
                method3_querySelector: query3,
                elementValue: searchInput?.value,
                elementOuterHTML: searchInput?.outerHTML
            });
            
            const query = query1 || query3; // Use whichever method works
            const status = statusFilter ? statusFilter.value : 'all';
            
            console.log('Final search parameters:', { query, status });
            
            // If this is the first load (no cached surveys), fetch from database
            if (allSurveys.length === 0) {
                console.log('First load - fetching all surveys from database');
                resultsDiv.innerHTML = '<p class="text-center py-8">Loading surveys...</p>';
                
                try {
                    allSurveys = await searchSurveys('', 'all'); // Get all surveys
                    console.log('Loaded', allSurveys.length, 'surveys from database');
                } catch (error) {
                    console.error('Error loading surveys:', error);
                    resultsDiv.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500 mb-2">Error loading surveys</p>
                            <p class="text-sm text-gray-600 mb-4">Error: ${error.message}</p>
                            <button onclick="searchSurveysInBrowser()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Retry
                            </button>
                        </div>
                    `;
                    return;
                }
            }
            
            // Filter surveys client-side for real-time search
            let filteredSurveys = allSurveys;
            
            // Apply status filter
            if (status !== 'all') {
                filteredSurveys = filteredSurveys.filter(survey => survey.status === status);
            }
            
            // Apply text search filter
            if (query.length > 0) {
                console.log('Applying text search for query:', query);
                filteredSurveys = filteredSurveys.filter(survey => {
                    const searchableText = [
                        survey.eventName || '',
                        survey.venueName || '',
                        survey.clientBusiness || '',
                        survey.surveyId || '',
                        survey.updatedBy || '',
                        survey.createdBy || ''
                    ].join(' ').toLowerCase();
                    
                    const matches = searchableText.includes(query);
                    if (matches) {
                        console.log('Match found for survey:', survey.surveyId, 'searchable text:', searchableText);
                    }
                    
                    return matches;
                });
                console.log('After text filter:', filteredSurveys.length, 'surveys remain');
            }
            
            console.log('Filtered to', filteredSurveys.length, 'surveys');
            
            try {
                if (filteredSurveys.length === 0) {
                    const message = query.length > 0 || status !== 'all'
                        ? 'No surveys found matching your search criteria' 
                        : 'No surveys found in the database. Create your first survey to get started!';
                    resultsDiv.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500 mb-4">${message}</p>
                            ${query.length === 0 && status === 'all' ? `
                                <button onclick="this.closest('.fixed').remove(); document.getElementById('new-survey-btn').click();" 
                                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                    Create First Survey
                                </button>
                            ` : ''}
                        </div>
                    `;
                    return;
                }
                
                console.log('About to generate HTML for', filteredSurveys.length, 'filtered surveys');
                
                const surveyHTML = filteredSurveys.map(survey => {
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900">${survey.eventName || 'Unnamed Event'}</h3>
                                    <p class="text-gray-600">Venue: ${survey.venueName || 'Venue TBD'}</p>
                                    <p class="text-gray-600">Client: ${survey.clientBusiness || 'Client TBD'}</p>
                                    <p class="text-sm text-gray-500">R2#: ${survey.surveyId || 'Unknown'}</p>
                                    <p class="text-sm text-gray-500">
                                        Last updated: ${formatDate(survey.lastUpdated)} by ${survey.updatedBy || 'Unknown'}
                                    </p>
                                    ${survey.createdAt ? `<p class="text-xs text-gray-400">Created: ${formatDate(survey.createdAt)} by ${survey.createdBy || 'Unknown'}</p>` : ''}
                                </div>
                                <div class="flex flex-col gap-2 ml-4">
                                    <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(survey.status)}">
                                        ${survey.status || 'In Progress'}
                                    </span>
                                    <div class="flex gap-2">
                                        <button onclick="openSurvey('${survey.surveyId}'); this.closest('.fixed').remove();" 
                                                class="bg-teal-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700">
                                            Open
                                        </button>
                                        ${(window.currentUserRole === 'admin' || window.currentUserRole === 'manager') ? `
                                            <button onclick="viewSurveyHistory('${survey.surveyId}')" 
                                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                                History
                                            </button>
                                        ` : ''}
                                        ${window.currentUserRole === 'admin' ? `
                                            <button onclick="confirmDeleteSurvey('${survey.surveyId}', '${survey.eventName || 'Unknown'}')" 
                                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                                Delete
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                resultsDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="mb-4 text-sm text-gray-600">
                            ${query.length > 0 || status !== 'all' ? 
                                `Found ${filteredSurveys.length} of ${allSurveys.length} surveys` : 
                                `Found ${filteredSurveys.length} survey${filteredSurveys.length === 1 ? '' : 's'}`
                            }
                        </div>
                        ${surveyHTML}
                    </div>
                `;
                
                console.log('Survey browser HTML updated successfully with filtering');
                
            } catch (htmlError) {
                console.error('Error generating survey HTML:', htmlError);
                resultsDiv.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500 mb-2">Error displaying surveys</p>
                        <p class="text-sm text-gray-600 mb-4">HTML Generation Error: ${htmlError.message}</p>
                        <button onclick="refreshSurveysCache(); searchSurveysInBrowser()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Try Again
                        </button>
                    </div>
                `;
            }
            
            console.log('=== searchSurveysInBrowser END ===');
        }

        // Function to refresh the surveys cache
        function refreshSurveysCache() {
            allSurveys = []; // Clear the cache to force a fresh database fetch
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                date = new Date(timestamp);
            }
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Completed': return 'bg-green-100 text-green-800';
                case 'In Progress': return 'bg-yellow-100 text-yellow-800';
                case 'Archived': return 'bg-gray-100 text-gray-800';
                default: return 'bg-blue-100 text-blue-800';
            }
        }

        function openSurvey(surveyId) {
            // Close the modal first
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();
            
            // Navigate to the survey
            window.location.search = `id=${encodeURIComponent(surveyId)}`;
        }

        async function viewSurveyHistory(surveyId) {
            if (!checkAccess('viewHistory')) {
                alert('Access denied. You do not have permission to view survey history.');
                return;
            }
            
            const history = await getSurveyHistory(surveyId);
            
            const historyModal = document.createElement('div');
            historyModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
            historyModal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold">Survey History - ${surveyId}</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        ${history.length > 0 ? `
                            <div class="space-y-3">
                                ${history.map(entry => `
                                    <div class="border-l-4 border-blue-500 pl-4 py-2">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium">${entry.description}</p>
                                                <p class="text-sm text-gray-600">by ${entry.userName}</p>
                                            </div>
                                            <span class="text-sm text-gray-500">${formatDate(entry.timestamp)}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-gray-500 text-center py-8">No history available for this survey</p>
                        `}
                    </div>
                    <div class="p-6 border-t border-gray-200">
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(historyModal);
        }

        async function confirmDeleteSurvey(surveyId, eventName) {
            if (!checkAccess('deleteSurvey')) {
                alert('Access denied. Only administrators can delete surveys.');
                return;
            }
            
            const confirmed = confirm(`Are you sure you want to permanently delete the survey for "${eventName}" (${surveyId})?\n\nThis action cannot be undone and will delete all associated data including photos and files.`);
            
            if (confirmed) {
                const success = await deleteSurvey(surveyId);
                if (success) {
                    alert('Survey deleted successfully.');
                    // Refresh the cache and search results
                    refreshSurveysCache();
                    window.searchSurveysInBrowser();
                } else {
                    alert('Failed to delete survey.');
                }
            }
        }

        // Auto-save survey to database when significant changes are made
        let autoSaveTimeout;
        let lastAutoSaveData = null;
        
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                try {
                    // Get current data to check if anything actually changed
                    const currentData = await getCurrentSurveyData();
                    const currentDataString = JSON.stringify(currentData);
                    
                    // Only auto-save if data has actually changed since last auto-save
                    if (lastAutoSaveData === currentDataString) {
                        return; // No changes, skip auto-save
                    }
                    
                    await saveSurveyToDatabase(true); // Silent auto-save
                    lastAutoSaveData = currentDataString;
                    
                    if(saveStatus) {
                        saveStatus.innerHTML = '<span class="text-green-600">✓ Auto-saved</span>';
                        setTimeout(() => { if(saveStatus) saveStatus.textContent = ''; }, 2000);
                    }
                } catch (error) {
                    console.error('Auto-save failed:', error);
                    if(saveStatus) {
                        saveStatus.innerHTML = '<span class="text-red-600">⚠ Auto-save failed</span>';
                        setTimeout(() => { if(saveStatus) saveStatus.textContent = ''; }, 3000);
                    }
                }
            }, 10000); // Auto-save 10 seconds after last change (increased from 3)
        }

        // AI Assistant Functions
        async function initializeAI() {
            // Check if AI system is enabled by admin (stored in Firebase)
            await checkAISystemStatus();
            
            // Update UI based on AI availability
            updateAIButtonVisibility();
            
            // If system is enabled, check for stored user preferences
            if (aiSystemEnabled) {
                const userAIEnabled = localStorage.getItem('userAIEnabled') === 'true';
                if (userAIEnabled) {
                    aiAssistanceEnabled = true;
                    updateAIStatus();
                }
            }
        }

        async function checkAISystemStatus() {
            try {
                if (!supabase) {
                    aiSystemEnabled = false;
                    openAIKey = null;
                    return;
                }
                
                // Check if AI system is enabled in the database
                const { data: aiConfig, error } = await supabase
                    .from('system_config').select('setting_name,setting_value')
                    .eq('setting_name', 'ai_settings')
                    .single();
                
                if (aiConfig && !error) {
                    const configData = aiConfig.setting_value || {};
                    aiSystemEnabled = configData.enabled || false;
                    openAIKey = configData.apiKey || null;
                } else {
                    aiSystemEnabled = false;
                    openAIKey = null;
                }
            } catch (error) {
                console.error('Error checking AI system status:', error);
                aiSystemEnabled = false;
            }
        }

        function updateAIButtonVisibility() {
            const aiBtn = document.getElementById('ai-assistant-btn');
            const aiStatus = document.getElementById('ai-status');
            
            if (aiSystemEnabled && aiBtn) {
                aiBtn.classList.remove('hidden');
                if (aiAssistanceEnabled) {
                    aiStatus?.classList.remove('hidden');
                }
            } else {
                aiBtn?.classList.add('hidden');
                aiStatus?.classList.add('hidden');
            }
        }

        function showAISettings() {
            console.log('showAISettings called');
            const modal = document.getElementById('ai-settings-modal');
            const userRole = window.currentUserRole || getUserRole();
            
            console.log('Modal element:', modal);
            console.log('User role:', userRole);
            console.log('Current user role from window:', window.currentUserRole);
            
            if (!modal) {
                console.error('AI settings modal not found');
                return;
            }
            
            // Configure modal based on user role
            if (userRole === 'admin') {
                console.log('Setting up admin AI modal');
                setupAdminAIModal();
            } else {
                console.log('Setting up user AI modal');
                setupUserAIModal();
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            console.log('AI settings modal should now be visible');
        }

        function setupAdminAIModal() {
            console.log('setupAdminAIModal called');
            const title = document.getElementById('ai-modal-title');
            const adminConfig = document.getElementById('admin-ai-config');
            const userFeatures = document.getElementById('user-ai-features');
            const disabledMessage = document.getElementById('ai-disabled-message');
            const statusDisplay = document.getElementById('ai-status-display');
            
            console.log('Modal elements found:', {
                title: !!title,
                adminConfig: !!adminConfig,
                userFeatures: !!userFeatures,
                disabledMessage: !!disabledMessage,
                statusDisplay: !!statusDisplay
            });
            
            if (title) title.textContent = 'AI System Configuration (Admin)';
            adminConfig?.classList.remove('hidden');
            userFeatures?.classList.add('hidden');
            disabledMessage?.classList.add('hidden');
            statusDisplay?.classList.remove('hidden');
            
            // Set current values
            const enableToggle = document.getElementById('enable-ai-system');
            const keySection = document.getElementById('api-key-section');
            const keyInput = document.getElementById('openai-key-input');
            const disableBtn = document.getElementById('disable-ai-system');
            
            if (enableToggle) {
                enableToggle.checked = aiSystemEnabled;
                enableToggle.addEventListener('change', () => {
                    if (enableToggle.checked) {
                        keySection?.classList.remove('hidden');
                    } else {
                        keySection?.classList.add('hidden');
                    }
                });
                
                // Trigger change to set initial state
                enableToggle.dispatchEvent(new Event('change'));
            }
            
            if (keyInput && openAIKey) {
                keyInput.value = openAIKey;
                console.log('Pre-filled API key input with existing key');
            }
            
            if (disableBtn) {
                if (aiSystemEnabled) {
                    disableBtn.classList.remove('hidden');
                }
            }
            
            setupAdminAIListeners();
            updateAIStatus();
        }

        function setupUserAIModal() {
            const title = document.getElementById('ai-modal-title');
            const adminConfig = document.getElementById('admin-ai-config');
            const userFeatures = document.getElementById('user-ai-features');
            const disabledMessage = document.getElementById('ai-disabled-message');
            const statusDisplay = document.getElementById('ai-status-display');
            
            if (title) title.textContent = 'AI Assistant Settings';
            adminConfig?.classList.add('hidden');
            
            if (aiSystemEnabled) {
                userFeatures?.classList.remove('hidden');
                disabledMessage?.classList.add('hidden');
                statusDisplay?.classList.remove('hidden');
                
                // Set current user preferences
                const aiToggle = document.getElementById('ai-assistance-toggle');
                if (aiToggle) {
                    aiToggle.checked = aiAssistanceEnabled;
                }
                
                setupUserAIListeners();
                updateAIStatus();
            } else {
                userFeatures?.classList.add('hidden');
                disabledMessage?.classList.remove('hidden');
                statusDisplay?.classList.add('hidden');
            }
        }

        function setupAdminAIListeners() {
            const saveBtn = document.getElementById('save-api-key');
            const testBtn = document.getElementById('test-api-key');
            const toggleBtn = document.getElementById('toggle-key-visibility');
            const keyInput = document.getElementById('openai-key-input');
            const disableBtn = document.getElementById('disable-ai-system');
            
            // Save and enable AI system
            saveBtn?.addEventListener('click', async () => {
                const key = keyInput?.value.trim();
                const enableToggle = document.getElementById('enable-ai-system');
                
                if (!enableToggle?.checked) {
                    showNotification('Please enable the AI system first', 'error');
                    return;
                }
                
                if (!key || !key.startsWith('sk-')) {
                    showNotification('Please enter a valid OpenAI API key', 'error');
                    return;
                }
                
                try {
                    // Save to Supabase
                    if (supabase) {
                        const { error } = await supabase
                            .from('system_config')
                            .upsert({
                                setting_name: 'ai_settings',
                                setting_value: {
                                    enabled: true,
                                    apiKey: key,
                                    enabledBy: window.currentUserEmail || currentUserName,
                                    enabledAt: new Date().toISOString()
                                }
                            }, {
                                onConflict: 'setting_name'
                            });
                        
                        if (error) throw error;
                    }
                    
                    openAIKey = key;
                    aiSystemEnabled = true;
                    testBtn.disabled = false;
                    
                    showNotification('AI system enabled successfully!', 'success');
                    updateAIButtonVisibility();
                    updateAIStatus();
                    
                    logActivity('Enabled AI system for all users');
                    
                } catch (error) {
                    console.error('Error saving AI config:', error);
                    showNotification('Failed to save AI configuration', 'error');
                }
            });
            
            // Disable AI system
            disableBtn?.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to disable the AI system for all users?')) return;
                
                try {
                    if (supabase) {
                        const { error } = await supabase
                            .from('system_config')
                            .upsert({
                                setting_name: 'ai_settings',
                                setting_value: {
                                    enabled: false,
                                    apiKey: null,
                                    disabledBy: window.currentUserEmail || currentUserName,
                                    disabledAt: new Date().toISOString()
                                }
                            }, {
                                onConflict: 'setting_name'
                            });
                        
                        if (error) throw error;
                    }
                    
                    openAIKey = null;
                    aiSystemEnabled = false;
                    aiAssistanceEnabled = false;
                    
                    showNotification('AI system disabled', 'success');
                    updateAIButtonVisibility();
                    closeAISettings();
                    
                    logActivity('Disabled AI system');
                    
                } catch (error) {
                    console.error('Error disabling AI system:', error);
                    showNotification('Failed to disable AI system', 'error');
                }
            });
            
            // Test API connection
            testBtn?.addEventListener('click', async () => {
                if (openAIKey) {
                    testBtn.disabled = true;
                    testBtn.textContent = 'Testing...';
                    
                    const isValid = await testOpenAIConnection();
                    
                    testBtn.disabled = false;
                    testBtn.textContent = 'Test Connection';
                    
                    if (isValid) {
                        showNotification('API connection successful!', 'success');
                    } else {
                        showNotification('API connection failed. Check your key.', 'error');
                    }
                }
            });
            
            // Toggle key visibility
            toggleBtn?.addEventListener('click', () => {
                if (keyInput) {
                    keyInput.type = keyInput.type === 'password' ? 'text' : 'password';
                    toggleBtn.textContent = keyInput.type === 'password' ? '👁️' : '🙈';
                }
            });
        }

        function setupUserAIListeners() {
            const aiToggle = document.getElementById('ai-assistance-toggle');
            
            // AI assistance toggle for users
            aiToggle?.addEventListener('change', () => {
                aiAssistanceEnabled = aiToggle.checked;
                localStorage.setItem('userAIEnabled', aiToggle.checked.toString());
                
                updateAIStatus();
                if (aiAssistanceEnabled) {
                    startAIAssistance();
                } else {
                    stopAIAssistance();
                }
                
                logActivity(aiAssistanceEnabled ? 'Enabled AI assistance' : 'Disabled AI assistance');
            });
        }

        function closeAISettings() {
            const modal = document.getElementById('ai-settings-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        async function testOpenAIConnection() {
            if (!openAIKey) {
                console.error('No OpenAI API key provided');
                return false;
            }
            
            try {
                console.log('Testing OpenAI API connection...');
                const response = await fetch('https://api.openai.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${openAIKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log('OpenAI API connection successful');
                    return true;
                } else {
                    console.error('OpenAI API error:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('OpenAI connection test failed:', error);
                return false;
            }
        }

        function updateAIStatus() {
            const statusDiv = document.getElementById('ai-status');
            const statusDisplay = document.getElementById('ai-status-display');
            const aiBtn = document.getElementById('ai-assistant-btn');
            const btnText = document.getElementById('ai-btn-text');
            
            if (aiSystemEnabled && openAIKey) {
                statusDiv?.classList.remove('hidden');
                statusDisplay?.classList.remove('hidden');
                
                // Update button text based on user role
                if (btnText) {
                    const userRole = getUserRole();
                    if (userRole === 'admin') {
                        btnText.textContent = 'AI Configuration';
                    } else {
                        btnText.textContent = aiAssistanceEnabled ? 'AI Assistant (On)' : 'AI Assistant (Off)';
                    }
                }
                
                const statusContent = document.getElementById('ai-status-content');
                if (statusContent) {
                    const userRole = getUserRole();
                    if (userRole === 'admin') {
                        statusContent.innerHTML = `
                            <p>✅ AI System: Enabled</p>
                            <p>🔑 API Key: Configured</p>
                            <p>👥 Available to: All Users</p>
                            <p>📋 Agenda Analysis: Available</p>
                        `;
                    } else {
                        statusContent.innerHTML = `
                            <p>✅ AI System: Available</p>
                            <p>🤖 Your AI Assistance: ${aiAssistanceEnabled ? 'Active' : 'Inactive'}</p>
                            <p>📋 Agenda Analysis: Available</p>
                        `;
                    }
                }
            } else {
                statusDiv?.classList.add('hidden');
                if (getUserRole() !== 'admin') {
                    statusDisplay?.classList.add('hidden');
                }
            }
        }

        function startAIAssistance() {
            if (!openAIKey) return;
            
            aiSuggestionsActive = true;
            showAISuggestions();
            
            // Generate initial suggestions based on current data
            generateAISuggestions();
        }

        function stopAIAssistance() {
            aiSuggestionsActive = false;
            hideAISuggestions();
        }

        function showAISuggestions() {
            const panel = document.getElementById('ai-suggestions-panel');
            if (panel) {
                panel.classList.remove('hidden');
            }
        }

        function hideAISuggestions() {
            const panel = document.getElementById('ai-suggestions-panel');
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        async function generateAISuggestions() {
            if (!openAIKey || !aiSuggestionsActive) return;
            
            try {
                const currentData = await getCurrentSurveyData();
                const currentSection = getCurrentActiveSection();
                
                const prompt = createAISuggestionsPrompt(currentData, currentSection);
                const suggestions = await callOpenAI(prompt, 'suggestions');
                
                displayAISuggestions(suggestions);
            } catch (error) {
                console.error('Failed to generate AI suggestions:', error);
            }
        }

        function createAISuggestionsPrompt(data, section) {
            const eventName = data['event-name'] || 'Unknown Event';
            const venueName = data['venue-name'] || 'TBD';
            const attendeeCount = data['attendee-count'] || 'Unknown';
            
            return `You are an expert AV technician and event planner. Based on the following site survey information, provide 3-5 specific, actionable suggestions for the "${section}" section:

Event: ${eventName}
Venue: ${venueName}
Expected Attendees: ${attendeeCount}
Current Section: ${section}

Current Data: ${JSON.stringify(data, null, 2)}

Focus on:
1. AV equipment recommendations
2. Technical considerations for the venue
3. Important questions to ask during the site survey
4. Potential challenges to watch for
5. Setup best practices

Provide concise, practical suggestions that a technician can immediately act upon. Format as a JSON array of objects with "category" and "suggestion" fields.`;
        }

        async function callOpenAI(prompt, type = 'chat') {
            if (!openAIKey) throw new Error('No API key configured');
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openAIKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert AV technician and event planning assistant. Provide practical, actionable advice.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: type === 'agenda' ? 2000 : 1000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status}`);
                }
                
                const result = await response.json();
                return result.choices[0].message.content;
            } catch (error) {
                console.error('OpenAI API call failed:', error);
                throw error;
            }
        }

        function displayAISuggestions(suggestions) {
            const content = document.getElementById('ai-suggestions-content');
            if (!content) return;
            
            try {
                const parsed = JSON.parse(suggestions);
                const html = parsed.map(item => `
                    <div class="mb-3 p-3 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                        <div class="font-medium text-purple-800">${item.category}</div>
                        <div class="text-sm text-purple-700 mt-1">${item.suggestion}</div>
                    </div>
                `).join('');
                
                content.innerHTML = html;
            } catch (error) {
                // Fallback to plain text if JSON parsing fails
                content.innerHTML = `
                    <div class="p-3 bg-purple-50 rounded-lg">
                        <div class="text-sm text-purple-700">${suggestions}</div>
                    </div>
                `;
            }
        }

        // Agenda Analysis Functions
        async function analyzeAgenda(agendaText, fileName = 'uploaded-agenda') {
            if (!openAIKey) {
                showNotification('AI analysis requires OpenAI API key configuration', 'error');
                return null;
            }
            
            try {
                const prompt = createAgendaAnalysisPrompt(agendaText);
                const analysis = await callOpenAI(prompt, 'agenda');
                
                return parseAgendaAnalysis(analysis);
            } catch (error) {
                console.error('Agenda analysis failed:', error);
                showNotification('Failed to analyze agenda. Please try again.', 'error');
                return null;
            }
        }

        function createAgendaAnalysisPrompt(agendaText) {
            return `Analyze this event agenda and extract key information to help set up a site survey. Provide a JSON response with the following structure:

{
  "eventInfo": {
    "name": "extracted event name",
    "description": "brief description",
    "dates": ["YYYY-MM-DD"],
    "estimatedAttendees": number,
    "eventType": "conference/meeting/presentation/etc"
  },
  "venueRequirements": {
    "suggestedVenueName": "if mentioned",
    "locationRequirements": "indoor/outdoor/specific needs"
  },
  "sessions": [
    {
      "name": "session name",
      "startTime": "HH:MM",
      "endTime": "HH:MM",
      "date": "YYYY-MM-DD",
      "description": "session description",
      "estimatedAttendees": number,
      "avRequirements": ["microphones", "projector", "etc"],
      "roomType": "main hall/breakout/etc"
    }
  ],
  "rooms": [
    {
      "name": "suggested room name",
      "purpose": "main presentation/breakout/etc",
      "capacity": estimated_number,
      "avNeeds": ["equipment needed"],
      "layout": "theater/classroom/rounds/etc"
    }
  ],
  "schedule": {
    "earliestStart": "HH:MM",
    "latestEnd": "HH:MM",
    "breaks": ["break times"],
    "meals": ["meal times and types"]
  },
  "technicalRequirements": {
    "avEquipment": ["list of needed equipment"],
    "specialNeeds": ["any special requirements"],
    "internetRequirements": "high/medium/low bandwidth needs",
    "powerRequirements": "special power needs"
  }
}

Agenda to analyze:
${agendaText}

Please be thorough but practical in your analysis. If information is not clear, make reasonable assumptions based on typical event patterns.`;
        }

        function parseAgendaAnalysis(analysisText) {
            try {
                return JSON.parse(analysisText);
            } catch (error) {
                console.error('Failed to parse agenda analysis:', error);
                return null;
            }
        }

        function showAgendaAnalysisResults(analysis) {
            if (!analysis) return;
            
            const modal = document.getElementById('agenda-analysis-modal');
            const content = document.getElementById('agenda-analysis-content');
            
            if (!modal || !content) return;
            
            content.innerHTML = createAgendaAnalysisHTML(analysis);
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Setup apply button
            const applyBtn = document.getElementById('apply-ai-suggestions');
            applyBtn?.addEventListener('click', () => {
                applyAgendaAnalysis(analysis);
                closeAgendaAnalysis();
            });
        }

        function createAgendaAnalysisHTML(analysis) {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Event Information -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-3">📅 Event Information</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Name:</strong> ${analysis.eventInfo?.name || 'Not specified'}</p>
                            <p><strong>Type:</strong> ${analysis.eventInfo?.eventType || 'Not specified'}</p>
                            <p><strong>Estimated Attendees:</strong> ${analysis.eventInfo?.estimatedAttendees || 'Not specified'}</p>
                            <p><strong>Dates:</strong> ${analysis.eventInfo?.dates?.join(', ') || 'Not specified'}</p>
                        </div>
                    </div>
                    
                    <!-- Venue Requirements -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-3">🏢 Venue Requirements</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Suggested Venue:</strong> ${analysis.venueRequirements?.suggestedVenueName || 'Not specified'}</p>
                            <p><strong>Location Type:</strong> ${analysis.venueRequirements?.locationRequirements || 'Not specified'}</p>
                        </div>
                    </div>
                    
                    <!-- Rooms -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-800 mb-3">🚪 Suggested Rooms</h3>
                        <div class="space-y-3">
                            ${analysis.rooms?.map(room => `
                                <div class="bg-white p-3 rounded border">
                                    <p class="font-medium">${room.name}</p>
                                    <p class="text-xs text-gray-600">Capacity: ${room.capacity} | Layout: ${room.layout}</p>
                                    <p class="text-xs text-gray-600">AV: ${room.avNeeds?.join(', ') || 'None specified'}</p>
                                </div>
                            `).join('') || '<p class="text-sm text-gray-600">No rooms identified</p>'}
                        </div>
                    </div>
                    
                    <!-- Schedule -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-yellow-800 mb-3">⏰ Schedule Overview</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Start:</strong> ${analysis.schedule?.earliestStart || 'Not specified'}</p>
                            <p><strong>End:</strong> ${analysis.schedule?.latestEnd || 'Not specified'}</p>
                            <p><strong>Breaks:</strong> ${analysis.schedule?.breaks?.join(', ') || 'Not specified'}</p>
                            <p><strong>Meals:</strong> ${analysis.schedule?.meals?.join(', ') || 'Not specified'}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sessions -->
                <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">📋 Sessions</h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        ${analysis.sessions?.map(session => `
                            <div class="bg-white p-3 rounded border">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <p class="font-medium">${session.name}</p>
                                        <p class="text-sm text-gray-600">${session.description}</p>
                                        <p class="text-xs text-gray-500">
                                            ${session.date} | ${session.startTime} - ${session.endTime} | 
                                            ${session.estimatedAttendees} attendees
                                        </p>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        AV: ${session.avRequirements?.join(', ') || 'None'}
                                    </div>
                                </div>
                            </div>
                        `).join('') || '<p class="text-sm text-gray-600">No sessions identified</p>'}
                    </div>
                </div>
                
                <!-- Technical Requirements -->
                <div class="mt-6 bg-red-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-red-800 mb-3">⚡ Technical Requirements</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="font-medium">AV Equipment:</p>
                            <ul class="list-disc list-inside text-xs text-gray-600">
                                ${analysis.technicalRequirements?.avEquipment?.map(item => `<li>${item}</li>`).join('') || '<li>Not specified</li>'}
                            </ul>
                        </div>
                        <div>
                            <p class="font-medium">Special Requirements:</p>
                            <ul class="list-disc list-inside text-xs text-gray-600">
                                ${analysis.technicalRequirements?.specialNeeds?.map(item => `<li>${item}</li>`).join('') || '<li>None specified</li>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeAgendaAnalysis() {
            const modal = document.getElementById('agenda-analysis-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        async function applyAgendaAnalysis(analysis) {
            if (!analysis) return;
            
            try {
                const updates = {};
                
                // Apply event information
                if (analysis.eventInfo) {
                    if (analysis.eventInfo.name) updates['event-name'] = analysis.eventInfo.name;
                    if (analysis.eventInfo.estimatedAttendees) updates['attendee-count'] = analysis.eventInfo.estimatedAttendees;
                    if (analysis.eventInfo.dates && analysis.eventInfo.dates[0]) updates['event-date'] = analysis.eventInfo.dates[0];
                }
                
                // Apply venue information
                if (analysis.venueRequirements?.suggestedVenueName) {
                    updates['venue-name'] = analysis.venueRequirements.suggestedVenueName;
                }
                
                // Apply schedule information
                if (analysis.schedule) {
                    if (analysis.schedule.earliestStart) updates['event-start-time'] = analysis.schedule.earliestStart;
                    if (analysis.schedule.latestEnd) updates['event-end-time'] = analysis.schedule.latestEnd;
                }
                
                // Apply room data
                if (analysis.rooms && analysis.rooms.length > 0) {
                    analysis.rooms.forEach((room, index) => {
                        const roomPrefix = `room-${index + 1}`;
                        updates[`${roomPrefix}-name`] = room.name;
                        updates[`${roomPrefix}-capacity`] = room.capacity;
                        updates[`${roomPrefix}-layout`] = room.layout;
                        updates[`${roomPrefix}-av-needs`] = room.avNeeds?.join(', ') || '';
                        updates[`${roomPrefix}-purpose`] = room.purpose;
                    });
                }
                
                // Store the full analysis for reference
                updates['ai-analysis'] = analysis;
                updates['ai-analysis-timestamp'] = new Date().toISOString();
                
                // Apply all updates
                await updateSurveyData(updates, true);
                
                logActivity(`Applied AI agenda analysis suggestions`);
                showNotification('AI suggestions applied successfully!', 'success');
                
                // Re-render sections to show updated data
                const currentData = await getCurrentSurveyData();
                renderAllSections(currentData);
                
            } catch (error) {
                console.error('Failed to apply agenda analysis:', error);
                showNotification('Failed to apply suggestions. Please try again.', 'error');
            }
        }

        // Make functions globally available
        window.handlePhotoDelete = handlePhotoDelete;
        window.showWelcomeModal = showWelcomeModal;
        window.showSurveyBrowser = showSurveyBrowser;
        window.searchSurveysInBrowser = searchSurveysInBrowser;
        window.openSurvey = openSurvey;
        window.viewSurveyHistory = viewSurveyHistory;
        window.confirmDeleteSurvey = confirmDeleteSurvey;
        window.saveSurveyToDatabase = saveSurveyToDatabase;
        window.showNotification = showNotification;
        window.checkExistingSurvey = checkExistingSurvey;
        window.showDuplicateSurveyDialog = showDuplicateSurveyDialog;
        window.returnToDashboard = returnToDashboard;
        window.createNewSurveyDirect = createNewSurveyDirect;
        
        // AI functions
        window.showAISettings = showAISettings;
        window.closeAISettings = closeAISettings;
        window.hideAISuggestions = hideAISuggestions;
        window.closeAgendaAnalysis = closeAgendaAnalysis;
        window.analyzeAgenda = analyzeAgenda;
        window.showAgendaAnalysisResults = showAgendaAnalysisResults;
        window.checkAISystemStatus = checkAISystemStatus;
        window.updateAIButtonVisibility = updateAIButtonVisibility;
        
        // Agenda functions  
        window.viewAgendaFile = viewAgendaFile;
        window.deleteAgendaFile = deleteAgendaFile;
        window.analyzeSpecificAgenda = analyzeSpecificAgenda;

        // Dashboard functions
        window.openVenueDetails = openVenueDetails;
        window.showNewSurveyModal = showNewSurveyModal;
        window.showVenueLookupModal = showVenueLookupModal;
        window.performVenueSearch = performVenueSearch;
        window.startSurvey = startSurvey;
        window.initializeMainApp = initializeMainApp;

        // Initialize the survey application
        showWelcomeModal();
        
        // Initialize AI when the app starts
        initializeAI();

        // Auto-flush pending changes on page unload
        window.addEventListener('beforeunload', () => {
            flushPendingChanges();
        });

        // Agenda file handling functions
        function setupAgendaUpload() {
            const agendaUpload = document.getElementById('agenda-upload');
            if (!agendaUpload) return;
            
            agendaUpload.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                
                const currentData = await getCurrentSurveyData();
                const agendaFiles = currentData.agendaFiles || [];
                
                for (const file of files) {
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                        continue;
                    }
                    
                    try {
                        const agendaId = `agenda_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        const storageRef = ref(storage, `agendas/${appId}/${agendaId}`);
                        const uploadResult = await uploadBytes(storageRef, file);
                        const downloadURL = await getDownloadURL(uploadResult.ref);
                        
                        const agendaData = {
                            id: agendaId,
                            name: file.name,
                            url: downloadURL,
                            type: file.type,
                            size: file.size,
                            uploadedAt: new Date().toISOString(),
                            uploadedBy: window.currentUserEmail || currentUserName
                        };
                        
                        agendaFiles.push(agendaData);
                        await updateSurveyData({ agendaFiles });
                        
                        logActivity(`Uploaded agenda file: "${file.name}"`);
                        renderAgendaFiles(agendaFiles);
                        
                    } catch (error) {
                        console.error('Error uploading agenda file:', error);
                        alert(`Failed to upload "${file.name}"`);
                    }
                }
                
                // Clear the input
                agendaUpload.value = '';
            });
        }
        
        // Make agenda functions globally available
        window.deleteAgendaFile = deleteAgendaFile;

        // Room Access Management Functions
        function setupRoomAccess(data) {
            loadVenueRoomsSelector(data['venue-name']);
            renderRoomAccessList(data.roomAccess || []);
            
            // Add room access button
            const addBtn = document.getElementById('add-room-access-btn');
            if (addBtn) {
                addBtn.addEventListener('click', () => addRoomAccess());
            }
        }
        
        async function loadVenueRoomsSelector(venueName) {
            const selector = document.getElementById('venue-rooms-selector');
            if (!selector || !venueName) {
                if (selector) selector.innerHTML = '';
                return;
            }
            
            try {
                // Load venue data to get existing rooms
                const venueData = await loadVenueData(venueName);
                if (venueData && venueData.rooms && venueData.rooms.length > 0) {
                    selector.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-lg font-medium text-blue-900 mb-2">Available Rooms from Venue Database</h4>
                            <p class="text-sm text-blue-700 mb-3">Select rooms from previous surveys for this venue:</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                ${venueData.rooms.map(room => `
                                    <button type="button" onclick="selectVenueRoom('${room.id}', '${room.name}', '${room.type}')" 
                                            class="text-left bg-white border border-blue-300 rounded p-2 hover:bg-blue-100 transition-colors">
                                        <div class="font-medium text-blue-900">${room.name}</div>
                                        <div class="text-xs text-blue-600">${room.type}</div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    selector.innerHTML = `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <p class="text-gray-600">No existing rooms found for this venue. Add rooms in the Rooms section, then return here to set access times.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading venue rooms:', error);
                selector.innerHTML = '';
            }
        }
        
        function selectVenueRoom(roomId, roomName, roomType) {
            // Check if room is already in access list
            const currentData = getCurrentSurveyData();
            const roomAccess = (currentData.roomAccess || []);
            
            if (roomAccess.find(r => r.roomId === roomId)) {
                alert('This room is already in your access schedule.');
                return;
            }
            
            addRoomAccess(roomId, roomName, roomType);
        }
        
        async function addRoomAccess(roomId = null, roomName = '', roomType = '') {
            const currentData = await getCurrentSurveyData();
            const roomAccess = currentData.roomAccess || [];
            
            const newRoomAccess = {
                id: `access_${Date.now()}`,
                roomId: roomId || `custom_${Date.now()}`,
                roomName: roomName || 'New Room',
                roomType: roomType || 'General',
                accessDate: '',
                accessTime: '',
                accessEndTime: '',
                accessNotes: '',
                isCustom: !roomId // Track if this is a custom room or from venue database
            };
            
            roomAccess.push(newRoomAccess);
            await updateSurveyData({ roomAccess });
            renderRoomAccessList(roomAccess);
            logActivity(`Added room access schedule for: ${newRoomAccess.roomName}`);
        }
        
        function renderRoomAccessList(roomAccess = []) {
            const container = document.getElementById('room-access-list');
            if (!container) return;
            
            if (roomAccess.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>No room access scheduled yet.</p>
                        <p class="text-sm">Select rooms from above or click "Add Room Access" to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = roomAccess.map(access => `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-start">
                        <div>
                            <label class="form-label text-sm">Room Name</label>
                            <input type="text" value="${access.roomName}" 
                                   onchange="updateRoomAccess('${access.id}', 'roomName', this.value)"
                                   class="form-input text-sm">
                        </div>
                        <div>
                            <label class="form-label text-sm">Access Date</label>
                            <input type="date" value="${access.accessDate || ''}" 
                                   onchange="updateRoomAccess('${access.id}', 'accessDate', this.value)"
                                   class="form-input text-sm">
                        </div>
                        <div>
                            <label class="form-label text-sm">Start Time</label>
                            <input type="time" value="${access.accessTime || ''}" 
                                   onchange="updateRoomAccess('${access.id}', 'accessTime', this.value)"
                                   class="form-input text-sm">
                        </div>
                        <div>
                            <label class="form-label text-sm">End Time</label>
                            <input type="time" value="${access.accessEndTime || ''}" 
                                   onchange="updateRoomAccess('${access.id}', 'accessEndTime', this.value)"
                                   class="form-input text-sm">
                        </div>
                    </div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label class="form-label text-sm">Access Notes</label>
                            <input type="text" value="${access.accessNotes || ''}" 
                                   onchange="updateRoomAccess('${access.id}', 'accessNotes', this.value)"
                                   placeholder="Special instructions, key codes, contact info..."
                                   class="form-input text-sm">
                        </div>
                        <div class="flex justify-end space-x-2">
                            <span class="text-xs text-gray-500 px-2 py-1 bg-gray-100 rounded">${access.roomType}</span>
                            <button type="button" onclick="removeRoomAccess('${access.id}')" 
                                    class="text-red-600 hover:text-red-800 px-2 py-1 text-sm">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function updateRoomAccess(accessId, field, value) {
            const currentData = await getCurrentSurveyData();
            const roomAccess = currentData.roomAccess || [];
            
            const access = roomAccess.find(a => a.id === accessId);
            if (access) {
                access[field] = value;
                await updateSurveyData({ roomAccess });
                logActivity(`Updated room access: ${access.roomName} - ${field}`);
            }
        }
        
        async function removeRoomAccess(accessId) {
            if (!confirm('Remove this room from the access schedule?')) return;
            
            const currentData = await getCurrentSurveyData();
            let roomAccess = currentData.roomAccess || [];
            const roomToRemove = roomAccess.find(a => a.id === accessId);
            
            roomAccess = roomAccess.filter(a => a.id !== accessId);
            await updateSurveyData({ roomAccess });
            
            if (roomToRemove) {
                logActivity(`Removed room access: ${roomToRemove.roomName}`);
            }
            renderRoomAccessList(roomAccess);
        }
        
        // Make room access functions globally available
        window.selectVenueRoom = selectVenueRoom;
        window.updateRoomAccess = updateRoomAccess;
        window.removeRoomAccess = removeRoomAccess;

        // Venue database functions
        
        function initializeVenueDatabase() {
            // No initialization needed for Supabase - using direct client
        }

        async function saveVenueToDatabase(venueData) {
            if (!supabase) return;
            
            // Check if user has permission to save venue data
            if (!checkAccess('createVenue')) {
                alert('Access denied. You do not have permission to save venue data.');
                return;
            }
            
            try {
                const venueDoc = {
                    venue_name: venueData.venueName,
                    venue_address: venueData.venueAddress || '',
                    venue_contact: venueData.venueContact || '',
                    venue_email: venueData.venueEmail || '',
                    venue_phone: venueData.venuePhone || '',
                    venue_contact_title: venueData.venueContactTitle || '',
                    venue_manager_name: venueData.venueManagerName || '',
                    venue_manager_email: venueData.venueManagerEmail || '',
                    venue_manager_phone: venueData.venueManagerPhone || '',
                    venue_data: {
                        logistics: venueData.logistics || {},
                        rooms: venueData.rooms || [],
                        guidelines: venueData.guidelines || {},
                        photos: venueData.photos || {}
                    },
                    updated_at: new Date().toISOString(),
                    updated_by: window.currentUserEmail || currentUserName
                };
                
                const { error } = await supabase
                    .from('venues')
                    .upsert(venueDoc, {
                        onConflict: 'venue_name'
                    });

                if (error) throw error;
                
                logActivity(`Saved venue "${venueData.venueName}" to database`);
            } catch (error) {
                console.error('Error saving venue to database:', error);
            }
        }

        async function searchVenues(query) {
            if (!supabase || !query || query.length < 2) return [];
            
            // Users with 'user' role cannot see venue lists for security
            if (!checkAccess('viewVenueList')) {
                return [];
            }
            
            try {
                const { data: venues, error } = await supabase
                    .from('venues')
                    .select('*')
                    .ilike('venue_name', `%${query}%`)
                    .order('venue_name');

                if (error) throw error;
                
                return venues.map(venue => ({
                    id: venue.venue_name,
                    venueName: venue.venue_name,
                    ...venue.venue_data
                })) || [];
            } catch (error) {
                console.error('Error searching venues:', error);
                return [];
            }
        }

        async function loadVenueData(venueId) {
            if (!supabase) return null;
            
            try {
                const { data: venue, error } = await supabase
                    .from('venues')
                    .select('*')
                    .eq('venue_name', venueId)
                    .single();

                if (error) throw error;
                
                return venue ? {
                    venueName: venue.venue_name,
                    ...venue.venue_data
                } : null;
            } catch (error) {
                console.error('Error loading venue data:', error);
                return null;
            }
        }

        function setupVenueAutocomplete() {
            const venueInput = document.getElementById('venue-name');
            const suggestionsDiv = document.getElementById('venue-suggestions');
            
            if (!venueInput || !suggestionsDiv) return;
            
            let searchTimeout;
            
            venueInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    if (query.length >= 2) {
                        const venues = await searchVenues(query);
                        showVenueSuggestions(venues, suggestionsDiv);
                    } else {
                        hideSuggestions(suggestionsDiv);
                    }
                }, 300);
            });
            
            venueInput.addEventListener('blur', () => {
                // Delay hiding to allow clicking on suggestions
                setTimeout(() => hideSuggestions(suggestionsDiv), 200);
            });
            
            venueInput.addEventListener('focus', async () => {
                const query = venueInput.value.trim();
                if (query.length >= 2) {
                    const venues = await searchVenues(query);
                    showVenueSuggestions(venues, suggestionsDiv);
                }
            });
        }

        function showVenueSuggestions(venues, suggestionsDiv) {
            if (venues.length === 0) {
                hideSuggestions(suggestionsDiv);
                return;
            }
            
            suggestionsDiv.innerHTML = venues.map(venue => `
                <div class="venue-suggestion p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 last:border-b-0" data-venue-id="${venue.id}">
                    <div class="font-semibold text-gray-900">${venue.venueName}</div>
                    <div class="text-sm text-gray-600">${venue.venueAddress || 'No address'}</div>
                    <div class="text-xs text-gray-400">Last updated by ${venue.updatedBy || 'Unknown'}</div>
                </div>
            `).join('');
            
            suggestionsDiv.classList.remove('hidden');
            
            // Add click handlers
            suggestionsDiv.querySelectorAll('.venue-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', () => {
                    const venueId = suggestion.dataset.venueId;
                    loadAndPopulateVenue(venueId);
                    hideSuggestions(suggestionsDiv);
                });
            });
        }

        function hideSuggestions(suggestionsDiv) {
            suggestionsDiv.classList.add('hidden');
        }

        async function loadAndPopulateVenue(venueId) {
            // Check if user has permission to load venue data
            if (!checkAccess('editOwnVenue')) {
                alert('Access denied. You do not have permission to load venue data.');
                return;
            }
            
            const venueData = await loadVenueData(venueId);
            if (!venueData) return;
            
            // Show confirmation dialog
            const confirmed = confirm(`Load data from "${venueData.venueName}"? This will populate venue details, logistics, rooms, and guidelines. Your current data will be merged with the saved venue data.`);
            
            if (!confirmed) return;
            
            // Get current survey data
            const currentData = await getCurrentSurveyData();
            
            // Merge venue data with current data
            const mergedData = {
                ...currentData,
                'venue-name': venueData.venueName,
                'venue-address': venueData.venueAddress,
                'venue-contact': venueData.venueContact,
                // Merge logistics
                ...venueData.logistics,
                // Merge rooms (append to existing)
                rooms: [...(currentData.rooms || []), ...(venueData.rooms || [])],
                // Merge guidelines
                guidelines: venueData.guidelines || currentData.guidelines,
                // Merge photos
                photos: { ...(currentData.photos || {}), ...(venueData.photos || {}) }
            };
            
            await updateSurveyData(mergedData);
            logActivity(`Loaded venue data from "${venueData.venueName}"`);
        }

        // Edit room functionality
        let editingRoomId = null;

        function setupRoomEditListeners(section) {
            section.querySelectorAll('.edit-room-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const roomId = btn.dataset.roomId;
                    editRoom(roomId);
                });
            });
        }

        async function editRoom(roomId) {
            const currentData = await getCurrentSurveyData();
            const room = currentData.rooms?.find(r => r.id === roomId);
            
            if (!room) return;
            
            // Populate form with room data
            const form = document.getElementById('rooms-form');
            if (!form) return;
            
            form['room-type'].value = room.type;
            form['room-name'].value = room.name;
            form['room-capacity'].value = room.capacity || '';
            form['room-layout'].value = room.layout || '';
            form['room-dimensions'].value = room.dimensions || '';
            form['room-ceiling-height'].value = room.ceilingHeight || '';
            form['room-electrical'].value = room.electrical || '';
            form['room-rigging'].value = room.rigging || '';
            form['room-sound-patch'].value = room.soundPatch || '';
            form['room-door-size'].value = room.doorSize || '';
            form['room-wifi-available'].checked = room.wifiAvailable || false;
            form['room-hardline-available'].checked = room.hardlineAvailable || false;
            form['room-wifi-notes'].value = room.wifiNotes || '';
            form['room-hardline-notes'].value = room.hardlineNotes || '';
            form['room-misc-notes'].value = room.miscNotes || '';
            
            // Change form behavior
            editingRoomId = roomId;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Update Room';
            submitBtn.className = 'bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700';
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.textContent = 'Cancel Edit';
            cancelBtn.className = 'bg-gray-500 text-white px-6 py-2 rounded-lg font-medium hover:bg-gray-600 ml-3';
            cancelBtn.onclick = cancelRoomEdit;
            submitBtn.parentNode.appendChild(cancelBtn);
            
            // Show photos for the room being edited
            const photos = currentData.photos || {};
            renderPhotos('new-room-photos', photos[`rooms-${roomId}`]);
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelRoomEdit() {
            editingRoomId = null;
            const form = document.getElementById('rooms-form');
            if (!form) return;
            
            form.reset();
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Room';
            submitBtn.className = 'bg-teal-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-teal-700';
            
            // Remove cancel button
            const cancelBtn = form.querySelector('button[type="button"]');
            if (cancelBtn) cancelBtn.remove();
            
            // Clear photos
            renderPhotos('new-room-photos', []);
        }

        // Auto-save venue data when survey is updated
        async function autoSaveVenueData() {
            const currentData = await getCurrentSurveyData();
            
            if (currentData['venue-name'] && currentData['venue-address']) {
                const venueData = {
                    venueName: currentData['venue-name'],
                    venueAddress: currentData['venue-address'],
                    venueContact: currentData['venue-contact'],
                    venueEmail: currentData['venue-email'],
                    venuePhone: currentData['venue-phone'],
                    venueContactTitle: currentData['venue-contact-title'],
                    venueManagerName: currentData['venue-manager-name'],
                    venueManagerEmail: currentData['venue-manager-email'],
                    venueManagerPhone: currentData['venue-manager-phone'],
                    logistics: {
                        'dock-location': currentData['dock-location'],
                        'dock-door-height': currentData['dock-door-height'],
                        'trailer-53-support': currentData['trailer-53-support'],
                        'cab-parking': currentData['cab-parking'],
                        'num-dock-spaces': currentData['num-dock-spaces'],
                        'dock-plate-type': currentData['dock-plate-type'],
                        'ramp-available': currentData['ramp-available'],
                        'ramp-dimensions': currentData['ramp-dimensions'],
                        'dock-access-process': currentData['dock-access-process'],
                        'dock-coordinator': currentData['dock-coordinator'],
                        'dock-schedule': currentData['dock-schedule'],
                        'freight-elevator-distance': currentData['freight-elevator-distance'],
                        'freight-elevator-dimensions': currentData['freight-elevator-dimensions'],
                        'max-item-size': currentData['max-item-size']
                    },
                    rooms: currentData.rooms || [],
                    guidelines: currentData.guidelines || {},
                    photos: currentData.photos || {}
                };
                
                await saveVenueToDatabase(venueData);
            }
        }

        async function offerAgendaAnalysis(uploadedFiles) {
            // Show a prompt asking if user wants AI analysis
            const shouldAnalyze = await showAgendaAnalysisPrompt(uploadedFiles);
            
            if (shouldAnalyze) {
                await performAgendaAnalysis(uploadedFiles);
            }
        }

        function showAgendaAnalysisPrompt(files) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">AI Agenda Analysis</h3>
                        <p class="text-gray-600 mb-4">
                            Would you like the AI assistant to analyze the uploaded agenda and help automatically organize your event?
                        </p>
                        <p class="text-sm text-gray-500 mb-6">
                            The AI can help create rooms, sessions, and populate the schedule based on the agenda content.
                        </p>
                        <div class="flex space-x-3">
                            <button id="analyze-yes" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Yes, Analyze
                            </button>
                            <button id="analyze-no" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                                Not Now
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('#analyze-yes').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(true);
                });
                
                modal.querySelector('#analyze-no').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(false);
                });
                
                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(false);
                    }
                });
            });
        }

        async function uploadAgendaFile(file) {
            const timestamp = Date.now();
            const fileName = `agenda_${timestamp}_${file.name}`;
            const storageRef = ref(storage, `surveys/${appId}/agenda/${fileName}`);
            
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            
            return {
                id: fileName,
                name: file.name,
                type: file.type,
                size: file.size,
                url: downloadURL,
                uploadedBy: currentUserName,
                uploadedAt: timestamp
            };
        }

        function renderAgendaFiles(files) {
            const filesContainer = document.getElementById('agenda-files');
            if (!filesContainer) return;
            
            if (files.length === 0) {
                filesContainer.innerHTML = '';
                return;
            }
            
            filesContainer.innerHTML = `
                <div class="border-t pt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Uploaded Files:</h4>
                    <div class="space-y-2">
                        ${files.map(file => `
                            <div class="flex items-center justify-between bg-white p-3 rounded border">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0">
                                        ${getFileIcon(file.type)}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                                        <p class="text-xs text-gray-500">
                                            ${formatFileSize(file.size)} • Uploaded by ${file.uploadedBy} • 
                                            ${new Date(file.uploadedAt).toLocaleDateString()}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="viewAgendaFile('${file.url}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                        View
                                    </button>
                                    <button onclick="deleteAgendaFile('${file.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                        Delete
                                    </button>
                                    ${openAIKey ? `<button onclick="analyzeSpecificAgenda('${file.id}')" class="text-purple-600 hover:text-purple-800 text-sm">
                                        AI Analyze
                                    </button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') {
                return '<span class="text-red-600 text-xl">📄</span>';
            } else if (fileType.includes('word') || fileType.includes('document')) {
                return '<span class="text-blue-600 text-xl">📝</span>';
            } else if (fileType.startsWith('image/')) {
                return '<span class="text-green-600 text-xl">🖼️</span>';
            }
            return '<span class="text-gray-600 text-xl">📁</span>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function deleteAgendaFile(fileId) {
            if (!confirm('Are you sure you want to delete this agenda file?')) return;
            
            try {
                // Delete from storage
                const storageRef = ref(storage, `surveys/${appId}/agenda/${fileId}`);
                await deleteObject(storageRef);
                
                // Update survey data
                const currentData = await getCurrentSurveyData();
                const files = (currentData.agendaFiles || []).filter(file => file.id !== fileId);
                await updateSurveyData({ agendaFiles: files }, true);
                
                // Re-render files
                renderAgendaFiles(files);
                
                logActivity(`Deleted agenda file`);
                showNotification('Agenda file deleted successfully', 'success');
                
            } catch (error) {
                console.error('Failed to delete agenda file:', error);
                showNotification('Failed to delete file. Please try again.', 'error');
            }
        }

        function viewAgendaFile(url) {
            window.open(url, '_blank');
        }

        async function performAgendaAnalysis(files) {
            try {
                showNotification('Analyzing agenda with AI...', 'info');
                
                // For now, we'll use the first file for analysis
                // In a real implementation, you might want to combine multiple files
                const firstFile = files[0];
                
                // Extract text from the file (this is a simplified approach)
                const agendaText = await extractTextFromFile(firstFile);
                
                if (!agendaText) {
                    showNotification('Could not extract text from agenda file. Please try a different format.', 'error');
                    return;
                }
                
                // Analyze with AI
                const analysis = await analyzeAgenda(agendaText, firstFile.name);
                
                if (analysis) {
                    showAgendaAnalysisResults(analysis);
                } else {
                    showNotification('AI analysis failed. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('Agenda analysis failed:', error);
                showNotification('Failed to analyze agenda. Please try again.', 'error');
            }
        }

        async function analyzeSpecificAgenda(fileId) {
            const currentData = await getCurrentSurveyData();
            const file = (currentData.agendaFiles || []).find(f => f.id === fileId);
            
            if (file) {
                await performAgendaAnalysis([file]);
            }
        }

        async function extractTextFromFile(file) {
            // This is a simplified approach - in a real implementation you would
            // use proper document parsing libraries or OCR for images
            if (file.type === 'application/pdf') {
                // For PDF files, you'd typically use PDF.js or send to a service
                return `[PDF content from ${file.name} - text extraction would be implemented here]`;
            } else if (file.type.includes('word') || file.type.includes('document')) {
                // For Word documents, you'd use a library like mammoth.js
                return `[Word document content from ${file.name} - text extraction would be implemented here]`;
            } else if (file.type.startsWith('image/')) {
                // For images, you'd use OCR like Tesseract.js
                return `[Image content from ${file.name} - OCR would be implemented here]`;
            }
            
            return null;
        }

        function preserveFocusAndRender(sectionElement, renderFunction) {
            const activeElement = document.activeElement;
            const activeElementId = activeElement ? activeElement.id : null;
            const selectionStart = activeElement ? activeElement.selectionStart : null;
            const selectionEnd = activeElement ? activeElement.selectionEnd : null;

            renderFunction();

            if (activeElementId && sectionElement.contains(document.getElementById(activeElementId))) {
                const newActiveElement = document.getElementById(activeElementId);
                if (newActiveElement) {
                    newActiveElement.focus();
                    if (newActiveElement.setSelectionRange && selectionStart != null && selectionEnd != null) {
                        newActiveElement.setSelectionRange(selectionStart, selectionEnd);
                    }
                }
            }
        }
        
        function renderEventInfoSection(data) {
            const section = document.getElementById('event-info');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Event Information</h2>
                    <p class="text-gray-600 mb-6">Enter the core details about the event, schedule, and agenda.</p>
                    
                    <!-- Event Information Section -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4">Basic Event Details</h3>
                            <div class="flex items-center gap-4">
                                <label for="survey-status" class="form-label text-sm mb-0">Survey Status:</label>
                                <select id="survey-status" class="form-input w-auto text-sm">
                                    <option value="In Progress" ${data.status === 'In Progress' || !data.status ? 'selected' : ''}>In Progress</option>
                                    <option value="Completed" ${data.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    <option value="Archived" ${data.status === 'Archived' ? 'selected' : ''}>Archived</option>
                                    ${checkAccess('editAnySurvey') ? `<option value="Review Required" ${data.status === 'Review Required' ? 'selected' : ''}>Review Required</option>` : ''}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label for="event-name" class="form-label">Event Name</label><input type="text" id="event-name" class="form-input" placeholder="e.g., Harmony Festival 2024" value="${data['event-name'] || ''}"></div>
                            <div><label for="r2-quote-number" class="form-label">R2 Quote Number</label><input type="text" id="r2-quote-number" class="form-input" placeholder="e.g., 0911234" value="${data['r2-quote-number'] || data['r2-number'] || ''}"></div>
                            <div><label for="anticipated-attendees" class="form-label">Anticipated Attendees</label><input type="number" id="anticipated-attendees" class="form-input" placeholder="e.g., 500" value="${data['anticipated-attendees'] || ''}"></div>
                            <div>
                                <label class="form-label">Indoor/Outdoor</label>
                                <select id="indoor-outdoor" class="form-input">
                                    <option value="">Select...</option>
                                    <option value="indoor" ${data['indoor-outdoor'] === 'indoor' ? 'selected' : ''}>Indoor</option>
                                    <option value="outdoor" ${data['indoor-outdoor'] === 'outdoor' ? 'selected' : ''}>Outdoor</option>
                                    <option value="both" ${data['indoor-outdoor'] === 'both' ? 'selected' : ''}>Both</option>
                                </select>
                            </div>
                            <div><label for="charge-days" class="form-label"># Charge Days</label><input type="number" id="charge-days" class="form-input" placeholder="e.g., 3" value="${data['charge-days'] || ''}"></div>
                            <div><label for="budget" class="form-label">Budget</label><input type="text" id="budget" class="form-input" placeholder="e.g., $15,000" value="${data['budget'] || ''}"></div>
                        </div>
                    </div>

                    <!-- Schedule Section -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-teal-700 border-l-4 border-teal-500 pl-4">Event Schedule</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-teal-600 text-white">
                                        <th class="border border-gray-300 px-4 py-2 text-left font-medium">Activity</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left font-medium">Date</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left font-medium">Time</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left font-medium">Specific Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Load in:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="load-in-date" class="form-input border-0 p-1" value="${data['load-in-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="load-in-time" class="form-input border-0 p-1" value="${data['load-in-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="load-in-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['load-in-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Setup:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="setup-date" class="form-input border-0 p-1" value="${data['setup-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="setup-time" class="form-input border-0 p-1" value="${data['setup-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="setup-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['setup-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Rehearsal:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="rehearsal-date" class="form-input border-0 p-1" value="${data['rehearsal-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="rehearsal-time" class="form-input border-0 p-1" value="${data['rehearsal-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="rehearsal-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['rehearsal-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Show Start:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="show-start-date" class="form-input border-0 p-1" value="${data['show-start-date'] || data['event-start-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="show-start-time" class="form-input border-0 p-1" value="${data['show-start-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="show-start-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['show-start-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Show End:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="show-end-date" class="form-input border-0 p-1" value="${data['show-end-date'] || data['event-end-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="show-end-time" class="form-input border-0 p-1" value="${data['show-end-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="show-end-notes" class="form-input border-0 p-1" placeholder="Notes..." value="${data['show-end-notes'] || ''}"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Strike:</td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="date" id="strike-date" class="form-input border-0 p-1" value="${data['strike-date'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="time" id="strike-time" class="form-input border-0 p-1" value="${data['strike-time'] || ''}"></td>
                                        <td class="border border-gray-300 px-2 py-1"><input type="text" id="strike-notes" class="form-input border-0 p-1" placeholder="8AM Start // 1PM Strike Call" value="${data['strike-notes'] || '8AM Start // 1PM Strike Call'}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Agenda Upload Section -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-teal-700 border-l-4 border-teal-500 pl-4">Event Agenda</h3>
                        <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="mt-4">
                                    <label for="agenda-upload" class="cursor-pointer">
                                        <span class="mt-2 block text-sm font-medium text-gray-900">Upload event agenda</span>
                                        <span class="mt-1 block text-sm text-gray-600">PDF, DOC, DOCX, or image files up to 10MB</span>
                                    </label>
                                    <input id="agenda-upload" name="agenda-upload" type="file" class="sr-only" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                                </div>
                            </div>
                            <div id="agenda-files" class="mt-4"></div>
                        </div>
                    </div>
                `;
                
                // Add event listeners for all form elements
                section.querySelectorAll('.form-input, select').forEach(input => {
                    input.addEventListener('input', handleFormChange);
                    input.addEventListener('change', handleFormChange);
                });
                
                // Setup agenda file upload
                setupAgendaUpload();
                
                // Render existing agenda files
                renderAgendaFiles(data.agendaFiles || []);
                
                // Setup AI assistance triggers for form changes
                if (aiAssistanceEnabled) {
                    section.addEventListener('input', () => {
                        generateAISuggestions();
                    });
                }
            });
        }

        function renderClientInfoSection(data) {
            const section = document.getElementById('client-info');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Client Information</h2>
                    <p class="text-gray-600 mb-6">Enter all client contact and business details for this event.</p>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Client Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label for="client-business" class="form-label">Client Business</label><input type="text" id="client-business" class="form-input" placeholder="e.g., ABC Corporation" value="${data['client-business'] || ''}"></div>
                            <div><label for="client-name" class="form-label">Client Name</label><input type="text" id="client-name" class="form-input" placeholder="e.g., John Smith" value="${data['client-name'] || data['client-contact'] || ''}"></div>
                            <div><label for="client-title" class="form-label">Client Title</label><input type="text" id="client-title" class="form-input" placeholder="e.g., Event Manager" value="${data['client-title'] || ''}"></div>
                            <div><label for="client-cell" class="form-label">Client Phone</label><input type="tel" id="client-cell" class="form-input" placeholder="e.g., 555-123-4567" value="${data['client-cell'] || ''}"></div>
                            <div><label for="client-email" class="form-label">Client Email</label><input type="email" id="client-email" class="form-input" placeholder="e.g., john@abccorp.com" value="${data['client-email'] || ''}"></div>
                            <div><label for="client-address" class="form-label">Client Address</label><input type="text" id="client-address" class="form-input" placeholder="e.g., 123 Business St, City, State" value="${data['client-address'] || ''}"></div>
                            <div>
                                <label class="form-label">Tax Status</label>
                                <select id="tax-status" class="form-input">
                                    <option value="">Select...</option>
                                    <option value="taxable" ${data['tax-status'] === 'taxable' ? 'selected' : ''}>Taxable</option>
                                    <option value="tax-exempt" ${data['tax-status'] === 'tax-exempt' ? 'selected' : ''}>Tax Exempt</option>
                                    <option value="non-profit" ${data['tax-status'] === 'non-profit' ? 'selected' : ''}>Non-Profit</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Event Contact Information</h3>
                        <p class="text-gray-600 mb-4">Primary event contact (may be different from client)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="event-contact-name" class="form-label">Event Contact Name</label><input type="text" id="event-contact-name" class="form-input" placeholder="e.g., Sarah Johnson" value="${data['event-contact-name'] || ''}"></div>
                            <div><label for="event-contact-title" class="form-label">Event Contact Title</label><input type="text" id="event-contact-title" class="form-input" placeholder="e.g., Event Coordinator" value="${data['event-contact-title'] || ''}"></div>
                            <div><label for="event-contact-phone" class="form-label">Event Contact Phone</label><input type="tel" id="event-contact-phone" class="form-input" placeholder="e.g., 555-987-6543" value="${data['event-contact-phone'] || ''}"></div>
                            <div><label for="event-contact-email" class="form-label">Event Contact Email</label><input type="email" id="event-contact-email" class="form-input" placeholder="e.g., sarah@abccorp.com" value="${data['event-contact-email'] || ''}"></div>
                        </div>
                    </div>
                `;
                
                // Add event listeners for all form elements
                section.querySelectorAll('.form-input, select').forEach(input => {
                    input.addEventListener('input', handleFormChange);
                    input.addEventListener('change', handleFormChange);
                });
            });
        }

        function renderVenueInfoSection(data) {
            const section = document.getElementById('venue-info');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Venue Information</h2>
                    <p class="text-gray-600 mb-6">Enter venue details and survey team information.</p>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Venue Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="relative">
                                <label for="venue-name" class="form-label">Venue Name</label>
                                <input type="text" id="venue-name" class="form-input" placeholder="e.g., Sunset Meadows Park" value="${data['venue-name'] || ''}" autocomplete="off">
                                <div id="venue-suggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-60 overflow-y-auto z-10 hidden"></div>
                            </div>
                            <div><label for="venue-address" class="form-label">Venue Address</label><input type="text" id="venue-address" class="form-input" placeholder="123 Park Ave, City, State" value="${data['venue-address'] || ''}"></div>
                            <div><label for="venue-contact" class="form-label">Main Venue Contact</label><input type="text" id="venue-contact" class="form-input" placeholder="Mike R. - 555-123-4567" value="${data['venue-contact'] || ''}"></div>
                            <div><label for="venue-email" class="form-label">Venue Email</label><input type="email" id="venue-email" class="form-input" placeholder="contact@venue.com" value="${data['venue-email'] || ''}"></div>
                            <div><label for="venue-phone" class="form-label">Venue Phone</label><input type="tel" id="venue-phone" class="form-input" placeholder="555-123-4567" value="${data['venue-phone'] || ''}"></div>
                            <div><label for="venue-contact-title" class="form-label">Contact Title</label><input type="text" id="venue-contact-title" class="form-input" placeholder="e.g., Event Manager" value="${data['venue-contact-title'] || ''}"></div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Venue Manager Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label for="venue-manager-name" class="form-label">Manager Name</label><input type="text" id="venue-manager-name" class="form-input" placeholder="e.g., Sarah Wilson" value="${data['venue-manager-name'] || ''}"></div>
                            <div><label for="venue-manager-email" class="form-label">Manager Email</label><input type="email" id="venue-manager-email" class="form-input" placeholder="manager@venue.com" value="${data['venue-manager-email'] || ''}"></div>
                            <div><label for="venue-manager-phone" class="form-label">Manager Phone</label><input type="tel" id="venue-manager-phone" class="form-input" placeholder="555-987-6543" value="${data['venue-manager-phone'] || ''}"></div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-teal-700 border-l-4 border-teal-500 pl-4 mb-6">Survey Team Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="survey-date" class="form-label">Survey Date</label><input type="date" id="survey-date" class="form-input" value="${data['survey-date'] || new Date().toISOString().split('T')[0]}"></div>
                            <div><label for="survey-team" class="form-label">Survey Team</label><input type="text" id="survey-team" class="form-input" placeholder="John D., Jane S." value="${data['survey-team'] || ''}"></div>
                            <div><label for="project-manager" class="form-label">Project Manager</label><input type="text" id="project-manager" class="form-input" placeholder="e.g., Alex Johnson" value="${data['project-manager'] || ''}"></div>
                            <div><label for="account-rep" class="form-label">Account Rep</label><input type="text" id="account-rep" class="form-input" placeholder="e.g., Maria Garcia" value="${data['account-rep'] || ''}"></div>
                        </div>
                    </div>
                `;
                
                // Add event listeners for all form elements
                section.querySelectorAll('.form-input, select').forEach(input => {
                    input.addEventListener('input', handleFormChange);
                    input.addEventListener('change', handleFormChange);
                });
                
                // Setup venue autocomplete
                setupVenueAutocomplete();
            });
        }

        function renderLogisticsSection(data) {
            const section = document.getElementById('logistics');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Venue & Access Logistics</h2>
                    <p class="text-gray-600 mb-6">Document all logistical details for load-in, load-out, and internal freight movement.</p>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-bold mb-4">Dock & Trailer Access</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="dock-location" class="form-label">Dock Location/Street Access</label><input type="text" id="dock-location" class="form-input" placeholder="e.g., Accessed from Main Street on the north side" value="${data['dock-location'] || ''}"></div>
                                <div><label for="dock-door-height" class="form-label">Dock Door Height</label><input type="text" id="dock-door-height" class="form-input" placeholder="e.g., 14' high" value="${data['dock-door-height'] || ''}"></div>
                                <div>
                                    <label class="form-label">Can it accommodate a 53' semi trailer?</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="trailer-53-support" value="yes" ${data['trailer-53-support'] === 'yes' ? 'checked' : ''}> Yes</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="trailer-53-support" value="no" ${data['trailer-53-support'] === 'no' ? 'checked' : ''}> No</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="trailer-53-support" value="unconfirmed" ${data['trailer-53-support'] === 'unconfirmed' || !data['trailer-53-support'] ? 'checked' : ''}> Unconfirmed</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">Can a cab remain attached without blocking traffic?</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="cab-parking" value="yes" ${data['cab-parking'] === 'yes' ? 'checked' : ''}> Yes</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="cab-parking" value="no" ${data['cab-parking'] === 'no' ? 'checked' : ''}> No</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="cab-parking" value="unconfirmed" ${data['cab-parking'] === 'unconfirmed' || !data['cab-parking'] ? 'checked' : ''}> Unconfirmed</label>
                                    </div>
                                </div>
                            </div>
                            ${createPhotoUploadArea('logistics', 'dock-access')}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Equipment & Ramps</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="num-dock-spaces" class="form-label">Number of Dock Spaces</label><input type="number" id="num-dock-spaces" class="form-input" placeholder="e.g., 3" value="${data['num-dock-spaces'] || ''}"></div>
                                <div>
                                    <label class="form-label">Dock Plate Available?</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-plate-type" value="motorized" ${data['dock-plate-type'] === 'motorized' ? 'checked' : ''}> Motorized</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-plate-type" value="manual" ${data['dock-plate-type'] === 'manual' ? 'checked' : ''}> Manual</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-plate-type" value="none" ${data['dock-plate-type'] === 'none' || !data['dock-plate-type'] ? 'checked' : ''}> None</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">Ramp Available?</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="ramp-available" value="yes" ${data['ramp-available'] === 'yes' ? 'checked' : ''}> Yes</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="ramp-available" value="no" ${data['ramp-available'] === 'no' || !data['ramp-available'] ? 'checked' : ''}> No</label>
                                    </div>
                                </div>
                                <div><label for="ramp-dimensions" class="form-label">Ramp Dimensions</label><input type="text" id="ramp-dimensions" class="form-input" placeholder="e.g., 6'W x 20'L" value="${data['ramp-dimensions'] || ''}"></div>
                            </div>
                            ${createPhotoUploadArea('logistics', 'equipment-ramps')}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Access & Coordination</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="dock-access-process" class="form-label">Process for Accessing the Dock</label><input type="text" id="dock-access-process" class="form-input" placeholder="e.g., Ring doorbell, check in with security" value="${data['dock-access-process'] || ''}"></div>
                                <div><label for="dock-coordinator" class="form-label">Dock Access Coordinator</label><input type="text" id="dock-coordinator" class="form-input" placeholder="e.g., Building Manager Jane Doe - 555-123-4567" value="${data['dock-coordinator'] || ''}"></div>
                                <div class="md:col-span-2">
                                    <label class="form-label">Dock Schedule</label>
                                    <div class="flex items-center gap-4 mt-2">
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-schedule" value="first-come" ${data['dock-schedule'] === 'first-come' || !data['dock-schedule'] ? 'checked' : ''}> First-Come, First-Served</label>
                                        <label class="inline-flex items-center"><input type="radio" class="form-checkbox" name="dock-schedule" value="scheduled" ${data['dock-schedule'] === 'scheduled' ? 'checked' : ''}> Scheduled</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Freight Elevator & Internal Movement</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="freight-elevator-distance" class="form-label">Distance from Dock to Freight Elevator</label><input type="text" id="freight-elevator-distance" class="form-input" placeholder="e.g., 150' straight shot" value="${data['freight-elevator-distance'] || ''}"></div>
                                <div><label for="freight-elevator-dimensions" class="form-label">Freight Elevator Dimensions & Weight Capacity</label><input type="text" id="freight-elevator-dimensions" class="form-input" placeholder="e.g., 8'W x 10'D x 8'H, 5,000 lbs" value="${data['freight-elevator-dimensions'] || ''}"></div>
                                <div class="md:col-span-2"><label for="max-item-size" class="form-label">Tallest & Longest Item that can be moved</label><textarea id="max-item-size" rows="3" class="form-input" placeholder="e.g., 7' tall, 10' long. Notes: Hallway turns are tight past the kitchen.">${data['max-item-size'] || ''}</textarea></div>
                            </div>
                            ${createPhotoUploadArea('logistics', 'freight-elevator')}
                        </div>
                        
                        <!-- Room Access Scheduling Section -->
                        <div>
                            <h3 class="text-xl font-bold mb-4">Room Access Schedule</h3>
                            <p class="text-gray-600 mb-4">Specify access times for each room being used during the event.</p>
                            
                            <!-- Load existing venue rooms if available -->
                            <div id="venue-rooms-selector" class="mb-6"></div>
                            
                            <!-- Room access table -->
                            <div id="room-access-container">
                                <div class="mb-4 flex justify-between items-center">
                                    <h4 class="text-lg font-semibold">Selected Rooms & Access Times</h4>
                                    <button type="button" id="add-room-access-btn" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">
                                        Add Room Access
                                    </button>
                                </div>
                                <div id="room-access-list" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>`;
                
                section.querySelectorAll('.form-input, .form-checkbox, textarea').forEach(input => input.addEventListener('input', handleFormChange));
                
                // Setup photo upload functionality
                setupPhotoUploadListeners(section);
                
                // Setup room access functionality
                setupRoomAccess(data);
                
                // Render existing photos
                const photos = data.photos || {};
                renderPhotos('logistics-dock-access', photos['logistics-dock-access']);
                renderPhotos('logistics-equipment-ramps', photos['logistics-equipment-ramps']);
                renderPhotos('logistics-freight-elevator', photos['logistics-freight-elevator']);
            });
        }

        function renderRoomsSection(data) {
            const section = document.getElementById('rooms');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                const rooms = data.rooms || [];
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Rooms & Spaces</h2>
                    <p class="text-gray-600 mb-6">Add rooms and their technical specifications. All data is saved in real-time for the team to see.</p>
                    <form id="rooms-form" class="p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div><label for="room-type" class="form-label">Room Type</label><select id="room-type" class="form-input" required><option>General Session</option><option>Breakout Room</option><option>Exhibit Hall</option><option>Registration</option><option>Office</option><option>Green Room</option><option>Other</option></select></div>
                            <div><label for="room-name" class="form-label">Room Name</label><input type="text" id="room-name" class="form-input" placeholder="e.g., Ballroom A" required></div>
                            <div><label for="room-capacity" class="form-label">Capacity</label><input type="number" id="room-capacity" class="form-input" placeholder="e.g., 150"></div>
                            <div><label for="room-layout" class="form-label">Layout Style</label><select id="room-layout" class="form-input"><option value="">Select...</option><option>Theater</option><option>Classroom</option><option>Rounds</option><option>U-Shape</option><option>Conference</option><option>Banquet</option><option>Reception</option><option>Other</option></select></div>
                        </div>
                        <div class="space-y-4 pt-4 border-t border-gray-200 mt-4">
                            <h3 class="font-semibold text-lg">Technical & A/V Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="room-dimensions" class="form-label">Dimensions (L x W)</label><input type="text" id="room-dimensions" class="form-input" placeholder="e.g., 50' x 75'"></div>
                                <div><label for="room-ceiling-height" class="form-label">Ceiling Height</label><input type="text" id="room-ceiling-height" class="form-input" placeholder="e.g., 20'"></div>
                                <div><label for="room-electrical" class="form-label">Available Electrical</label><input type="text" id="room-electrical" class="form-input" placeholder="e.g., 4x 20A Circuits, 1x 50A Panel"></div>
                                <div><label for="room-rigging" class="form-label">Rigging Options</label><input type="text" id="room-rigging" class="form-input" placeholder="e.g., Limited grid, 500 lbs per point"></div>
                                <div><label for="room-sound-patch" class="form-label">Sound Patch</label><input type="text" id="room-sound-patch" class="form-input" placeholder="e.g., Yes, at FOH location"></div>
                                <div><label for="room-door-size" class="form-label">Largest Door Access Size</label><input type="text" id="room-door-size" class="form-input" placeholder="e.g., 7'W x 8'H"></div>
                            </div>
                        </div>
                        <div class="space-y-4 pt-4 border-t border-gray-200 mt-4">
                            <h3 class="font-semibold text-lg">Connectivity Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="form-checkbox-label"><input type="checkbox" id="room-wifi-available" class="form-checkbox"> Wi-Fi Available</label></div>
                                <div><label class="form-checkbox-label"><input type="checkbox" id="room-hardline-available" class="form-checkbox"> Hardline Available</label></div>
                                <div><label for="room-wifi-notes" class="form-label">Wi-Fi Notes</label><textarea id="room-wifi-notes" rows="3" class="form-input"></textarea></div>
                                <div><label for="room-hardline-notes" class="form-label">Hardline Notes</label><textarea id="room-hardline-notes" rows="3" class="form-input"></textarea></div>
                                <div class="md:col-span-2"><label for="room-misc-notes" class="form-label">Miscellaneous Notes</label><textarea id="room-misc-notes" rows="3" class="form-input"></textarea></div>
                            </div>
                        </div>
                        <div class="space-y-4 pt-4 border-t border-gray-200 mt-4">
                            <h3 class="font-semibold text-lg">Room Photos</h3>
                            ${createPhotoUploadArea('new-room', 'photos')}
                        </div>
                        <div class="flex justify-end pt-4"><button type="submit" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-teal-700">Add Room</button></div>
                    </form>
                    <div id="rooms-list" class="space-y-6 mt-8"></div>
                `;

                const roomsListEl = section.querySelector('#rooms-list');
                roomsListEl.innerHTML = ''; 
                if (rooms.length === 0) {
                    roomsListEl.innerHTML = '<p class="text-gray-500 text-center">No rooms added yet. Use the form above to add one.</p>';
                } else {
                    const photos = data.photos || {};
                    const groupedRooms = rooms.reduce((acc, room) => {
                        (acc[room.type] = acc[room.type] || []).push(room);
                        return acc;
                    }, {});

                    Object.keys(groupedRooms).sort().forEach(type => {
                        const roomTypeSection = document.createElement('div');
                        roomTypeSection.innerHTML = `<h3 class="text-xl font-bold text-gray-800 mb-2">${type} Rooms</h3><div class="space-y-4 mb-6"></div>`;
                        const container = roomTypeSection.querySelector('div');
                        
                        groupedRooms[type].forEach(room => {
                            const roomElement = document.createElement('div');
                            roomElement.className = 'bg-gray-100 p-4 rounded-lg border border-gray-200 shadow-sm';
                            roomElement.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">${room.name}</h4>
                                        ${room.capacity ? `<p class="text-sm text-gray-600">Capacity: ${room.capacity}${room.layout ? ` | Layout: ${room.layout}` : ''}</p>` : ''}
                                    </div>
                                    <div class="flex gap-2">
                                        <button data-room-id="${room.id}" class="edit-room-btn text-blue-500 hover:text-blue-700 p-1 rounded-full" title="Edit room">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                            </svg>
                                        </button>
                                        <button data-room-id="${room.id}" class="delete-room-btn text-red-500 hover:text-red-700 p-1 rounded-full" title="Delete room">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600 grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <p><strong>Dimensions:</strong> ${room.dimensions || 'N/A'}</p>
                                    <p><strong>Ceiling Height:</strong> ${room.ceilingHeight || 'N/A'}</p>
                                    <p><strong>Electrical:</strong> ${room.electrical || 'N/A'}</p>
                                    <p><strong>Rigging:</strong> ${room.rigging || 'N/A'}</p>
                                    <p><strong>Sound Patch:</strong> ${room.soundPatch || 'N/A'}</p>
                                    <p><strong>Door Size:</strong> ${room.doorSize || 'N/A'}</p>
                                    <div class="md:col-span-2 mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <div><p><strong>Wi-Fi:</strong> ${room.wifiAvailable ? 'Yes' : 'No'}</p><p class="text-xs pl-2">${room.wifiNotes || ''}</p></div>
                                        <div><p><strong>Hardline:</strong> ${room.hardlineAvailable ? 'Yes' : 'No'}</p><p class="text-xs pl-2">${room.hardlineNotes || ''}</p></div>
                                    </div>
                                    <div class="md:col-span-2 mt-2"><p><strong>Notes:</strong> ${room.miscNotes || 'N/A'}</p></div>
                                </div>
                                ${createPhotoUploadArea('rooms', room.id)}`;
                            container.appendChild(roomElement);
                            
                            // Setup photo functionality for this room
                            setupPhotoUploadListeners(roomElement);
                            renderPhotos(`rooms-${room.id}`, photos[`rooms-${room.id}`]);
                        });
                        roomsListEl.appendChild(roomTypeSection);
                    });
                }

                section.querySelector('#rooms-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    
                    const roomData = {
                        type: form['room-type'].value,
                        name: form['room-name'].value,
                        capacity: parseInt(form['room-capacity'].value) || null,
                        layout: form['room-layout'].value,
                        dimensions: form['room-dimensions'].value,
                        ceilingHeight: form['room-ceiling-height'].value,
                        electrical: form['room-electrical'].value,
                        rigging: form['room-rigging'].value,
                        soundPatch: form['room-sound-patch'].value,
                        doorSize: form['room-door-size'].value,
                        wifiAvailable: form['room-wifi-available'].checked,
                        hardlineAvailable: form['room-hardline-available'].checked,
                        wifiNotes: form['room-wifi-notes'].value,
                        hardlineNotes: form['room-hardline-notes'].value,
                        miscNotes: form['room-misc-notes'].value,
                    };
                    
                    let updatedRooms;
                    
                    if (editingRoomId) {
                        // Editing existing room
                        roomData.id = editingRoomId;
                        updatedRooms = rooms.map(room => room.id === editingRoomId ? roomData : room);
                        logActivity(`Updated room: "${roomData.name}"`);
                        
                        // Handle photos for edited room
                        const currentData = await getCurrentSurveyData();
                        const photos = currentData.photos || {};
                        const newRoomPhotos = photos['new-room-photos'] || [];
                        
                        if (newRoomPhotos.length > 0) {
                            // Move photos from new-room area to the actual room
                            photos[`rooms-${editingRoomId}`] = [...(photos[`rooms-${editingRoomId}`] || []), ...newRoomPhotos];
                            delete photos['new-room-photos'];
                            await updateSurveyData({ photos });
                        }
                        
                        cancelRoomEdit();
                    } else {
                        // Adding new room
                        roomData.id = `room_${Date.now()}`;
                        updatedRooms = [...rooms, roomData];
                        logActivity(`Added room: "${roomData.name}"`);
                        
                        // Handle photos for new room
                        const currentData = await getCurrentSurveyData();
                        const photos = currentData.photos || {};
                        const newRoomPhotos = photos['new-room-photos'] || [];
                        
                        if (newRoomPhotos.length > 0) {
                            photos[`rooms-${roomData.id}`] = newRoomPhotos;
                            delete photos['new-room-photos'];
                            await updateSurveyData({ photos });
                        }
                        
                        form.reset();
                    }
                    
                    updateSurveyData({ rooms: updatedRooms });
                    
                    // Auto-save venue data
                    setTimeout(autoSaveVenueData, 1000);
                });
                
                // Setup photo upload for room form
                setupPhotoUploadListeners(section);
                
                // Setup edit room listeners
                setupRoomEditListeners(section);
                
                // Render photos for new room area
                const photos = data.photos || {};
                renderPhotos('new-room-photos', photos['new-room-photos'] || []);

                section.querySelectorAll('.delete-room-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const roomIdToDelete = btn.dataset.roomId;
                        const roomToDelete = rooms.find(r => r.id === roomIdToDelete);
                        
                        if (!roomToDelete) return;
                        
                        const confirmed = confirm(`Are you sure you want to delete the room "${roomToDelete.name}"? This will also delete all associated photos.`);
                        
                        if (!confirmed) return;
                        
                        const updatedRooms = rooms.filter(r => r.id !== roomIdToDelete);
                        
                        // Also delete photos for this room
                        const currentData = await getCurrentSurveyData();
                        const photos = currentData.photos || {};
                        const roomPhotos = photos[`rooms-${roomIdToDelete}`] || [];
                        
                        // Delete photos from storage
                        for (const photo of roomPhotos) {
                            try {
                                await deletePhoto(photo.id);
                            } catch (error) {
                                console.error('Error deleting room photo:', error);
                            }
                        }
                        
                        // Remove photos from database
                        delete photos[`rooms-${roomIdToDelete}`];
                        
                        await updateSurveyData({ rooms: updatedRooms, photos });
                        logActivity(`Deleted room: "${roomToDelete.name}"`);
                        
                        // Auto-save venue data
                        setTimeout(autoSaveVenueData, 1000);
                    });
                });
            });
        }
        
        function renderVenueGuidelinesSection(data) {
            const section = document.getElementById('venue-guidelines');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                const guidelinesData = data.guidelines || {};
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Venue Guidelines Processor</h2>
                    <div id="guidelines-content"></div>`;

                const contentEl = section.querySelector('#guidelines-content');
                if (guidelinesData.results) {
                    const processedAt = guidelinesData.processedAt ? new Date(guidelinesData.processedAt).toLocaleString() : 'Unknown';
                    const processedBy = guidelinesData.processedBy || 'Unknown';
                    
                    contentEl.innerHTML = `
                        <div id="processing-results" class="space-y-10">
                            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-green-600">✅</span>
                                        <span class="font-medium text-gray-800">AI Processing Complete</span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        Processed by ${processedBy} on ${processedAt}
                                    </div>
                                </div>
                            </div>
                            <div id="results-container" class="space-y-6">
                                <div class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg shadow-md">
                                    <h2 class="text-2xl font-bold mb-4 text-blue-800">📅 Due Dates & Deadlines</h2>
                                    ${guidelinesData.results.dueDates.length > 0 ? 
                                        `<ul class="list-disc pl-5 space-y-3">${guidelinesData.results.dueDates.map(item => `<li><span class="font-semibold">${item.task}:</span> <span class="bg-blue-200 text-blue-800 px-2 py-1 rounded-full text-sm">${item.dueDate}</span></li>`).join('')}</ul>` :
                                        `<p class="text-blue-700">No specific due dates found in the guidelines.</p>`
                                    }
                                </div>
                                <div class="bg-green-50 border-l-4 border-green-600 p-6 rounded-lg shadow-md">
                                    <h2 class="text-2xl font-bold mb-4 text-green-800">📋 Important Information</h2>
                                    ${guidelinesData.results.importantInfo.length > 0 ?
                                        `<ul class="list-disc pl-5 space-y-3">${guidelinesData.results.importantInfo.map(item => `<li>${item}</li>`).join('')}</ul>` :
                                        `<p class="text-green-700">No specific important information extracted.</p>`
                                    }
                                </div>
                            </div>
                            <div class="bg-gray-100 p-6 rounded-lg shadow-inner mt-10">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800">📄 Original Guidelines</h3>
                                <div class="bg-gray-200 p-4 rounded-lg max-h-60 overflow-y-auto font-mono text-sm">${guidelinesData.originalText}</div>
                                <button id="reset-guidelines-btn" class="mt-4 w-full py-2 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600">Process New Document</button>
                            </div>
                        </div>`;
                } else {
                    // Check if AI is available to show appropriate message
                    const aiAvailable = aiSystemEnabled && openAIKey;
                    const statusMessage = aiAvailable 
                        ? "Paste your venue's regulations below. Our AI will extract key information and due dates, and save them for the whole team to see."
                        : "⚠️ AI processing is not available. Please contact an administrator to enable AI features. You can still paste guidelines manually for reference.";
                    
                    const statusClass = aiAvailable ? "text-gray-600" : "text-orange-600 bg-orange-50 border border-orange-200 rounded-lg p-3";
                    
                    contentEl.innerHTML = `
                        <p class="${statusClass} mb-6 text-center max-w-2xl mx-auto">${statusMessage}</p>
                        <textarea id="guidelines-text" class="w-full p-4 border rounded-lg min-h-[300px] font-mono text-sm" placeholder="Paste guidelines here...">${guidelinesData.originalText || ''}</textarea>
                        <div id="error-container" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                        <button id="process-guidelines-btn" class="mt-6 w-full py-3 text-white font-bold ${aiAvailable ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'} rounded-lg" ${!aiAvailable ? 'disabled' : ''}>
                            ${aiAvailable ? '🤖 Extract Key Info & Due Dates with AI' : '🚫 AI Processing Unavailable'}
                        </button>
                        <div id="loading-indicator" class="hidden flex items-center justify-center p-10"><div class="loader h-10 w-10 border-4 border-blue-600 border-t-transparent rounded-full"></div><p class="ml-4">Processing with AI...</p></div>`;
                }

                const processBtn = section.querySelector('#process-guidelines-btn');
                if(processBtn) {
                    processBtn.addEventListener('click', handleGuidelinesProcessing);
                }
                const resetBtn = section.querySelector('#reset-guidelines-btn');
                if(resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        updateSurveyData({ guidelines: {} });
                        logActivity('Reset Venue Guidelines processor.');
                    });
                }
            });
        }

        async function handleGuidelinesProcessing() {
            const guidelinesTextarea = document.getElementById('guidelines-text');
            const guidelinesText = guidelinesTextarea.value.trim();
            const errorContainer = document.getElementById('error-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const processBtn = document.getElementById('process-guidelines-btn');

            if (!guidelinesText) {
                errorContainer.textContent = 'Please paste some text to process.';
                errorContainer.classList.remove('hidden');
                return;
            }

            // Check if AI system is available
            if (!aiSystemEnabled || !openAIKey) {
                errorContainer.textContent = 'AI system is not available. Please contact an administrator to enable AI features.';
                errorContainer.classList.remove('hidden');
                return;
            }

            errorContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            guidelinesTextarea.disabled = true;
            processBtn.disabled = true;

            const prompt = `You are an expert event planning assistant. Analyze the following venue guidelines and extract:

1. Important information that event planners need to know
2. Tasks with specific due dates or deadlines

Please provide your response in JSON format with:
- "importantInfo": array of key venue rules, restrictions, requirements, and policies
- "dueDates": array of objects with "task" and "dueDate" properties for any deadlines mentioned

Venue Guidelines:
${guidelinesText}

Focus on practical information that would affect event planning, setup, logistics, and operations.`;
            
            try {
                console.log('Processing venue guidelines with OpenAI...');
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openAIKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert event planning assistant. Always respond with valid JSON.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.3,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`OpenAI API Error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                const aiResponse = result.choices[0].message.content;
                console.log('OpenAI response:', aiResponse);
                
                let parsedData;
                try {
                    parsedData = JSON.parse(aiResponse);
                } catch (parseError) {
                    console.error('Failed to parse AI response:', parseError);
                    throw new Error('AI response was not valid JSON. Please try again.');
                }

                // Ensure we have the expected structure
                if (!parsedData.importantInfo) parsedData.importantInfo = [];
                if (!parsedData.dueDates) parsedData.dueDates = [];

                const guidelinesResult = {
                    originalText: guidelinesText,
                    results: parsedData,
                    processedAt: new Date().toISOString(),
                    processedBy: window.currentUserEmail || currentUserName
                };

                await updateSurveyData({ guidelines: guidelinesResult });
                logActivity('Processed venue guidelines with AI assistant.');
                showNotification('Venue guidelines processed successfully!', 'success');

            } catch (e) {
                console.error("Error processing guidelines:", e);
                errorContainer.textContent = `Failed to process guidelines: ${e.message}`;
                errorContainer.classList.remove('hidden');
                showNotification('Failed to process venue guidelines. Please try again.', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                guidelinesTextarea.disabled = false;
                processBtn.disabled = false;
            }
        }

        function renderWrapUpSection(data) {
            const section = document.getElementById('wrap-up');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">Wrap-Up & Recommendations</h2>
                    <p class="text-gray-600 mb-6">Conclude the survey by summarizing your key findings, listing actionable items, and providing an overall assessment.</p>
                    <div class="space-y-6">
                        <div><label for="key-findings" class="form-label">Key Findings</label><textarea id="key-findings" name="key-findings" rows="5" class="form-input" placeholder="Summarize the most important points...">${data['key-findings'] || ''}</textarea></div>
                        <div><label for="action-items" class="form-label">Action Items</label><textarea id="action-items" name="action-items" rows="5" class="form-input" placeholder="List specific tasks that need to be addressed...">${data['action-items'] || ''}</textarea></div>
                        <div><label for="assessment" class="form-label">Overall Assessment</label><textarea id="assessment" name="assessment" rows="3" class="form-input" placeholder="Provide a final recommendation...">${data['assessment'] || ''}</textarea></div>
                        ${createPhotoUploadArea('wrap-up', 'final-documentation')}
                    </div>`;
                
                section.querySelectorAll('.form-input, textarea').forEach(input => input.addEventListener('input', handleFormChange));
                
                // Setup photo upload functionality
                setupPhotoUploadListeners(section);
                
                // Render existing photos
                const photos = data.photos || {};
                renderPhotos('wrap-up-final-documentation', photos['wrap-up-final-documentation']);
            });
        }
        
        // --- MODIFIED SUMMARY SECTION ---
        function renderSummaryExportSection(data) {
            const section = document.getElementById('summary-export');
            if (!section) return;

            preserveFocusAndRender(section, () => {
                const na = '<span class="text-gray-400">N/A</span>';
                
                // Helper for Logistics radio buttons
                const formatRadio = (value) => {
                    if (!value) return na;
                    return value.charAt(0).toUpperCase() + value.slice(1).replace('-', ' ');
                };
                
                // Render Rooms
                const rooms = data.rooms || [];
                const photos = data.photos || {};
                let roomsHtml = `<p class="text-gray-500">No rooms have been added.</p>`;
                if (rooms.length > 0) {
                     roomsHtml = Object.entries(rooms.reduce((acc, room) => {
                        (acc[room.type] = acc[room.type] || []).push(room);
                        return acc;
                    }, {})).map(([type, roomList]) => `
                        <div class="mb-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">${type} Rooms</h4>
                            ${roomList.map(room => {
                                const roomPhotos = photos[`rooms-${room.id}`] || [];
                                const photoHtml = roomPhotos.length > 0 ? `
                                    <div class="mt-2">
                                        <h6 class="text-sm font-medium text-gray-600 mb-1">📸 Photos:</h6>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            ${roomPhotos.map(photo => `<img src="${photo.url}" alt="${photo.name}" class="w-full h-20 object-cover rounded border">`).join('')}
                                        </div>
                                    </div>
                                ` : '';
                                
                                return `
                                    <div class="p-3 mb-2 border-l-4 border-gray-200 bg-gray-50 rounded-r-lg">
                                        <h5 class="font-bold text-gray-800">${room.name || na}</h5>
                                        <dl class="mt-1 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Dimensions:</dt><dd class="text-gray-800">${room.dimensions || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Ceiling:</dt><dd class="text-gray-800">${room.ceilingHeight || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Electrical:</dt><dd class="text-gray-800">${room.electrical || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Rigging:</dt><dd class="text-gray-800">${room.rigging || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Sound Patch:</dt><dd class="text-gray-800">${room.soundPatch || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Largest Door:</dt><dd class="text-gray-800">${room.doorSize || na}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Wi-Fi:</dt><dd class="text-gray-800">${room.wifiAvailable ? `Yes (${room.wifiNotes || 'No notes'})` : 'No'}</dd></div>
                                            <div class="flex"><dt class="w-28 font-medium text-gray-500">Hardline:</dt><dd class="text-gray-800">${room.hardlineAvailable ? `Yes (${room.hardlineNotes || 'No notes'})` : 'No'}</dd></div>
                                            <div class="col-span-full flex"><dt class="w-28 font-medium text-gray-500">Misc Notes:</dt><dd class="text-gray-800">${room.miscNotes || na}</dd></div>
                                        </dl>
                                        ${photoHtml}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `).join('');
                }

                // Helper function to create photo section for summary
                const createPhotoSummary = (sectionName, title) => {
                    const sectionPhotos = photos[sectionName] || [];
                    if (sectionPhotos.length === 0) return '';
                    
                    return `
                        <div class="mt-3">
                            <h5 class="text-sm font-medium text-gray-600 mb-2">📸 ${title} Photos:</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                ${sectionPhotos.map(photo => `<img src="${photo.url}" alt="${photo.name}" class="w-full h-20 object-cover rounded border">`).join('')}
                            </div>
                        </div>
                    `;
                };

                // Render Venue Guidelines
                const guidelinesData = data.guidelines || {};
                let guidelinesHtml = `<p class="text-gray-500">No venue guidelines have been processed.</p>`;
                if (guidelinesData.results) {
                    guidelinesHtml = `
                        <div class="mb-2">
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">Important Information</h4>
                            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-800">${guidelinesData.results.importantInfo.map(item => `<li>${item}</li>`).join('') || na}</ul>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">Due Dates</h4>
                            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-800">${guidelinesData.results.dueDates.map(item => `<li><strong>${item.task}:</strong> ${item.dueDate}</li>`).join('') || na}</ul>
                        </div>
                    `;
                }

                section.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Event Summary: ${appId}</h2>
                        <button id="print-summary-btn" class="no-print bg-teal-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-teal-700 transition-colors">Print Summary</button>
                    </div>
                    <div id="summary-content" class="space-y-6 text-sm">
                        
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Event Information</h3>
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Event Name:</dt><dd>${data['event-name'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">R2 Quote Number:</dt><dd>${data['r2-quote-number'] || data['r2-number'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Anticipated Attendees:</dt><dd>${data['anticipated-attendees'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Indoor/Outdoor:</dt><dd>${data['indoor-outdoor'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Charge Days:</dt><dd>${data['charge-days'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Budget:</dt><dd>${data['budget'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Business:</dt><dd>${data['client-business'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Name:</dt><dd>${data['client-name'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Cell:</dt><dd>${data['client-cell'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Client Email:</dt><dd>${data['client-email'] || na}</dd></div>
                                <div class="flex"><dt class="w-40 font-semibold text-gray-600">Tax Status:</dt><dd>${data['tax-status'] || na}</dd></div>
                            </dl>
                        </div>

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Event Schedule</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Activity</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Date</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Time</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Load in</td><td class="border border-gray-300 px-4 py-2">${data['load-in-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['load-in-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['load-in-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Setup</td><td class="border border-gray-300 px-4 py-2">${data['setup-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['setup-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['setup-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Rehearsal</td><td class="border border-gray-300 px-4 py-2">${data['rehearsal-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['rehearsal-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['rehearsal-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Show Start</td><td class="border border-gray-300 px-4 py-2">${data['show-start-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['show-start-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['show-start-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Show End</td><td class="border border-gray-300 px-4 py-2">${data['show-end-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['show-end-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['show-end-notes'] || na}</td></tr>
                                        <tr><td class="border border-gray-300 px-4 py-2 font-medium bg-gray-50">Strike</td><td class="border border-gray-300 px-4 py-2">${data['strike-date'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['strike-time'] || na}</td><td class="border border-gray-300 px-4 py-2">${data['strike-notes'] || na}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${(data.agendaFiles && data.agendaFiles.length > 0) ? `
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Event Agenda Files</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${data.agendaFiles.map(file => `
                                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded border">
                                        <div class="flex-shrink-0">${getFileIcon(file.type)}</div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                                            <p class="text-xs text-gray-500">${formatFileSize(file.size)} • ${new Date(file.uploadedAt).toLocaleDateString()}</p>
                                        </div>
                                        <a href="${file.url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View</a>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Venue Information</h3>
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Venue Name:</dt><dd>${data['venue-name'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Venue Address:</dt><dd>${data['venue-address'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Survey Date:</dt><dd>${data['survey-date'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Survey Team:</dt><dd>${data['survey-team'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Venue Contact:</dt><dd>${data['venue-contact'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Project Manager:</dt><dd>${data['project-manager'] || na}</dd></div>
                                <div class="flex"><dt class="w-32 font-semibold text-gray-600">Account Rep:</dt><dd>${data['account-rep'] || na}</dd></div>
                            </dl>
                        </div>

                        ${(data.roomAccess && data.roomAccess.length > 0) ? `
                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Room Access Schedule</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Room</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Date</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Start Time</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">End Time</th>
                                            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.roomAccess.map(access => `
                                            <tr>
                                                <td class="border border-gray-300 px-4 py-2 font-medium">${access.roomName}</td>
                                                <td class="border border-gray-300 px-4 py-2">${access.accessDate || na}</td>
                                                <td class="border border-gray-300 px-4 py-2">${access.accessTime || na}</td>
                                                <td class="border border-gray-300 px-4 py-2">${access.accessEndTime || na}</td>
                                                <td class="border border-gray-300 px-4 py-2">${access.accessNotes || na}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Venue & Access Logistics</h3>
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Dock Location:</dt><dd class="pl-4">${data['dock-location'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Dock Door Height:</dt><dd>${data['dock-door-height'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Number of Dock Spaces:</dt><dd>${data['num-dock-spaces'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Accommodates 53' semi?</dt><dd>${formatRadio(data['trailer-53-support'])}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Cab can remain attached?</dt><dd>${formatRadio(data['cab-parking'])}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Dock Plate:</dt><dd>${formatRadio(data['dock-plate-type'])}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Ramp Available?</dt><dd>${data['ramp-available'] === 'yes' ? 'Yes' : 'No'}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Ramp Dimensions:</dt><dd class="pl-4">${data['ramp-dimensions'] || na}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Dock Access Process:</dt><dd class="pl-4">${data['dock-access-process'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Dock Coordinator:</dt><dd>${data['dock-coordinator'] || na}</dd></div>
                                <div class="flex"><dt class="w-48 font-semibold text-gray-600">Dock Schedule:</dt><dd>${formatRadio(data['dock-schedule'])}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Distance to Freight Elevator:</dt><dd class="pl-4">${data['freight-elevator-distance'] || na}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Freight Elevator Dimensions:</dt><dd class="pl-4">${data['freight-elevator-dimensions'] || na}</dd></div>
                                <div class="col-span-full"><dt class="font-semibold text-gray-600">Max Item Size for Movement:</dt><dd class="pl-4">${data['max-item-size'] || na}</dd></div>
                            </dl>
                            ${createPhotoSummary('logistics-dock-access', 'Dock Access')}
                            ${createPhotoSummary('logistics-equipment-ramps', 'Equipment & Ramps')}
                            ${createPhotoSummary('logistics-freight-elevator', 'Freight Elevator')}
                        </div>

                         <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Rooms & Spaces</h3>
                            ${roomsHtml}
                        </div>

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Venue Guidelines</h3>
                            ${guidelinesHtml}
                        </div>

                        <div class="p-4 border rounded-lg bg-white">
                            <h3 class="text-xl font-bold mb-3 border-b pb-2">Wrap-Up & Recommendations</h3>
                            <div class="space-y-4">
                                <div><h4 class="font-semibold text-gray-600">Key Findings:</h4><p class="mt-1 pl-4 whitespace-pre-wrap">${data['key-findings'] || na}</p></div>
                                <div><h4 class="font-semibold text-gray-600">Action Items:</h4><p class="mt-1 pl-4 whitespace-pre-wrap">${data['action-items'] || na}</p></div>
                                <div><h4 class="font-semibold text-gray-600">Overall Assessment:</h4><p class="mt-1 pl-4 whitespace-pre-wrap">${data['assessment'] || na}</p></div>
                            </div>
                            ${createPhotoSummary('wrap-up-final-documentation', 'Final Documentation')}
                        </div>
                    </div>
                `;

                section.querySelector('#print-summary-btn').addEventListener('click', () => {
                    const printableContent = section.querySelector('#summary-content').innerHTML;
                    const printableArea = document.getElementById('printable-area');
                    printableArea.innerHTML = `<div class="p-8">${printableContent}</div>`;
                    window.print();
                });
            });
        }

        function renderActivityLog(activityData) {
            const section = document.getElementById('activity');
            if (!section) return;
            preserveFocusAndRender(section, () => {
                section.innerHTML = `<h2 class="text-2xl font-bold mb-6 border-b pb-3">Activity Log</h2><div id="activity-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>`;
                const activityList = section.querySelector('#activity-list');
                if (!activityList) return;
                if (activityData.length === 0) {
                    activityList.innerHTML = '<p class="text-gray-500 text-center">No activity yet. Changes to the form will be logged here.</p>';
                    return;
                }
                activityList.innerHTML = '';
                activityData.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm';
                    const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'Loading...';
                    
                    // Enhanced display for change summaries
                    let descriptionHtml = `<p>${log.description}</p>`;
                    if (log.changes && log.changes.length > 1) {
                        descriptionHtml = `
                            <p class="mb-2">${log.description}</p>
                            <details class="text-sm">
                                <summary class="cursor-pointer text-blue-600 hover:text-blue-800">View details (${log.changes.length} changes)</summary>
                                <ul class="mt-2 ml-4 space-y-1">
                                    ${log.changes.map(change => `<li class="text-gray-700">• ${change}</li>`).join('')}
                                </ul>
                            </details>
                        `;
                    }
                    
                    logElement.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-semibold text-gray-800">${log.user_name || 'Anonymous'}</p>
                            <p class="text-sm text-gray-500">${timestamp}</p>
                        </div>
                        <p class="text-xs font-mono text-gray-400 mb-2">Email: ${log.user_email}${log.section ? ` • Section: ${log.section}` : ''}</p>
                        ${descriptionHtml}`;
                    activityList.appendChild(logElement);
                });
            });
        }
    </script>

    <!-- Authentication & Authorization Script -->
    <script type="module">
        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: "1a7bd6d9-44d3-489c-9f71-0541a0a38b5c", // Replace with your Azure App Registration Client ID
                authority: "https://login.microsoftonline.com/ce2e8146-47b9-4422-a1a4-f107d68b5803", // Replace with your tenant ID
                redirectUri: "https://ita.com/wp-content/themes/utech-child/Surveys-Beta/site-survey.html" // Must match Azure AD exactly
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        // Login request configuration
        const loginRequest = {
            scopes: ["User.Read", "profile", "openid", "email"]
        };

        // Initialize MSAL instance
        let msalInstance;
        let currentUser = null;

        // User roles mapping
        const userRoles = {
            'alex.greene@ita.com': 'admin'
            // Additional roles will be stored in Firebase
        };

        // Initialize authentication
        async function initAuth() {
            try {
                // For Live Server development - check if we're in localhost
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log('Development mode - bypassing Microsoft SSO');
                    // Create mock user for development
                    currentUser = {
                        account: {
                            username: 'alex.greene@ita.com',
                            name: 'Alex Greene (Dev)',
                            idTokenClaims: {
                                email: 'alex.greene@ita.com'
                            }
                        }
                    };
                    
                    // Immediately show main app and hide auth container for development
                    showMainApp();
                    
                    // Set up the authenticated user
                    window.currentUserEmail = 'alex.greene@ita.com';
                    window.currentUserName = 'Alex Greene (Dev)';
                    window.currentUserRole = 'admin';
                    
                    // Update UI
                    updateUserInterface('Alex Greene (Dev)', 'alex.greene@ita.com', 'admin');
                    
                    // Track user session in development mode
                    await trackUserSession('alex.greene@ita.com', 'Alex Greene (Dev)', 'admin');
                    
                    // Initialize the survey app
                    initializeSurveyApp();
                    return;
                }

                // Production mode - use real Microsoft SSO
                // Wait for MSAL to be available
                let attempts = 0;
                while (typeof msal === 'undefined' && attempts < 100) {
                    console.log(`Waiting for MSAL to load... attempt ${attempts + 1}`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof msal === 'undefined') {
                    console.error('MSAL library failed to load after waiting');
                    alert('Authentication library failed to load. Please refresh the page and try again.');
                    return;
                }
                
                console.log('MSAL is available, initializing...');
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();

                // Check if user is already logged in
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentUser = { account: accounts[0] };
                    await handleSuccessfulLogin();
                } else {
                    showAuthContainer();
                }
            } catch (error) {
                console.error('Auth initialization error:', error);
                showAuthContainer();
            }
        }

        // Handle Microsoft login
        async function handleMicrosoftLogin() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Development bypass
                return;
            }

            try {
                // Check if MSAL is available
                if (typeof msal === 'undefined') {
                    alert('Authentication library is not loaded. Please refresh the page and try again.');
                    return;
                }
                
                // Check if msalInstance is initialized
                if (!msalInstance) {
                    alert('Authentication system is not initialized. Please refresh the page and try again.');
                    return;
                }
                
                showAuthLoading();
                console.log('Attempting Microsoft login with config:', {
                    clientId: msalConfig.auth.clientId,
                    authority: msalConfig.auth.authority,
                    redirectUri: msalConfig.auth.redirectUri,
                    currentUrl: window.location.href
                });
                
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                currentUser = loginResponse;
                await handleSuccessfulLogin();
            } catch (error) {
                console.error('Login error details:', error);
                console.error('Error code:', error.errorCode);
                console.error('Error message:', error.errorMessage);
                console.error('Current URL:', window.location.href);
                console.error('Configured redirect URI:', msalConfig.auth.redirectUri);
                
                hideAuthLoading();
                
                // More detailed error message
                let errorMsg = 'Login failed. ';
                if (error.errorCode === 'redirect_uri_mismatch') {
                    errorMsg += 'The redirect URI does not match what is configured in Azure AD. ';
                    errorMsg += `Expected: ${msalConfig.auth.redirectUri}, Current: ${window.location.href}`;
                } else if (error.errorCode) {
                    errorMsg += `Error: ${error.errorCode} - ${error.errorMessage}`;
                } else {
                    errorMsg += 'Please check the browser console for details and try again.';
                }
                
                alert(errorMsg);
            }
        }

        // Handle successful login
        async function handleSuccessfulLogin() {
            try {
                // Get user info
                const email = currentUser.account.idTokenClaims?.email || currentUser.account.username;
                const name = currentUser.account.name || email;
                
                // Determine user role
                const role = await getUserRoleFromDatabase(email);
                
                // Update UI
                updateUserInterface(name, email, role);
                
                // Track user session
                await trackUserSession(email, name, role);
                
                // Initialize AI system (wait for database to be ready)
                setTimeout(async () => {
                    if (window.db) {
                        try {
                            // Wait for the main module functions to be available
                            let attempts = 0;
                            while (!window.checkAISystemStatus && attempts < 50) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                attempts++;
                            }
                            
                            if (window.checkAISystemStatus) {
                                await window.checkAISystemStatus();
                                if (window.updateAIButtonVisibility) {
                                    window.updateAIButtonVisibility();
                                }
                            }
                        } catch (error) {
                            console.warn('AI initialization skipped:', error);
                        }
                    }
                }, 1000);
                
                // Show main application
                showMainApp();
                
                // Initialize the existing survey application
                initializeSurveyApp();
                
            } catch (error) {
                console.error('Post-login setup error:', error);
                alert('Setup failed. Please refresh and try again.');
            }
        }

        // Get user role from Supabase or default mapping
        async function getUserRoleFromDatabase(email) {
            try {
                // Try to get role from Supabase using the database function
                const supabase = window.supabaseClient || window.supabase;
                if (!supabase) {
                    console.error('Database not available for role lookup');
                    // Fallback to hardcoded admin check
                    return email === 'alex.greene@ita.com' ? 'admin' : 'user';
                }
                
                const { data: userRole, error } = await supabase.rpc('get_or_create_user_role', {
                    user_email: email
                });
                
                if (!error && userRole) {
                    return userRole;
                }
                
                // If the function doesn't exist, fallback to direct table lookup
                const { data: roleData, error: roleError } = await supabase
                    .from('user_roles')
                    .select('role')
                    .eq('email', email)
                    .single();
                
                if (roleData && !roleError) {
                    return roleData.role || 'user';
                }
                
                // Final fallback - check hardcoded admin
                if (email === 'alex.greene@ita.com') {
                    return 'admin';
                }
                
                // Default role
                return 'user';
            } catch (error) {
                console.error('Error getting user role:', error);
                // Fallback to hardcoded admin check
                return email === 'alex.greene@ita.com' ? 'admin' : 'user';
            }
        }

        // Update user interface based on role
        function updateUserInterface(name, email, role) {
            // Update user display in header
            const userDisplayName = document.getElementById('user-display-name');
            const userRoleElement = document.getElementById('user-role');
            const userAvatar = document.getElementById('user-avatar');
            
            if (userDisplayName) userDisplayName.textContent = name;
            if (userRoleElement) userRoleElement.textContent = role.charAt(0).toUpperCase() + role.slice(1);
            if (userAvatar) userAvatar.textContent = name.charAt(0).toUpperCase();
            
            // Update dropdown elements
            const dropdownUserName = document.getElementById('dropdown-user-name');
            const dropdownUserEmail = document.getElementById('dropdown-user-email');
            
            if (dropdownUserName) dropdownUserName.textContent = name;
            if (dropdownUserEmail) dropdownUserEmail.textContent = email;
            
            // Show admin indicator if admin
            const adminIndicator = document.getElementById('admin-indicator');
            const adminSection = document.getElementById('admin-section');
            
            if (role === 'admin') {
                if (adminIndicator) adminIndicator.classList.remove('hidden');
                if (adminSection) adminSection.classList.remove('hidden');
            }
            
            // Store current user info globally
            window.currentUserEmail = email;
            window.currentUserName = name;
            window.currentUserRole = role;
        }

        // Track user session in Firebase
        async function trackUserSession(email, name, role) {
            try {
                console.log('Tracking user session:', { email, name, role });
                
                const supabase = window.supabaseClient || window.supabase;
                if (!supabase) {
                    console.error('Database not available after waiting');
                    // Set role locally without database
                    window.currentUserRole = email === 'alex.greene@ita.com' ? 'admin' : 'user';
                    return;
                }
                
                // Use the upsert_user_session function to handle role assignment
                const { data, error } = await supabase.rpc('upsert_user_session', {
                    user_email: email,
                    user_name: name
                });
                
                if (error) {
                    console.error('Error tracking user session:', error);
                    console.log('Database tables may not exist yet. Please run the supabase_tables.sql script.');
                    // Fallback to direct insert if function doesn't exist
                    const { error: fallbackError } = await supabase
                        .from('user_sessions')
                        .upsert({
                            email: email,
                            name: name,
                            role: email === 'alex.greene@ita.com' ? 'admin' : 'user',
                            last_active: new Date().toISOString(),
                            login_time: new Date().toISOString()
                        }, {
                            onConflict: 'email'
                        });
                    
                    if (fallbackError) {
                        console.log('Database tables not available - continuing without session tracking');
                        // Set role locally without database
                        window.currentUserRole = email === 'alex.greene@ita.com' ? 'admin' : 'user';
                    } else {
                        console.log('User session tracked successfully (fallback)');
                        // Update the current user role based on the database or default logic
                        window.currentUserRole = email === 'alex.greene@ita.com' ? 'admin' : 'user';
                    }
                } else {
                    console.log('User session tracked successfully');
                    // The function returns the actual role from the database
                    window.currentUserRole = data || (email === 'alex.greene@ita.com' ? 'admin' : 'user');
                }
            } catch (error) {
                console.error('Error tracking session:', error);
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                // Remove from active sessions
                if (window.currentUserEmail) {
                    const db = window.db;
                    if (db) {
                        await deleteDoc(doc(db, 'activeSessions', window.currentUserEmail));
                    }
                }
                
                // Logout from MSAL if not in development
                if (msalInstance && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    await msalInstance.logoutPopup();
                }
                
                // Reset state
                currentUser = null;
                window.currentUserEmail = null;
                window.currentUserName = null;
                window.currentUserRole = null;
                
                // Show auth container
                showAuthContainer();
                
            } catch (error) {
                console.error('Logout error:', error);
                location.reload(); // Force reload on error
            }
        }

        // Set user role (admin only) - WordPress version
        async function setUserRole(email, role) {
            if (!checkAccess('manageUsers')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            try {
                // Use WordPress REST API
                const response = await fetch('/wp-json/site-survey/v1/user-roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-WP-Nonce': window.wpNonce || ''
                    },
                    body: JSON.stringify({
                        email: email,
                        role: mapToWordPressRole(role)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`User role set successfully: ${email} -> ${role}`);
                    loadUserRolesList(); // Refresh user roles display
                    logActivity(`Updated user role: ${email} is now ${role}`);
                } else {
                    throw new Error(result.message || 'Failed to update user role');
                }
                
            } catch (error) {
                console.error('Error setting user role:', error);
                
                // Fallback: Show manual instructions
                const manualInstructions = `
WordPress Admin Instructions:
1. Go to WordPress Admin → Users
2. Find user: ${email}
3. Edit user and change role to: ${mapToWordPressRole(role)}
4. Or use WordPress Admin → Tools → Site Survey Users

Error: ${error.message}
                `;
                
                if (confirm('Automatic role update failed. Would you like to see manual instructions?')) {
                    alert(manualInstructions);
                }
                
                // Log for admin reference
                logActivity(`MANUAL ACTION NEEDED: Set ${email} role to ${role} - Auto-update failed`);
            }
        }

        async function loadUserRolesList() {
            if (!checkAccess('manageUsers')) return;
            
            try {
                // Try to load from WordPress first
                const response = await fetch('/wp-json/site-survey/v1/users', {
                    headers: {
                        'X-WP-Nonce': window.wpNonce || ''
                    }
                });
                
                let users = [];
                
                if (response.ok) {
                    const wpUsers = await response.json();
                    users = wpUsers.map(user => ({
                        email: user.email,
                        role: mapFromWordPressRole(user.roles[0]),
                        name: user.name,
                        updatedBy: 'WordPress',
                        updatedAt: user.date
                    }));
                } else {
                    // Fallback to mock data
                    users = [
                        {
                            email: 'alex.greene@ita.com',
                            role: 'admin',
                            name: 'Alex Greene',
                            updatedBy: 'System',
                            updatedAt: new Date().toISOString()
                        }
                    ];
                }
                
                const container = document.getElementById('user-roles-list');
                if (!container) return;
                
                if (users.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No user roles defined yet</p>';
                    return;
                }
                
                container.innerHTML = users.map(user => `
                    <div class="flex justify-between items-center p-2 bg-white rounded border">
                        <div>
                            <span class="font-medium">${user.email}</span>
                            <span class="text-sm text-gray-500 ml-2 px-2 py-1 rounded ${getRoleColorClass(user.role)}">${user.role.toUpperCase()}</span>
                            ${user.name ? `<br><small class="text-gray-400">${user.name}</small>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editUserRole('${user.email}', '${user.role}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                Edit
                            </button>
                            <button onclick="removeUserRole('${user.email}')" class="text-red-600 hover:text-red-800 text-sm">
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading user roles:', error);
                const container = document.getElementById('user-roles-list');
                if (container) {
                    container.innerHTML = `
                        <div class="p-2 bg-yellow-50 border border-yellow-200 rounded">
                            <p class="text-sm text-yellow-800">
                                Unable to load users from WordPress. 
                                <a href="/wp-admin/tools.php?page=site-survey-users" target="_blank" class="underline">
                                    Manage users in WordPress Admin
                                </a>
                            </p>
                        </div>
                    `;
                }
            }
        }
        
        function editUserRole(email, currentRole) {
            const emailInput = document.getElementById('role-email');
            const roleSelect = document.getElementById('role-select');
            
            if (emailInput) emailInput.value = email;
            if (roleSelect) roleSelect.value = currentRole;
        }
        
        function getRoleColorClass(role) {
            switch(role) {
                case 'admin': return 'bg-red-100 text-red-800';
                case 'manager': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        async function removeUserRole(email) {
            if (!checkAccess('manageUsers')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            if (!confirm(`Remove survey access for ${email}? They will lose access to the site survey system.`)) {
                return;
            }
            
            try {
                // In WordPress, we'll change their role to 'subscriber' (basic user)
                await setUserRole(email, 'user'); // This will map to basic subscriber role
                logActivity(`Removed site survey access: ${email}`);
                loadUserRolesList(); // Refresh display
                
            } catch (error) {
                console.error('Error removing user role:', error);
                alert('Failed to remove user role: ' + error.message);
            }
        }

        // Make functions globally accessible
        window.removeUserRole = removeUserRole;
        window.editUserRole = editUserRole;

        // Load active users for admin panel
        async function loadActiveUsers() {
            console.log('Loading active users...');
            try {
                const db = window.db;
                if (!db) {
                    console.error('Database not initialized');
                    const activeUsersList = document.getElementById('active-users-list');
                    if (activeUsersList) {
                        activeUsersList.innerHTML = '<p class="text-red-500">Database not available</p>';
                    }
                    return;
                }
                
                const activeSessions = await getDocs(query(collection(db, 'activeSessions'), orderBy('lastActive', 'desc')));
                const activeUsersList = document.getElementById('active-users-list');
                
                if (!activeUsersList) {
                    console.error('Active users list element not found');
                    return;
                }
                
                console.log('Active sessions found:', activeSessions.size);
                
                if (activeSessions.empty) {
                    activeUsersList.innerHTML = '<p class="text-gray-500">No active users</p>';
                    return;
                }
                
                activeUsersList.innerHTML = '';
                activeSessions.forEach(doc => {
                    const session = doc.data();
                    console.log('Session data:', session);
                    const userElement = document.createElement('div');
                    userElement.className = 'flex justify-between items-center p-2 bg-white rounded border';
                    userElement.innerHTML = `
                        <div>
                            <div class="font-medium">${session.name}</div>
                            <div class="text-sm text-gray-500">${session.email}</div>
                            <div class="text-xs text-blue-600">${session.role}</div>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${session.lastActive ? new Date(session.lastActive.seconds * 1000).toLocaleString() : 'Unknown'}
                        </div>
                    `;
                    activeUsersList.appendChild(userElement);
                });
            } catch (error) {
                console.error('Error loading active users:', error);
                const activeUsersList = document.getElementById('active-users-list');
                if (activeUsersList) {
                    activeUsersList.innerHTML = '<p class="text-red-500">Error loading users</p>';
                }
            }
        }

        // Load survey records for admin panel
        async function loadSurveyRecords() {
            console.log('Loading survey records...');
            try {
                const db = window.db;
                if (!db) {
                    console.error('Database not initialized');
                    const surveyRecords = document.getElementById('survey-records');
                    if (surveyRecords) {
                        surveyRecords.innerHTML = '<p class="text-red-500">Database not available</p>';
                    }
                    return;
                }
                
                // Get all artifacts (surveys)
                const artifactsSnapshot = await getDocs(collection(db, 'artifacts'));
                const surveyRecords = document.getElementById('survey-records');
                
                if (!surveyRecords) {
                    console.error('Survey records element not found');
                    return;
                }
                
                console.log('Survey records found:', artifactsSnapshot.size);
                
                if (artifactsSnapshot.empty) {
                    surveyRecords.innerHTML = '<p class="text-gray-500">No survey records found</p>';
                    return;
                }
                
                surveyRecords.innerHTML = '';
                
                for (const artifactDoc of artifactsSnapshot.docs) {
                    const artifactId = artifactDoc.id;
                    
                    try {
                        // Get the main survey data
                        const surveyDoc = await getDoc(doc(db, 'artifacts', artifactId, 'public', 'data', 'survey', 'main'));
                        
                        if (surveyDoc.exists()) {
                            const surveyData = surveyDoc.data();
                            const recordElement = document.createElement('div');
                            recordElement.className = 'p-3 bg-white rounded border mb-2 hover:bg-gray-50 cursor-pointer';
                            recordElement.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900">R2# ${artifactId}</div>
                                        <div class="text-sm text-gray-600">${surveyData['event-name'] || 'No event name'}</div>
                                        <div class="text-sm text-gray-500">${surveyData['venue-name'] || 'No venue'}</div>
                                        <div class="text-xs text-gray-400">
                                            Survey Date: ${surveyData['survey-date'] || 'Not set'}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400">
                                            Rooms: ${(surveyData.rooms || []).length}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            Photos: ${Object.keys(surveyData.photos || {}).length} sections
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Add click handler to view survey
                            recordElement.addEventListener('click', () => {
                                window.open(`?id=${encodeURIComponent(artifactId)}`, '_blank');
                            });
                            
                            surveyRecords.appendChild(recordElement);
                        }
                    } catch (docError) {
                        console.log(`No survey data for artifact ${artifactId}:`, docError);
                    }
                }
                
            } catch (error) {
                console.error('Error loading survey records:', error);
                const surveyRecords = document.getElementById('survey-records');
                if (surveyRecords) {
                    surveyRecords.innerHTML = '<p class="text-red-500">Error loading survey records</p>';
                }
            }
        }

        // UI Helper Functions
        function showAuthContainer() {
            // Only show auth container in production mode
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        }

        function showMainApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        function showAuthLoading() {
            document.getElementById('auth-content').classList.add('hidden');
            document.getElementById('auth-loading').classList.remove('hidden');
        }

        function hideAuthLoading() {
            document.getElementById('auth-content').classList.remove('hidden');
            document.getElementById('auth-loading').classList.add('hidden');
        }

        // Initialize existing survey app functionality
        function initializeSurveyApp() {
            // Wait for the main module to load before calling showWelcomeModal
            const waitForWelcomeModal = () => {
                if (window.showWelcomeModal) {
                    window.showWelcomeModal();
                } else {
                    // Wait a bit more for the module to load
                    setTimeout(waitForWelcomeModal, 100);
                }
            };
            waitForWelcomeModal();
        }

        // Check access permissions for operations
        function checkAccess(operation) {
            const role = window.currentUserRole;
            
            switch (operation) {
                case 'viewAllRecords':
                    return role === 'admin' || role === 'manager';
                case 'editAllRecords':
                    return role === 'admin';
                case 'manageUsers':
                    return role === 'admin';
                case 'createVenue':
                case 'editOwnVenue':
                    return true; // All roles can create/edit
                case 'viewVenueList':
                    return role !== 'user'; // Users can't see venue list
                default:
                    return false;
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize authentication first
            initAuth();
            
            // Auth event listeners
            document.getElementById('login-btn').addEventListener('click', handleMicrosoftLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // User menu toggle
            document.getElementById('user-menu-btn').addEventListener('click', function() {
                document.getElementById('user-dropdown').classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.user-menu')) {
                    document.getElementById('user-dropdown').classList.remove('show');
                }
            });
            
            // Admin panel
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            const adminModal = document.getElementById('admin-modal');
            const closeAdminModal = document.getElementById('close-admin-modal');
            
            if (adminPanelBtn && adminModal) {
                adminPanelBtn.addEventListener('click', function() {
                    console.log('Admin panel button clicked');
                    adminModal.classList.remove('hidden');
                    adminModal.classList.add('flex');
                    loadActiveUsers();
                    loadSurveyRecords();
                    loadUserRolesList(); // Load user roles list
                });
            } else {
                console.error('Admin panel elements not found:', { adminPanelBtn, adminModal });
            }
            
            if (closeAdminModal && adminModal) {
                closeAdminModal.addEventListener('click', function() {
                    console.log('Close admin modal clicked');
                    adminModal.classList.add('hidden');
                    adminModal.classList.remove('flex');
                });
            }
            
            // AI admin panel
            const aiAdminBtn = document.getElementById('ai-admin-btn');
            if (aiAdminBtn) {
                aiAdminBtn.addEventListener('click', function() {
                    console.log('AI admin button clicked');
                    showAISettings();
                });
            } else {
                console.error('AI admin button not found');
            }
            
            document.getElementById('set-role-btn').addEventListener('click', function() {
                const email = document.getElementById('role-email').value;
                const role = document.getElementById('role-select').value;
                if (email && role) {
                    setUserRole(email, role);
                    document.getElementById('role-email').value = '';
                }
            });
        });

        // Update last active timestamp periodically
        setInterval(async function() {
            if (window.currentUserEmail) {
                try {
                    const db = window.db;
                    if (db) {
                        await setDoc(doc(db, 'activeSessions', window.currentUserEmail), {
                            lastActive: serverTimestamp()
                        }, { merge: true });
                    }
                } catch (error) {
                    console.error('Error updating last active:', error);
                }
            }
        }, 60000); // Every minute
    </script>

    </div> <!-- End main-app -->
</body>
<header class="fixed top-0 left-0 p-4 z-50">
    <div id="home-link" class="text-xl font-semibold text-gray-600 cursor-pointer hover:text-blue-800">
        Site Survey Portal
    </div>
</header>

<script>
    document.getElementById('home-link').addEventListener('click', () => {
        // Navigate back to the dashboard/home page
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('dashboard-container').classList.remove('hidden');
        document.getElementById('dashboard-header')?.classList.remove('hidden');
        document.getElementById('auth-container').classList.add('hidden');
    });
</script>
</html>